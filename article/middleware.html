<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


:root {
    --monospace: "JetBrains Mono", HYZhengYuan, "Fira Code", Menlo, "Ubuntu Mono", Consolas; /*code font*/
    --text-font: var(--monospace); /*default font*/
    --title-font: var(--monospace); /*title font*/

    --bg-color: #283237;
    --text-color: #b3bec4;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #37474f;
    --active-file-bg-color: var(--item-hover-bg-color);

    --md-char-color: #535455;
    --side-bar-bg-color: var(--bg-color);
    --search-select-bg-color: #ffffff;
    --search-select-text-color: var(--bg-color);
    --select-text-bg-color: #3473B068;
    --window-border: 1px solid #282828;

    --drake-accent: #429488;
    --drake-highlight: #429488;
    --a-color: var(--drake-highlight);
    --variable-color: var(--drake-highlight);
    --outline-active-color: var(--a-color);
    --code-block-bg-color: #1b2529;
    --code-block-color: var(--text-color);
    --title-color: #bbc6d2;
    --blockquote-border-color: var(--drake-accent);
    --blockquote-color: var(--text-color);
    --blockquote-bg-color: #364149;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--drake-highlight);
    --height-light-border-color: var(--drake-highlight);
    --yaml-color: #676773;
    --yaml-bg-color: var(--code-block-bg-color);
    --footnotes-bg-color: var(--item-hover-bg-color);
    --footnotes-highlight: #FFD760;
    --table-border-color: var(--item-hover-bg-color);
    --table-header-bg-color: #314549;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: var(--table-header-bg-color);
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23acb7c4'/%3E%3C/svg%3E");
}

html {
    font-size: 12px;
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
    line-height: 1.8rem;
    font-size: 13px;
}

/*code block*/
#write .md-fences {
    font-size: 1rem;
    padding: 0.5rem !important;
    border-radius: 2px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: none;
}

/*code snippet*/
#write code, tt {
    margin: 0 2px;
    color: var(--drake-highlight);
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}

.md-rawblock:hover > .md-rawblock-container {
    background: none;
}

.md-rawblock-input {
    font-size: 1rem;
}

.md-rawblock-tooltip-btn:hover {
    background: none;
}

.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}

.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}

.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote:before {
    display: block;
    position: absolute;
    content: '';
    width: 4px;
    left: 0;
    top: 0;
    height: 100%;
    background-color: var(--blockquote-border-color);
    border-radius: 2px;
}

blockquote {
    color: var(--blockquote-color);
    border-radius: 2px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}

#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
#write a {
    color: var(--a-color);
    text-decoration: none;
}

#write a .md-plain, .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}

[md-inline=link] a {
    margin: 0 .2rem;
}

a:any-link {
    color: var(--a-color);
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}

#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write p {
    word-spacing: .05rem;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 1.6rem;
    text-align: center;
    margin-top: 0;
}

h2.md-end-block.md-heading {
    font-size: 1.6rem;
    display: inline-block;
}

h2.md-end-block.md-heading:after {
    display: block;
    content: '';
    height: 2px;
    margin-top: 4px;
    background-color: var(--h2-underline-color);
    border-radius: 2px;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}

p {
    margin: 0;
}

li > ol,
li > ul {
    margin: 0 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

table {
    padding: 0;
    word-break: initial;
    background-color: var(--table-bg-color);
}

table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}

table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}

table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}

table thead {
    background-color: var(--table-header-bg-color);
}

table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

#write table thead th {
    background-color: var(--table-header-bg-color);
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    vertical-align: top;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}

#typora-sidebar {
    font-size: 1.1rem;
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 1rem;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 500;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}

#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}

#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}

.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}

.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}

.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}

#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}

#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}

.megamenu-menu-header {
    border-bottom: none;
}

#recent-file-panel-action-btn {
    background: none;
    border: none;
}

#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}

#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}

.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}

#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}

.megamenu-menu-panel table {
    font-weight: normal;
}

#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}

.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}

header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}

.ty-preferences select {
    padding-left: 2px;
}

.preference-item-hint {
    font-size: 14px;
}

a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/*
  Name:       material
  Author:     Mattia Astorino (http://github.com/equinusocio)
  Website:    https://material-theme.site/
*/
.cm-s-inner.CodeMirror {
    background: none;
    color: var(--code-block-color);
}

.cm-s-inner .CodeMirror-gutters {
    border-right: none;
    border-radius: 2px;
    padding-left: 0.5rem;
    background: #263238;
    color: #546E7A;
}

.cm-s-inner .CodeMirror-guttermarker,
.cm-s-inner .CodeMirror-guttermarker-subtle,
.cm-s-inner .CodeMirror-linenumber {
    color: #546E7A;
}

.cm-s-inner .CodeMirror-line::selection,
.cm-s-inner .CodeMirror-line > span::selection,
.cm-s-inner .CodeMirror-line > span > span::selection {
    background: rgba(128, 203, 196, 0.2);
}

.cm-s-inner .CodeMirror-line::-moz-selection,
.cm-s-inner .CodeMirror-line > span::-moz-selection,
.cm-s-inner .CodeMirror-line > span > span::-moz-selection {
    background: rgba(128, 203, 196, 0.2);
}

.cm-s-inner .cm-keyword {
    color: #C792EA;
}

.cm-s-inner .cm-operator {
    color: #89DDFF;
}

.cm-s-inner .cm-variable-2 {
    color: var(--code-block-color);
}

.cm-s-inner .cm-variable-3,
.cm-s-inner .cm-type {
    color: #f07178;
}

.cm-s-inner .cm-builtin {
    color: #FFCB6B;
}

.cm-s-inner .cm-atom {
    color: #F78C6C;
}

.cm-s-inner .cm-number {
    color: #FF5370;
}

.cm-s-inner .cm-def {
    color: #82AAFF;
}

.cm-s-inner .cm-string {
    color: #C3E88D;
}

.cm-s-inner .cm-string-2 {
    color: #f07178;
}

.cm-s-inner .cm-comment {
    color: #546E7A;
}

.cm-s-inner .cm-variable {
    color: var(--code-block-color);
}

.cm-s-inner .cm-tag {
    color: #FF5370;
}

.cm-s-inner .cm-meta {
    color: #FFCB6B;
}

.cm-s-inner .cm-attribute {
    color: #C792EA;
}

.cm-s-inner .cm-property {
    color: #C792EA;
}

.cm-s-inner .cm-qualifier {
    color: #DECB6B;
}

.cm-s-inner .cm-variable-3,
.cm-s-inner .cm-type {
    color: #DECB6B;
}

.cm-s-inner .cm-error {
    color: rgba(255, 255, 255, 1.0);
    background-color: #FF5370;
}

.cm-s-inner .CodeMirror-matchingbracket {
    text-decoration: underline;
    color: white !important;
}

.cm-s-inner .CodeMirror-selected {
    background: #214283 !important;
}

.cm-s-inner .CodeMirror-selectedtext {
    background: #214283 !important;
}

.cm-s-typora-default .CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-overlay.CodeMirror-selectedtext {
    background: var(--select-text-bg-color) !important;
}

.cm-s-inner div.CodeMirror-cursor {
    border-left: 1px solid var(--code-block-color);
}


</style><title>Middleware</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n2"><a class="md-toc-inner" href="#spi">SPI</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5"><a class="md-toc-inner" href="#java-spi">Java SPI</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n9"><a class="md-toc-inner" href="#dubbo-spi-1">Dubbo SPI</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n22"><a class="md-toc-inner" href="#motan-spi">Motan SPI</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n27"><a class="md-toc-inner" href="#springboot-spi">SpringBoot SPI</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n33"><a class="md-toc-inner" href="#redis">Redis</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n92"><a class="md-toc-inner" href="#线程模型-1">线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n108"><a class="md-toc-inner" href="#通信流程">通信流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n142"><a class="md-toc-inner" href="#文件事件处理器">文件事件处理器</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n153"><a class="md-toc-inner" href="#io多路复用">I/O多路复用</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n197"><a class="md-toc-inner" href="#执行效率高">执行效率高</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n209"><a class="md-toc-inner" href="#数据类型">数据类型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n223"><a class="md-toc-inner" href="#string字符串">String(字符串)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n226"><a class="md-toc-inner" href="#hash字典">Hash(字典)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n241"><a class="md-toc-inner" href="#list列表">List(列表)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n264"><a class="md-toc-inner" href="#set集合">Set(集合)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n281"><a class="md-toc-inner" href="#sorted-set有序集合">Sorted Set(有序集合)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n294"><a class="md-toc-inner" href="#特殊数据结构">特殊数据结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n295"><a class="md-toc-inner" href="#hyperloglog基数统计">HyperLogLog(基数统计)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n323"><a class="md-toc-inner" href="#geo地理空间信息">Geo(地理空间信息)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n376"><a class="md-toc-inner" href="#pubsub发布订阅">Pub/Sub(发布订阅)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n408"><a class="md-toc-inner" href="#bitmap位图">Bitmap(位图)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n460"><a class="md-toc-inner" href="#bloomfilter布隆过滤">BloomFilter(布隆过滤)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n478"><a class="md-toc-inner" href="#基于bitmap数据结构">基于Bitmap数据结构</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n481"><a class="md-toc-inner" href="#基于redisbloom模块">基于RedisBloom模块</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n495"><a class="md-toc-inner" href="#底层数据结构">底层数据结构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n499"><a class="md-toc-inner" href="#sds简单动态字符">SDS(简单动态字符)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n510"><a class="md-toc-inner" href="#hash表字典">hash表(字典)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n518"><a class="md-toc-inner" href="#linkedlist双端列表">linkedList(双端列表)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n522"><a class="md-toc-inner" href="#ziplist压缩列表">zipList(压缩列表)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n529"><a class="md-toc-inner" href="#skiplist跳跃表">skipList(跳跃表)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n534"><a class="md-toc-inner" href="#intset整数数组">intset(整数数组)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n539"><a class="md-toc-inner" href="#持久化机制">持久化机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n552"><a class="md-toc-inner" href="#rdb模式内存快照">RDB模式(内存快照)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n577"><a class="md-toc-inner" href="#save同步保存">save同步保存</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n583"><a class="md-toc-inner" href="#bgsave异步保存">bgsave异步保存</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n589"><a class="md-toc-inner" href="#自动保存">自动保存</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n593"><a class="md-toc-inner" href="#默认配置-1">默认配置</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n597"><a class="md-toc-inner" href="#aof模式日志追加">AOF模式(日志追加)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n613"><a class="md-toc-inner" href="#持久化流程">持久化流程</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n648"><a class="md-toc-inner" href="#文件重写">文件重写</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n676"><a class="md-toc-inner" href="#默认配置-2">默认配置</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n680"><a class="md-toc-inner" href="#过期策略">过期策略</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n682"><a class="md-toc-inner" href="#定时过期">定时过期</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n685"><a class="md-toc-inner" href="#惰性过期">惰性过期</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n688"><a class="md-toc-inner" href="#定期过期">定期过期</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n691"><a class="md-toc-inner" href="#淘汰策略">淘汰策略</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n694"><a class="md-toc-inner" href="#lru最近最少使用">LRU(最近最少使用)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n701"><a class="md-toc-inner" href="#lfu最近最不经常使用">LFU(最近最不经常使用)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n708"><a class="md-toc-inner" href="#random随机淘汰">Random(随机淘汰)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n715"><a class="md-toc-inner" href="#ttl过期时间">TTL(过期时间)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n722"><a class="md-toc-inner" href="#no-enviction驱逐">No-Enviction(驱逐)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n727"><a class="md-toc-inner" href="#部署架构">部署架构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n728"><a class="md-toc-inner" href="#单节点single-1">单节点(Single)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n746"><a class="md-toc-inner" href="#主从复制replication-1">主从复制(Replication)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n752"><a class="md-toc-inner" href="#哨兵sentinel-1">哨兵(Sentinel)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n764"><a class="md-toc-inner" href="#集群cluster-1">集群(Cluster)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n768"><a class="md-toc-inner" href="#环境搭建">环境搭建</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n781"><a class="md-toc-inner" href="#单节点single-2">单节点(Single)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n787"><a class="md-toc-inner" href="#主从复制replication-2">主从复制(Replication)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n801"><a class="md-toc-inner" href="#哨兵sentinel-2">哨兵(Sentinel)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n821"><a class="md-toc-inner" href="#集群cluster-2">集群(Cluster)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n852"><a class="md-toc-inner" href="#拓展方案">拓展方案</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n853"><a class="md-toc-inner" href="#分区partitioning">分区(Partitioning)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n877"><a class="md-toc-inner" href="#主从master-slave">主从(Master-Slave)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n894"><a class="md-toc-inner" href="#哨兵sentinel-3">哨兵(Sentinel)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n911"><a class="md-toc-inner" href="#集群cluster-3">集群(Cluster)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n929"><a class="md-toc-inner" href="#常见问题">常见问题</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n943"><a class="md-toc-inner" href="#kafka">Kafka</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n945"><a class="md-toc-inner" href="#rocketmq">RocketMQ</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n961"><a class="md-toc-inner" href="#架构设计">架构设计</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n962"><a class="md-toc-inner" href="#部署模型">部署模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n965"><a class="md-toc-inner" href="#角色">角色</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n966"><a class="md-toc-inner" href="#broker">Broker</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n979"><a class="md-toc-inner" href="#nameserver">NameServer</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n994"><a class="md-toc-inner" href="#producer-1">Producer</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1003"><a class="md-toc-inner" href="#consumer-1">Consumer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1012"><a class="md-toc-inner" href="#核心流程-1">核心流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1025"><a class="md-toc-inner" href="#实现原理">实现原理</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1036"><a class="md-toc-inner" href="#核心概念">核心概念</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1037"><a class="md-toc-inner" href="#message消息">Message(消息)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1040"><a class="md-toc-inner" href="#topic主题">Topic(主题)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1043"><a class="md-toc-inner" href="#queue队列">Queue(队列)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1046"><a class="md-toc-inner" href="#tag标签">Tag(标签)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1049"><a class="md-toc-inner" href="#消费模式message-model">消费模式(Message Model)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1051"><a class="md-toc-inner" href="#集群模式clustering">集群模式(Clustering)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1062"><a class="md-toc-inner" href="#广播模式broadcasting">广播模式(Broadcasting)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1073"><a class="md-toc-inner" href="#message-order消息顺序">Message Order(消息顺序)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1075"><a class="md-toc-inner" href="#顺序orderly）">顺序（Orderly）</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1077"><a class="md-toc-inner" href="#并发concurrently）">并发（Concurrently）</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1079"><a class="md-toc-inner" href="#producer-group生产组">Producer Group(生产组)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1082"><a class="md-toc-inner" href="#consumer-group消费组">Consumer Group(消费组)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1086"><a class="md-toc-inner" href="#offset">Offset</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1090"><a class="md-toc-inner" href="#核心设计-1">核心设计</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1091"><a class="md-toc-inner" href="#消息清理">消息清理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1102"><a class="md-toc-inner" href="#push-or-pull">push or pull</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1108"><a class="md-toc-inner" href="#负载均衡-1">负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1110"><a class="md-toc-inner" href="#producer端">Producer端</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1144"><a class="md-toc-inner" href="#consumer端">Consumer端</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1164"><a class="md-toc-inner" href="#最佳实践">最佳实践</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1165"><a class="md-toc-inner" href="#producer-2">Producer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1191"><a class="md-toc-inner" href="#consumer-2">Consumer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1208"><a class="md-toc-inner" href="#事务消息">事务消息</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1230"><a class="md-toc-inner" href="#保证顺序">保证顺序</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1254"><a class="md-toc-inner" href="#保持顺序发送">保持顺序发送</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1257"><a class="md-toc-inner" href="#保持顺序发送存储">保持顺序发送存储</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1260"><a class="md-toc-inner" href="#保持顺序消费">保持顺序消费</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1262"><a class="md-toc-inner" href="#mqpullconsumer">MQPullConsumer</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1265"><a class="md-toc-inner" href="#mqpushconsumer">MQPushConsumer</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1268"><a class="md-toc-inner" href="#消息不丢失">消息不丢失</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1280"><a class="md-toc-inner" href="#生产阶段">生产阶段</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1285"><a class="md-toc-inner" href="#同步发送">同步发送</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1296"><a class="md-toc-inner" href="#失败重试">失败重试</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1302"><a class="md-toc-inner" href="#故障切换">故障切换</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1305"><a class="md-toc-inner" href="#broker存储阶段">Broker存储阶段</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1309"><a class="md-toc-inner" href="#设置broker同步刷盘策略">设置Broker同步刷盘策略</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1315"><a class="md-toc-inner" href="#等待master和slave刷盘完">等待Master和Slave刷盘完</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1319"><a class="md-toc-inner" href="#消费阶段">消费阶段</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1322"><a class="md-toc-inner" href="#手动ack确认">手动ACK确认</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1326"><a class="md-toc-inner" href="#消费异常自动重试">消费异常自动重试</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1339"><a class="md-toc-inner" href="#消费超时无线重试">消费超时无线重试</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1342"><a class="md-toc-inner" href="#死信队列">死信队列</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1355"><a class="md-toc-inner" href="#消息幂等">消息幂等</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1370"><a class="md-toc-inner" href="#zookeeper">Zookeeper</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1372"><a class="md-toc-inner" href="#节点角色">节点角色</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1373"><a class="md-toc-inner" href="#leader">Leader</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1381"><a class="md-toc-inner" href="#follower">Follower</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1391"><a class="md-toc-inner" href="#observer">Observer</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1394"><a class="md-toc-inner" href="#核心流程设计">核心流程设计</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1395"><a class="md-toc-inner" href="#启动阶段-leader选举">启动阶段 Leader选举</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1416"><a class="md-toc-inner" href="#运行期间leader宕机处理">运行期间Leader宕机处理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1424"><a class="md-toc-inner" href="#节点之间同步数据流程">节点之间同步数据流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1458"><a class="md-toc-inner" href="#zab顺序一致性原理">ZAB顺序一致性原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1465"><a class="md-toc-inner" href="#zookeeper是否是强一致性">Zookeeper是否是强一致性</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1472"><a class="md-toc-inner" href="#leader-宕机数据丢失问题">Leader 宕机数据丢失问题</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1485"><a class="md-toc-inner" href="#zk特性">ZK特性</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1504"><a class="md-toc-inner" href="#zk角色">ZK角色</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1558"><a class="md-toc-inner" href="#数据模型-1">数据模型</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1575"><a class="md-toc-inner" href="#server工作状态">Server工作状态</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1587"><a class="md-toc-inner" href="#运行模式">运行模式</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1597"><a class="md-toc-inner" href="#leader选举">Leader选举</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1598"><a class="md-toc-inner" href="#服务器启动的leader选举">服务器启动的Leader选举</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1636"><a class="md-toc-inner" href="#服务器运行期间的leader选举">服务器运行期间的Leader选举</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1656"><a class="md-toc-inner" href="#节点znode）">节点（znode）</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1684"><a class="md-toc-inner" href="#关键词">关键词</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1693"><a class="md-toc-inner" href="#watcher监听机制">Watcher监听机制</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1719"><a class="md-toc-inner" href="#zxid">ZXID</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1729"><a class="md-toc-inner" href="#工作流程-1">工作流程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1790"><a class="md-toc-inner" href="#zab协议">ZAB协议</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1851"><a class="md-toc-inner" href="#zk选举过程">ZK选举过程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1869"><a class="md-toc-inner" href="#zookeeper安装">Zookeeper安装</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1870"><a class="md-toc-inner" href="#单机模式">单机模式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1876"><a class="md-toc-inner" href="#集群模式">集群模式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1885"><a class="md-toc-inner" href="#运维命令-1">运维命令</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1888"><a class="md-toc-inner" href="#zoocfg配置参数">zoo.cfg配置参数</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1891"><a class="md-toc-inner" href="#netty">Netty</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1892"><a class="md-toc-inner" href="#netty逻辑架构">Netty逻辑架构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1896"><a class="md-toc-inner" href="#网络通信层">网络通信层</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1912"><a class="md-toc-inner" href="#事件调度层">事件调度层</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1935"><a class="md-toc-inner" href="#服务编排层">服务编排层</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1954"><a class="md-toc-inner" href="#reactor线程模型">Reactor线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1967"><a class="md-toc-inner" href="#单reactor单线程">单Reactor单线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1980"><a class="md-toc-inner" href="#单reactor多线程">单Reactor多线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1984"><a class="md-toc-inner" href="#主从reactor多线程">主从Reactor多线程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1989"><a class="md-toc-inner" href="#核心设计-2">核心设计</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1990"><a class="md-toc-inner" href="#netty-eventloop原理">Netty EventLoop原理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1993"><a class="md-toc-inner" href="#eventloop运行模式">EventLoop运行模式</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1997"><a class="md-toc-inner" href="#nioeventloop原理">NioEventLoop原理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2002"><a class="md-toc-inner" href="#事件处理机制">事件处理机制</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2028"><a class="md-toc-inner" href="#任务处理机制">任务处理机制</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2054"><a class="md-toc-inner" href="#eventloop最佳实践">EventLoop最佳实践</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2066"><a class="md-toc-inner" href="#channelpipeline">ChannelPipeline</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2068"><a class="md-toc-inner" href="#channelpipeline内部结构">ChannelPipeline内部结构</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2074"><a class="md-toc-inner" href="#channelhandler接口设计">ChannelHandler接口设计</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2110"><a class="md-toc-inner" href="#channelpipeline事件传播机制">ChannelPipeline事件传播机制</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2122"><a class="md-toc-inner" href="#channelpipeline异常传播机制">ChannelPipeline异常传播机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2130"><a class="md-toc-inner" href="#定时器timertask">定时器TimerTask</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2132"><a class="md-toc-inner" href="#时间轮hashedwheeltimer">时间轮HashedWheelTimer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2199"><a class="md-toc-inner" href="#无锁队列mpsc-queue">无锁队列mpsc queue</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2201"><a class="md-toc-inner" href="#fastthreadlocal">FastThreadLocal</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2203"><a class="md-toc-inner" href="#bytebuf-1">ByteBuf</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2205"><a class="md-toc-inner" href="#编解码协议">编解码协议</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2209"><a class="md-toc-inner" href="#拆包粘包">拆包粘包</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2223"><a class="md-toc-inner" href="#核心流程-2">核心流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2224"><a class="md-toc-inner" href="#服务端启动流程">服务端启动流程</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2234"><a class="md-toc-inner" href="#配置线程池">配置线程池</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2242"><a class="md-toc-inner" href="#channel-初始化">Channel 初始化</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2278"><a class="md-toc-inner" href="#端口绑定">端口绑定</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2285"><a class="md-toc-inner" href="#netty流程">Netty流程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2290"><a class="md-toc-inner" href="#线程模型-2">线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2292"><a class="md-toc-inner" href="#单线程reactor线程模型">单线程Reactor线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2297"><a class="md-toc-inner" href="#多线程reactor线程模型">多线程Reactor线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2301"><a class="md-toc-inner" href="#混合型reactor线程模型">混合型Reactor线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2310"><a class="md-toc-inner" href="#netty-reactor线程模型">Netty-Reactor线程模型</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2325"><a class="md-toc-inner" href="#bytebuf-2">ByteBuf</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2326"><a class="md-toc-inner" href="#工作流程-2">工作流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2343"><a class="md-toc-inner" href="#使用模式">使用模式</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2345"><a class="md-toc-inner" href="#堆缓冲区模式heap-buffer">堆缓冲区模式(Heap Buffer)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2354"><a class="md-toc-inner" href="#直接缓冲区模式direct-buffer">直接缓冲区模式(Direct Buffer)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2363"><a class="md-toc-inner" href="#复合缓冲区模式composite-buffer">复合缓冲区模式(Composite Buffer)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2374"><a class="md-toc-inner" href="#字节级操作">字节级操作</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2375"><a class="md-toc-inner" href="#随机访问索引">随机访问索引</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2384"><a class="md-toc-inner" href="#顺序访问索引">顺序访问索引</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2388"><a class="md-toc-inner" href="#可丢弃字节区域">可丢弃字节区域</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2396"><a class="md-toc-inner" href="#可读字节区域">可读字节区域</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2399"><a class="md-toc-inner" href="#可写字节区域">可写字节区域</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2402"><a class="md-toc-inner" href="#索引管理">索引管理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2415"><a class="md-toc-inner" href="#查找操作indexof">查找操作(indexOf)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2424"><a class="md-toc-inner" href="#派生缓冲------视图">派生缓冲——视图</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2453"><a class="md-toc-inner" href="#读写操作">读/写操作</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2464"><a class="md-toc-inner" href="#更多操作">更多操作</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2473"><a class="md-toc-inner" href="#bytebuf分配">ByteBuf分配</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2475"><a class="md-toc-inner" href="#按序分配bytebufallocator接口">按序分配：ByteBufAllocator接口</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2494"><a class="md-toc-inner" href="#unpooled缓冲区------非池化">Unpooled缓冲区——非池化</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2506"><a class="md-toc-inner" href="#bytebufutil类">ByteBufUtil类</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2514"><a class="md-toc-inner" href="#引用计数">引用计数</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2531"><a class="md-toc-inner" href="#zero-copy">Zero-Copy</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2542"><a class="md-toc-inner" href="#零拷贝操作">零拷贝操作</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2543"><a class="md-toc-inner" href="#通过compositebytebuf实现零拷贝">通过CompositeByteBuf实现零拷贝</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2547"><a class="md-toc-inner" href="#通过wrap操作实现零拷贝">通过wrap操作实现零拷贝</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2550"><a class="md-toc-inner" href="#通过slice操作实现零拷贝">通过slice操作实现零拷贝</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2557"><a class="md-toc-inner" href="#通过fileregion实现零拷贝">通过FileRegion实现零拷贝</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2560"><a class="md-toc-inner" href="#传统io的流程">传统IO的流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2573"><a class="md-toc-inner" href="#零拷贝整体流程图">零拷贝整体流程图</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2577"><a class="md-toc-inner" href="#tcp粘包拆包">TCP粘包拆包</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2578"><a class="md-toc-inner" href="#粘包拆包图解">粘包拆包图解</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2593"><a class="md-toc-inner" href="#产生原因-1">产生原因</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2601"><a class="md-toc-inner" href="#解决方案-1">解决方案</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2602"><a class="md-toc-inner" href="#固定长度">固定长度</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2609"><a class="md-toc-inner" href="#指定分隔符">指定分隔符</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2618"><a class="md-toc-inner" href="#数据包长度字段">数据包长度字段</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2629"><a class="md-toc-inner" href="#自定义粘包拆包器">自定义粘包拆包器</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2637"><a class="md-toc-inner" href="#高性能">高性能</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2650"><a class="md-toc-inner" href="#操作系统调优">操作系统调优</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2651"><a class="md-toc-inner" href="#文件描述符">文件描述符</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2666"><a class="md-toc-inner" href="#tcpip相关参数">TCP/IP相关参数</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2672"><a class="md-toc-inner" href="#多网卡队列和软中断">多网卡队列和软中断</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2686"><a class="md-toc-inner" href="#netty性能调优">Netty性能调优</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2687"><a class="md-toc-inner" href="#设置合理的线程数">设置合理的线程数</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2714"><a class="md-toc-inner" href="#心跳检测优化">心跳检测优化</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2772"><a class="md-toc-inner" href="#接收和发送缓冲区调优">接收和发送缓冲区调优</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2786"><a class="md-toc-inner" href="#合理使用内存池">合理使用内存池</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2793"><a class="md-toc-inner" href="#防止io线程被意外阻塞">防止I/O线程被意外阻塞</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2799"><a class="md-toc-inner" href="#io线程与业务线程分离">I/O线程与业务线程分离</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2811"><a class="md-toc-inner" href="#服务端并发连接数流控">服务端并发连接数流控</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2814"><a class="md-toc-inner" href="#案例分析">案例分析</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2815"><a class="md-toc-inner" href="#疑似内存泄漏">疑似内存泄漏</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2821"><a class="md-toc-inner" href="#当心closewait">当心CLOSE_WAIT</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n2839"><a class="md-toc-inner" href="#rabbitmq">RabbitMQ</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2840"><a class="md-toc-inner" href="#模式介绍">模式介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2843"><a class="md-toc-inner" href="#简单模式与工作队列模式">简单模式与工作队列模式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2854"><a class="md-toc-inner" href="#发布订阅路由与主题模式">发布/订阅、路由与主题模式</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n2870"><a class="md-toc-inner" href="#dubbo">Dubbo</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2893"><a class="md-toc-inner" href="#rpc">RPC</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2896"><a class="md-toc-inner" href="#框架设计">框架设计</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2897"><a class="md-toc-inner" href="#dubbo-简介">Dubbo 简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2933"><a class="md-toc-inner" href="#dubbo框架分层">Dubbo框架分层</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n2970"><a class="md-toc-inner" href="#spi机制">SPI机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2972"><a class="md-toc-inner" href="#spi-含义">SPI 含义</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2975"><a class="md-toc-inner" href="#java-spi缺点">Java SPI缺点</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2984"><a class="md-toc-inner" href="#dubbo-spi-2">Dubbo SPI</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2996"><a class="md-toc-inner" href="#dubbo-spi源码追踪">Dubbo SPI源码追踪</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n2999"><a class="md-toc-inner" href="#injectextension--ioc">injectExtension  IOC</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3002"><a class="md-toc-inner" href="#wrapperclass-aop">WrapperClass AOP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3005"><a class="md-toc-inner" href="#activate">Activate</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3008"><a class="md-toc-inner" href="#adaptive自适应扩展">Adaptive自适应扩展</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3013"><a class="md-toc-inner" href="#adaptive注解在类上">Adaptive注解在类上</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3016"><a class="md-toc-inner" href="#adaptive注解在方法上">Adaptive注解在方法上</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3030"><a class="md-toc-inner" href="#服务暴露流程">服务暴露流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3031"><a class="md-toc-inner" href="#服务暴露总览">服务暴露总览</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3061"><a class="md-toc-inner" href="#服务暴露源码追踪">服务暴露源码追踪</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3074"><a class="md-toc-inner" href="#服务引用流程">服务引用流程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3115"><a class="md-toc-inner" href="#调用整体流程">调用整体流程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3151"><a class="md-toc-inner" href="#集群容错负载均衡">集群容错负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3162"><a class="md-toc-inner" href="#集群容错">集群容错</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3202"><a class="md-toc-inner" href="#智能容错之负载均衡">智能容错之负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3215"><a class="md-toc-inner" href="#智能容错之服务目录">智能容错之服务目录</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3225"><a class="md-toc-inner" href="#智能容错之服务路由">智能容错之服务路由</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3232"><a class="md-toc-inner" href="#设计rpc">设计RPC</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3250"><a class="md-toc-inner" href="#nacos">Nacos</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3251"><a class="md-toc-inner" href="#基本架构">基本架构</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3253"><a class="md-toc-inner" href="#服务-service">服务 (Service)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3256"><a class="md-toc-inner" href="#服务注册中心-service-registry">服务注册中心 (Service Registry)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3259"><a class="md-toc-inner" href="#服务元数据-service-metadata">服务元数据 (Service Metadata)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3262"><a class="md-toc-inner" href="#服务提供方-service-provider">服务提供方 (Service Provider)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3265"><a class="md-toc-inner" href="#服务消费方-service-consumer">服务消费方 (Service Consumer)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3268"><a class="md-toc-inner" href="#配置-configuration">配置 (Configuration)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3271"><a class="md-toc-inner" href="#配置管理-configuration-management">配置管理 (Configuration Management)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3274"><a class="md-toc-inner" href="#名字服务-naming-service">名字服务 (Naming Service)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3277"><a class="md-toc-inner" href="#配置服务-configuration-service">配置服务 (Configuration Service)</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3280"><a class="md-toc-inner" href="#逻辑架构">逻辑架构</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3342"><a class="md-toc-inner" href="#功能特性">功能特性</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3354"><a class="md-toc-inner" href="#数据模型-2">数据模型</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3358"><a class="md-toc-inner" href="#nacos-sdk类视图">Nacos-SDK类视图</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3361"><a class="md-toc-inner" href="#配置领域模型">配置领域模型</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3365"><a class="md-toc-inner" href="#安装部署-1">安装部署</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3366"><a class="md-toc-inner" href="#下载源码或者安装包">下载源码或者安装包</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3373"><a class="md-toc-inner" href="#启动服务器">启动服务器</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3383"><a class="md-toc-inner" href="#服务测试">服务测试</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3393"><a class="md-toc-inner" href="#关闭服务器">关闭服务器</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3400"><a class="md-toc-inner" href="#开源案例">开源案例</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3401"><a class="md-toc-inner" href="#spring-boot">Spring Boot</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3402"><a class="md-toc-inner" href="#启动配置管理-1">启动配置管理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3418"><a class="md-toc-inner" href="#启动服务发现-1">启动服务发现</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3433"><a class="md-toc-inner" href="#spring-cloud">Spring Cloud</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3434"><a class="md-toc-inner" href="#启动配置管理-2">启动配置管理</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n3460"><a class="md-toc-inner" href="#启动服务发现-2">启动服务发现</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3478"><a class="md-toc-inner" href="#sentinel">Sentinel</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3490"><a class="md-toc-inner" href="#主要特性">主要特性</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3494"><a class="md-toc-inner" href="#开源生态">开源生态</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3504"><a class="md-toc-inner" href="#quick-start">Quick Start</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3505"><a class="md-toc-inner" href="#手动接入sentinel以及控制台">手动接入Sentinel以及控制台</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3531"><a class="md-toc-inner" href="#influxdb">Influxdb</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3533"><a class="md-toc-inner" href="#重要特性">重要特性</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3546"><a class="md-toc-inner" href="#存储引擎">存储引擎</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3561"><a class="md-toc-inner" href="#lsm">LSM</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3572"><a class="md-toc-inner" href="#tsm">TSM</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3582"><a class="md-toc-inner" href="#系统架构">系统架构</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3592"><a class="md-toc-inner" href="#spring-1">Spring</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3622"><a class="md-toc-inner" href="#相关概念">相关概念</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3624"><a class="md-toc-inner" href="#spring-2">Spring</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3627"><a class="md-toc-inner" href="#springmvc">SpringMVC</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3632"><a class="md-toc-inner" href="#springboot-1">SpringBoot</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3649"><a class="md-toc-inner" href="#spring原理">Spring原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3650"><a class="md-toc-inner" href="#核心组件">核心组件</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3653"><a class="md-toc-inner" href="#spring常用模块">Spring常用模块</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3672"><a class="md-toc-inner" href="#spring主要包">Spring主要包</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3675"><a class="md-toc-inner" href="#spring常用注解">Spring常用注解</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3678"><a class="md-toc-inner" href="#ioc-1">IoC</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3683"><a class="md-toc-inner" href="#aop-1">AOP</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3686"><a class="md-toc-inner" href="#静态代理">静态代理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3688"><a class="md-toc-inner" href="#动态代理">动态代理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3708"><a class="md-toc-inner" href="#应用场景-1">应用场景</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3736"><a class="md-toc-inner" href="#过滤器filter）">过滤器（Filter）</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3746"><a class="md-toc-inner" href="#拦截器interceptor）">拦截器（Interceptor）</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3765"><a class="md-toc-inner" href="#handlerinterceptor">HandlerInterceptor</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3770"><a class="md-toc-inner" href="#methodinterceptor">MethodInterceptor</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3773"><a class="md-toc-inner" href="#spring流程">Spring流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3774"><a class="md-toc-inner" href="#spring容器启动流程">Spring容器启动流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3785"><a class="md-toc-inner" href="#springmvc流程">SpringMVC流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3824"><a class="md-toc-inner" href="#非拦截器http请求流程">非拦截器Http请求流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3828"><a class="md-toc-inner" href="#拦截器http请求流程">拦截器Http请求流程</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n3832"><a class="md-toc-inner" href="#springboot-2">SpringBoot</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3833"><a class="md-toc-inner" href="#mvc">MVC</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3834"><a class="md-toc-inner" href="#http请求处理流程">HTTP请求处理流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3835"><a class="md-toc-inner" href="#参数绑定">参数绑定</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3836"><a class="md-toc-inner" href="#过滤器拦截器aop执行顺序">过滤器、拦截器、AOP执行顺序</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3837"><a class="md-toc-inner" href="#ioc-2">IOC</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3838"><a class="md-toc-inner" href="#bean的加载过程">Bean的加载过程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3839"><a class="md-toc-inner" href="#bean实例化的过程">Bean实例化的过程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3840"><a class="md-toc-inner" href="#aop-2">AOP</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3842"><a class="md-toc-inner" href="#others">Others</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3844"><a class="md-toc-inner" href="#factorybean">FactoryBean</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3854"><a class="md-toc-inner" href="#import">@Import</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3856"><a class="md-toc-inner" href="#实现importselector接口">实现ImportSelector接口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3859"><a class="md-toc-inner" href="#实现importbeandefinitionregistrar接口">实现ImportBeanDefinitionRegistrar接口</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3862"><a class="md-toc-inner" href="#beanpostprocessor">BeanPostProcessor</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3899"><a class="md-toc-inner" href="#beanfactorypostprocessor">BeanFactoryPostProcessor</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3903"><a class="md-toc-inner" href="#spring-spi机制">Spring SPI机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3913"><a class="md-toc-inner" href="#自动装配">自动装配</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3914"><a class="md-toc-inner" href="#propertysourceloader">PropertySourceLoader</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3945"><a class="md-toc-inner" href="#applicationcontextinitializer">ApplicationContextInitializer</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3950"><a class="md-toc-inner" href="#environmentpostprocessor">EnvironmentPostProcessor</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3954"><a class="md-toc-inner" href="#applicationrunner和commandlinerunner">ApplicationRunner和CommandLineRunner</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3958"><a class="md-toc-inner" href="#spring-event-事件">Spring Event 事件</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3981"><a class="md-toc-inner" href="#applicationevent">ApplicationEvent</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3984"><a class="md-toc-inner" href="#applicationlistener">ApplicationListener</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3987"><a class="md-toc-inner" href="#applicationeventpublisher">ApplicationEventPublisher</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3992"><a class="md-toc-inner" href="#命名空间">命名空间</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n4013"><a class="md-toc-inner" href="#springcloud">SpringCloud</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4015"><a class="md-toc-inner" href="#eurake">Eurake</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4025"><a class="md-toc-inner" href="#eurka工作流程">Eurka工作流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4049"><a class="md-toc-inner" href="#eureka-server">Eureka Server</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4079"><a class="md-toc-inner" href="#eureka-client">Eureka Client</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4099"><a class="md-toc-inner" href="#eureka缓存机制">Eureka缓存机制</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4134"><a class="md-toc-inner" href="#常用配置-1">常用配置</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4142"><a class="md-toc-inner" href="#eureka集群原理">Eureka集群原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4169"><a class="md-toc-inner" href="#eureka一致性协议">Eureka一致性协议</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n4172"><a class="md-toc-inner" href="#消息广播">消息广播</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n4205"><a class="md-toc-inner" href="#崩溃恢复">崩溃恢复</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4216"><a class="md-toc-inner" href="#zuul">Zuul</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4233"><a class="md-toc-inner" href="#feign">Feign</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4243"><a class="md-toc-inner" href="#feign动态代理">Feign动态代理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4254"><a class="md-toc-inner" href="#基于feign实现负载均衡">基于Feign实现负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4260"><a class="md-toc-inner" href="#基于feign实现熔断">基于Feign实现熔断</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4264"><a class="md-toc-inner" href="#feign参数编码整体流程">Feign参数编码整体流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4276"><a class="md-toc-inner" href="#feign整体装配流程">Feign整体装配流程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4307"><a class="md-toc-inner" href="#其它">其它</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4323"><a class="md-toc-inner" href="#ribbon">Ribbon</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4330"><a class="md-toc-inner" href="#hystrix">Hystrix</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4337"><a class="md-toc-inner" href="#gateway">Gateway</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4341"><a class="md-toc-inner" href="#config">Config</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4345"><a class="md-toc-inner" href="#bus">Bus</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4349"><a class="md-toc-inner" href="#oauth2">OAuth2</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4353"><a class="md-toc-inner" href="#sleuth">Sleuth</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n4357"><a class="md-toc-inner" href="#mybatis">MyBatis</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4393"><a class="md-toc-inner" href="#mybatis架构">MyBatis架构</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4431"><a class="md-toc-inner" href="#mybatis流程">MyBatis流程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4434"><a class="md-toc-inner" href="#dao接口工作原理">Dao接口工作原理</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4438"><a class="md-toc-inner" href="#mybatis缓存">MyBatis缓存</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4441"><a class="md-toc-inner" href="#一级缓存">一级缓存</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4450"><a class="md-toc-inner" href="#二级缓存">二级缓存</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4464"><a class="md-toc-inner" href="#mybatis主要组件">MyBatis主要组件</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4466"><a class="md-toc-inner" href="#sqlsessionfactorybuilder">SqlSessionFactoryBuilder</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4474"><a class="md-toc-inner" href="#sqlsessionfactory">SqlSessionFactory</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4482"><a class="md-toc-inner" href="#sqlsession">SqlSession</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4486"><a class="md-toc-inner" href="#executor">Executor</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4491"><a class="md-toc-inner" href="#statementhandler">StatementHandler</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4501"><a class="md-toc-inner" href="#parameterhandler">ParameterHandler</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4504"><a class="md-toc-inner" href="#resultsethandler">ResultSetHandler</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4507"><a class="md-toc-inner" href="#typehandler">TypeHandler</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n4516"><a class="md-toc-inner" href="#nginx">Nginx</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4517"><a class="md-toc-inner" href="#nginx安装">Nginx安装</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4528"><a class="md-toc-inner" href="#运维命令-2">运维命令</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4530"><a class="md-toc-inner" href="#systemctl命令">systemctl命令</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4533"><a class="md-toc-inner" href="#nginx应用命令">Nginx应用命令</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4536"><a class="md-toc-inner" href="#配置规则">配置规则</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4539"><a class="md-toc-inner" href="#uri匹配">URI匹配</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4541"><a class="md-toc-inner" href="#upstream">upstream</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4546"><a class="md-toc-inner" href="#proxypass">proxy_pass</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4564"><a class="md-toc-inner" href="#应用场景-2">应用场景</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4565"><a class="md-toc-inner" href="#反向代理-1">反向代理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4568"><a class="md-toc-inner" href="#负载均衡-2">负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n4571"><a class="md-toc-inner" href="#hash算法">hash算法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n4575"><a class="md-toc-inner" href="#iphash">ip_hash</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n4579"><a class="md-toc-inner" href="#最少连接数算法">最少连接数算法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4583"><a class="md-toc-inner" href="#配置缓存">配置缓存</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4617"><a class="md-toc-inner" href="#https">HTTPS</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4621"><a class="md-toc-inner" href="#开启gzip压缩">开启gzip压缩</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4625"><a class="md-toc-inner" href="#常用配置-2">常用配置</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4626"><a class="md-toc-inner" href="#侦听端口">侦听端口</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4629"><a class="md-toc-inner" href="#访问日志">访问日志</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4632"><a class="md-toc-inner" href="#域名">域名</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4635"><a class="md-toc-inner" href="#静态资源">静态资源</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4638"><a class="md-toc-inner" href="#重定向">重定向</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4641"><a class="md-toc-inner" href="#反向代理-2">反向代理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4644"><a class="md-toc-inner" href="#负载均衡-3">负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4647"><a class="md-toc-inner" href="#ssl协议">SSL协议</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4650"><a class="md-toc-inner" href="#日志分析">日志分析</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n4653"><a class="md-toc-inner" href="#lvs">LVS</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4655"><a class="md-toc-inner" href="#工作模式">工作模式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4674"><a class="md-toc-inner" href="#nat模式网络地址转换">NAT模式(网络地址转换)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4726"><a class="md-toc-inner" href="#ip-tun模型ip隧道">IP TUN模型(IP隧道)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4771"><a class="md-toc-inner" href="#dr模式直接路由">DR模式(直接路由)</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4821"><a class="md-toc-inner" href="#full-nat模式">full NAT模式</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4865"><a class="md-toc-inner" href="#enat模式">ENAT模式</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4903"><a class="md-toc-inner" href="#调度算法">调度算法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4904"><a class="md-toc-inner" href="#静态调度算法">静态调度算法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4916"><a class="md-toc-inner" href="#动态调度算法">动态调度算法</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n4931"><a class="md-toc-inner" href="#常见问题分析">常见问题分析</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4932"><a class="md-toc-inner" href="#脑裂">脑裂</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4968"><a class="md-toc-inner" href="#负载不均">负载不均</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4982"><a class="md-toc-inner" href="#排错">排错</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n5010"><a class="md-toc-inner" href="#keepalived">Keepalived</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5013"><a class="md-toc-inner" href="#功能体系">功能体系</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5049"><a class="md-toc-inner" href="#脑裂问题">脑裂问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n5060"><a class="md-toc-inner" href="#产生原因-2">产生原因</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n5082"><a class="md-toc-inner" href="#解决方案-2">解决方案</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5094"><a class="md-toc-inner" href="#安装部署-2">安装部署</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n5131"><a class="md-toc-inner" href="#haproxy">HAProxy</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5134"><a class="md-toc-inner" href="#四层负载均衡">四层负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5139"><a class="md-toc-inner" href="#七层负载均衡">七层负载均衡</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5147"><a class="md-toc-inner" href="#负载均衡策略">负载均衡策略</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5173"><a class="md-toc-inner" href="#haproxy与lvs的区别">HAProxy与LVS的区别</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n5186"><a class="md-toc-inner" href="#安装配置">安装配置</a></span></p></div><h1 id='spi'><span>SPI</span></h1><p><span>SPI 全称为 Service Provider Interface，是一种服务发现机制。SPI 的本质是将接口实现类的全限定名，配置在文件中，并由服务加载器读取配置文件，加载实现类。这样可以在运行时，动态为接口替换实现类，正因为该特性，我们可以很容易的通过 SPI 机制为程序提供拓展功能。</span></p><p>&nbsp;</p><h2 id='java-spi'><span>Java SPI</span></h2><p><span>JDK 中 提供了一个 </span><code>SPI</code><span> 的功能，核心类是 </span><code>java.util.ServiceLoader</code><span>。其作用就是，可以通过类名获取在 </span><code>META-INF/services/</code><span> 下的多个配置实现文件。为了解决上面的扩展问题，现在我们在</span><code>META-INF/services/</code><span>下创建一个</span><code>com.github.yu120.test.SuperLoggerConfiguration</code><span>文件（没有后缀）。文件中只有一行代码，那就是我们默认的</span><code>com.github.yu120.test.XMLConfiguration</code><span>（注意，一个文件里也可以写多个实现，回车分隔）。然后通过 ServiceLoader 获取我们的 SPI 机制配置的实现类：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// META-INF/services/com.github.test.test.SuperLoggerConfiguration:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">com</span>.<span class="cm-variable">github</span>.<span class="cm-variable">yu120</span>.<span class="cm-variable">test</span>.<span class="cm-variable">XMLConfiguration</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ServiceLoader</span><span class="cm-operator">&lt;</span><span class="cm-variable">SuperLoggerConfiguration</span><span class="cm-operator">&gt;</span> <span class="cm-variable">serviceLoader</span> <span class="cm-operator">=</span> <span class="cm-variable">ServiceLoader</span>.<span class="cm-variable">load</span>(<span class="cm-variable">SuperLoggerConfiguration</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Iterator</span><span class="cm-operator">&lt;</span><span class="cm-variable">SuperLoggerConfiguration</span><span class="cm-operator">&gt;</span> <span class="cm-variable">iterator</span> <span class="cm-operator">=</span> <span class="cm-variable">serviceLoader</span>.<span class="cm-variable">iterator</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">SuperLoggerConfiguration</span> <span class="cm-variable">configuration</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">while</span>(<span class="cm-variable">iterator</span>.<span class="cm-variable">hasNext</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 加载并初始化实现类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">configuration</span> <span class="cm-operator">=</span> <span class="cm-variable">iterator</span>.<span class="cm-variable">next</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 对最后一个configuration类调用configure方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">configuration</span>.<span class="cm-variable">configure</span>(<span class="cm-variable">configFile</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p>&nbsp;</p><h2 id='dubbo-spi-1'><a href='https://github.com/apache/dubbo/tree/master/dubbo-common/src/main/java/org/apache/dubbo/common/extension'><span>Dubbo SPI</span></a></h2><p><span>Dubbo SPI 的相关逻辑被封装在了 ExtensionLoader类中，它的getExtensionLoader方法用于从缓存中获取与接口对应的ExtensionLoader，若缓存未命中，则创建一个新的实例。Dubbo SPI的核心思想其实很简单：</span></p><ul><li><span>通过配置文件，解耦拓展接口和拓展实现类</span></li><li><span>通过IOC自动注入依赖的拓展实现类对象</span></li><li><span>通过URL参数，在运行时确认真正的自定义拓展类对象</span></li></ul><p><span>Dubbo SPI 所需的配置文件需放置在 META-INF/dubbo 路径下，配置内容如下（以下demo来自dubbo官方文档）。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">optimusPrime </span>=<span class="cm-quote"> org.apache.spi.OptimusPrime</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">bumblebee </span>=<span class="cm-quote"> org.apache.spi.Bumblebee</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>与 Java SPI 实现类配置不同，Dubbo SPI 是通过键值对的方式进行配置，这样我们可以按需加载指定的实现类。另外在使用时还需要在接口上标注 @SPI 注解。</span></p><p>&nbsp;</p><h2 id='motan-spi'><a href='https://github.com/weibocom/motan/tree/master/motan-core/src/main/java/com/weibo/api/motan/core/extension'><span>Motan SPI</span></a></h2><p><span>Motan使用SPI机制来实现模块间的访问，基于接口和name来获取实现类，降低了模块间的耦合。</span></p><p><span>Motan的SPI的实现在 </span><code>motan-core/com/weibo/api/motan/core/extension</code><span> 中。组织结构如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="tex"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="tex"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">motan-core/com.weibo.api.motan.core.extension</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-Activation：SPI的扩展功能，例如过滤、排序</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-ActivationComparator：排序比较器</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-ExtensionLoader：核心，主要负责SPI的扫描和加载</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-Scope：模式枚举，单例、多例</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-Spi：注解，作用在接口上，表明这个接口的实现可以通过SPI的形式加载</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  |-SpiMeta：注解，作用在具体的SPI接口的实现类上，标注该扩展的名称</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p><h2 id='springboot-spi'><span>SpringBoot SPI</span></h2><p><span>Spring 的 SPI 配置文件是一个固定的文件 - </span><code>META-INF/spring.factories</code><span>，功能上和 JDK 的类似，每个接口可以有多个扩展实现，使用起来非常简单：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取所有factories文件中配置的LoggingSystemFactory</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">LoggingSystemFactory</span><span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">factories</span> <span class="cm-operator">=</span> <span class="cm-variable">SpringFactoriesLoader</span>.<span class="cm-variable">loadFactories</span>(<span class="cm-variable">LoggingSystemFactory</span>.<span class="cm-keyword">class</span>, <span class="cm-variable">classLoader</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><p><span>下面是一段 Spring Boot 中 spring.factories 的配置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Logging Systems</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.boot.logging.LoggingSystemFactory</span>=<span class="cm-quote">\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.logging.logback.LogbackLoggingSystem.Factory,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.logging.log4j2.Log4J2LoggingSystem.Factory</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># PropertySource Loaders</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.boot.env.PropertySourceLoader</span>=<span class="cm-quote">\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.env.YamlPropertySourceLoader</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p>&nbsp;</p><h1 id='redis'><span>Redis</span></h1><p><strong><span>Java类型所占字节数（或bit数）</span></strong></p><figure><table><thead><tr><th><span>类型</span></th><th><span>存储(byte)</span></th><th><span>bit数(bit)</span></th><th><span>取值范围</span></th></tr></thead><tbody><tr><td><span>int</span></td><td><span>4字节</span></td><td><span>4×8位</span></td><td><span>即 (-2)的31次方 ~ (2的31次方) - 1</span></td></tr><tr><td><span>short</span></td><td><span>2字节</span></td><td><span>2×8位</span></td><td><span>即 (-2)的15次方 ~ (2的15次方) - 1</span></td></tr><tr><td><span>long</span></td><td><span>8字节</span></td><td><span>8×8位</span></td><td><span>即 (-2)的63次方 ~ (2的63次方) - 1</span></td></tr><tr><td><span>byte</span></td><td><span>1字节</span></td><td><span>1×8位</span></td><td><span>即 (-2)的7次方 ~ (2的7次方) - 1，-128~127</span></td></tr><tr><td><span>float</span></td><td><span>4字节</span></td><td><span>4×8位</span></td><td><span>float 类型的数值有一个后缀 F（例如：3.14F）</span></td></tr><tr><td><span>double</span></td><td><span>8字节</span></td><td><span>8×8位</span></td><td><span>没有后缀 F 的浮点数值（例如：3.14）默认为 double</span></td></tr><tr><td><span>boolean</span></td><td><span>1字节</span></td><td><span>1×8位</span></td><td><span>true、false</span></td></tr><tr><td><span>char</span></td><td><span>2字节</span></td><td><span>2×8位</span></td><td><span>Java中，只要是字符，不管是数字还是英文还是汉字，都占两个字节</span></td></tr></tbody></table></figure><p><strong><span>注意</span></strong><span>：</span></p><ul><li><span>英文的数字、字母或符号：1个字符 = 1个字节数</span></li><li><span>中文的数字、字母或符号：1个字符 = 2个字节数</span></li><li><span>计算机的基本单位：bit 。一个bit代表一个0或1，1个字节是8个bit</span></li><li><span>1TB=1024GB，1GB=1024MB，1MB=1024KB，1KB=1024B（字节，byte），1B=8b（bit，位）</span></li></ul><p>&nbsp;</p><h2 id='线程模型-1'><span>线程模型</span></h2><p><img src="images/Middleware/Redis线程模型.png" referrerpolicy="no-referrer" alt="Redis线程模型"></p><p><span>Redis内部使用文件事件处理器</span><code>File Event Handler</code><span>，这个文件事件处理器是单线程的所以Redis才叫做单线程的模型。它采用</span><code>I/O</code><span>多路复用机制同时监听多个</span><code>Socket</code><span>，将产生事件的</span><code>Socket</code><span>压入到内存队列中，事件分派器根据</span><code>Socket</code><span>上的事件类型来选择对应的事件处理器来进行处理。文件事件处理器包含5个部分：</span></p><ul><li><strong><span>多个Socket</span></strong></li><li><strong><span>I/O多路复用程序</span></strong></li><li><strong><span>Scocket队列</span></strong></li><li><strong><span>文件事件分派器</span></strong></li><li><strong><span>事件处理器</span></strong><span>（连接应答处理器、命令请求处理器、命令回复处理器）</span></li></ul><p><img src="images/Middleware/Redis文件事件处理器.png" referrerpolicy="no-referrer" alt="Redis文件事件处理器"></p><p>&nbsp;</p><h3 id='通信流程'><span>通信流程</span></h3><p><span>客户端与redis的一次通信过程：</span></p><p><img src="images/Middleware/Redis请求过程.png" referrerpolicy="no-referrer" alt="Redis请求过程"></p><ul><li><p><strong><span>请求类型1</span></strong><span>：</span><code>客户端发起建立连接的请求</code></p><ul><li><span>服务端会产生一个</span><code>AE_READABLE</code><span>事件，</span><code>I/O</code><span>多路复用程序接收到</span><code>server socket</code><span>事件后，将该</span><code>socket</code><span>压入队列中</span></li><li><span>文件事件分派器从队列中获取</span><code>socket</code><span>，交给连接应答处理器，创建一个可以和客户端交流的</span><code>socket01</code></li><li><span>将</span><code>socket01</code><span>的</span><code>AE_READABLE</code><span>事件与命令请求处理器关联</span></li></ul></li><li><p><strong><span>请求类型2</span></strong><span>：</span><code>客户端发起set key value请求</code></p><ul><li><code>socket01</code><span>产生</span><code>AE_READABLE</code><span>事件，</span><code>socket01</code><span>压入队列</span></li><li><span>将获取到的</span><code>socket01</code><span>与命令请求处理器关联</span></li><li><span>命令请求处理器读取</span><code>socket01</code><span>中的</span><code>key value</code><span>，并在内存中完成对应的设置</span></li><li><span>将</span><code>socket01</code><span>的</span><code>AE_WRITABLE</code><span>事件与命令回复处理器关联</span></li></ul></li><li><p><strong><span>请求类型3</span></strong><span>：</span><code>服务端返回结果</code></p><ul><li><code>Redis</code><span>中的</span><code>socket01</code><span>会产生一个</span><code>AE_WRITABLE</code><span>事件，压入到队列中</span></li><li><span>将获取到的</span><code>socket01</code><span>与命令回复处理器关联</span></li><li><span>回复处理器对</span><code>socket01</code><span>输入操作结果，如</span><code>ok</code><span>。之后解除</span><code>socket01</code><span>的</span><code>AE_WRITABLE</code><span>事件与命令回复处理器的关联</span></li></ul></li></ul><p>&nbsp;</p><h3 id='文件事件处理器'><span>文件事件处理器</span></h3><ul><li><strong><span>基于 Reactor 模式开发了自己的网络事件处理器（文件事件处理器，file event handler）</span></strong></li><li><span>文件事件处理器 </span><strong><span>使用 I/O 多路复用（multiplexing）程序来同时监听多个套接字</span></strong><span>，并根据套接字目前执行的任务来为套接字关联不同的事件处理器</span></li><li><span>当被监听的套接字准备好执行连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作时， 与操作相对应的文件事件就会产生， 这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件</span></li><li><span>文件事件处理器以单线程方式运行， 但通过使用 I/O 多路复用程序来监听多个套接字， 文件事件处理器既实现了高性能的网络通信模型， 又可以很好地与 redis 服务器中其他同样以单线程方式运行的模块进行对接， 这保持了 Redis 内部单线程设计的简单性</span></li></ul><p>&nbsp;</p><h3 id='io多路复用'><span>I/O多路复用</span></h3><p><span>I/O多路复用的I/O是指网络I/O，多路指多个TCP连接(即socket或者channel），复用指复用一个或几个线程。意思说一个或一组线程处理多个TCP连接。最大优势是减少系统开销小，不必创建过多的进程/线程，也不必维护这些进程/线程。</span>
<span>I/O多路复用使用两个系统调用(select/poll/epoll和recvfrom)，blocking I/O只调用了recvfrom；select/poll/epoll 核心是可以同时处理多个connection，而不是更快，所以连接数不高的话，性能不一定比多线程+阻塞I/O好,多路复用模型中，每一个socket，设置为non-blocking,阻塞是被select这个函数block，而不是被socket阻塞的。</span></p><p>&nbsp;</p><p><strong><span>select机制</span></strong>
<strong><span>基本原理</span></strong>
<span>客户端操作服务器时就会产生这三种文件描述符(简称fd)：writefds(写)、readfds(读)、和exceptfds(异常)。select会阻塞住监视3类文件描述符，等有数据、可读、可写、出异常 或超时、就会返回；返回后通过遍历fdset整个数组来找到就绪的描述符fd，然后进行对应的I/O操作。</span>
<strong><span>优点</span></strong></p><ul><li><span>几乎在所有的平台上支持，跨平台支持性好</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>由于是采用轮询方式全盘扫描，会随着文件描述符FD数量增多而性能下降</span></li><li><span>每次调用 select()，需要把 fd 集合从用户态拷贝到内核态，并进行遍历(消息传递都是从内核到用户空间)</span></li><li><span>默认单个进程打开的FD有限制是1024个，可修改宏定义，但是效率仍然慢。</span></li></ul><p>&nbsp;</p><p><strong><span>poll机制</span></strong>
<span>基本原理与select一致，也是轮询+遍历；唯一的区别就是poll没有最大文件描述符限制（使用链表的方式存储fd）。</span></p><p>&nbsp;</p><p><strong><span>epoll机制</span></strong>
<strong><span>基本原理</span></strong>
<span>没有fd个数限制，用户态拷贝到内核态只需要一次，使用时间通知机制来触发。通过epoll_ctl注册fd，一旦fd就绪就会通过callback回调机制来激活对应fd，进行相关的io操作。epoll之所以高性能是得益于它的三个函数：</span></p><ul><li><code>epoll_create()</code><span>：系统启动时，在Linux内核里面申请一个B+树结构文件系统，返回epoll对象，也是一个fd</span></li><li><code>epoll_ctl()</code><span>：每新建一个连接，都通过该函数操作epoll对象，在这个对象里面修改添加删除对应的链接fd, 绑定一个callback函数</span></li><li><code>epoll_wait()</code><span>：轮训所有的callback集合，并完成对应的IO操作</span></li></ul><p><strong><span>优点</span></strong></p><ul><li><span>没fd这个限制，所支持的FD上限是操作系统的最大文件句柄数，1G内存大概支持10万个句柄</span></li><li><span>效率提高，使用回调通知而不是轮询的方式，不会随着FD数目的增加效率下降</span></li><li><span>内核和用户空间mmap同一块内存实现(mmap是一种内存映射文件方法，即将一个文件或其它对象映射到进程的地址空间)</span></li></ul><p>&nbsp;</p><p><span>例子：100万个连接，里面有1万个连接是活跃，我们可以对比 select、poll、epoll 的性能表现：</span></p><ul><li><code>select</code><span>：不修改宏定义默认是1024，则需要100w/1024=977个进程才可以支持 100万连接，会使得CPU性能特别的差</span></li><li><code>poll</code><span>：  没有最大文件描述符限制，100万个链接则需要100w个fd，遍历都响应不过来了，还有空间的拷贝消耗大量资源</span></li><li><code>epoll</code><span>:  请求进来时就创建fd并绑定一个callback，主需要遍历1w个活跃连接的callback即可，即高效又不用内存拷贝</span></li></ul><p>&nbsp;</p><h3 id='执行效率高'><span>执行效率高</span></h3><p><strong><span>Redis是单线程模型为什么效率还这么高？</span></strong></p><ul><li><code>纯内存操作</code><span>：数据存放在内存中，内存的响应时间大约是100纳秒，这是Redis每秒万亿级别访问的重要基础</span></li><li><code>非阻塞的I/O多路复用机制</code><span>：Redis采用epoll做为I/O多路复用技术的实现，再加上Redis自身的事件处理模型将epoll中的连接，读写，关闭都转换为了时间，不在I/O上浪费过多的时间</span></li><li><code>C语言实现</code><span>：距离操作系统更近，执行速度会更快</span></li><li><code>单线程避免切换开销</code><span>：单线程避免了多线程上下文切换的时间开销，预防了多线程可能产生的竞争问题</span></li></ul><p>&nbsp;</p><h2 id='数据类型'><span>数据类型</span></h2><p><span>在 Redis 中，常用的 5 种数据类型和应用场景如下：</span></p><ul><li><strong><span>String：</span></strong><span> 缓存、计数器、分布式锁等</span></li><li><strong><span>List：</span></strong><span> 链表、队列、微博关注人时间轴列表等</span></li><li><strong><span>Hash：</span></strong><span> 用户信息、Hash 表等</span></li><li><strong><span>Set：</span></strong><span> 去重、赞、踩、共同好友等</span></li><li><strong><span>Zset：</span></strong><span> 访问量排行榜、点击量排行榜等</span></li></ul><p><img src="images/Middleware/Redis-基本数据类型.png" referrerpolicy="no-referrer" alt="Redis-基本数据类型"></p><h3 id='string字符串'><span>String(字符串)</span></h3><p><span>String 数据结构是简单的 key-value 类型，value 不仅可以是 String，也可以是数字（当数字类型用 Long 可以表示的时候encoding 就是整型，其他都存储在 sdshdr 当做字符串）。</span></p><p>&nbsp;</p><h3 id='hash字典'><span>Hash(字典)</span></h3><p><img src="images/Middleware/Redis-Hash.png" referrerpolicy="no-referrer" alt="Redis-Hash"></p><p><span>在 Memcached 中，我们经常将一些结构化的信息打包成 hashmap，在客户端序列化后存储为一个字符串的值（一般是 JSON 格式），比如用户的昵称、年龄、性别、积分等。这时候在需要修改其中某一项时，通常需要将字符串（JSON）取出来，然后进行反序列化，修改某一项的值，再序列化成字符串（JSON）存储回去。简单修改一个属性就干这么多事情，消耗必定是很大的，也不适用于一些可能并发操作的场合（比如两个并发的操作都需要修改积分）。而 Redis 的 Hash 结构可以使你像在数据库中 Update 一个属性一样只修改某一项属性值。</span></p><ul><li><span>存储、读取、修改用户属性</span></li></ul><p><strong><span>实战场景</span></strong></p><ul><li><span>缓存： 经典使用场景，把常用信息，字符串，图片或者视频等信息放到redis中，redis作为缓存层，mysql做持久化层，降低mysql的读写压力</span></li><li><span>计数器：redis是单线程模型，一个命令执行完才会执行下一个，同时数据可以一步落地到其他的数据源</span></li><li><span>session：常见方案spring session + redis实现session共享</span></li></ul><p>&nbsp;</p><h3 id='list列表'><span>List(列表)</span></h3><p><span>List 说白了就是链表（redis 使用双端链表实现的 List），相信学过数据结构知识的人都应该能理解其结构。使用 List 结构，我们可以轻松地实现最新消息排行等功能（比如新浪微博的 TimeLine ）。List 的另一个应用就是消息队列，可以利用 List 的 *PUSH 操作，将任务存在 List 中，然后工作线程再用 POP 操作将任务取出进行执行。Redis 还提供了操作 List 中某一段元素的 API，你可以直接查询，删除 List 中某一段的元素。</span></p><ul><li><span>微博 TimeLine</span></li><li><span>消息队列</span></li></ul><p><img src="images/Middleware/Redis-List.png" referrerpolicy="no-referrer" alt="Redis-List"></p><p><span>使用列表的技巧</span></p><ul><li><span>lpush+lpop=Stack(栈)</span></li><li><span>lpush+rpop=Queue（队列）</span></li><li><span>lpush+ltrim=Capped Collection（有限集合）</span></li><li><span>lpush+brpop=Message Queue（消息队列）</span></li></ul><p><span>实战场景：</span></p><ul><li><span>timeline：例如微博的时间轴，有人发布微博，用lpush加入时间轴，展示新的列表信息。</span></li></ul><p>&nbsp;</p><h3 id='set集合'><span>Set(集合)</span></h3><p><img src="images/Middleware/Redis-Set.png" referrerpolicy="no-referrer" alt="Redis-Set"></p><p><span>Set 就是一个集合，集合的概念就是一堆不重复值的组合。利用 Redis 提供的 Set 数据结构，可以存储一些集合性的数据。比如在微博应用中，可以将一个用户所有的关注人存在一个集合中，将其所有粉丝存在一个集合。因为 Redis 非常人性化的为集合提供了求交集、并集、差集等操作，那么就可以非常方便的实现如共同关注、共同喜好、二度好友等功能，对上面的所有集合操作，你还可以使用不同的命令选择将结果返回给客户端还是存集到一个新的集合中。</span></p><ul><li><span>共同好友、二度好友</span></li><li><span>利用唯一性，可以统计访问网站的所有独立 IP</span></li><li><span>好友推荐的时候，根据 tag 求交集，大于某个 threshold 就可以推荐</span></li></ul><p><span>实战场景;</span></p><ul><li><span>标签（tag）,给用户添加标签，或者用户给消息添加标签，这样有同一标签或者类似标签的可以给推荐关注的事或者关注的人</span></li><li><span>点赞，或点踩，收藏等，可以放到set中实现</span></li></ul><p>&nbsp;</p><h3 id='sorted-set有序集合'><span>Sorted Set(有序集合)</span></h3><p><img src="images/Middleware/Redis-SortedSet.png" referrerpolicy="no-referrer" alt="Redis-SortedSet"></p><p><span>和Sets相比，Sorted Sets是将 Set 中的元素增加了一个权重参数 score，使得集合中的元素能够按 score 进行有序排列，比如一个存储全班同学成绩的 Sorted Sets，其集合 value 可以是同学的学号，而 score 就可以是其考试得分，这样在数据插入集合的时候，就已经进行了天然的排序。另外还可以用 Sorted Sets 来做带权重的队列，比如普通消息的 score 为1，重要消息的 score 为2，然后工作线程可以选择按 score 的倒序来获取工作任务。让重要的任务优先执行。</span></p><ul><li><span>带有权重的元素，比如一个游戏的用户得分排行榜</span></li><li><span>比较复杂的数据结构，一般用到的场景不算太多</span></li></ul><p><span>实战场景：</span></p><ul><li><span>排行榜：有序集合经典使用场景。例如小说视频等网站需要对用户上传的小说视频做排行榜，榜单可以按照用户关注数，更新时间，字数等打分，做排行。</span></li></ul><p>&nbsp;</p><h2 id='特殊数据结构'><span>特殊数据结构</span></h2><h3 id='hyperloglog基数统计'><span>HyperLogLog(基数统计)</span></h3><p><span>HyperLogLog 主要的应用场景就是进行基数统计。实际上不会存储每个元素的值，它使用的是概率算法，通过存储元素的hash值的第一个1的位置，来计算元素数量。HyperLogLog 可用极小空间完成独立数统计。命令如下：</span></p><figure><table><thead><tr><th><span>命令</span></th><th><span>作用</span></th></tr></thead><tbody><tr><td><span>pfadd key element ...</span></td><td><span>将所有元素添加到key中</span></td></tr><tr><td><span>pfcount key</span></td><td><span>统计key的估算值(不精确)</span></td></tr><tr><td><span>pgmerge new_key key1 key2 ...</span></td><td><span>合并key至新key</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>应用案例</span></strong></p><p><span>如何统计 Google 主页面每天被多少个不同的账户访问过？</span></p><p><span>对于 Google 这种访问量巨大的网页而言，其实统计出有十亿的访问量或十亿零十万的访问量其实是没有太多的区别的，因此，在这种业务场景下，为了节省成本，其实可以只计算出一个大概的值，而没有必要计算出精准的值。</span></p><p><span>对于上面的场景，可以使用</span><code>HashMap</code><span>、</span><code>BitMap</code><span>和</span><code>HyperLogLog</code><span>来解决。对于这三种解决方案，这边做下对比：</span></p><ul><li><code>HashMap</code><span>：算法简单，统计精度高，对于少量数据建议使用，但是对于大量的数据会占用很大内存空间</span></li><li><code>BitMap</code><span>：位图算法，具体内容可以参考我的这篇，统计精度高，虽然内存占用要比</span><code>HashMap</code><span>少，但是对于大量数据还是会占用较大内存</span></li><li><code>HyperLogLog</code><span>：存在一定误差，占用内存少，稳定占用 12k 左右内存，可以统计 2^64 个元素，对于上面举例的应用场景，建议使用</span></li></ul><p>&nbsp;</p><h3 id='geo地理空间信息'><span>Geo(地理空间信息)</span></h3><p><span>Geo主要用于存储地理位置信息，并对存储的信息进行操作（添加、获取、计算两位置之间距离、获取指定范围内位置集合、获取某地点指定范围内集合）。Redis支持将Geo信息存储到有序集合(zset)中，再通过Geohash算法进行填充。命令如下：</span></p><figure><table><thead><tr><th><span>命令</span></th><th><span>作用</span></th></tr></thead><tbody><tr><td><span>geoadd key latitude longitude member</span></td><td><span>添加成员位置(纬度、经度、名称)到key中</span></td></tr><tr><td><span>geopos key member ...</span></td><td><span>获取成员geo坐标</span></td></tr><tr><td><span>geodist key member1 member2 [unit]</span></td><td><span>计算成员位置间距离。若两个位置之间的其中一个不存在， 那返回空值</span></td></tr><tr><td><span>georadius</span></td><td><span>基于经纬度坐标范围查询</span></td></tr><tr><td><span>georadiusbymember</span></td><td><span>基于成员位置范围查询</span></td></tr><tr><td><span>geohash</span></td><td><span>计算经纬度hash</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>GEORADIUS</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count]</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。范围可以使用以下其中一个单位：</span></p><ul><li><strong><span>m</span></strong><span> 表示单位为米</span></li><li><strong><span>km</span></strong><span> 表示单位为千米</span></li><li><strong><span>mi</span></strong><span> 表示单位为英里</span></li><li><strong><span>ft</span></strong><span> 表示单位为英尺</span></li></ul><p><span>在给定以下可选项时， 命令会返回额外的信息：</span></p><ul><li><code>WITHDIST</code><span>: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离单位和范围单位保持一致</span></li><li><code>WITHCOORD</code><span>: 将位置元素的经度和维度也一并返回</span></li><li><code>WITHHASH</code><span>: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大</span></li></ul><p><span>命令默认返回未排序的位置元素。 通过以下两个参数， 用户可以指定被返回位置元素的排序方式：</span></p><ul><li><code>ASC</code><span>: 根据中心的位置， 按照从近到远的方式返回位置元素</span></li><li><code>DESC</code><span>: 根据中心的位置， 按照从远到近的方式返回位置元素</span></li></ul><p><span>在默认情况下， GEORADIUS 命令会返回所有匹配的位置元素。 虽然用户可以使用 </span><strong><span>COUNT </span><code>&lt;count&gt;</code></strong><span> 选项去获取前 N 个匹配元素， 但是因为命令在内部可能会需要对所有被匹配的元素进行处理， 所以在对一个非常大的区域进行搜索时， 即使只使用 </span><code>COUNT</code><span> 选项去获取少量元素， 命令的执行速度也可能会非常慢。 但是从另一方面来说， 使用 </span><code>COUNT</code><span> 选项去减少需要返回的元素数量， 对于减少带宽来说仍然是非常有用的。</span></p><p>&nbsp;</p><h3 id='pubsub发布订阅'><span>Pub/Sub(发布订阅)</span></h3><p><span>发布订阅类似于广播功能。redis发布订阅包括 发布者、订阅者、Channel。常用命令如下：</span></p><figure><table><thead><tr><th><span>命令</span></th><th><span>作用</span></th><th><span>时间复杂度</span></th></tr></thead><tbody><tr><td><span>subscribe channel</span></td><td><span>订阅一个频道</span></td><td><span>O(n)</span></td></tr><tr><td><span>unsubscribe channel ...</span></td><td><span>退订一个/多个频道</span></td><td><span>O(n)</span></td></tr><tr><td><span>publish channel msg</span></td><td><span>将信息发送到指定的频道</span></td><td><span>O(n+m)，n 是频道 channel 的订阅者数量, M 是使用模式订阅(subscribed patterns)的客户端的数量</span></td></tr><tr><td><span>pubsub CHANNELS</span></td><td><span>查看订阅与发布系统状态(多种子模式)</span></td><td><span>O(n)</span></td></tr><tr><td><span>psubscribe</span></td><td><span>订阅多个频道</span></td><td><span>O(n)</span></td></tr><tr><td><span>unsubscribe</span></td><td><span>退订多个频道</span></td><td><span>O(n)</span></td></tr></tbody></table></figure><p>&nbsp;</p><h3 id='bitmap位图'><span>Bitmap(位图)</span></h3><p><span>Bitmap就是位图，其实也就是字节数组（byte array），用一串连续的2进制数字（0或1）表示，每一位所在的位置为偏移(offset)，位图就是用每一个二进制位来存放或者标记某个元素对应的值。通常是用来判断某个数据存不存在的，因为是用bit为单位来存储所以Bitmap本身会极大的节省储存空间。常用命令如下：</span></p><figure><table><thead><tr><th><span>命令</span></th><th><span>作用</span></th><th><span>时间复杂度</span></th></tr></thead><tbody><tr><td><span>setbit key offset val</span></td><td><span>给指定key的值的第offset赋值val</span></td><td><span>O(1)</span></td></tr><tr><td><span>getbit key offset</span></td><td><span>获取指定key的第offset位</span></td><td><span>O(1)</span></td></tr><tr><td><span>bitcount key start end</span></td><td><span>返回指定key中[start,end]中为1的数量</span></td><td><span>O(n)</span></td></tr><tr><td><span>bitop operation destkey key</span></td><td><span>对不同的二进制存储数据进行位运算(AND、OR、NOT、XOR)</span></td><td><span>O(n)</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>应用案例</span></strong></p><p><span>有1亿用户，5千万登陆用户，那么统计每日用户的登录数。每一位标识一个用户ID，当某个用户访问我们的网站就在Bitmap中把标识此用户的位设置为1。使用set集合和Bitmap存储的对比：</span></p><figure><table><thead><tr><th><span>数据类型</span></th><th><span>每个 userid 占用空间</span></th><th><span>需要存储的用户量</span></th><th><span>全部占用内存量</span></th></tr></thead><tbody><tr><td><span>set</span></td><td><span>32位也就是4个字节（假设userid用的是整型，实际很多网站用的是长整型）</span></td><td><span>50,000,000</span></td><td><span>32位 * 50,000,000 = 200 MB</span></td></tr><tr><td><span>Bitmap</span></td><td><span>1 位（bit）</span></td><td><span>100,000,000</span></td><td><span>1 位 * 100,000,000 = 12.5 MB</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>应用场景</span></strong></p><ul><li><span>用户在线状态</span></li><li><span>用户签到状态</span></li><li><span>统计独立用户</span></li></ul><p>&nbsp;</p><h3 id='bloomfilter布隆过滤'><span>BloomFilter(布隆过滤)</span></h3><p><img src="images/Middleware/Redis-BloomFilter.jpg" referrerpolicy="no-referrer" alt="Redis-BloomFilter"></p><p><span>当一个元素被加入集合时，通过K个散列函数将这个元素映射成一个位数组中的K个点（使用多个哈希函数对</span><strong><span>元素key (bloom中不存value)</span></strong><span> 进行哈希，算出一个整数索引值，然后对位数组长度进行取模运算得到一个位置，每个无偏哈希函数都会得到一个不同的位置），把它们置为1。检索时，我们只要看看这些点是不是都是1就（大约）知道集合中有没有它了：</span></p><ul><li><span>如果这些点有任何一个为0，则被检元素一定不在</span></li><li><span>如果都是1，并不能完全说明这个元素就一定存在其中，有可能这些位置为1是因为其他元素的存在，这就是布隆过滤器会出现误判的原因</span></li></ul><p>&nbsp;</p><p><strong><span>应用场景</span></strong></p><ul><li><strong><span>解决缓存穿透</span></strong><span>：事先把存在的key都放到redis的</span><strong><span>Bloom Filter</span></strong><span> 中，他的用途就是存在性检测，如果 BloomFilter 中不存在，那么数据一定不存在；如果 BloomFilter 中存在，实际数据也有可能会不存</span></li><li><strong><span>黑名单校验</span></strong><span>：假设黑名单的数量是数以亿计的，存放起来就是非常耗费存储空间的，布隆过滤器则是一个较好的解决方案。把所有黑名单都放在布隆过滤器中，再收到邮件时，判断邮件地址是否在布隆过滤器中即可</span></li><li><strong><span>Web拦截器</span></strong><span>：用户第一次请求，将请求参数放入布隆过滤器中，当第二次请求时，先判断请求参数是否被布隆过滤器命中，从而提高缓存命中率</span></li></ul><p>&nbsp;</p><h4 id='基于bitmap数据结构'><span>基于Bitmap数据结构</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">com</span>.<span class="cm-variable">google</span>.<span class="cm-variable">common</span>.<span class="cm-variable">base</span>.<span class="cm-variable">Preconditions</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">data</span>.<span class="cm-variable">redis</span>.<span class="cm-variable">core</span>.<span class="cm-variable">RedisTemplate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">org</span>.<span class="cm-variable">springframework</span>.<span class="cm-variable">stereotype</span>.<span class="cm-variable">Service</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">annotation</span>.<span class="cm-variable">Resource</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">Collection</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">Map</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">TimeUnit</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Service</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">RedisService</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Resource</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">RedisTemplate</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span> <span class="cm-variable">redisTemplate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 根据给定的布隆过滤器添加值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable-3">void</span> <span class="cm-variable">addByBloomFilter</span>(<span class="cm-variable">BloomFilterHelper</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">bloomFilterHelper</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">key</span>, <span class="cm-variable">T</span> <span class="cm-variable">value</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Preconditions</span>.<span class="cm-variable">checkArgument</span>(<span class="cm-variable">bloomFilterHelper</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>, <span class="cm-string">"bloomFilterHelper不能为空"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span>[] <span class="cm-variable">offset</span> <span class="cm-operator">=</span> <span class="cm-variable">bloomFilterHelper</span>.<span class="cm-variable">murmurHashOffset</span>(<span class="cm-variable">value</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> : <span class="cm-variable">offset</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span class="cm-variable">setBit</span>(<span class="cm-variable">key</span>, <span class="cm-variable">i</span>, <span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 根据给定的布隆过滤器判断值是否存在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">includeByBloomFilter</span>(<span class="cm-variable">BloomFilterHelper</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">bloomFilterHelper</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">key</span>, <span class="cm-variable">T</span> <span class="cm-variable">value</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Preconditions</span>.<span class="cm-variable">checkArgument</span>(<span class="cm-variable">bloomFilterHelper</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>, <span class="cm-string">"bloomFilterHelper不能为空"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span>[] <span class="cm-variable">offset</span> <span class="cm-operator">=</span> <span class="cm-variable">bloomFilterHelper</span>.<span class="cm-variable">murmurHashOffset</span>(<span class="cm-variable">value</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> : <span class="cm-variable">offset</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">redisTemplate</span>.<span class="cm-variable">opsForValue</span>().<span class="cm-variable">getBit</span>(<span class="cm-variable">key</span>, <span class="cm-variable">i</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 972px;"></div><div class="CodeMirror-gutters" style="display: none; height: 972px;"></div></div></div></pre><p>&nbsp;</p><h4 id='基于redisbloom模块'><span>基于RedisBloom模块</span></h4><p><span>RedisBloom模块提供了四种数据类型：</span></p><ul><li><strong><span>Bloom Filter (布隆过滤器)</span></strong></li><li><strong><span>Cuckoo Filter（布谷鸟过滤器）</span></strong></li><li><strong><span>Count-Mins-Sketch</span></strong></li><li><strong><span>Top-K</span></strong></li></ul><p><code>Bloom Filter</code><span> 和 </span><code>Cuckoo</code><span> 用于确定（以给定的确定性）集合中是否存在某项。使用 </span><code>Count-Min Sketch</code><span> 来估算子线性空间中的项目数，使用 </span><code>Top-K</code><span> 维护K个最频繁项目的列表。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.git 下载</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># git clone https://github.com/RedisBloom/RedisBloom.git</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># cd redisbloom</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># make</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.wget 下载</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># wget https://github.com/RedisBloom/RedisBloom/archive/v2.0.3.tar.gz</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># tar -zxvf RedisBloom-2.0.3.tar.gz</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># cd RedisBloom-2.0.3/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># make</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3.修改Redis Conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment">#vim /etc/redis.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在文件中添加下行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">loadmodule /root/RedisBloom-2.0.3/redisbloom.so</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 4.启动Redis server</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># /redis-server /etc/redis.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 或者启动服务时加载os文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># /redis-server /etc/redis.conf --loadmodule /root/RedisBloom/redisbloom.so</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 5.测试RedisBloom</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~]<span class="cm-comment"># redis-cli</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1:6379&gt; bf.add bloomFilter foo</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1:6379&gt; bf.exists bloomFilter foo</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1:6379&gt; cf.add cuckooFilter foo</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1:6379&gt; cf.exists cuckooFilter foo</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 626px;"></div><div class="CodeMirror-gutters" style="display: none; height: 626px;"></div></div></div></pre><p>&nbsp;</p><h2 id='底层数据结构'><span>底层数据结构</span></h2><p><span>当然是为了追求速度，不同数据类型使用不同的数据结构速度才得以提升。每种数据类型都有一种或者多种数据结构来支撑，底层数据结构有 6 种。</span></p><p><img src="images/Middleware/Redis数据类型与底层数据结构关系.png" referrerpolicy="no-referrer" alt="Redis数据类型与底层数据结构关系"></p><p>&nbsp;</p><h3 id='sds简单动态字符'><span>SDS(简单动态字符)</span></h3><p><img src="images/Middleware/SDS简单动态字符.png" referrerpolicy="no-referrer" alt="img"></p><p><span>C 语言字符串结构与 SDS 字符串结构对比图如上所示：</span></p><ul><li><span>SDS 中 len 保存这字符串的长度，O(1) 时间复杂度查询字符串长度信息</span></li><li><span>空间预分配：SDS 被修改后，程序不仅会为 SDS 分配所需要的必须空间，还会分配额外的未使用空间</span></li><li><span>惰性空间释放：当对 SDS 进行缩短操作时，程序并不会回收多余的内存空间，而是使用 free 字段将这些字节数量记录下来不释放，后面如果需要 append 操作，则直接使用 free 中未使用的空间，减少了内存的分配</span></li></ul><p>&nbsp;</p><h3 id='hash表字典'><span>hash表(字典)</span></h3><p><img src="images/Middleware/Redis全局hash字典.png" referrerpolicy="no-referrer" alt="img"></p><p><span>Redis 整体就是一个 哈希表来保存所有的键值对，无论数据类型是 5 种的任意一种。哈希表，本质就是一个数组，每个元素被叫做哈希桶，不管什么数据类型，每个桶里面的 entry 保存着实际具体值的指针。</span></p><p><span>整个数据库就是一个全局哈希表，而哈希表的时间复杂度是 O(1)，只需要计算每个键的哈希值，便知道对应的哈希桶位置，定位桶里面的 entry 找到对应数据，这个也是 Redis 快的原因之一。</span></p><p>&nbsp;</p><p><strong><span>那 Hash 冲突怎么办？</span></strong></p><p><span>当写入 Redis 的数据越来越多的时候，哈希冲突不可避免，会出现不同的 key 计算出一样的哈希值。Redis 通过链式哈希解决冲突：也就是同一个 桶里面的元素使用链表保存。但是当链表过长就会导致查找性能变差可能，所以 Redis 为了追求快，使用了两个全局哈希表。用于 rehash 操作，增加现有的哈希桶数量，减少哈希冲突。开始默认使用 hash 表 1 保存键值对数据，哈希表 2 此刻没有分配空间。</span></p><p>&nbsp;</p><h3 id='linkedlist双端列表'><span>linkedList(双端列表)</span></h3><p><img src="images/Middleware/quicklist.png" referrerpolicy="no-referrer" alt="quicklist"></p><p><span>后续版本对列表数据结构进行了改造，使用 quicklist 代替了 ziplist 和 linkedlist。quicklist 是 ziplist 和 linkedlist 的混合体，它将 linkedlist 按段切分，每一段使用 ziplist 来紧凑存储，多个 ziplist 之间使用双向指针串接起来。这也是为何 Redis 快的原因，不放过任何一个可以提升性能的细节。</span></p><p>&nbsp;</p><h3 id='ziplist压缩列表'><span>zipList(压缩列表)</span></h3><p><img src="images/Middleware/ZipList压缩列表.png" referrerpolicy="no-referrer" alt="ZipList压缩列表"></p><p><span>压缩列表是 List 、hash、 sorted Set 三种数据类型底层实现之一。当一个列表只有少量数据的时候，并且每个列表项要么就是小整数值，要么就是长度比较短的字符串，那么 Redis 就会使用压缩列表来做列表键的底层实现。</span></p><p><span>ziplist 是由一系列特殊编码的连续内存块组成的顺序型的数据结构，ziplist 中可以包含多个 entry 节点，每个节点可以存放整数或者字符串。ziplist 在表头有三个字段 zlbytes、zltail 和 zllen，分别表示列表占用字节数、列表尾的偏移量和列表中的 entry 个数；压缩列表在表尾还有一个 zlend，表示列表结束。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="go"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="go"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-variable">ziplist</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">int32</span> <span class="cm-variable">zlbytes</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">// 整个压缩列表占用字节数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">int32</span> <span class="cm-variable">zltail_offset</span>; &nbsp;<span class="cm-comment">// 最后一个元素距离压缩列表起始位置的偏移量，用于快速定位到最后一个节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">int16</span> <span class="cm-variable">zllength</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 元素个数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">T</span>[] <span class="cm-variable">entries</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 元素内容列表，挨个挨个紧凑存储</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">int8</span> <span class="cm-variable">zlend</span>; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">// 标志压缩列表的结束，值恒为 0xFF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p><span>如果我们要查找定位第一个元素和最后一个元素，可以通过表头三个字段的长度直接定位，复杂度是 O(1)。而查找其他元素时，就没有这么高效了，只能逐个查找，此时的复杂度就是 O(N)。</span></p><p>&nbsp;</p><h3 id='skiplist跳跃表'><span>skipList(跳跃表)</span></h3><p><img src="images/Middleware/skipList跳跃表.png" referrerpolicy="no-referrer" alt="skipList跳跃表"></p><p><span>sorted set 类型的排序功能便是通过「跳跃列表」数据结构来实现。跳跃表（skiplist）是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。</span></p><p><span>跳跃表支持平均 O（logN）、最坏 O（N）复杂度的节点查找，还可以通过顺序性操作来批量处理节点。跳表在链表的基础上，增加了多层级索引，通过索引位置的几个跳转，实现数据的快速定位。</span></p><p>&nbsp;</p><h3 id='intset整数数组'><span>intset(整数数组)</span></h3><p><span>当一个集合只包含整数值元素，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现，节省内存。结构如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="go"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="go"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-variable">intset</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">//编码方式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">uint32_t</span> <span class="cm-variable">encoding</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">//集合包含的元素数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">uint32_t</span> <span class="cm-variable">length</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">//保存元素的数组</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">int8_t</span> <span class="cm-variable">contents</span>[];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}<span class="cm-variable">intset</span>;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p><span>contents 数组是整数集合的底层实现：整数集合的每个元素都是 contents 数组的一个数组项（item），各个项在数组中按值的大小从小到大有序地排列，并且数组中不包含任何重复项。length 属性记录了整数集合包含的元素数量，也即是 contents 数组的长度。</span></p><p>&nbsp;</p><h2 id='持久化机制'><span>持久化机制</span></h2><p><span>通常来说，应该同时使用两种持久化方案，以保证数据安全：</span></p><ul><li><span>如果数据不敏感，且可以从其他地方重新生成，可以关闭持久化</span></li><li><span>如果数据比较重要，且能够承受几分钟的数据丢失，比如缓存等，只需要使用RDB即可</span></li><li><span>如果是用做内存数据，要使用Redis的持久化，建议是RDB和AOF都开启</span></li><li><span>如果只用AOF，优先使用everysec的配置选择，因为它在可靠性和性能之间取了一个平衡</span></li></ul><p><span>当RDB与AOF两种方式都开启时，Redis会优先使用AOF恢复数据，因为AOF保存的文件比RDB文件更完整</span></p><p>&nbsp;</p><h3 id='rdb模式内存快照'><span>RDB模式(内存快照)</span></h3><p><code>RDB</code><span>（Redis Database Backup File，</span><strong><span>Redis数据备份文件</span></strong><span>）持久化方式：是指用数据集快照的方式半持久化模式记录 Redis 数据库的所有键值对，在某个时间点将数据写入一个临时文件，持久化结束后，用这个临时文件替换上次持久化的文件，达到数据恢复。</span></p><p><strong><span>优点</span></strong></p><ul><li><span>RDB快照是一个压缩过的非常紧凑的文件。保存着某个时间点的数据集，适合做数据的备份，灾难恢复</span></li><li><span>可最大化Redis的的性能。在保存RDB文件，服务器进程只需要fork一个子进程来完成RDB文件创建，父进程不需要做IO操作</span></li><li><span>与AOF相比，恢复大数据集的时候会更快</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>RDB的数据安全性是不如AOF的，保存整个数据集的过程是比繁重的，根据配置可能要几分钟才快照一次，如果服务器宕机，那么就可能丢失几分钟的数据</span></li><li><span>Redis数据集较大时，fork的子进程要完成快照会比较耗CPU、耗时</span></li></ul><p>&nbsp;</p><p><strong><span>① 创建</span></strong></p><p><span>当 Redis 持久化时，程序会将当前内存中的</span><strong><span>数据库状态</span></strong><span>保存到磁盘中。创建 RDB 文件主要有两个 Redis 命令：</span><code>SAVE</code><span> 和 </span><code>BGSAVE</code><span>。</span></p><p><img src="images/Middleware/Redis-RDB-创建.png" referrerpolicy="no-referrer" alt="Redis-RDB-创建"></p><p>&nbsp;</p><p><strong><span>② 载入</span></strong></p><p><span>服务器在载入 RDB 文件期间，会一直处于</span><strong><span>阻塞</span></strong><span>状态，直到载入工作完成为止。</span></p><p><img src="images/Middleware/Redis-RDB-载入.png" referrerpolicy="no-referrer" alt="Redis-RDB-载入"></p><p>&nbsp;</p><h4 id='save同步保存'><span>save同步保存</span></h4><p><code>save</code><span> 命令是同步操作，执行命令时，会 </span><strong><span>阻塞</span></strong><span> Redis 服务器进程，拒绝客户端发送的命令请求。</span></p><p><span>具体流程如下：</span></p><p><img src="images/Middleware/Redis-RDB-Save命令.png" referrerpolicy="no-referrer" alt="Redis-RDB-Save命令"></p><p><span>由于 </span><code>save</code><span> 命令是同步命令，会占用Redis的主进程。若Redis数据非常多时，</span><code>save</code><span>命令执行速度会非常慢，阻塞所有客户端的请求。因此很少在生产环境直接使用SAVE 命令，可以使用BGSAVE 命令代替。如果在BGSAVE命令的保存数据的子进程发生错误的时，用 SAVE命令保存最新的数据是最后的手段。</span></p><p>&nbsp;</p><h4 id='bgsave异步保存'><span>bgsave异步保存</span></h4><p><code>bgsave</code><span> 命令是异步操作，执行命令时，子进程执行保存工作，服务器还可以继续让主线程</span><strong><span>处理</span></strong><span>客户端发送的命令请求。</span></p><p><span>具体流程如下：</span></p><p><img src="images/Middleware/Redis-RDB-BgSave命令.png" referrerpolicy="no-referrer" alt="Redis-RDB-BgSave命令"></p><p><span>Redis使用Linux系统的</span><code>fock()</code><span>生成一个子进程来将DB数据保存到磁盘，主进程继续提供服务以供客户端调用。如果操作成功，可以通过客户端命令LASTSAVE来检查操作结果。</span></p><p>&nbsp;</p><h4 id='自动保存'><span>自动保存</span></h4><p><span>可通过配置文件对 Redis 进行设置， 让它在“ N 秒内数据集至少有 M 个改动”这一条件被满足时， 自动进行数据集保存操作:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB自动持久化规则</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 当 900 秒内有至少有 1 个键被改动时，自动进行数据集保存操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">900</span> <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 当 300 秒内有至少有 10 个键被改动时，自动进行数据集保存操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">300</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 当 60 秒内有至少有 10000 个键被改动时，自动进行数据集保存操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">60</span> <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB持久化文件名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dbfilename dump-&lt;port&gt;.rdb</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 数据持久化文件存储目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /var/lib/redis</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bgsave发生错误时是否停止写入，通常为yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">stop-writes-on-bgsave-error <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># rdb文件是否使用压缩格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdbcompression <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 是否对rdb文件进行校验和检验，通常为yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdbchecksum <span class="cm-builtin">yes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 475px;"></div><div class="CodeMirror-gutters" style="display: none; height: 475px;"></div></div></div></pre><p>&nbsp;</p><h4 id='默认配置-1'><span>默认配置</span></h4><p><span>RDB 文件默认的配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">################################ SNAPSHOTTING  ################################</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Save the DB on disk:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在给定的秒数和给定的对数据库的写操作数下，自动持久化操作。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#  save &lt;seconds&gt; &lt;changes&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">save 900 1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">save 300 10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">save 60 10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#bgsave发生错误时是否停止写入，一般为yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">stop-writes-on-bgsave-error yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#持久化时是否使用LZF压缩字符串对象?</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">rdbcompression yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否对rdb文件进行校验和检验，通常为yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">rdbchecksum yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB持久化文件名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dbfilename dump.rdb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#持久化文件存储目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dir ./</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 432px;"></div><div class="CodeMirror-gutters" style="display: none; height: 432px;"></div></div></div></pre><p>&nbsp;</p><h3 id='aof模式日志追加'><span>AOF模式(日志追加)</span></h3><p><span>AOF（Append  Only File，</span><strong><span>追加日志文件</span></strong><span>）持久化方式：是指所有的命令行记录以 Redis 命令请求协议的格式完全持久化存储保存为 aof 文件。Redis 是先执行命令，把数据写入内存，然后才记录日志。因为该模式是</span><strong><span>只追加</span></strong><span>的方式，所以没有任何磁盘寻址的开销，所以很快，有点像 Mysql 中的binlog，AOF更适合做热备。</span></p><p><img src="images/Middleware/Redis-AOF.png" referrerpolicy="no-referrer" alt="Redis-AOF"></p><p><strong><span>优点</span></strong></p><ul><li><span>数据更完整，安全性更高，秒级数据丢失（取决fsync策略，如果是everysec，最多丢失1秒的数据）</span></li><li><span>AOF文件是一个只进行追加的日志文件，且写入操作是以Redis协议的格式保存的，内容是可读的，适合误删紧急恢复</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>对于相同的数据集，AOF文件的体积要大于RDB文件，数据恢复也会比较慢</span></li><li><span>根据所使用的fsync策略，AOF的速度可能会慢于RDB。 不过在一般情况下，每秒fsync的性能依然非常高</span></li></ul><p>&nbsp;</p><h4 id='持久化流程'><span>持久化流程</span></h4><p><img src="images/Middleware/Redis-AOF持久化流程.png" referrerpolicy="no-referrer" alt="Redis-AOF持久化流程"></p><p><strong><span>① 命令追加</span></strong></p><p><span>若 AOF 持久化功能处于打开状态，服务器在执行完一个命令后，会以协议格式将被执行的写命令</span><strong><span>追加</span></strong><span>到服务器状态的 </span><code>aof_buf</code><span> 缓冲区的末尾。</span></p><p>&nbsp;</p><p><strong><span>② 文件同步</span></strong></p><p><span>服务器每次结束一个事件循环之前，都会调用 </span><code>flushAppendOnlyFile</code><span> 函数，这个函数会考虑是否需要将 </span><code>aof_buf</code><span> 缓冲区中的内容</span><strong><span>写入和保存</span></strong><span>到 AOF 文件里。</span><code>flushAppendOnlyFile</code><span> 函数执行以下流程：</span></p><ul><li><span>WRITE：根据条件，将 aof_buf 中的</span><strong><span>缓存</span></strong><span>写入到 AOF 文件；</span></li><li><span>SAVE：根据条件，调用 fsync 或 fdatasync 函数，将 AOF 文件保存到</span><strong><span>磁盘</span></strong><span>中。</span></li></ul><p><span>这个函数是由服务器配置的 </span><code>appendfsync</code><span> 的三个值：</span><code>always、everysec、no</code><span> 来影响的，也被称为三种策略：</span></p><ul><li><p><strong><span>always</span></strong><span>：每条</span><strong><span>命令</span></strong><span>都会 fsync 到硬盘中，这样 redis 的写入数据就不会丢失。</span></p><p><img src="images/Middleware/Redis-AOF-Always.png" referrerpolicy="no-referrer" alt="Redis-AOF-Always"></p></li><li><p><strong><span>everysec</span></strong><span>：</span><strong><span>每秒</span></strong><span>都会刷新缓冲区到硬盘中(默认值)。</span></p><p><img src="images/Middleware/Redis-AOF-Everysec.png" referrerpolicy="no-referrer" alt="Redis-AOF-Everysec"></p></li><li><p><strong><span>no</span></strong><span>：根据当前</span><strong><span>操作系统</span></strong><span>的规则决定什么时候刷新到硬盘中，不需要我们来考虑。</span></p><p><img src="images/Middleware/Redis-AOF-No.png" referrerpolicy="no-referrer" alt="Redis-AOF-No"></p></li></ul><p>&nbsp;</p><p><strong><span>数据加载</span></strong></p><ul><li><span>创建一个不带网络连接的伪客户端</span></li><li><span>从 AOF 文件中分析并读取出一条写命令</span></li><li><span>使用伪客户端执行被读出的写命令</span></li><li><span>一直执行步骤 2 和 3，直到 AOF 文件中的所有写命令都被</span><strong><span>处理完毕</span></strong><span>为止</span></li></ul><p>&nbsp;</p><h4 id='文件重写'><span>文件重写</span></h4><p><strong><span>为何需要文件重写</span></strong></p><ul><li><span>为了解决 AOF 文件</span><strong><span>体积膨胀</span></strong><span>的问题</span></li><li><span>通过重写创建一个新的 AOF 文件来替代现有的 AOF 文件，新的 AOF 文件不会包含任何浪费空间的冗余命令</span></li></ul><p>&nbsp;</p><p><strong><span>文件重写的实现原理</span></strong></p><ul><li><span>不需要对现有的 AOF 文件进行任何操作</span></li><li><span>从数据库中直接读取键现在的值</span></li><li><span>用一条命令记录键值对，从而</span><strong><span>代替</span></strong><span>之前记录这个键值对的多条命令</span></li></ul><p>&nbsp;</p><p><strong><span>后台重写</span></strong></p><p><span>为不阻塞父进程，Redis将AOF重写程序放到</span><strong><span>子进程</span></strong><span>里执行。在子进程执行AOF重写期间，服务器进程需要执行三个流程：</span></p><ul><li><span>执行客户端发来的命令</span></li><li><span>将执行后的写命令追加到 AOF 缓冲区</span></li><li><span>将执行后的写命令追加到 AOF 重写缓冲区</span></li></ul><p><img src="images/Middleware/Redis-AOF-后台重写.png" referrerpolicy="no-referrer" alt="Redis-AOF-后台重写"></p><p>&nbsp;</p><h4 id='默认配置-2'><span>默认配置</span></h4><p><span>AOF 文件默认的配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">############################## APPEND ONLY MODE ###############################</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#开启AOF持久化方式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">appendonly no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#AOF持久化文件名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">appendfilename "appendonly.aof"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#每秒把缓冲区的数据fsync到磁盘</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">appendfsync everysec</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># appendfsync no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否在执行重写时不同步数据到AOF文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">no-appendfsync-on-rewrite no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 触发AOF文件执行重写的增长率</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">auto-aof-rewrite-percentage 100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#触发AOF文件执行重写的最小size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">auto-aof-rewrite-min-size 64mb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#redis在恢复时，会忽略最后一条可能存在问题的指令</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">aof-load-truncated yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否打开混合开关</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">aof-use-rdb-preamble yes</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 410px;"></div><div class="CodeMirror-gutters" style="display: none; height: 410px;"></div></div></div></pre><p>&nbsp;</p><h2 id='过期策略'><span>过期策略</span></h2><p><strong><span>过期策略用于处理过期缓存数据</span></strong><span>。Redis采用过期策略：</span><code>惰性删除</code><span> + </span><code>定期删除</code><span>。memcached采用过期策略：</span><code>惰性删除</code><span>。</span></p><h3 id='定时过期'><span>定时过期</span></h3><p><span>每个设置过期时间的key都需要创建一个定时器，到过期时间就会立即对key进行清除。该策略可以立即清除过期的数据，对内存很友好；但是</span><strong><span>会占用大量的CPU资源去处理过期的数据</span></strong><span>，从而影响缓存的响应时间和吞吐量。</span></p><p>&nbsp;</p><h3 id='惰性过期'><span>惰性过期</span></h3><p><span>只有当访问一个key时，才会判断该key是否已过期，过期则清除。该策略可以最大化地节省CPU资源，却</span><strong><span>对内存非常不友好</span></strong><span>。极端情况可能出现大量的过期key没有再次被访问，从而不会被清除，占用大量内存。</span></p><p>&nbsp;</p><h3 id='定期过期'><span>定期过期</span></h3><p><span>每隔一定的时间，会扫描一定数量的数据库的expires字典中一定数量的key，并清除其中已过期的key。该策略是前两者的一个折中方案。通过调整定时扫描的时间间隔和每次扫描的限定耗时，可以在不同情况下使得CPU和内存资源</span><strong><span>达到最优</span></strong><span>的平衡效果。expires字典会保存所有设置了过期时间的key的过期时间数据，其中 key 是指向键空间中的某个键的指针，value是该键的毫秒精度的UNIX时间戳表示的过期时间。键空间是指该Redis集群中保存的所有键。</span></p><p>&nbsp;</p><h2 id='淘汰策略'><span>淘汰策略</span></h2><p><span>Redis淘汰机制的存在是为了更好的使用内存，用一定的缓存丢失来换取内存的使用效率。当Redis内存快耗尽时，Redis会启动内存淘汰机制，将部分key清掉以腾出内存。当达到内存使用上限超过</span><code>maxmemory</code><span>时，可在配置文件</span><code>redis.conf</code><span>中指定 </span><code>maxmemory-policy</code><span> 的清理缓存方式。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 配置最大内存限制</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">maxmemory 1000mb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 配置淘汰策略</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">maxmemory-policy volatile-lru</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><h3 id='lru最近最少使用'><span>LRU(最近最少使用)</span></h3><ul><li><code>volatile-lru</code><span>：从已设置过期时间的key中，挑选</span><strong><span>最近最少使用(最长时间没有使用)</span></strong><span>的key进行淘汰</span></li><li><code>allkeys-lru</code><span>：从所有key中，挑选</span><strong><span>最近最少使用</span></strong><span>的数据淘汰</span></li></ul><p>&nbsp;</p><h3 id='lfu最近最不经常使用'><span>LFU(最近最不经常使用)</span></h3><ul><li><code>volatile-lfu</code><span>：从已设置过期时间的key中，挑选</span><strong><span>最近最不经常使用(使用次数最少)</span></strong><span>的key进行淘汰</span></li><li><code>allkeys-lfu</code><span>：从所有key中，选择某段时间内内</span><strong><span>最近最不经常使用</span></strong><span>的数据淘汰</span></li></ul><p>&nbsp;</p><h3 id='random随机淘汰'><span>Random(随机淘汰)</span></h3><ul><li><code>volatile-random</code><span>：从已设置过期时间的key中，</span><strong><span>任意选择</span></strong><span>数据淘汰</span></li><li><code>allkeys-random</code><span>：从所有key中，</span><strong><span>任意选择数</span></strong><span>据淘汰</span></li></ul><p>&nbsp;</p><h3 id='ttl过期时间'><span>TTL(过期时间)</span></h3><ul><li><code>volatile-ttl</code><span>：从已设置过期时间的key中，挑选</span><strong><span>将要过期</span></strong><span>的数据淘汰</span></li><li><code>allkeys-random</code><span>：从所有key中，</span><strong><span>任意选择数</span></strong><span>据淘汰</span></li></ul><p>&nbsp;</p><h3 id='no-enviction驱逐'><span>No-Enviction(驱逐)</span></h3><ul><li><code>noenviction（驱逐）</code><span>：当达到最大内存时直接返回错误，不覆盖或逐出任何数据</span></li></ul><p>&nbsp;</p><h2 id='部署架构'><span>部署架构</span></h2><h3 id='单节点single-1'><span>单节点(Single)</span></h3><p><strong><span>优点</span></strong></p><ul><li><span>架构简单，部署方便</span></li><li><span>高性价比：缓存使用时无需备用节点(单实例可用性可以用 supervisor 或 crontab 保证)，当然为了满足业务的高可用性，也可以牺牲一个备用节点，但同时刻只有一个实例对外提供服务</span></li><li><span>高性能</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>不保证数据的可靠性</span></li><li><span>在缓存使用，进程重启后，数据丢失，即使有备用的节点解决高可用性，但是仍然不能解决缓存预热问题，因此不适用于数据可靠性要求高的业务</span></li><li><span>高性能受限于单核CPU的处理能力(Redis是单线程机制)，CPU为主要瓶颈，所以适合操作命令简单，排序/计算较少场景</span></li></ul><p>&nbsp;</p><h3 id='主从复制replication-1'><span>主从复制(Replication)</span></h3><p><strong><span>基本原理</span></strong></p><p><span>主从复制模式中包含一个主数据库实例（Master）与一个或多个从数据库实例（Slave），如下图：</span></p><p><img src="images/Middleware/Redis主从复制模式(Replication).png" referrerpolicy="no-referrer" alt="Redis主从复制模式(Replication)"></p><p><img src="images/Middleware/Redis主从复制模式(Replication)优缺点.png" referrerpolicy="no-referrer" alt="Redis主从复制模式(Replication)优缺点"></p><p>&nbsp;</p><h3 id='哨兵sentinel-1'><span>哨兵(Sentinel)</span></h3><p><span>Sentinel主要作用如下：</span></p><ul><li><strong><span>监控</span></strong><span>：Sentinel 会不断的检查主服务器和从服务器是否正常运行</span></li><li><strong><span>通知</span></strong><span>：当被监控的某个Redis服务器出现问题，Sentinel通过API脚本向管理员或者其他的应用程序发送通知</span></li><li><strong><span>自动故障转移</span></strong><span>：当主节点不能正常工作时，Sentinel会开始一次自动的故障转移操作，它会将与失效主节点是主从关系的其中一个从节点升级为新的主节点，并且将其他的从节点指向新的主节点</span></li></ul><p><img src="images/Middleware/Redis哨兵模式(Sentinel).png" referrerpolicy="no-referrer" alt="Redis哨兵模式(Sentinel)"></p><p><img src="images/Middleware/Redis哨兵模式(Sentinel)优缺点.png" referrerpolicy="no-referrer" alt="Redis哨兵模式(Sentinel)优缺点"></p><p>&nbsp;</p><h3 id='集群cluster-1'><span>集群(Cluster)</span></h3><p><img src="images/Middleware/Redis集群模式(Cluster).png" referrerpolicy="no-referrer" alt="Redis集群模式(Cluster)"></p><p><img src="images/Middleware/Redis集群模式(Cluster)优缺点.png" referrerpolicy="no-referrer" alt="Redis集群模式(Cluster)优缺点"></p><p>&nbsp;</p><h2 id='环境搭建'><span>环境搭建</span></h2><p><strong><span>Redis安装及配置</span></strong></p><p><span>Redis的安装十分简单，打开redis的官网 </span><a href='http://redis.io/'><span>http://redis.io</span></a><span> 。</span></p><ul><li><span>下载一个最新版本的安装包，如 redis-version.tar.gz</span></li><li><span>解压 </span><code>tar zxvf redis-version.tar.gz</code></li><li><span>执行 make (执行此命令可能会报错，例如确实gcc，一个个解决即可)</span></li></ul><p><span>如果是 mac 电脑，安装redis将十分简单执行</span><code>brew install redis</code><span>即可。安装好redis之后，我们先不慌使用，先进行一些配置。打开</span><code>redis.conf</code><span>文件，我们主要关注以下配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 指定端口为 6379，也可自行修改 </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize <span class="cm-builtin">yes</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 指定后台运行</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p>&nbsp;</p><h3 id='单节点single-2'><span>单节点(Single)</span></h3><p><span>安装好redis之后，我们来运行一下。启动redis的命令为 :</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">$ </span>&lt;redishome&gt;/bin/redis-server path/to/redis.config</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>假设我们没有配置后台运行（即：daemonize no）,那么我们会看到如下启动日志：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">93825</span>:C <span class="cm-number">20</span> Jan <span class="cm-number">2019</span> <span class="cm-number">11</span>:43:22.640 <span class="cm-comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">93825</span>:C <span class="cm-number">20</span> Jan <span class="cm-number">2019</span> <span class="cm-number">11</span>:43:22.640 <span class="cm-comment"># Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=93825, just started</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">93825</span>:C <span class="cm-number">20</span> Jan <span class="cm-number">2019</span> <span class="cm-number">11</span>:43:22.640 <span class="cm-comment"># Configuration loaded</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">93825</span>:S <span class="cm-number">20</span> Jan <span class="cm-number">2019</span> <span class="cm-number">11</span>:43:22.641 * Increased maximum number of open files to <span class="cm-number">10032</span> (it was originally <span class="cm-keyword">set</span> to <span class="cm-number">256</span>).</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  _._ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _.-<span class="cm-quote">``</span>__ <span class="cm-string">''</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  _.-<span class="cm-quote">``</span> &nbsp; &nbsp;<span class="cm-quote">`.  `</span>_. &nbsp;<span class="cm-string">''</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Redis <span class="cm-number">5</span>.0.3 (00000000/0) <span class="cm-number">64</span> bit</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  .-<span class="cm-quote">``</span> .-<span class="cm-quote">```.  ```</span>\/ &nbsp;  _.,_ <span class="cm-string">''</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> ( &nbsp; &nbsp;<span class="cm-string">' &nbsp; &nbsp;  , &nbsp; &nbsp; &nbsp; .-`  | `, &nbsp;  ) &nbsp; &nbsp; Running in standalone mode</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> |<span class="cm-quote">`-._`</span><span class="cm-attribute">-</span>...-<span class="cm-quote">` __...-.``-._|'`</span> _.-<span class="cm-string">'| &nbsp; &nbsp; Port: 6380</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> | &nbsp; &nbsp;<span class="cm-quote">`-._ &nbsp; `</span>._ &nbsp;  / &nbsp; &nbsp; _.-<span class="cm-string">' &nbsp;  | &nbsp; &nbsp; PID: 93825</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-quote">`-._ &nbsp;  `</span><span class="cm-attribute">-</span>._ &nbsp;<span class="cm-quote">`-./  _.-' &nbsp;  _.-' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> |<span class="cm-quote">`-._`</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp;<span class="cm-quote">`-.__.-' &nbsp;  _.-'_.-'| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> | &nbsp; &nbsp;<span class="cm-quote">`-._`</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp; &nbsp;  _.-<span class="cm-string">'_.-'</span> &nbsp;  | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http://redis.io &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-quote">`-._ &nbsp;  `</span><span class="cm-attribute">-</span>._<span class="cm-quote">`-.__.-'_.-' &nbsp;  _.-' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> |<span class="cm-quote">`-._`</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp;<span class="cm-quote">`-.__.-' &nbsp;  _.-'_.-'| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> | &nbsp; &nbsp;<span class="cm-quote">`-._`</span><span class="cm-attribute">-</span>._ &nbsp; &nbsp; &nbsp;  _.-<span class="cm-string">'_.-'</span> &nbsp;  | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-quote">`-._ &nbsp;  `</span><span class="cm-attribute">-</span>._<span class="cm-quote">`-.__.-'_.-' &nbsp;  _.-' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-quote">`-._ &nbsp;  `</span><span class="cm-attribute">-</span>.__.-<span class="cm-string">' &nbsp;  _.-'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-quote">`-._ &nbsp; &nbsp; &nbsp;  _.-' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-quote">`-.__.-' &nbsp; </span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 540px;"></div><div class="CodeMirror-gutters" style="display: none; height: 540px;"></div></div></div></pre><p>&nbsp;</p><h3 id='主从复制replication-2'><span>主从复制(Replication)</span></h3><p><span>Redis主从配置非常简单，过程如下(演示情况下主从配置在一台电脑上)：</span></p><p><strong><span>第一步</span></strong><span>：复制两个redis配置文件（启动两个redis，只需要一份redis程序，两个不同的redis配置文件即可）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> redis-master-slave</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> path/to/redis/conf/redis.conf path/to/redis-master-slave master.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> path/to/redis/conf/redis.conf path/to/redis-master-slave slave.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><strong><span>第二步</span></strong><span>：修改配置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## master.conf</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">## master.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6380</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slaveof <span class="cm-number">127</span>.0.0.1 <span class="cm-number">6379</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><strong><span>第三步</span></strong><span>：分别启动两个redis</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-master-slave/master.conf</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-master-slave/slave.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>启动之后，打开两个命令行窗口，分别执行 </span><code>telnet localhost 6379</code><span> 和 </span><code>telnet localhost 6380</code><span>，然后分别在两个窗口中执行 </span><code>info</code><span> 命令,可以看到：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Replication</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">role:master</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Replication</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">role:slave</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">master_host:127.0.0.1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">master_port:6379</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p><span>主从配置没问题。然后在master 窗口执行 set 之后，到slave窗口执行get，可以get到，说明主从同步成功。这时，我们如果在slave窗口执行 set ，会报错:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-READONLY</span> You can<span class="cm-string">'t write against a read only replica.</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>因为从节点是只读的。</span></p><p>&nbsp;</p><h3 id='哨兵sentinel-2'><span>哨兵(Sentinel)</span></h3><p><span>Sentinel是用来监控主从节点的健康情况。客户端连接Redis主从的时候，先连接Sentinel，Sentinel会告诉客户端主Redis的地址是多少，然后客户端连接上Redis并进行后续的操作。当主节点挂掉的时候，客户端就得不到连接了因而报错了，客户端重新向Sentinel询问主master的地址，然后客户端得到了[新选举出来的主Redis]，然后又可以愉快的操作了。</span></p><p>&nbsp;</p><p><strong><span>哨兵sentinel配置</span></strong></p><p><span>为了说明sentinel的用处，我们做个试验。配置3个redis（1主2从），1个哨兵。步骤如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> redis-sentinel</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> redis-sentinel</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> redis/path/conf/redis.conf path/to/redis-sentinel/redis01.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> redis/path/conf/redis.conf path/to/redis-sentinel/redis02.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> redis/path/conf/redis.conf path/to/redis-sentinel/redis03.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">touch</span> sentinel.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><span>上我们创建了 3个redis配置文件，1个哨兵配置文件。我们将 redis01设置为master，将redis02，redis03设置为slave。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> redis01.conf</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">63791</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> redis02.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">63792</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slaveof <span class="cm-number">127</span>.0.0.1 <span class="cm-number">63791</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> redis03.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">63793</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slaveof <span class="cm-number">127</span>.0.0.1 <span class="cm-number">63791</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel monitor mymaster <span class="cm-number">127</span>.0.0.1 <span class="cm-number">63793</span> <span class="cm-number">1</span> &nbsp; <span class="cm-comment"># 下面解释含义</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p><span>上面的主从配置都熟悉，只有哨兵配置 sentinel.conf，需要解释一下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mymaster &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 为主节点名字，可以随便取，后面程序里边连接的时候要用到</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1 <span class="cm-number">63793</span> <span class="cm-comment"># 为主节点的 ip,port</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 后面的数字 1 表示选举主节点的时候，投票数。1表示有一个sentinel同意即可升级为master</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>启动哨兵</span></strong></p><p><span>上面我们配置好了redis主从，1主2从，以及1个哨兵。下面我们分别启动redis，并启动哨兵：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-sentinel/redis01.conf</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-sentinel/redis02.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-sentinel/redis03.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-server path/to/redis-sentinel/sentinel.conf <span class="cm-attribute">--sentinel</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><span>启动之后，可以分别连接到 3个redis上，执行info查看主从信息。</span></p><p>&nbsp;</p><p><strong><span>模拟主节点宕机情况</span></strong></p><p><span>运行上面的程序（</span><strong><span>注意，在实验这个效果的时候，可以将sleep时间加长或者for循环增多，以防程序提前停止，不便看整体效果</span></strong><span>），然后将主redis关掉，模拟redis挂掉的情况。现在主redis为redis01,端口为63791</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-p</span> <span class="cm-number">63791</span> shutdown</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><h3 id='集群cluster-2'><span>集群(Cluster)</span></h3><p><span>上述所做的这些工作只是保证了数据备份以及高可用，目前为止我们的程序一直都是向1台redis写数据，其他的redis只是备份而已。实际场景中，单个redis节点可能不满足要求，因为：</span></p><ul><li><span>单个redis并发有限</span></li><li><span>单个redis接收所有数据，最终回导致内存太大，内存太大回导致rdb文件过大，从很大的rdb文件中同步恢复数据会很慢</span></li></ul><p><span>所以需要redis cluster 即redis集群。Redis 集群是一个提供在</span><strong><span>多个Redis间节点间共享数据</span></strong><span>的程序集。Redis集群并不支持处理多个keys的命令，因为这需要在不同的节点间移动数据，从而达不到像Redis那样的性能,在高负载的情况下可能会导致不可预料的错误。Redis 集群通过分区来提供</span><strong><span>一定程度的可用性</span></strong><span>，在实际环境中当某个节点宕机或者不可达的情况下继续处理命令.。Redis 集群的优势：</span></p><ul><li><span>自动分割数据到不同的节点上</span></li><li><span>整个集群的部分节点失败或者不可达的情况下能够继续处理命令</span></li></ul><p><span>为了配置一个redis cluster,我们需要准备至少6台redis，为啥至少6台呢？我们可以在redis的官方文档中找到如下一句话：</span></p><blockquote><p><span>Note that the minimal cluster that works as expected requires to contain at least three master nodes. </span></p></blockquote><p><span>因为最小的redis集群，需要至少3个主节点，既然有3个主节点，而一个主节点搭配至少一个从节点，因此至少得6台redis。然而对我来说，就是复制6个redis配置文件。本实验的redis集群搭建依然在一台电脑上模拟。</span></p><p>&nbsp;</p><p><strong><span>配置 redis cluster 集群</span></strong></p><p><span>上面提到，配置redis集群需要至少6个redis节点。因此我们需要准备及配置的节点如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主：redis01  从 redis02 &nbsp;  slaveof redis01</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主：redis03  从 redis04 &nbsp;  slaveof redis03</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主：redis05  从 redis06 &nbsp;  slaveof redis05</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> redis-cluster</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> redis-cluster</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> redis01 到 redis06 <span class="cm-number">6</span>个文件夹</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> redis.conf 到 redis01 ... redis06</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修改端口, 分别配置3组主从关系</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>启动redis集群</span></strong></p><p><span>上面的配置完成之后，分别启动6个redis实例。配置正确的情况下，都可以启动成功。然后运行如下命令创建集群：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-5.0.3/src/redis-cli <span class="cm-attribute">--cluster</span> create <span class="cm-number">127</span>.0.0.1:6371 <span class="cm-number">127</span>.0.0.1:6372 <span class="cm-number">127</span>.0.0.1:6373 <span class="cm-number">127</span>.0.0.1:6374 <span class="cm-number">127</span>.0.0.1:6375 <span class="cm-number">127</span>.0.0.1:6376 <span class="cm-attribute">--cluster-replicas</span> <span class="cm-number">1</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>，这里使用的是ip:port，而不是 domain:port ，因为我在使用 localhost:6371 之类的写法执行的时候碰到错误：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ERR Invalid <span class="cm-builtin">node</span> address specified: localhost:6371</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>执行成功之后，连接一台redis，执行 cluster info 会看到类似如下信息：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_state:ok</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_slots_assigned:16384</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_slots_ok:16384</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_slots_pfail:0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_slots_fail:0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_known_nodes:6</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_size:3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_current_epoch:6</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_my_epoch:1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_ping_sent:1515</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_pong_sent:1506</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_sent:3021</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_ping_received:1501</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_pong_received:1515</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_meet_received:5</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster_stats_messages_received:3021</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><span>我们可以看到</span><code>cluster_state:ok</code><span>，</span><code>cluster_slots_ok:16384</code><span>，</span><code>cluster_size:3</code><span>。</span></p><p>&nbsp;</p><h2 id='拓展方案'><span>拓展方案</span></h2><h3 id='分区partitioning'><span>分区(Partitioning)</span></h3><p><span>指在面临</span><strong><span>单机</span></strong><span>的</span><strong><span>存储空间</span></strong><span>瓶颈时，即将全部数据分散在多个Redis实例中，每个实例不需要关联，可以是完全独立的。</span></p><p>&nbsp;</p><p><strong><span>使用方式</span></strong></p><ul><li><p><span>客户端处理</span>
<span>和传统的数据库分库分表一样，可以从</span><strong><span>key</span></strong><span>入手，先进行计算，找到对应数据存储的实例在进行操作。</span></p><ul><li><strong><span>范围角度</span></strong><span>，比如orderId:1~orderId:1000放入实例1，orderId:1001~orderId:2000放入实例2</span></li><li><strong><span>哈希计算</span></strong><span>，就像我们的</span><strong><span>hashmap</span></strong><span>一样，用hash函数加上位运算或者取模，高级玩法还有一致性Hash等操作，找到对应的实例进行操作</span></li></ul></li><li><p><span>使用代理中间件</span>
<span>我们可以开发独立的代理中间件，屏蔽掉处理数据分片的逻辑，独立运行。当然Redis也有优秀的代理中间件，譬如Twemproxy，或者codis，可以结合场景选择是否使用</span></p></li></ul><p>&nbsp;</p><p><strong><span>缺点</span></strong></p><ul><li><strong><span>无缘多key操作</span></strong><span>，key都不一定在一个实例上，那么多key操作或者多key事务自然是不支持</span></li><li><strong><span>维护成本</span></strong><span>，由于每个实例在物理和逻辑上，都属于单独的一个节点，缺乏统一管理</span></li><li><strong><span>灵活性有限</span></strong><span>，范围分片还好，比如hash+MOD这种方式，如果想</span><strong><span>动态</span></strong><span>调整Redis实例的数量，就要考虑大量数据迁移</span></li></ul><p>&nbsp;</p><h3 id='主从master-slave'><span>主从(Master-Slave)</span></h3><p><span>分区暂时能解决</span><strong><span>单点</span></strong><span>无法容纳的</span><strong><span>数据量问题</span></strong><span>，但是一个Key还是只在一个实例上。主从则将数据从</span><strong><span>主节点</span></strong><span>同步到</span><strong><span>从节点</span></strong><span>，然后可做</span><strong><span>读写分离</span></strong><span>，将读流量均摊在各个从节点，可靠性也能提高。</span><strong><span>主从</span></strong><span>(Master-Slave)也就是复制(Replication)方式。</span></p><p>&nbsp;</p><p><strong><span>使用方式</span></strong></p><ul><li><span>作为主节点的Redis实例，并不要求配置任何参数，只需要正常启动</span></li><li><span>作为从节点的实例，使用配置文件或命令方式</span><code>REPLICAOF 主节点Host 主节点port</code><span>即可完成主从配置</span></li></ul><p>&nbsp;</p><p><strong><span>缺点</span></strong></p><ul><li><span>slave节点都是</span><strong><span>只读</span></strong><span>的，如果</span><strong><span>写流量</span></strong><span>大的场景，就有些力不从心</span></li><li><strong><span>故障转移</span></strong><span>不友好，主节点挂掉后，写处理就无处安放，需要</span><strong><span>手工</span></strong><span>的设定新的主节点，如使用</span><code>REPLICAOF no one</code><span> 晋升为主节点，再梳理其他slave节点的新主配置，相对来说比较麻烦</span></li></ul><p>&nbsp;</p><h3 id='哨兵sentinel-3'><span>哨兵(Sentinel)</span></h3><p><strong><span>主从</span></strong><span>的手工故障转移，肯定让人很难接受，自然就出现了高可用方案-</span><strong><span>哨兵</span></strong><span>（Sentinel）。我们可以在主从架构不变的场景，直接加入</span><strong><span>Redis Sentinel</span></strong><span>，对节点进行</span><strong><span>监控</span></strong><span>，来完成自动的</span><strong><span>故障发现</span></strong><span>与</span><strong><span>转移</span></strong><span>。并且还能够充当</span><strong><span>配置提供者</span></strong><span>，提供主节点的信息，就算发生了故障转移，也能提供正确的地址。</span></p><p>&nbsp;</p><p><strong><span>使用方式</span></strong></p><p><strong><span>Sentinel</span></strong><span>的最小配置，一行即可：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel monitor &lt;主节点别名&gt; &lt;主节点host&gt; &lt;主节点端口&gt; &lt;票数&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>只需要配置master即可，然后用</span><code>redis-sentinel &lt;配置文件&gt;</code><span> 命令即可启用。哨兵数量建议在三个以上且为奇数。</span></p><p>&nbsp;</p><p><strong><span>使用场景问题</span></strong></p><ul><li><span>故障转移期间短暂的不可用，但其实官网的例子也给出了</span><code>parallel-syncs</code><span>参数来指定并行的同步实例数量，以免全部实例都在同步出现整体不可用的情况，相对来说要比手工的故障转移更加方便</span></li><li><span>分区逻辑需要自定义处理，虽然解决了主从下的高可用问题，但是Sentinel并没有提供分区解决方案，还需开发者考虑如何建设</span></li><li><span>既然是还是主从，如果异常的写流量搞垮了主节点，那么自动的“故障转移”会不会变成自动“灾难传递”，即slave提升为Master之后挂掉，又进行提升又被挂掉</span></li></ul><p>&nbsp;</p><h3 id='集群cluster-3'><span>集群(Cluster)</span></h3><p><strong><span>Cluster</span></strong><span>在分区管理上，使用了“</span><strong><span>哈希槽</span></strong><span>”(hash slot)这么一个概念，一共有</span><strong><span>16384</span></strong><span>个槽位，每个实例负责一部分</span><strong><span>槽</span></strong><span>，通过</span><code>CRC16（key）&amp;16383</code><span>这样的公式，计算出来key所对应的槽位。</span></p><p>&nbsp;</p><p><strong><span>使用方式</span></strong></p><p><span>配置文件</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cluster-enabled yes</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cluster-config-file "redis-node.conf"</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>启动命令</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">--cluster</span> create <span class="cm-number">127</span>.0.0.1:7000 <span class="cm-number">127</span>.0.0.1:7001 \</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">127</span>.0.0.1:7002 <span class="cm-number">127</span>.0.0.1:7003 <span class="cm-number">127</span>.0.0.1:7004 <span class="cm-number">127</span>.0.0.1:7005 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--cluster-replicas</span> <span class="cm-number">1</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>存在问题</span></strong></p><ul><li><span>虽然是对分区良好支持，但也有一些分区的老问题。如如果不在同一个“槽”的数据，是没法使用类似mset的</span><strong><span>多键操作</span></strong></li><li><span>在select命令页有提到, 集群模式下只能使用一个库，虽然平时一般也是这么用的，但是要了解一下</span></li><li><span>运维上也要谨慎，俗话说得好，“</span><strong><span>使用越简单底层越复杂</span></strong><span>”，启动搭建是很方便，使用时面对带宽消耗，数据倾斜等等具体问题时，还需人工介入，或者研究合适的配置参数</span></li></ul><p>&nbsp;</p><h2 id='常见问题'><span>常见问题</span></h2><p><strong><span>题目</span></strong><span>：保证Redis 中的 20w 数据都是热点数据 说明是 被频繁访问的数据，并且要保证Redis的内存能够存放20w数据，要计算出Redis内存的大小。</span></p><ul><li><strong><span>保留热点数据：</span></strong><span>对于保留 Redis 热点数据来说，我们可以使用 Redis 的内存淘汰策略来实现，可以使用</span><strong><span>allkeys-lru淘汰策略，</span></strong><span>该淘汰策略是从 Redis 的数据中挑选最近最少使用的数据删除，这样频繁被访问的数据就可以保留下来了</span></li><li><strong><span>保证 Redis 只存20w的数据：</span></strong><span>1个中文占2个字节，假如1条数据有100个中文，则1条数据占200字节，20w数据 乘以 200字节 等于 4000 字节（大概等于38M）;所以要保证能存20w数据，Redis 需要38M的内存</span></li></ul><p>&nbsp;</p><p><strong><span>题目：MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据?</span></strong></p><p><span>限定 Redis 占用的内存，Redis 会根据自身数据淘汰策略，加载热数据到内存。所以，计算一下 20W 数据大约占用的内存，然后设置一下 Redis 内存限制即可。</span></p><p>&nbsp;</p><p><strong><span>题目：假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？</span></strong></p><p><span>使用 keys 指令可以扫出指定模式的 key 列表。对方接着追问：如果这个 Redis 正在给线上的业务提供服务，那使用 keys 指令会有什么问题？这个时候你要回答 Redis 关键的一个特性：Redis 的单线程的。keys 指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用 scan 指令，scan 指令可以无阻塞地提取出指定模式的 key 列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用 keys 指令长。</span></p><p>&nbsp;</p><h1 id='kafka'><span>Kafka</span></h1><p>&nbsp;</p><h1 id='rocketmq'><span>RocketMQ</span></h1><p><span>RocketMQ 是阿里巴巴开源的分布式消息中间件。支持事务消息、顺序消息、批量消息、定时消息、消息回溯等。它里面有几个区别于标准消息中件间的概念，如Group、Topic、Queue等。系统组成则由Producer、Consumer、Broker、NameServer等。</span></p><p>&nbsp;</p><p><strong><span>功能优势</span></strong></p><ul><li><strong><span>削峰填谷</span></strong><span>：主要解决瞬时写压力大于应用服务能力导致消息丢失、系统奔溃等问题</span></li><li><strong><span>应用解耦</span></strong><span>：解决不同重要程度、不同能力级别系统之间依赖导致一死全死</span></li><li><strong><span>提升性能</span></strong><span>：当存在一对多调用时，可以发一条消息给消息系统，让消息系统通知相关系统</span></li><li><strong><span>蓄流压测</span></strong><span>：线上有些链路不好压测，可以通过堆积一定量消息再放开来压测</span></li><li><strong><span>异步处理</span></strong><span>：不需要同步执行的远程调用可以有效提高响应时间</span></li></ul><p>&nbsp;</p><h2 id='架构设计'><span>架构设计</span></h2><h3 id='部署模型'><span>部署模型</span></h3><p><img src="images/Middleware/1090617-20190626233829426-1023022108.png" referrerpolicy="no-referrer" alt="img"></p><p>&nbsp;</p><h3 id='角色'><span>角色</span></h3><h4 id='broker'><span>Broker</span></h4><ul><li><span>理解成RocketMQ本身</span></li><li><span>Broker主要用于Producer和Consumer接收和发送消息</span></li><li><span>Broker会定时向NameSrver提交自己的信息</span></li><li><span>是消息中间件的消息存储、转发服务器</span></li><li><span>每个Broker节点在启动时都会遍历NameServer列表，与每个NameServer建立长连接，注册自己的信息，之后定时上报</span></li></ul><p>&nbsp;</p><h4 id='nameserver'><span>NameServer</span></h4><ul><li><span>理解成Zookeeper的效果，只是他没用zk，而是自己写了个NameServer来替代zk</span></li><li><span>底层由Netty实现，提供了路由管理、服务注册、服务发现的功能，是一个无状态节点</span></li><li><span>NameServer是服务发现者，集群中各个角色（Producer、Broker、Consumer等）都需要定时向NameServer上报自己的状态，以便互相发现彼此，超时不上报的话，NameServer会把它从列表中剔除</span></li><li><span>NameServer可以部署多个，当多个NameServer存在的时候，其他角色同时向他们上报信息，以保证高可用，</span></li><li><span>NameServer集群间互不通信，没有主备的概念</span></li><li><span>NameServer内存式存储，NameServer中的Broker、Topic等信息默认不会持久化，所以他是无状态节点</span></li></ul><p>&nbsp;</p><h4 id='producer-1'><span>Producer</span></h4><ul><li><span>消息的生产者</span></li><li><span>随机选择其中一个NameServer节点建立长连接，获得Topic路由信息（包括Topic下的Queue，这些Queue分布在哪些Broker上等等）</span></li><li><span>接下来向提供Topic服务的Master建立长连接（因为RocketMQ只有Master才能写消息），且定时向Master发送心跳</span></li></ul><p>&nbsp;</p><h4 id='consumer-1'><span>Consumer</span></h4><ul><li><span>消息的消费者</span></li><li><span>通过NameServer集群获得Topic的路由信息，连接到对应的Broker上消费消息</span></li><li><span>由于Master和Slave都可以读取消息，因此Consumer会与Master和Slave都建立连接进行消费消息</span></li></ul><p>&nbsp;</p><h3 id='核心流程-1'><span>核心流程</span></h3><ul><li><span>Broker都注册到Nameserver上</span></li><li><span>Producer发消息的时候会从Nameserver上获取发消息的Topic信息</span></li><li><span>Producer向提供服务的所有Master建立长连接，且定时向Master发送心跳</span></li><li><span>Consumer通过NameServer集群获得Topic的路由信息</span></li><li><span>Consumer会与所有的Master和所有的Slave都建立连接进行监听新消息</span></li></ul><p>&nbsp;</p><h3 id='实现原理'><span>实现原理</span></h3><p><span>RocketMQ由NameServer注册中心集群、Producer生产者集群、Consumer消费者集群和若干Broker（RocketMQ进程）组成，它的架构原理是这样的：</span></p><ul><li><span>Broker在启动的时候去向所有的NameServer注册，并保持长连接，每30s发送一次心跳</span></li><li><span>Producer在发送消息的时候从NameServer获取Broker服务器地址，根据负载均衡算法选择一台服务器来发送消息</span></li><li><span>Conusmer消费消息的时候同样从NameServer获取Broker地址，然后主动拉取消息来消费</span></li></ul><p><img src="images/Middleware/RocketMQ实现原理.jpg" referrerpolicy="no-referrer" alt="RocketMQ实现原理"></p><p>&nbsp;</p><h2 id='核心概念'><span>核心概念</span></h2><h3 id='message消息'><span>Message(消息)</span></h3><p><span>消息载体。Message发送或者消费的时候必须指定Topic。Message有一个可选的Tag项用于过滤消息，还可以添加额外的键值对。</span></p><p>&nbsp;</p><h3 id='topic主题'><span>Topic(主题)</span></h3><p><span>消息的逻辑分类，发消息之前必须要指定一个topic才能发，就是将这条消息发送到这个topic上。消费消息的时候指定这个topic进行消费。就是逻辑分类。</span></p><p>&nbsp;</p><h3 id='queue队列'><span>Queue(队列)</span></h3><p><span>1个Topic会被分为N个Queue，数量是可配置的。message本身其实是存储到queue上的，消费者消费的也是queue上的消息。多说一嘴，比如1个topic4个queue，有5个Consumer都在消费这个topic，那么会有一个consumer浪费掉了，因为负载均衡策略，每个consumer消费1个queue，5&gt;4，溢出1个，这个会不工作。</span></p><p>&nbsp;</p><h3 id='tag标签'><span>Tag(标签)</span></h3><p><span>Tag 是 Topic 的进一步细分，顾名思义，标签。每个发送的时候消息都能打tag，消费的时候可以根据tag进行过滤，选择性消费。</span></p><p>&nbsp;</p><h3 id='消费模式message-model'><span>消费模式(Message Model)</span></h3><p><span>消息模型：集群（Clustering）和广播（Broadcasting）</span></p><h4 id='集群模式clustering'><span>集群模式(Clustering)</span></h4><p><span>生产者往某个队列里面发送消息，一个队列可以存储多个生产者的消息，一个队列也可以有多个消费者，但是消费者之间是竞争关系，即每条消息只能被一个消费者消费。</span></p><p><img src="images/Middleware/集群模式.jpg" referrerpolicy="no-referrer" alt="集群模式"></p><ul><li><span>每条消息只需要被处理一次，Broker只会把消息发送给消费集群中的一个消费者</span></li><li><span>在消息重投时，不能保证路由到同一台机器上</span></li><li><span>消费状态由Broker维护</span></li></ul><p>&nbsp;</p><h4 id='广播模式broadcasting'><span>广播模式(Broadcasting)</span></h4><p><strong><span>为了解决一条消息能被多个消费者消费的问题</span></strong><span>，发布/订阅模型就来了。该模型是将消息发往一个</span><code>Topic</code><span>即主题中，所有订阅了这个 </span><code>Topic</code><span> 的订阅者都能消费这条消息。</span></p><p><img src="images/Middleware/广播模式.jpg" referrerpolicy="no-referrer" alt="广播模式"></p><ul><li><span>消费进度由Consumer维护</span></li><li><span>保证每个消费者都消费一次消息</span></li><li><span>消费失败的消息不会重投</span></li></ul><p>&nbsp;</p><h3 id='message-order消息顺序'><span>Message Order(消息顺序)</span></h3><p><span>消息顺序：顺序（Orderly）和并发（Concurrently）</span></p><h4 id='顺序orderly）'><span>顺序（Orderly）</span></h4><p>&nbsp;</p><h4 id='并发concurrently）'><span>并发（Concurrently）</span></h4><p>&nbsp;</p><h3 id='producer-group生产组'><span>Producer Group(生产组)</span></h3><p><span>消息生产者组。标识发送同一类消息的Producer，通常发送逻辑一致。发送普通消息的时候，仅标识使用，并无特别用处。若事务消息，如果某条发送某条消息的producer-A宕机，使得事务消息一直处于PREPARED状态并超时，则broker会回查同一个group的其 他producer，确认这条消息应该commit还是rollback。但开源版本并不完全支持事务消息（阉割了事务回查的代码）。</span></p><p>&nbsp;</p><h3 id='consumer-group消费组'><span>Consumer Group(消费组)</span></h3><p><span>消息消费者组。标识一类Consumer的集合名称，这类Consumer通常消费一类消息，且消费逻辑一致。同一个Consumer Group下的各个实例将共同消费topic的消息，起到负载均衡的作用。消费进度以Consumer Group为粒度管理，不同Consumer Group之间消费进度彼此不受影响，即消息A被Consumer Group1消费过，也会再给Consumer Group2消费。</span></p><p><span>注： RocketMQ要求同一个Consumer Group的消费者必须要拥有相同的注册信息，即必须要听一样的topic(并且tag也一样)。</span></p><p>&nbsp;</p><h3 id='offset'><span>Offset</span></h3><p><span>在 Topic 的消费过程中，由于消息需要被不同的组进行多次消费，所以消费完的消息并不会立即被删除，这就需要 RocketMQ 为每个消费组在每个队列上维护一个消费位置（Consumer Offset），这个位置之前的消息都被消费过，之后的消息都没有被消费过，每成功消费一条消息，消费位置就加一。这个消费位置是非常重要的概念，我们在使用消息队列的时候，丢消息的原因大多是由于消费位置处理不当导致的。</span></p><p><img src="images/Middleware/RocketMQ-Offset.png" referrerpolicy="no-referrer" alt="RocketMQ-Offset"></p><p>&nbsp;</p><h2 id='核心设计-1'><span>核心设计</span></h2><h3 id='消息清理'><span>消息清理</span></h3><p><span>Broker中的消息被消费后不会立即删除，每条消息都会持久化到CommitLog中，每个Consumer连接到Broker后会维持消费进度信息，当有消息消费后只是当前Consumer的消费进度（CommitLog的offset）更新了。默认48小时后会删除不再使用的CommitLog文件：</span></p><ul><li><span>检查这个文件最后访问时间</span></li><li><span>判断是否大于过期时间</span></li><li><span>指定时间删除，默认凌晨4点</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@link org.apache.rocketmq.store.DefaultMessageStore.CleanCommitLogService#isTimeToDelete()}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">isTimeToDelete</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// when = "04";</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">when</span> <span class="cm-operator">=</span> <span class="cm-variable">DefaultMessageStore</span>.<span class="cm-keyword">this</span>.<span class="cm-variable">getMessageStoreConfig</span>().<span class="cm-variable">getDeleteWhen</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 是04点，就返回true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">UtilAll</span>.<span class="cm-variable">isItTimeToDo</span>(<span class="cm-variable">when</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">// 不是04点，返回false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@link org.apache.rocketmq.store.DefaultMessageStore.CleanCommitLogService#deleteExpiredFiles()}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">void</span> <span class="cm-def">deleteExpiredFiles</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// isTimeToDelete()这个方法是判断是不是凌晨四点，是的话就执行删除逻辑。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">isTimeToDelete</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 默认是72，但是broker配置文件默认改成了48，所以新版本都是48。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">long</span> <span class="cm-variable">fileReservedTime</span> <span class="cm-operator">=</span> <span class="cm-number">48</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">deleteCount</span> <span class="cm-operator">=</span> <span class="cm-variable">DefaultMessageStore</span>.<span class="cm-keyword">this</span>.<span class="cm-variable">commitLog</span>.<span class="cm-variable">deleteExpiredFile</span>(<span class="cm-number">72</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>, <span class="cm-variable">xx</span>, <span class="cm-variable">xx</span>, <span class="cm-variable">xx</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@link org.apache.rocketmq.store.CommitLog#deleteExpiredFile()}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-def">deleteExpiredFile</span>(<span class="cm-variable">xxx</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 这个方法的主逻辑就是遍历查找最后更改时间+过期时间，小于当前系统时间的话就删了（也就是小于48小时）。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-variable">mappedFileQueue</span>.<span class="cm-variable">deleteExpiredFileByTime</span>(<span class="cm-number">72</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">60</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>, <span class="cm-variable">xx</span>, <span class="cm-variable">xx</span>, <span class="cm-variable">xx</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 950px;"></div><div class="CodeMirror-gutters" style="display: none; height: 950px;"></div></div></div></pre><p>&nbsp;</p><h3 id='push-or-pull'><span>push or pull</span></h3><p><span>RocketMQ没有真正意义的push，都是pull，虽然有push类，但实际底层实现采用的是</span><strong><span>长轮询机制</span></strong><span>，即拉取方式。Broker端属性 </span><code>longPollingEnable</code><span> 标记是否开启长轮询，默认开启。源码如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// {@link org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#pullMessage()}</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 拉取消息，结果放到pullCallback里</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">this</span>.<span class="cm-variable">pullAPIWrapper</span>.<span class="cm-variable">pullKernelImpl</span>(<span class="cm-variable">pullCallback</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><strong><span>为什么要主动拉取消息而不使用事件监听方式？</span></strong></p><p><span>事件驱动方式是建立好长连接，由事件（发送数据）的方式来实时推送。如果broker主动推送消息的话有可能push速度快，消费速度慢的情况，那么就会造成消息在consumer端堆积过多，同时又不能被其他consumer消费的情况。而pull的方式可以根据当前自身情况来pull，不会造成过多的压力而造成瓶颈。所以采取了pull的方式。</span></p><p>&nbsp;</p><h3 id='负载均衡-1'><span>负载均衡</span></h3><p><span>RocketMQ通过Topic在多Broker中分布式存储实现。</span></p><h4 id='producer端'><span>Producer端</span></h4><p><span>发送端指定message queue发送消息到相应的broker，来达到写入时的负载均衡</span></p><ul><li><span>提升写入吞吐量，当多个producer同时向一个broker写入数据的时候，性能会下降</span></li><li><span>消息分布在多broker中，为负载消费做准备</span></li></ul><p>&nbsp;</p><p><strong><span>默认策略是随机选择：</span></strong></p><ul><li><span>producer维护一个index</span></li><li><span>每次取节点会自增</span></li><li><span>index向所有broker个数取余</span></li><li><span>自带容错策略</span></li></ul><p>&nbsp;</p><p><strong><span>其他实现：</span></strong></p><ul><li><p><span>SelectMessageQueueByHash</span></p></li><li><ul><li><span>hash的是传入的args</span></li></ul></li><li><p><span>SelectMessageQueueByRandom</span></p></li><li><p><span>SelectMessageQueueByMachineRoom 没有实现</span></p></li></ul><p><span>也可以自定义实现</span><strong><span>MessageQueueSelector</span></strong><span>接口中的select方法</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">MessageQueue</span> <span class="cm-def">select</span>(<span class="cm-keyword">final</span> <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">MessageQueue</span><span class="cm-operator">&gt;</span> <span class="cm-variable">mqs</span>, <span class="cm-keyword">final</span> <span class="cm-variable">Message</span> <span class="cm-variable">msg</span>, <span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">arg</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p>&nbsp;</p><h4 id='consumer端'><span>Consumer端</span></h4><p><span>采用的是平均分配算法来进行负载均衡。</span></p><p><strong><span>其他负载均衡算法</span></strong></p><ul><li><span>平均分配策略(默认)(AllocateMessageQueueAveragely)</span></li><li><span>环形分配策略(AllocateMessageQueueAveragelyByCircle)</span></li><li><span>手动配置分配策略(AllocateMessageQueueByConfig)</span></li><li><span>机房分配策略(AllocateMessageQueueByMachineRoom)</span></li><li><span>一致性哈希分配策略(AllocateMessageQueueConsistentHash)</span></li><li><span>靠近机房策略(AllocateMachineRoomNearby)</span></li></ul><p>&nbsp;</p><p><strong><span>当消费负载均衡Consumer和Queue不对等的时候会发生什么？</span></strong></p><p><span>Consumer和Queue会优先平均分配，如果Consumer少于Queue的个数，则会存在部分Consumer消费多个Queue的情况，如果Consumer等于Queue的个数，那就是一个Consumer消费一个Queue，如果Consumer个数大于Queue的个数，那么会有部分Consumer空余出来，白白的浪费了。</span></p><p>&nbsp;</p><h2 id='最佳实践'><span>最佳实践</span></h2><h3 id='producer-2'><span>Producer</span></h3><ul><li><p><strong><span>Topic</span></strong><span>：消息主题，通过Topic对不同的业务消息进行分类</span></p></li><li><p><strong><span>Tag</span></strong><span>：消息标签，用来进一步区分某个Topic下的消息分类，消息从生产者发出即带上的属性</span></p></li><li><p><strong><span>key</span></strong><span>：每个消息在业务层面的唯一标识码，要设置到 keys 字段，方便将来定位消息丢失问题。服务器会为每个消息创建索引(哈希索引)，应用可以通过 topic，key来查询这条消息内容，以及消息被谁消费。由于是哈希索引，请务必保证key 尽可能唯一，这样可以避免潜在的哈希冲突</span></p></li><li><p><strong><span>日志</span></strong><span>：消息发送成功或者失败，要打印消息日志，务必要打印 send result 和key 字段</span></p></li><li><p><strong><span>send</span></strong><span>：send消息方法，只要不抛异常，就代表发送成功。但是发送成功会有多个状态，在sendResult里定义</span></p><ul><li><strong><span>SEND_OK</span></strong><span>：消息发送成功</span></li><li><strong><span>FLUSH_DISK_TIMEOUT</span></strong><span>：消息发送成功，但是服务器刷盘超时，消息已经进入服务器队列，只有此时服务器宕机，消息才会丢失</span></li><li><strong><span>FLUSH_SLAVE_TIMEOUT</span></strong><span>：消息发送成功，但是服务器同步到Slave时超时，消息已经进入服务器队列，只有此时服务器宕机，消息才会丢失</span></li><li><strong><span>SLAVE_NOT_AVAILABLE</span></strong><span>：消息发送成功，但是此时slave不可用，消息已经进入服务器队列，只有此时服务器宕机，消息才会丢失</span></li></ul></li><li><p><strong><span>订阅关系一致</span></strong></p><p><span>多个Group ID订阅了多个Topic，并且每个Group ID里的多个消费者实例的订阅关系保持了一致。</span></p><p><img src="images/Middleware/RocketMQ消息正确订阅关系.png" referrerpolicy="no-referrer" alt="RocketMQ消息正确订阅关系"></p></li></ul><p>&nbsp;</p><h3 id='consumer-2'><span>Consumer</span></h3><ul><li><p><strong><span>消费幂等</span></strong></p><p><span>为了防止消息重复消费导致业务处理异常，消息队列RocketMQ版的消费者在接收到消息后，有必要根据业务上的唯一Key对消息做幂等处理。消息重复的场景如下：</span></p><ul><li><strong><span>发送时消息重复</span></strong></li><li><strong><span>投递时消息重复</span></strong></li><li><strong><span>负载均衡时消息重复</span></strong><span>（包括但不限于网络抖动、Broker重启以及消费者应用重启）</span></li></ul></li><li><p><strong><span>日志</span></strong><span>：消费时记录日志，以便后续定位问题</span></p></li><li><p><strong><span>批量消费</span></strong><span>：尽量使用批量方式消费方式，可以很大程度上提高消费吞吐量</span></p></li></ul><p>&nbsp;</p><h3 id='事务消息'><span>事务消息</span></h3><p><span>MQ与DB一致性原理（两方事务）</span></p><p><img src="images/Middleware/MQ与DB一致性原理.png" referrerpolicy="no-referrer" alt="MQ与DB一致性原理"></p><p><span>事务消息就是MQ提供的类似XA的分布式事务能力，通过事务消息可以达到分布式事务的最终一致性。半事务消息就是MQ收到了生产者的消息，但是没有收到二次确认，不能投递的消息。实现原理如下：</span></p><ul><li><span>生产者先发送一条半事务消息到MQ</span></li><li><span>MQ收到消息后返回ack确认</span></li><li><span>生产者开始执行本地事务</span></li><li><span>如果事务执行成功发送commit到MQ，失败发送rollback</span></li><li><span>如果MQ长时间未收到生产者的二次确认commit或者rollback，MQ对生产者发起消息回查</span></li><li><span>生产者查询事务执行最终状态</span></li><li><span>根据查询事务状态再次提交二次确认</span></li></ul><p><span>如果MQ收到二次确认commit，就可以把消息投递给消费者，反之如果是rollback，消息会保存下来并且在3天后被删除。</span></p><p><img src="images/Middleware/RocketMQ事务消息.jpg" referrerpolicy="no-referrer" alt="RocketMQ事务消息"></p><p>&nbsp;</p><h2 id='保证顺序'><span>保证顺序</span></h2><p><span>RocketMQ的消息是存储到Topic的Queue里面的，Queue本身是FIFO（First Int First Out）先进先出队列。所以单个Queue是可以保证有序性的。</span></p><p><span>顺序消息（FIFO 消息）是 MQ 提供的一种严格按照顺序进行发布和消费的消息类型。顺序消息由两个部分组成：</span></p><ul><li><strong><span>顺序发布</span></strong></li><li><strong><span>顺序消费</span></strong></li></ul><p>&nbsp;</p><p><span>顺序消息包含两种类型：</span></p><ul><li><strong><span>分区顺序</span></strong><span>：一个Partition内所有的消息按照先进先出的顺序进行发布和消费</span></li><li><strong><span>全局顺序</span></strong><span>：一个Topic内所有的消息按照先进先出的顺序进行发布和消费</span></li></ul><p>&nbsp;</p><p><img src="images/Middleware/471426-20180519131211273-554395305.png" referrerpolicy="no-referrer" alt="img"></p><p><span>对于两个订单的消息的原始数据：a1、b1、b2、a2、a3、b3（绝对时间下发生的顺序）：</span></p><ul><li><span>在发送时，a订单的消息需要保持a1、a2、a3的顺序，b订单的消息也相同，但是a、b订单之间的消息没有顺序关系，这意味着a、b订单的消息可以在不同的线程中被发送出去</span></li><li><span>在存储时，需要分别保证a、b订单的消息的顺序，但是a、b订单之间的消息的顺序可以不保证</span></li></ul><p>&nbsp;</p><h3 id='保持顺序发送'><span>保持顺序发送</span></h3><p><span>消息被发送时保持顺序。</span></p><p>&nbsp;</p><h3 id='保持顺序发送存储'><span>保持顺序发送存储</span></h3><p><span>消息被存储时保持和发送的顺序一致。</span></p><p>&nbsp;</p><h3 id='保持顺序消费'><span>保持顺序消费</span></h3><p><span>消息被消费时保持和存储的顺序一致。</span></p><h4 id='mqpullconsumer'><span>MQPullConsumer</span></h4><p><span>MQPullConsumer由用户控制线程，主动从服务端获取消息，每次获取到的是一个MessageQueue中的消息。PullResult中的List msgFoundList自然和存储顺序一致，用户需要再拿到这批消息后自己保证消费的顺序。</span></p><p>&nbsp;</p><h4 id='mqpushconsumer'><span>MQPushConsumer</span></h4><p><span>对于PushConsumer，由用户注册MessageListener来消费消息，在客户端中需要保证调用MessageListener时消息的顺序性。</span></p><p>&nbsp;</p><h2 id='消息不丢失'><span>消息不丢失</span></h2><p><span>一条消息从生产到被消费，将会经历三个阶段：</span></p><p><img src="images/Middleware/Rocket消息丢失.jpg" referrerpolicy="no-referrer" alt="Rocket消息丢失"></p><ul><li><span>生产阶段：Producer 新建消息，然后通过网络将消息投递给 MQ Broker</span></li><li><span>存储阶段：消息将会存储在 Broker 端磁盘中</span></li><li><span>消息阶段：Consumer 将会从 Broker 拉取消息</span></li></ul><p><span>以上任一阶段都可能会丢失消息，我们只要找到这三个阶段丢失消息原因，采用合理的办法避免丢失，就可以彻底解决消息丢失的问题。</span></p><p>&nbsp;</p><h3 id='生产阶段'><span>生产阶段</span></h3><p><span>Producer通过网络将消息发送给Broker，这个发送可能会发生丢失，比如网络延迟不可达等。</span></p><p><span>失败会自动重试，即使重试N次也不行后，那客户端也会知道消息没成功，这也可以自己补偿等，不会盲目影响到主业务逻辑。再比如即使Broker挂了，那还有其他Broker再提供服务了，高可用，不影响。</span></p><p><span>总结：</span><strong><span>同步发送+自动重试机制+多个Master节点</span></strong></p><p>&nbsp;</p><h4 id='同步发送'><span>同步发送</span></h4><p><span>有三种send方法，同步发送、异步发送、单向发送，可以采取同步发送的方式进行发送消息。</span></p><ul><li><strong><span>同步发送</span></strong><span>：发消息时会同步阻塞等待broker返回的结果，如果没成功，则不会收到SendResult，这种是最可靠的</span></li><li><strong><span>异步发送</span></strong><span>：在回调方法里可以得知是否发送成功</span></li><li><strong><span>单向发送（OneWay）</span></strong><span>：最不靠谱的一种发送方式，我们无法保证消息真正可达</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@link org.apache.rocketmq.client.producer.DefaultMQProducer}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 同步发送</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">SendResult</span> <span class="cm-def">send</span>(<span class="cm-variable">Message</span> <span class="cm-variable">msg</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">MQClientException</span>, <span class="cm-variable">RemotingException</span>, <span class="cm-variable">MQBrokerException</span>, <span class="cm-variable">InterruptedException</span> {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 异步发送，sendCallback作为回调</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">send</span>(<span class="cm-variable">Message</span> <span class="cm-variable">msg</span>,<span class="cm-variable">SendCallback</span> <span class="cm-variable">sendCallback</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">MQClientException</span>, <span class="cm-variable">RemotingException</span>, <span class="cm-variable">InterruptedException</span> {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 单向发送，不关心发送结果，最不靠谱</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">sendOneway</span>(<span class="cm-variable">Message</span> <span class="cm-variable">msg</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">MQClientException</span>, <span class="cm-variable">RemotingException</span>, <span class="cm-variable">InterruptedException</span> {}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h4 id='失败重试'><span>失败重试</span></h4><p><span>发送消息如果失败或者超时了，则会自动重试。默认是重试3次，可以根据api进行更改，比如改为10次：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">producer</span>.<span class="cm-variable">setRetryTimesWhenSendFailed</span>(<span class="cm-number">10</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>底层源码逻辑如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@link org.apache.rocketmq.client.producer.DefaultMQProducer#sendDefaultImpl(Message, CommunicationMode, SendCallback, long)}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 自动重试次数，this.defaultMQProducer.getRetryTimesWhenSendFailed()默认为2，如果是同步发送，默认重试3次，否则重试1次</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">timesTotal</span> <span class="cm-operator">=</span> <span class="cm-variable">communicationMode</span> <span class="cm-operator">==</span> <span class="cm-variable">CommunicationMode</span>.<span class="cm-variable">SYNC</span> <span class="cm-operator">?</span> <span class="cm-number">1</span> <span class="cm-operator">+</span> <span class="cm-keyword">this</span>.<span class="cm-variable">defaultMQProducer</span>.<span class="cm-variable">getRetryTimesWhenSendFailed</span>() : <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">int</span> <span class="cm-variable">times</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (; <span class="cm-variable">times</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">timesTotal</span>; <span class="cm-variable">times</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 选择发送的消息queue</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">MessageQueue</span> <span class="cm-variable">mqSelected</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">selectOneMessageQueue</span>(<span class="cm-variable">topicPublishInfo</span>, <span class="cm-variable">lastBrokerName</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">mqSelected</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 真正的发送逻辑，sendKernelImpl。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sendResult</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">sendKernelImpl</span>(<span class="cm-variable">msg</span>, <span class="cm-variable">mq</span>, <span class="cm-variable">communicationMode</span>, <span class="cm-variable">sendCallback</span>, <span class="cm-variable">topicPublishInfo</span>, <span class="cm-variable">timeout</span> <span class="cm-operator">-</span> <span class="cm-variable">costTime</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">switch</span> (<span class="cm-variable">communicationMode</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">ASYNC</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">ONEWAY</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">SYNC</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 如果发送失败了，则continue，意味着还会再次进入for，继续重试发送</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">sendResult</span>.<span class="cm-variable">getSendStatus</span>() <span class="cm-operator">!=</span> <span class="cm-variable">SendStatus</span>.<span class="cm-variable">SEND_OK</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-variable">defaultMQProducer</span>.<span class="cm-variable">isRetryAnotherBrokerWhenNotStoreOK</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 发送成功的话，将发送结果返回给调用者</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">sendResult</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">default</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">RemotingException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (...) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1037px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1037px;"></div></div></div></pre><p>&nbsp;</p><h4 id='故障切换'><span>故障切换</span></h4><p><span>假设Broker宕机了，但是生产环境一般都是多M多S的，所以还会有其他Master节点继续提供服务，这也不会影响到我们发送消息，我们消息依然可达。因为比如恰巧发送到broker的时候，broker宕机了，producer收到broker的响应发送失败了，这时候producer会自动重试，这时候宕机的broker就被踢下线了， 所以producer会换一台broker发送消息。</span></p><p>&nbsp;</p><h3 id='broker存储阶段'><span>Broker存储阶段</span></h3><p><span>若想很严格的保证Broker存储消息阶段消息不丢失，则需要如下配置，但是性能肯定远差于默认配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># master 节点配置</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">flushDiskType </span>=<span class="cm-quote"> SYNC_FLUSH</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">brokerRole</span>=<span class="cm-quote">SYNC_MASTER</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># slave 节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">brokerRole</span>=<span class="cm-quote">slave</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">flushDiskType </span>=<span class="cm-quote"> SYNC_FLUSH</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p><h4 id='设置broker同步刷盘策略'><span>设置Broker同步刷盘策略</span></h4><p><strong><span>设置Broker同步刷盘策略</span></strong><span>。默认情况下，消息只要到了 Broker 端，将会优先保存到内存中，然后立刻返回确认响应给生产者。随后 Broker 定期批量的将一组消息从内存异步刷入磁盘。这种方式减少 I/O 次数，可以取得更好的性能，但是如果发生机器断电，异常宕机等情况，消息还未及时刷入磁盘，就会出现丢失消息的情况。</span></p><p><span>若想保证 Broker 端不丢消息，保证消息的可靠性，我们需要将消息保存机制修改为同步刷盘方式，即消息</span><strong><span>存储磁盘成功</span></strong><span>，才会返回响应。修改 Broker 端配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认情况为 ASYNC_FLUSH </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">flushDiskType </span>=<span class="cm-quote"> SYNC_FLUSH </span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>若 Broker 未在同步刷盘时间内（</span><strong><span>默认为 5s</span></strong><span>）完成刷盘，将会返回 </span><code>SendStatus.FLUSH_DISK_TIMEOUT</code><span> 状态给生产者。</span></p><p>&nbsp;</p><h4 id='等待master和slave刷盘完'><span>等待Master和Slave刷盘完</span></h4><p><span>等待Master和Slave刷盘完。即使Broker设置了同步刷盘策略，但是Broker刷完盘后磁盘坏了，这会导致盘上的消息全丢了。但是如果即使是1主1从了，但是Master刷完盘后还没来得及同步给Slave就磁盘坏了，这会导致盘上的消息全丢了。所以我们还可以配置不仅是等Master刷完盘就通知Producer，而是等Master和Slave都刷完盘后才去通知Producer说消息ok了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认为 ASYNC_MASTER</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">brokerRole</span>=<span class="cm-quote">SYNC_MASTER</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p>&nbsp;</p><h3 id='消费阶段'><span>消费阶段</span></h3><p><span>消费失败了其实也是消息丢失的一种变体。</span></p><p><span>只有当消费模式为 </span><strong><span>MessageModel.CLUSTERING(集群模式)</span></strong><span> 时，Broker 才会自动进行重试，对于广播消息是不会重试的。对于一直无法消费成功的消息，RocketMQ 会在达到最大重试次数之后，将该消息投递至死信队列。然后我们需要关注死信队列，并对该死信消息业务做人工的补偿操作。</span></p><h4 id='手动ack确认'><span>手动ACK确认</span></h4><p><span>消费者会先把消息拉取到本地，然后进行业务逻辑，业务逻辑完成后手动进行ack确认，这时候才会真正的代表消费完成。而不是说pull到本地后消息就算消费完了。举个例子</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">consumer</span>.<span class="cm-variable">registerMessageListener</span>(<span class="cm-keyword">new</span> <span class="cm-variable">MessageListenerConcurrently</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">public</span> <span class="cm-variable">ConsumeConcurrentlyStatus</span> <span class="cm-variable">consumeMessage</span>(<span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">MessageExt</span><span class="cm-operator">&gt;</span> <span class="cm-variable">msgs</span>, <span class="cm-variable">ConsumeConcurrentlyContext</span> <span class="cm-variable">consumeConcurrentlyContext</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">try</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">for</span> (<span class="cm-variable">MessageExt</span> <span class="cm-variable">msg</span> : <span class="cm-variable">msgs</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-variable-3">String</span> <span class="cm-variable">str</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">msg</span>.<span class="cm-variable">getBody</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">str</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-tab" role="presentation" cm-text="	">   </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-variable">ConsumeConcurrentlyStatus</span>.<span class="cm-variable">CONSUME_SUCCESS</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; } <span class="cm-keyword">catch</span>(<span class="cm-variable">Throwable</span> <span class="cm-variable">t</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">log</span>.<span class="cm-variable">error</span>(<span class="cm-string">"消费异常:{}"</span>, <span class="cm-variable">msgs</span>, <span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-variable">ConsumeConcurrentlyStatus</span>.<span class="cm-variable">RECONSUME_LATER</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> });</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 367px;"></div><div class="CodeMirror-gutters" style="display: none; height: 367px;"></div></div></div></pre><p>&nbsp;</p><h4 id='消费异常自动重试'><span>消费异常自动重试</span></h4><ul><li><span>业务消费方返回 ConsumeConcurrentlyStatus.RECONSUME_LATER</span></li><li><span>业务消费方返回 null</span></li><li><span>业务消费方主动/被动抛出异常</span></li></ul><p><span>针对以上3种情况下，Broker一般会进行重试（默认最大重试16次），RocketMQ 采用了“时间衰减策略”进行消息的重复投递，即重试次数越多，消息消费成功的可能性越小。我们可以在 RocketMQ 的 </span><code>broker.conf</code><span> 配置文件中配置 Consumer 侧重试次数及时间间隔（</span><strong><span>距离第1次发送的时间间隔</span></strong><span>）, 配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def"> &nbsp;  messageDelayLevel</span>=<span class="cm-quote">1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>消费者客户端，首先判断消费端有没有显式设置最大重试次数 MaxReconsumeTimes， 如果没有，则设置默认重试次数为 16，否则以设置的最大重试次数为准。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-def">getMaxReconsumeTimes</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// default reconsume times: 16</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-variable">defaultMQPushConsumer</span>.<span class="cm-variable">getMaxReconsumeTimes</span>() <span class="cm-operator">==</span> <span class="cm-operator">-</span><span class="cm-number">1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-number">16</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-variable">defaultMQPushConsumer</span>.<span class="cm-variable">getMaxReconsumeTimes</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p>&nbsp;</p><h4 id='消费超时无线重试'><span>消费超时无线重试</span></h4><p><span>如果是消费超时情况，MQ会无限制的发送给消费端。这种情况就是Consumer端没有返回</span><code>ConsumeConcurrentlyStatus. CONSUME_SUCCESS</code><span>，也没有返回</span><code>ConsumeConcurrentlyStatus.RECONSUME_LATER</code><span>。</span></p><p>&nbsp;</p><h4 id='死信队列'><span>死信队列</span></h4><p><span>死信的处理逻辑：</span></p><ul><li><span>首先判断消息当前重试次数是否大于等于 16，或者消息延迟级别是否小于 0</span></li><li><span>只要满足上述的任意一个条件，设置新的 topic（死信 topic）为：</span><strong><span>%DLQ%+consumerGroup</span></strong></li><li><span>进行前置属性的添加</span></li><li><span>将死信消息投递到上述步骤 2 建立的死信 topic 对应的死信队列中并落盘，使消息持久化</span></li></ul><p><span>最后单独启动一个死信队列的消费者进行消费，然后进行人工干预处理失败的消息。</span></p><p>&nbsp;</p><h2 id='消息幂等'><span>消息幂等</span></h2><p><span>在所有消息系统中消费消息有三种模式：</span><code>at-most-once</code><span>（最多一次）、</span><code>at-least-once</code><span>（最少一次）和 </span><code>exactly-only-once</code><span>（精确仅一次），分布式消息系统都是在三者间取平衡，前两者是可行的并且被广泛使用。</span></p><ul><li><p><code>at-most-once</code><span>：消息投递后不论消息是否被消费成功，不会再重复投递，有可能会导致消息未被消费，RocketMQ 未使用该方式</span></p></li><li><p><code>at-lease-once</code><span>：消息投递后，消费完成后，向服务器返回 ACK，没有消费则一定不会返回 ACK 消息。由于网络异常、客户端重启等原因，服务器未能收到客户端返回的 ACK，服务器则会再次投递，这就会导致可能重复消费，RocketMQ 通过 ACK 来确保消息至少被消费一次</span></p></li><li><p><code>exactly-only-once</code><span>：在分布式系统环境下，如果要实现该模式，巨大的开销不可避免。RocketMQ 没有保证此特性，无法避免消息重复，由业务上进行幂等性处理。必须下面两个条件都满足，才能认为消息是&quot;Exactly Only Once&quot;： </span></p><ul><li><span>发送消息阶段，不允许发送重复消息</span></li><li><span>消费消息阶段，不允许消费重复的消息</span></li></ul></li></ul><p>&nbsp;</p><h1 id='zookeeper'><span>Zookeeper</span></h1><p><strong><span>下载地址：</span></strong><a href='http://www.apache.org/dist/zookeeper/' target='_blank' class='url'>http://www.apache.org/dist/zookeeper/</a></p><h2 id='节点角色'><span>节点角色</span></h2><h3 id='leader'><span>Leader</span></h3><ul><li><span>负责处理客户端发送的</span><code>读、写事务请求</code><span>。这里的事务请求可以理解这个请求具有事务的 ACID 特性</span></li><li><span>同步</span><code>写事务请求</code><span>给其他节点，且需要保证事务的顺序性</span></li><li><span>状态为 LEADING</span></li></ul><h3 id='follower'><span>Follower</span></h3><ul><li><span>负责处理客户端发送的读请求</span></li><li><span>转发写事务请求给 Leader</span></li><li><span>参与 Leader 的选举</span></li><li><span>状态为 FOLLOWING</span></li></ul><h3 id='observer'><span>Observer</span></h3><p><span>和 Follower 一样，唯一不同的是，不参与 Leader 的选举，且状态为 OBSERING。可以用来线性扩展读的 QPS。</span></p><p>&nbsp;</p><h2 id='核心流程设计'><span>核心流程设计</span></h2><h3 id='启动阶段-leader选举'><span>启动阶段 Leader选举</span></h3><p><span>Zookeeper 刚启动的时候，多个节点需要找出一个 Leader。怎么找呢，就是用</span><code>投票</code><span>。比如集群中有两个节点，A 和 B，原理图如下所示：</span></p><p><img src="images/Middleware/启动阶段Leader选举.png" referrerpolicy="no-referrer" alt="启动阶段Leader选举"></p><ul><li><span>节点 A 先</span><code>投票给自己</code><span>，投票信息包含</span><code>节点 id（SID)</code><span> 和一个 </span><code>ZXID</code><span>，如 （1,0）。SID 是配置好的，且唯一，ZXID 是唯一的递增编号</span></li><li><span>节点 B 先</span><code>投票给自己</code><span>，投票信息为（2,0）</span></li><li><span>然后节点 A 和 B 将自己的投票信息</span><code>投票</code><span>给集群中</span><code>所有节点</code></li><li><span>节点 A 收到节点 B 的投票信息后，</span><code>检查</code><span>下节点 B 的状态是否是</span><code>本轮投票</code><span>，以及是否是</span><code>正在选举(LOOKING)</code><span>的状态</span></li><li><span>投票 PK：节点 A 会将自己的投票和别人的投票进行 PK，如果别的节点发过来的 ZXID 较大，则把自己的投票信息</span><code>更新</code><span>为别的节点发过来的投票信息，</span><strong><span>如果 ZXID 相等，则比较 SID</span></strong><span>。这里节点 A 和 节点 B 的 ZXID 相同，SID 的话，节点 B 要大些，所以节点 A 更新投票信息为（2，0），然后将投票信息</span><code>再次</code><span>发送出去。而节点 B </span><code>不需要更新</code><span>投票信息，但是下一轮还需要再次将投票发出去。这个时候节点 A 的投票信息为（2，0），如下图所示：</span></li></ul><p><img src="images/Middleware/启动阶段Leader选举-阶段信息.png" referrerpolicy="no-referrer" alt="启动阶段Leader选举-阶段信息"></p><ul><li><span>统计投票：每一轮投票，都会统计每台节点收到的投票信息，判断是否有</span><code>过半的节点</code><span>收到了</span><code>相同</code><span>的投票信息。节点 A 和 节点 B 收到的投票信息都为（2，0），且数量来说，大于一半节点的数量，所以将节点 B 选出来作为 Leader</span></li><li><span>更新节点状态：节点 A 作为 </span><code>Follower</code><span>，更新状态为 FOLLOWING，节点 B 作为 </span><code>Leader</code><span>，更新状态为 LEADING</span></li></ul><p>&nbsp;</p><h3 id='运行期间leader宕机处理'><span>运行期间Leader宕机处理</span></h3><p><span>在 Zookeeper 运行期间，Leader 会一直保持为 LEADING 状态，直到 Leader 宕机了，这个时候就要重新选 Leader，而选举过程和启动阶段的选举过程基本一致。需要注意的点：</span></p><ul><li><span>剩下的 Follower 进行选举，Observer 不参与选举</span></li><li><span>投票信息中的 zxid 用的是本地磁盘日志文件中的。如果这个节点上的 zxid 较大，就会被当选为 Leader。如果 Follower 的 zxid 都相同，则 Follower 的节点 id 较大的会被选为 Leader</span></li></ul><p>&nbsp;</p><h3 id='节点之间同步数据流程'><span>节点之间同步数据流程</span></h3><p><span>不同的客户端可以分别连接到主节点或备用节点。而客户端发送读写请求时是不知道自己连的是Leader 还是 Follower，</span><strong><span>如果客户端连的是主节点</span></strong><span>，发送了写请求，那么 Leader 执行 2PC（两阶段提交协议）同步给其他 Follower 和 Observer 就可以了。但是</span><strong><span>如果客户端连的是 Follower</span></strong><span>，发送了写请求，那么 Follower 会将写请求转发给 Leader，然后 Leader 再进行 2PC 同步数据给 Follower。两阶段提交协议：</span></p><ul><li><strong><span>第一阶段</span></strong><span>：Leader 先发送 proposal 给 Follower，Follower 发送 ack 响应给 Leader。如果收到的 ack 过半，则进入下一阶段</span></li><li><strong><span>第二阶段</span></strong><span>： Leader 从磁盘日志文件中加载数据到内存中，Leader 发送 commit 消息给 Follower，Follower 加载数据到内存中</span></li></ul><p>&nbsp;</p><p><span>我们来看下 Leader 同步数据的流程：</span></p><p><img src="images/Middleware/Leader同步数据的流程.png" referrerpolicy="no-referrer" alt="Leader同步数据的流程"></p><ul><li><span>① 客户端发送写事务请求</span></li><li><span>② Leader 收到写请求后，转化为一个 &quot;proposal01：zxid1&quot; 事务请求，存到磁盘日志文件</span></li><li><span>③ 发送 proposal 给其他 Follower</span></li><li><span>④ Follower 收到 proposal 后，Follower 写磁盘日志文件</span></li></ul><p><span>接着我们看下 Follower 收到 Leader 发送的 proposal 事务请求后，怎么处理的：</span></p><p><img src="images/Middleware/Follower收到事务请求处理流程.png" referrerpolicy="no-referrer" alt="Follower收到事务请求处理流程"></p><ul><li><span>⑤ Follower 返回 ack 给 Leader</span></li><li><span>⑥ Leader 收到超过一半的 ack，进行下一阶段</span></li><li><span>⑦ Leader 将磁盘中的日志文件的 proposal 加载到 znode 内存数据结构中</span></li><li><span>⑧ Leader 发送 commit 消息给所有 Follower 和 Observer</span></li><li><span>⑨ Follower 收到 commit 消息后，将 磁盘中数据加载到 znode 内存数据结构中</span></li></ul><p><span>现在Leader和Follower的数据都是在内存数据中的，且是一致的，客户端从Leader和Follower读到的数据都是一致的。</span></p><p>&nbsp;</p><h3 id='zab顺序一致性原理'><span>ZAB顺序一致性原理</span></h3><p><span>Leader 发送 proposal 时，其实会为每个 Follower 创建一个队列，都往各自的队列中发送 proposal。如下图所示是 Zookeeper 的消息广播流程：</span></p><p><img src="images/Middleware/Zookeeper的消息广播流程.png" referrerpolicy="no-referrer" alt="Zookeeper的消息广播流程"></p><p><span>客户端发送了三条写事务请求，对应的 proposal 为</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">proposal01</span>:<span class="cm-quote">zxid1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">proposal02</span>:<span class="cm-quote">zxid2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">proposal03</span>:<span class="cm-quote">zxid3</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><span>Leader 收到请求后，依次放到队列中，然后 Follower 依次从队列中获取请求，这样就保证了数据的顺序性。</span></p><p>&nbsp;</p><h3 id='zookeeper是否是强一致性'><span>Zookeeper是否是强一致性</span></h3><blockquote><p><span>官方定义：顺序一致性。</span></p></blockquote><p><span>不保证强一致性，为什么呢？</span></p><p><span>因为 Leader 再发送 commit 消息给所有 Follower 和 Observer 后，它们并不是同时完成 commit 的。比如因为</span><code>网络原因</code><span>，不同节点收到的 commit 较晚，那么提交的时间也较晚，就会出现多个节点的数据不一致，但是经过短暂的时间后，所有节点都 commit 后，数据就保持同步了。另外 Zookeeper 支持强一致性，就是手动调用 sync 方法来保证所有节点都 commit 才算成功。</span></p><p><span>这里有个问题：如果某个节点 commit 失败，那么 Leader 会进行重试吗？如何保证数据的一致性？</span></p><p>&nbsp;</p><h3 id='leader-宕机数据丢失问题'><span>Leader 宕机数据丢失问题</span></h3><p><strong><span>第一种情况</span></strong><span>：假设 Leader 已经将消息写入了本地磁盘，但是还没有发送 proposal 给 Follower，这个时候 Leader 宕机了。那就需要选新的 Leader，新 Leader 发送 proposal 的时候，包含的 zxid 自增规律会发生一次变化：</span></p><ul><li><span>zxid 的高 32 位自增 1 一次，高 32 位代表 Leader 的版本号。</span></li><li><span>zxid 的低 32 位自增 1，后续还是继续保持自增长。</span></li></ul><p><span>当老 Leader 恢复后，会转成 Follower，Leader 发送最新的 proposal 给它时，发现本地磁盘的 proposal 的 zxid 的高 32 位小于新 Leader 发送的 proposal，就丢弃自己的 proposal。</span></p><p><strong><span>第二种情况</span></strong><span>：如果 Leader 成功发送了 commit 消息给 Follower，但是所有或者部分 Follower 还没来得及 commit 这个 proposal，也就是加载磁盘中的 proposal 到 内存中，这个时候 Leader 宕机了。</span></p><p><span>那么就需要选出磁盘日志中 zxid 最大的 Follower，如果 zxid 相同，则比较节点 id，节点 id 大的作为 Leader。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='zk特性'><span>ZK特性</span></h2><p><span>Zookeeper主要靠其 </span><strong><span>分布式数据一致性</span></strong><span> 为集群提供 </span><strong><span>分布式协调服务</span></strong><span>，即指在集群的节点中进行可靠的消息传递，来协调集群的工作。主要具有如下特点：</span></p><ul><li><p><strong><span>最终一致性：</span></strong><span>Client无论连接到哪个Server，展示给它都是同一个视图，这是zookeeper最重要的性能</span></p></li><li><p><strong><span>可靠性：</span></strong><span>如果一个消息或事物被一台Server接受，那么它将被所有的服务器接受</span></p></li><li><p><strong><span>实时性：</span></strong><span>Zookeeper不能保证强一致性，只保证顺序一致性和最终一致性，因此称为</span><strong><span>伪实时性</span></strong><span>。由于网络延时等原因，Zookeeper不能保证两个客户端能同时得到刚更新的数据，如果需要最新数据，应该在读数据之前调用sync()接口</span></p></li><li><p><strong><span>原子性：</span></strong><span>更新只能成功或者失败，没有中间状态</span></p></li><li><p><strong><span>顺序性：</span></strong><span>包括 </span><strong><span>全序（Total order）</span></strong><span> 和 </span><strong><span>因果顺序（Causal order）</span></strong></p><ul><li><strong><span>全序：</span></strong><span>如果消息a在消息b之前发送，则所有Server应该看到相同的结果</span></li><li><strong><span>因果顺序：</span></strong><span>如果消息a在消息b之前发生（a导致了b），并被一起发送，则a始终在b之前被执行</span></li></ul></li></ul><p>&nbsp;</p><h2 id='zk角色'><span>ZK角色</span></h2><ul><li><p><strong><span>Server（服务端）</span></strong></p><ul><li><p><strong><span>Leader（领导者）：</span></strong><span>负责对所有对ZK状态变更的请求，将状态更新请求进行排序与编号，以保证集群内部消息处理的有序性</span></p></li><li><p><strong><span>Learner（学习者）</span></strong></p><ul><li><strong><span>Follower（追随者）：</span></strong><span>用于接收客户请求并向客户端返回结果，在选举过程中参与投票</span></li><li><strong><span>Observer（观察者）：</span></strong><span>其作用是为了扩展集群来提供读取速度，可以接收客户端连接，将写请求转发给Leader节点，但不参与投票，只同步Leader状态</span></li></ul></li></ul></li><li><p><strong><span>Client（客户端）：</span></strong><span>请求发起方</span></p></li></ul><p><span>每个Server在工作过程中有三种状态：</span></p><ul><li><strong><span>LOOKING：</span></strong><span>当前Server不知道Leader是谁，正在搜寻</span></li><li><strong><span>LEADING：</span></strong><span>当前Server即为选举出来的Leader</span></li><li><strong><span>FOLLOWING：</span></strong><span>Leader已经选举出来，当前Server与之同步</span></li></ul><p><img src="images/Middleware/Zookeeper中的角色.jpg" referrerpolicy="no-referrer" alt="Zookeeper中的角色"></p><p><span>Zookeeper集群中，有Leader、Follower和Observer三种角色</span></p><ul><li><p><strong><span>领导者（Leader）</span></strong><span>：负责进行投票的发起和决议，更新系统状态</span></p><p><span>Leader服务器是整个ZooKeeper集群工作机制中的核心，其主要工作：</span></p><ul><li><span>事务请求的唯一调度和处理者，保证集群事务处理的顺序性</span></li><li><span>集群内部各服务的调度者</span></li></ul></li><li><p><strong><span>跟随者（Follower）</span></strong><span>：用于接收客户端请求并给客户端返回结果，在选主过程中进行投票</span></p><p><span>Follower服务器是ZooKeeper集群状态的跟随者，其主要工作：</span></p><ul><li><span>处理客户端非事务请求，转发事务请求给Leader服务器</span></li><li><span>参与事务请求Proposal的投票</span></li><li><span>参与Leader选举投票</span></li></ul></li><li><p><strong><span>观察者（Observer）</span></strong><span>：可以接受客户端连接，将写请求转发给 leader，但是observer 不参加投票的过程，只是为了扩展系统，提高读取的速度</span></p><p><span>Observer是3.3.0 版本开始引入的一个服务器角色，它充当一个观察者角色——观察ZooKeeper集群的最新状态变化并将这些状态变更同步过来。其工作：</span></p><ul><li><span>处理客户端的非事务请求，转发事务请求给 Leader 服务器</span></li><li><span>不参与任何形式的投票</span></li></ul></li></ul><p>&nbsp;</p><h2 id='数据模型-1'><span>数据模型</span></h2><p><span>Zookeeper 的数据模型：</span></p><ul><li><span>层次化的目录结构，命名符合常规文件系统规范，类似于Linux</span></li><li><span>每个节点在zookeeper中叫做znode,并且其有一个唯一的路径标识</span></li><li><span>节点Znode可以包含数据和子节点，但是EPHEMERAL类型的节点不能有子节点</span></li><li><span>Znode中的数据可以有多个版本，比如某一个路径下存有多个数据版本，那么查询这个路径下的数据就需要带上版本</span></li><li><span>客户端应用可以在节点上设置监视器</span></li><li><span>节点不支持部分读写，而是一次性完整读写</span></li></ul><p><img src="images/Middleware/Zookeeper的数据模型.jpg" referrerpolicy="no-referrer" alt="Zookeeper的数据模型"></p><p>&nbsp;</p><h2 id='server工作状态'><span>Server工作状态</span></h2><p><span>服务器具有四种状态，分别是 LOOKING、FOLLOWING、LEADING、OBSERVING。</span></p><ul><li><span>LOOKING：寻找Leader状态。当服务器处于该状态时，它会认为当前集群中没有 Leader，因此需要进入 Leader 选举状态</span></li><li><span>FOLLOWING：跟随者状态。表明当前服务器角色是Follower</span></li><li><span>LEADING：领导者状态。表明当前服务器角色是Leader</span></li><li><span>OBSERVING：观察者状态。表明当前服务器角色是Observer</span></li></ul><p>&nbsp;</p><h2 id='运行模式'><span>运行模式</span></h2><p><span>Zookeeper 有三种运行模式：单机模式、伪集群模式和集群模式。</span></p><ul><li><strong><span>单机模式</span></strong><span>：这种模式一般适用于开发测试环境，一方面我们没有那么多机器资源，另外就是平时的开发调试并不需要极好的稳定性。</span></li><li><strong><span>集群模式</span></strong><span>：一个 ZooKeeper 集群通常由一组机器组成，一般 3 台以上就可以组成一个可用的 ZooKeeper 集群了。组成 ZooKeeper 集群的每台机器都会在内存中维护当前的服务器状态，并且每台机器之间都会互相保持通信。</span></li><li><strong><span>伪集群模式</span></strong><span>：这是一种特殊的集群模式，即集群的所有服务器都部署在一台机器上。当你手头上有一台比较好的机器，如果作为单机模式进行部署，就会浪费资源，这种情况下，ZooKeeper 允许你在一台机器上通过启动不同的端口来启动多个 ZooKeeper 服务实例，以此来以集群的特性来对外服务。</span></li></ul><p>&nbsp;</p><h2 id='leader选举'><span>Leader选举</span></h2><h3 id='服务器启动的leader选举'><span>服务器启动的Leader选举</span></h3><p><span>zookeeper集群初始化阶段，服务器（myid=1-5）</span><strong><span>「依次」</span></strong><span>启动，开始zookeeper选举Leader~</span></p><p><img src="images/Middleware/服务器启动的Leader选举.png" referrerpolicy="no-referrer" alt="服务器启动的Leader选举"></p><ul><li><p><span>服务器1（myid=1）启动，当前只有一台服务器，无法完成Leader选举</span></p></li><li><p><span>服务器2（myid=2）启动，此时两台服务器能够相互通讯，开始进入Leader选举阶段</span></p><ul><li><p><span>每个服务器发出一个投票</span></p><p><span>服务器1 和 服务器2都将自己作为Leader服务器进行投票，投票的基本元素包括：服务器的myid和ZXID，我们以（myid，ZXID）形式表示。初始阶段，服务器1和服务器2都会投给自己，即服务器1的投票为（1,0），服务器2的投票为（2,0），然后各自将这个投票发给集群中的其他所有机器。</span></p></li><li><p><span>接受来自各个服务器的投票</span></p><p><span>每个服务器都会接受来自其他服务器的投票。同时，服务器会校验投票的有效性，是否本轮投票、是否来自LOOKING状态的服务器。</span></p></li><li><p><span>处理投票</span></p><p><span>收到其他服务器的投票，会将别人的投票跟自己的投票PK，PK规则如下：</span></p><ul><li><span>优先检查ZXID。ZXID比较大的服务器优先作为leader。</span></li><li><span>如果ZXID相同的话，就比较myid，myid比较大的服务器作为leader。服务器1的投票是（1,0），它收到投票是（2,0），两者zxid都是0，因为收到的myid=2，大于自己的myid=1，所以它更新自己的投票为（2,0），然后重新将投票发出去。对于服务器2呢，即不再需要更新自己的投票，把上一次的投票信息发出即可。</span></li></ul></li><li><p><span>统计投票</span></p><p><span>每次投票后，服务器会统计所有投票，判断是否有过半的机器接受到相同的投票信息。服务器2收到两票，少于3（n/2+1,n为总服务器5），所以继续保持LOOKING状态</span></p></li></ul></li><li><p><span>服务器3（myid=3）启动，继续进入Leader选举阶段</span></p><p><span>跟前面流程一致，服务器1和2先投自己一票，因为服务器3的myid最大，所以大家把票改投给它。此时，服务器为3票（大于等于n/2+1）,所以服务器3当选为Leader。服务器1，2更改状态为FOLLOWING，服务器3更改状态为LEADING；</span></p></li><li><p><span>服务器4启动，发起一次选举。</span></p><p><span>此时服务器1，2，3已经不是LOOKING状态，不会更改选票信息。选票信息结果：服务器3为3票，服务器4为1票。服务器4并更改状态为FOLLOWING；</span></p></li><li><p><span>服务器5启动，发起一次选举。</span></p><p><span>同理，服务器也是把票投给服务器3，服务器5并更改状态为FOLLOWING；</span></p></li><li><p><span>投票结束，服务器3当选为Leader</span></p></li></ul><p>&nbsp;</p><h3 id='服务器运行期间的leader选举'><span>服务器运行期间的Leader选举</span></h3><p><span>zookeeper集群的五台服务器（myid=1-5）正在运行中，突然某个瞬间，Leader服务器3挂了，这时候便开始Leader选举~</span></p><p><img src="images/Middleware/服务器运行期间的Leader选举.png" referrerpolicy="no-referrer" alt="服务器运行期间的Leader选举"></p><ul><li><p><span>变更状态</span></p><p><span>Leader 服务器挂了之后，余下的非Observer服务器都会把自己的服务器状态更改为LOOKING，然后开始进入Leader选举流程。</span></p></li><li><p><span>每个服务器发起投票</span></p><p><span>每个服务器都把票投给自己，因为是运行期间，所以每台服务器的ZXID可能不相同。假设服务1,2,4,5的zxid分别为333,666,999,888，则分别产生投票（1,333），（2，666），（4,999）和（5,888），然后各自将这个投票发给集群中的其他所有机器。</span></p></li><li><p><span>接受来自各个服务器的投票</span></p></li><li><p><span>处理投票</span></p><p><span>投票规则是跟Zookeeper集群启动期间一致的，优先检查ZXID，大的优先作为Leader，所以显然服务器zxid=999具有优先权。</span></p></li><li><p><span>统计投票</span></p></li><li><p><span>改变服务器状态</span></p></li></ul><p>&nbsp;</p><h2 id='节点znode）'><span>节点（znode）</span></h2><p><strong><span>① 节点组成</span></strong></p><p><span>每个znode由4部分组成:</span></p><ul><li><strong><span>path：</span></strong><span>即节点名称，用于存放简单可视化的数据</span></li><li><strong><span>stat：</span></strong><span>即状态信息，描述该znode的版本，权限等信息</span></li><li><strong><span>data：</span></strong><span>与该znode关联的数据</span></li><li><strong><span>children：</span></strong><span>该znode下的子节点</span></li></ul><p>&nbsp;</p><p><strong><span>② 节点类型</span></strong></p><ul><li><p><strong><span>PERSISTENT（持久化目录节点）</span></strong></p><p><span>客户端与zookeeper断开连接后，该节点依旧存在 </span></p></li><li><p><strong><span>PERSISTENT_SEQUENTIAL（持久化顺序编号目录节点）</span></strong></p><p><span>客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号 </span></p></li><li><p><strong><span>EPHEMERAL（临时目录节点）</span></strong></p><p><span>客户端与zookeeper断开连接后，该节点被删除 </span></p></li><li><p><strong><span>EPHEMERAL_SEQUENTIAL（临时顺序编号目录节点）</span></strong></p><p><span>客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号 </span></p></li></ul><p>&nbsp;</p><h2 id='关键词'><span>关键词</span></h2><ul><li><p><strong><span>zxid（事务ID号）</span></strong></p><p><span>ZooKeeper状态的每一次改变，都对应着一个递增的</span><code>Transaction id</code><span>，该id称为zxid。由于zxid的递增性质，如果zxid1小于zxid2，那么zxid1肯定先于zxid2发生。创建任意节点、更新任意节点的数据、删除任意节点，都会导致Zookeeper状态发生改变，从而导致zxid的值增加。</span></p></li><li><p><strong><span>session（会话连接）</span></strong></p><p><span>在Client和Server通信之前，首先需要建立连接，该连接称为session。连接建立后，如果发生连接超时、授权失败或显式关闭连接，连接便处于CLOSED状态，此时session结束。</span></p></li></ul><p>&nbsp;</p><h2 id='watcher监听机制'><span>Watcher监听机制</span></h2><p><span>Zookeeper 允许客户端向服务端的某个Znode注册一个Watcher监听，当服务端的一些指定事件触发了这个Watcher，服务端会向指定客户端发送一个事件通知来实现分布式的通知功能，然后客户端根据 Watcher通知状态和事件类型做出业务上的改变。</span></p><p><img src="images/Middleware/Watcher监听机制的工作原理.png" referrerpolicy="no-referrer" alt="Watcher监听机制的工作原理"></p><ul><li><span>ZooKeeper的Watcher机制主要包括客户端线程、客户端 WatcherManager、Zookeeper服务器三部分</span></li><li><span>客户端向ZooKeeper服务器注册Watcher的同时，会将Watcher对象存储在客户端的WatchManager中</span></li><li><span>当zookeeper服务器触发watcher事件后，会向客户端发送通知， 客户端线程从 WatcherManager 中取出对应的 Watcher 对象来执行回调逻辑</span></li></ul><p>&nbsp;</p><p><strong><span>Watcher特性总结</span></strong></p><ul><li><strong><span>「一次性:」</span></strong><span> 一个Watch事件是一个一次性的触发器。一次性触发，客户端只会收到一次这样的信息</span></li><li><strong><span>「异步的：」</span></strong><span> Zookeeper服务器发送watcher的通知事件到客户端是异步的，不能期望能够监控到节点每次的变化，Zookeeper只能保证最终的一致性，而无法保证强一致性</span></li><li><strong><span>「轻量级：」</span></strong><span> Watcher 通知非常简单，它只是通知发生了事件，而不会传递事件对象内容</span></li><li><strong><span>「客户端串行：」</span></strong><span> 执行客户端 Watcher 回调的过程是一个串行同步的过程</span></li><li><span>注册 watcher用getData、exists、getChildren方法</span></li><li><span>触发 watcher用create、delete、setData方法</span></li></ul><p>&nbsp;</p><h2 id='zxid'><span>ZXID</span></h2><p><img src="images/Middleware/Zookeeper-ZXID.png" referrerpolicy="no-referrer" alt="Zookeeper-ZXID"></p><p><span>ZXID有两部分组成：</span></p><ul><li><span>任期：完成本次选举后，直到下次选举前，由同一Leader负责协调写入</span></li><li><span>事务计数器：单调递增，每生效一次写入，计数器加一</span></li></ul><p><span>ZXID的低32位是计数器，所以同一任期内，ZXID是连续的，每个结点又都保存着自身最新生效的ZXID，通过对比新提案的ZXID与自身最新ZXID是否相差“1”，来保证事务严格按照顺序生效的。</span></p><p>&nbsp;</p><h2 id='工作流程-1'><span>工作流程</span></h2><p><strong><span>① 客户端发起的操作的主要流程</span></strong></p><p><span>Leader可以执行增删改查操作，而Follower只能进行查询操作。所有的更新操作都会被转交给Leader来处理，Leader批准的任务，再发送给Follower去执行来保证和Leader的一致性。由于网络是不稳定的，为了保证执行顺序的一致，所有的任务都会被赋予一个唯一的顺序的编号，一定是按照这个编号来执行任务，保证任务顺序的一致性。</span></p><p>&nbsp;</p><p><strong><span>② 客户端的请求什么时候才能算处理成功？为什么说集群过半机器宕机后无法再工作？</span></strong></p><p><span>Leader在收到客户端提交过来的任务后，会向集群中所有的Follower发送提案等待Follower的投票，Follower们收到这个提议后，会进行投票，同意或者不同意，Leader会回收Follower的投票，一旦受到过半的投票表示同意，则Leader认为这个提案通过，再发送命令要求所有的Follower都进行这个提案中的任务。由于需要过半的机器同意才能执行任务，所以一旦集群中过半的机器挂掉，整个集群就无法工作了。</span></p><ul><li><p><strong><span>Leader工作流程</span></strong></p><p><span>Leader主要有三个功能：</span></p><ul><li><p><span>恢复数据</span></p></li><li><p><span>维持与Learner的心跳，接收Learner请求并判断Learner的请求消息类型</span></p></li><li><p><span>Learner的消息类型主要有如下四种，根据不同的消息类型，进行不同的处理：</span></p><ul><li><strong><span>PING消息：</span></strong><span>指Learner的心跳信息</span></li><li><strong><span>REQUEST消息：</span></strong><span>Follower发送的提议信息，包括写请求及同步请求</span></li><li><strong><span>ACK消息：</span></strong><span>Follower的对提议的回复，超过半数的Follower通过，则commit该提议</span></li><li><strong><span>REVALIDATE消息：</span></strong><span>用来延长SESSION有效时间</span></li></ul></li></ul></li></ul><ul><li><p><strong><span>Follower工作流程</span></strong></p><p><span>Follower主要有四个功能：</span></p><ul><li><span>向Leader发送消息请求（PING消息、REQUEST消息、ACK消息、REVALIDATE消息）</span></li><li><span>接收Leader消息并进行处理</span></li><li><span>接收Client的请求，如果为写请求，发送给Leader进行投票</span></li><li><span>返回Client结果</span></li></ul><p><span>Follower的消息循环处理如下几种来自Leader的消息：</span></p><ul><li><strong><span>PING消息：</span></strong><span> 心跳消息</span></li></ul></li><li><p><strong><span>PROPOSAL消息：</span></strong><span>Leader发起的提案，要求Follower投票</span></p><ul><li><strong><span>COMMIT消息：</span></strong><span>服务器端最新一次提案的信息</span></li><li><strong><span>UPTODATE消息：</span></strong><span>表明同步完成</span></li><li><strong><span>REVALIDATE消息：</span></strong><span>根据Leader的REVALIDATE结果，关闭待revalidate的session还是允许其接受消息</span></li><li><strong><span>SYNC消息：</span></strong><span>返回SYNC结果到客户端，这个消息最初由客户端发起，用来强制得到最新的更新</span></li></ul></li></ul><ul><li><p><strong><span>Observer工作流程</span></strong></p><p><span>对于Observer的流程不再叙述，Observer流程和Follower的唯一不同的地方就是Observer不会参加Leader发起的投票。</span></p></li></ul><p>&nbsp;</p><h2 id='zab协议'><span>ZAB协议</span></h2><p><span>ZooKeeper并没有完全采用Paxos算法，而是使用一种称为ZooKeeper Atomic Broadcast（ZAB，Zookeeper原子消息广播协议）的协议作为其数据一致性的核心算法，简称ZAB协议。ZAB协议分为两种模式：</span></p><ul><li><strong><span>崩溃恢复模式（Recovery）：</span></strong><span>当服务初次启动或Leader节点挂了时，系统就会进入恢复模式，直到选出了有合法数量Follower的新Leader，然后新Leader负责将整个系统同步到最新状态</span></li><li><strong><span>消息广播模式（Boardcast）：</span></strong><span>ZAB协议中，所有的写请求都由Leader来处理。正常工作状态下，Leader接收请求并通过广播协议来处理（如：广播提议投票、广播命令）</span></li></ul><p>&nbsp;</p><p><strong><span>① 崩溃恢复模式（Recovery）</span></strong></p><p><span>为了使Leader挂了后系统能正常工作，需要解决以下两个问题：</span></p><ul><li><span>已经被处理的消息不能丢</span></li><li><span>被丢弃的消息不能再次出现</span></li></ul><p>&nbsp;</p><p><strong><span>② 消息广播模式（Boardcast）</span></strong></p><p><span>广播的过程实际上是一个简化的二阶段提交过程：</span></p><ul><li><span>Leader 接收到消息请求后，将消息赋予一个全局唯一的 64 位自增 id，叫做：zxid，通过 zxid 的大小比较即可实现因果有序这一特性</span></li><li><span>Leader 通过先进先出队列（通过 TCP 协议来实现，以此实现了全局有序这一特性）将带有 zxid 的消息作为一个提案（proposal）分发给所有 follower</span></li><li><span>当 follower 接收到 proposal，先将 proposal 写到硬盘，写硬盘成功后再向 leader 回一个 ACK</span></li><li><span>当 leader 接收到合法数量的 ACKs 后，leader 就向所有 follower 发送 COMMIT 命令，同事会在本地执行该消息</span></li><li><span>当 follower 收到消息的 COMMIT 命令时，就会执行该消息</span></li></ul><p>&nbsp;</p><p><strong><span>总结</span></strong></p><p><span>个人认为 Zab 协议设计的优秀之处有两点，一是简化二阶段提交，提升了在正常工作情况下的性能；二是巧妙地利用率自增序列，简化了异常恢复的逻辑，也很好地保证了顺序处理这一特性。值得注意的是，ZAB提交事务并不像2PC一样需要全部Follower都ACK，只需要得到quorum（超过半数的节点）的ACK就可以了。</span></p><p>&nbsp;</p><p><strong><span>③ ZAB 的四个阶段</span></strong></p><ul><li><strong><span>Leader election（选举阶段）：</span></strong><span>节点在一开始都处于选举阶段，只要有一个节点得到超半数节点的票数，它就可以当选准Leader（只有完成ZAB的四个阶段，准Leader才会成为真正的Leader）。本阶段的目的是就是为了选出一个准Leader，然后进入下一个阶段</span></li><li><strong><span>Discovery（发现阶段）：</span></strong><span>在次阶段，Followers跟准Leader进行通信，同步Followers最近接收的事务提议，这个一阶段的主要目的是发现当前大多数节点接收的最新提议</span></li><li><strong><span>Synchronization（同步阶段）：</span></strong><span>同步阶段主要是利用Leader前一阶段获得的最新提议历史，同步集群中所有的副本。只有当quorum都同步完成，准Leader才会成为真正的Leader。Follower只会接收zxid比自己的lastZxid大的提议</span></li><li><strong><span>Broadcast（广播阶段）：</span></strong><span>到了这个阶段，Zookeeper 集群才能正式对外提供事务服务，并且Leader可以进行消息广播。同时如果有新的节点加入，还需要对新节点进行同步</span></li></ul><p>&nbsp;</p><p><strong><span>④ JAVA版ZAB协议</span></strong></p><ul><li><p><strong><span>Fast Leader Election</span></strong><span>：Fast Leader Election</span></p><p><span>前面提到 FLE 会选举拥有最新提议历史（lastZixd最大）的节点作为 leader，这样就省去了发现最新提议的步骤。这是基于拥有最新提议的节点也有最新提交记录的前提。成为 leader 的条件：</span></p><ul><li><span>选epoch最大的</span></li><li><span>epoch相等，选 zxid 最大的</span></li><li><span>epoch和zxid都相等，选择server id最大的（即配置zoo.cfg中的myid）</span></li></ul></li><li><p><strong><span>Recovery Phase</span></strong><span>：这一阶段Follower发送它们的 lastZixd 给Leader，Leader 根据 lastZixd 决定如何同步数据。这里的实现跟前面 Phase 2 有所不同：Follower 收到 TRUNC 指令会中止 L.lastCommittedZxid 之后的提议，收到 DIFF 指令会接收新的提议。</span></p></li><li><p><strong><span>Broadcast Phase</span></strong><span>：暂无</span></p></li></ul><p>&nbsp;</p><h2 id='zk选举过程'><span>ZK选举过程</span></h2><p><span>最开始集群启动时，会选择xzid最小的机器作为leader。</span></p><p><span>当Leader崩溃或者Leader失去大多数的Follower，这时候ZK进入恢复模式，恢复模式需要重新选举出一个新的Leader，让所有的Server都恢复到一个正确的状态。ZK的选举算法使用</span><strong><span>ZAB协议</span></strong><span>：</span></p><ul><li><span>选举线程由当前Server发起选举的线程担任，其主要功能是对投票结果进行统计，并选出推荐的Server</span></li><li><span>选举线程首先向所有Server发起一次询问（包括自己）</span></li><li><span>选举线程收到回复后，验证是否是自己发起的询问(验证zxid是否一致)，然后获取对方的id(myid)，并存储到当前询问对象列表中，最后获取对方提议的leader相关信息(id,zxid)，并将这些信息存储到当次选举的投票记录表中</span></li><li><span>收到所有Server回复以后，就计算出zxid最大的那个Server，并将这个Server相关信息设置成下一次要投票的Server</span></li><li><span>线程将当前zxid最大的Server设置为当前Server要推荐的Leader，如果此时获胜的Server获得n/2 + 1的Server票数， 设置当前推荐的leader为获胜的Server，将根据获胜的Server相关信息设置自己的状态，否则，继续这个过程，直到leader被选举出来</span></li></ul><p>&nbsp;</p><p><strong><span>分析结论</span></strong></p><p><span>要使Leader获得多数Server的支持，则Server总数最好是奇数2n+1，且存活的Server的数目不得少于n+1。因为需要过半存活集群才能工作，所以2n个机器提供的集群可靠性其实和2n-1个机器提供的集群可靠性是一样的。</span></p><p>&nbsp;</p><h2 id='zookeeper安装'><span>Zookeeper安装</span></h2><h3 id='单机模式'><span>单机模式</span></h3><p><strong><span>第一步：安装部署</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 下载解压</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">wget</span> http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.9/zookeeper-3.4.9.tar.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tar <span class="cm-attribute">-zxvf</span> zookeeper-3.4.9.tar.gz</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置全局变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> ~/.bash_profile</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最后一行加入</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-def">ZOOKEEPER_HOME</span><span class="cm-operator">=</span>/home/zookeeper/zookeeper-3.4.9</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">export</span> <span class="cm-def">PATH</span><span class="cm-operator">=</span><span class="cm-def">$ZOOKEEPER_HOME</span>/bin:<span class="cm-def">$PATH</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 使之生效</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">source</span> ~/.bash_profile</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 复制配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cp</span> /home/zookeeper/zookeeper-3.4.9/conf/zoo_sample.cfg /home/zookeeper/zookeeper-3.4.9/conf/zoo.cfg</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><strong><span>第二步：配置信息</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 心跳间隔</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">tickTime</span><span class="cm-operator">=</span><span class="cm-number">2000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保存数据目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dataDir</span><span class="cm-operator">=</span>/home/zookeeper/zookeeper-3.4.9/dataDir</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保存日志目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dataLogDir</span><span class="cm-operator">=</span>/home/zookeeper/zookeeper-3.4.9/dataLogDir</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 客户端连接Zookeeper的端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">clientPort</span><span class="cm-operator">=</span><span class="cm-number">2181</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 允许follower连接并同步到leader的初始化连接时间(心跳倍数)，超过则连接失败</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">initLimit</span><span class="cm-operator">=</span><span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 表示leader和follower之间发送消息时, 请求和应答的最大时间长度</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">syncLimit</span><span class="cm-operator">=</span><span class="cm-number">2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h3 id='集群模式'><span>集群模式</span></h3><p><strong><span>第一步：安装部署</span></strong></p><p><span>安装方式参考单机模式。</span></p><p><strong><span>第二步：配置信息</span></strong></p><p><span>在dataDir根目录下新建myid文件，并向文件myid中写入值(如：1、2、3……)</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1表示当前集群的id号</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> <span class="cm-string">"1"</span> &gt; myid</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>在单机配置情况下，新增下述参数：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 格式：server.X=A:B:C</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># X表示myid(范围1~255)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># A是该server所在的IP地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># B配置该server和集群中的leader交换消息所使用的端口,即数据同步端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># C配置选举leader时所使用的端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">server<span class="cm-def">.1</span><span class="cm-operator">=</span><span class="cm-number">10</span>.24.1.62:2888:3888</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">server<span class="cm-def">.2</span><span class="cm-operator">=</span><span class="cm-number">10</span>.24.1.63:2888:3888</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">server<span class="cm-def">.3</span><span class="cm-operator">=</span><span class="cm-number">10</span>.24.1.64:2888:3888</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p>&nbsp;</p><h3 id='运维命令-1'><span>运维命令</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动ZK服务器</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./zkServer.sh <span class="cm-builtin">start</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 使用ZK Client连接指定服务器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./zkCli.sh <span class="cm-attribute">-server</span> <span class="cm-number">127</span>.0.0.1:2181</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看ZK服务状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./zkServer.sh status</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 停止ZK服务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./zkServer.sh <span class="cm-builtin">stop</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重启ZK服务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">./zkServer.sh <span class="cm-builtin">restart</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p>&nbsp;</p><h3 id='zoocfg配置参数'><span>zoo.cfg配置参数</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 客户端连接server的端口，默认值2181</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">clientPort</span><span class="cm-operator">=</span><span class="cm-number">2181</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 存储快照文件snapshot的目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dataDir</span><span class="cm-operator">=</span>/User/lry/zookeeper/data</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ZK中的最小时间单元，单位为毫秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">tickTime</span><span class="cm-operator">=</span><span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 事务日志输出目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dataLogDir</span><span class="cm-operator">=</span>/User/lry/zookeeper/datalog</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Server端最大允许的请求堆积数，默认值为1000 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">globalOutstandingLimit</span><span class="cm-operator">=</span><span class="cm-number">1000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 每个事务日志文件的大小，默认值64M</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">preAllocSize</span><span class="cm-operator">=</span><span class="cm-number">64</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 每进行snapCount次事务日志输出后，触发一次快照,默认值100000,实际代码中是随机范围触发，避免并发情况</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">snapCount</span><span class="cm-operator">=</span><span class="cm-number">100000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 单个客户端与单台服务器之间的连接数的限制，是ip级别的，默认是60，如果设置为0，那么表明不作任何限制</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">maxClientCnxns</span><span class="cm-operator">=</span><span class="cm-number">60</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 对于多网卡的机器，可以为每个IP指定不同的监听端口。默认是所有IP都监听clientPort指定的端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">clientPortAddress</span><span class="cm-operator">=</span><span class="cm-number">10</span>.24.22.56</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Session超时时间限制，如果客户端设置的超时时间不在这个范围，那么会被强制设置为最大或最小时间。默认的Session超时时间是在2*tickTime~20*tickTime这个范围</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">minSessionTimeoutmaxSessionTimeout</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Follower在启动过程中，会从Leader同步所有最新数据，然后确定自己能够对外服务的起始状态。Leader允许F在 initLimit 时间内完成这个工作。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">initLimit</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在运行过程中，Leader负责与ZK集群中所有机器进行通信，例如通过一些心跳检测机制，来检测机器的存活状态。如果L发出心跳包在syncLimit之后，还没有从F那里收到响应，那么就认为这个F已经不在线了。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">syncLimit</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认情况下，Leader是会接受客户端连接，并提供正常的读写服务。但是，如果你想让Leader专注于集群中机器的协调，那么可以将这个参数设置为no，这样一来，会大大提高写操作的性能</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">leaderServes</span><span class="cm-operator">=</span><span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># server.[myid]=[hostname]:[数据同步和其它通讯端口]:[选举投票通讯]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">server<span class="cm-def">.x</span><span class="cm-operator">=</span>[hostname]:nnnnn[:nnnnn]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 对机器分组和权重设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">group<span class="cm-def">.x</span><span class="cm-operator">=</span>nnnnn[:nnnnn]weight<span class="cm-def">.x</span><span class="cm-operator">=</span>nnnnn</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Leader选举过程中，打开一次连接的超时时间，默认是5s</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cnxTimeout</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 每个节点最大数据量，是默认是1M</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">jute.maxbuffer</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 950px;"></div><div class="CodeMirror-gutters" style="display: none; height: 950px;"></div></div></div></pre><p>&nbsp;</p><h1 id='netty'><span>Netty</span></h1><h2 id='netty逻辑架构'><span>Netty逻辑架构</span></h2><p><img src="images/Middleware/Netty逻辑架构.png" referrerpolicy="no-referrer" alt="Netty逻辑架构"></p><p><span>Netty内部逻辑的流转：</span></p><p><img src="images/Middleware/Netty内部逻辑的流转.png" referrerpolicy="no-referrer" alt="Netty内部逻辑的流转"></p><h3 id='网络通信层'><span>网络通信层</span></h3><p><span>网络通信层的职责是</span><strong><span>执行网络I/O的操作</span></strong><span>，它支持多种网络协议和I/O模型的连接操作。当网络数据读取到内核缓冲区后，会触发各种网络事件，这些网络事件会分发给事件调度层进行处理。三个核心组件包括：</span></p><ul><li><p><strong><span>BootStrap和ServerBootStrap</span></strong></p><p><span>主要负责整个Netty程序的启动、初始化、服务器连接等过程，它相当于一条主线，串联了Netty的其它核心组件。Bootstrap和ServerBootStrap十分相似，两者的区别在于：</span></p><ul><li><span>Bootstrap可用于连接远端服务器，只绑定一个EventLoopGroup</span></li><li><span>ServerBootStrap则用于服务端启动绑定本地端口，会绑定两个EventLoopGroup，通常称为Boss和Worker（Boss 会不停地接收新的连接，然后将连接分配给一个个Worker处理连接）</span></li></ul></li><li><p><strong><span>Channel</span></strong></p><p><span>提供了基本的API用于网络I/O操作，如register、bind、connect、read、write、flush 等。Netty的Channel是以JDK NIO Channel为基础的，相比较于JDK NIO，Netty的Channel提供了更高层次的抽象，同时屏蔽了底层Socket的复杂性，赋予了Channel更加强大的功能，在使用Netty时基本不需要再与Java Socket类直接打交道。</span></p></li></ul><p>&nbsp;</p><h3 id='事件调度层'><span>事件调度层</span></h3><p><span>事件调度层的职责是通过Reactor线程模型对各类事件进行聚合处理，通过Selector主循环线程集成多种事件（I/O事件、信号事件、定时事件等），实际的业务处理逻辑是交由服务编排层中相关的Handler完成。两个核心组件包括：</span></p><ul><li><p><strong><span>EventLoopGroup、EventLoop</span></strong></p><p><span>EventLoopGroup是Netty的核心处理引擎，本质是一个线程池，主要负责接收I/O请求，并分配线程执行处理请求。EventLoopGroup的实现类</span><strong><span>NioEventLoopGroup</span></strong><span>也是 Netty 中最被推荐使用的线程模型。是基于NIO模型开发的，可以把NioEventLoopGroup理解为一个线程池，每个线程负责处理多个Channel，而同一个Channel只会对应一个线程。</span></p><p><img src="images/Middleware/Netty事件调度层.png" referrerpolicy="no-referrer" alt="Netty事件调度层"></p><ul><li><span>一个 EventLoopGroup 往往包含一个或者多个 EventLoop。EventLoop 用于处理 Channel 生命周期内的所有 I/O 事件，如 accept、connect、read、write 等 I/O 事件</span></li><li><span>EventLoop 同一时间会与一个线程绑定，每个 EventLoop 负责处理多个 Channel</span></li><li><span>每新建一个 Channel，EventLoopGroup 会选择一个 EventLoop 与其绑定。该 Channel 在生命周期内都可以对 EventLoop 进行多次绑定和解绑</span></li></ul><p><span>其实EventLoopGroup是Netty Reactor线程模型的具体实现方式，Netty通过创建不同的EventLoopGroup参数配置，就可以支持Reactor的三种线程模型：</span></p><ul><li><strong><span>单线程模型</span></strong><span>：EventLoopGroup只包含一个EventLoop，Boss和Worker使用同一个EventLoopGroup</span></li><li><strong><span>多线程模型</span></strong><span>：EventLoopGroup包含多个EventLoop，Boss和Worker使用同一个EventLoopGroup</span></li><li><strong><span>主从多线程模型</span></strong><span>：EventLoopGroup包含多个EventLoop，Boss是主Reactor，Worker是从Reactor，它们分别使用不同的EventLoopGroup，主Reactor负责新的网络连接Channel创建，然后把Channel注册到从Reactor</span></li></ul></li></ul><p>&nbsp;</p><h3 id='服务编排层'><span>服务编排层</span></h3><p><span>服务编排层的职责是负责组装各类服务，是Netty的核心处理链，用以实现网络事件的动态编排和有序传播。核心组件包括：</span></p><ul><li><p><strong><span>ChannelPipeline</span></strong></p><p><span>ChannelPipeline 是 Netty 的核心编排组件，负责组装各种 ChannelHandler，实际数据的编解码以及加工处理操作都是由 ChannelHandler 完成的。ChannelPipeline 可以理解为ChannelHandler 的实例列表——内部通过双向链表将不同的 ChannelHandler 链接在一起。当 I/O 读写事件触发时，ChannelPipeline 会依次调用 ChannelHandler 列表对 Channel 的数据进行拦截和处理。</span></p><p><span>ChannelPipeline 是线程安全的，因为每一个新的 Channel 都会对应绑定一个新的 ChannelPipeline。一个 ChannelPipeline 关联一个 EventLoop，一个 EventLoop 仅会绑定一个线程。</span></p><p><span>ChannelPipeline、ChannelHandler 都是高度可定制的组件。开发者可以通过这两个核心组件掌握对 Channel 数据操作的控制权。下面我们看一下 ChannelPipeline 的结构图：</span></p><p><img src="images/Middleware/ChannelPipeline结构图.png" referrerpolicy="no-referrer" alt="ChannelPipeline结构图"></p><p><span>ChannelPipeline中包含入站ChannelInboundHandler和出站 ChannelOutboundHandler两种处理器，结合客户端和服务端的数据收发流程：</span></p><p><img src="images/Middleware/ClientServerChannelPipeline.png" referrerpolicy="no-referrer" alt="ClientServerChannelPipeline"></p></li></ul><p>&nbsp;</p><ul><li><p><strong><span>ChannelHandler &amp; ChannelHandlerContext</span></strong></p><p><span>数据的编解码工作以及其他转换工作实际都是通过 ChannelHandler 处理的。ChannelHandlerContext 用于保存 ChannelHandler 上下文，通过 ChannelHandlerContext 可以知道 ChannelPipeline 和 ChannelHandler 的关联关系。ChannelHandlerContext 可以实现 ChannelHandler 之间的交互，ChannelHandlerContext 包含了 ChannelHandler 生命周期的所有事件，如 connect、bind、read、flush、write、close 等。</span></p><p><img src="images/Middleware/ChannelHandler.png" referrerpolicy="no-referrer" alt="ChannelHandler"></p><p><span>每创建一个 Channel 都会绑定一个新的 ChannelPipeline，ChannelPipeline 中每加入一个 ChannelHandler 都会绑定一个 ChannelHandlerContext。</span></p></li></ul><p>&nbsp;</p><h2 id='reactor线程模型'><span>Reactor线程模型</span></h2><p><img src="images/Middleware/Reactor线程模型运行机制.png" referrerpolicy="no-referrer" alt="Reactor线程模型运行机制"></p><p><span>Reactor线程模型运行机制的四个步骤，分别为</span><strong><span>连接注册、事件轮询、事件分发、任务处理</span></strong><span>。</span></p><ul><li><span>连接注册：Channel建立后，注册至Reactor线程中的Selector选择器</span></li><li><span>事件轮询：轮询Selector选择器中已注册的所有Channel的I/O事件</span></li><li><span>事件分发：为准备就绪的I/O事件分配相应的处理线程</span></li><li><span>任务处理：Reactor线程还负责任务队列中的非I/O任务，每个Worker线程从各自维护的任务队列中取出任务异步执行</span></li></ul><p>&nbsp;</p><h3 id='单reactor单线程'><span>单Reactor单线程</span></h3><p><img src="images/Middleware/单Reactor单线程.png" referrerpolicy="no-referrer" alt="单Reactor单线程"></p><p><span>上图描述了 Reactor 的单线程模型结构，在 Reactor 单线程模型中，所有 I/O 操作（包括连接建立、数据读写、事件分发等），都是由一个线程完成的。单线程模型逻辑简单，缺陷也十分明显：</span></p><ul><li><span>一个线程支持处理的连接数非常有限，CPU 很容易打满，性能方面有明显瓶颈</span></li><li><span>当多个事件被同时触发时，只要有一个事件没有处理完，其他后面的事件就无法执行，这就会造成消息积压及请求超时</span></li><li><span>线程在处理 I/O 事件时，Select 无法同时处理连接建立、事件分发等操作</span></li><li><span>如果 I/O 线程一直处于满负荷状态，很可能造成服务端节点不可用</span></li></ul><p>&nbsp;</p><h3 id='单reactor多线程'><span>单Reactor多线程</span></h3><p><img src="images/Middleware/单Reactor多线程.png" referrerpolicy="no-referrer" alt="单Reactor多线程"></p><p><span>由于单线程模型有性能方面的瓶颈，多线程模型作为解决方案就应运而生了。Reactor 多线程模型将业务逻辑交给多个线程进行处理。除此之外，多线程模型其他的操作与单线程模型是类似的，例如读取数据依然保留了串行化的设计。当客户端有数据发送至服务端时，Select 会监听到可读事件，数据读取完毕后提交到业务线程池中并发处理。</span></p><p>&nbsp;</p><h3 id='主从reactor多线程'><span>主从Reactor多线程</span></h3><p><img src="images/Middleware/主从Reactor多线程.png" referrerpolicy="no-referrer" alt="主从Reactor多线程"></p><p><span>主从多线程模型由多个 Reactor 线程组成，每个 Reactor 线程都有独立的 Selector 对象。MainReactor 仅负责处理客户端连接的 Accept 事件，连接建立成功后将新创建的连接对象注册至 SubReactor。再由 SubReactor 分配线程池中的 I/O 线程与其连接绑定，它将负责连接生命周期内所有的 I/O 事件。</span></p><p><span>Netty 推荐使用主从多线程模型，这样就可以轻松达到成千上万规模的客户端连接。在海量客户端并发请求的场景下，主从多线程模式甚至可以适当增加 SubReactor 线程的数量，从而利用多核能力提升系统的吞吐量。</span></p><p>&nbsp;</p><h2 id='核心设计-2'><span>核心设计</span></h2><h3 id='netty-eventloop原理'><span>Netty EventLoop原理</span></h3><p><span>EventLoop 这个概念其实并不是 Netty 独有的，它是一种事件等待和处理的程序模型，可以解决多线程资源消耗高的问题。例如 Node.js 就采用了 EventLoop 的运行机制，不仅占用资源低，而且能够支撑了大规模的流量访问。</span></p><p><span>EventLoop 可以说是 Netty 的调度中心，负责监听多种事件类型：I/O 事件、信号事件、定时事件等。</span></p><h4 id='eventloop运行模式'><span>EventLoop运行模式</span></h4><p><img src="images/Middleware/EventLoop通用的运行模式.png" referrerpolicy="no-referrer" alt="EventLoop通用的运行模式"></p><p><span>上图展示了 EventLoop 通用的运行模式。每当事件发生时，应用程序都会将产生的事件放入事件队列当中，然后 EventLoop 会轮询从队列中取出事件执行或者将事件分发给相应的事件监听者执行。事件执行的方式通常分为</span><strong><span>立即执行、延后执行、定期执行</span></strong><span>几种。</span></p><p>&nbsp;</p><h4 id='nioeventloop原理'><span>NioEventLoop原理</span></h4><p><span>在 Netty 中 EventLoop 可以理解为 Reactor 线程模型的事件处理引擎，每个 EventLoop 线程都维护一个 Selector 选择器和任务队列 taskQueue。它主要负责处理 I/O 事件、普通任务和定时任务。Netty 中推荐使用 NioEventLoop 作为实现类，那么 Netty 是如何实现 NioEventLoop 的呢？首先我们来看 NioEventLoop 最核心的 run() 方法源码：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-def">run</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (;;) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">switch</span> (<span class="cm-variable">selectStrategy</span>.<span class="cm-variable">calculateStrategy</span>(<span class="cm-variable">selectNowSupplier</span>, <span class="cm-variable">hasTasks</span>())) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">SelectStrategy</span>.<span class="cm-variable">CONTINUE</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">SelectStrategy</span>.<span class="cm-variable">BUSY_WAIT</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">case</span> <span class="cm-variable">SelectStrategy</span>.<span class="cm-variable">SELECT</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 轮询 I/O 事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">select</span>(<span class="cm-variable">wakenUp</span>.<span class="cm-variable">getAndSet</span>(<span class="cm-atom">false</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wakenUp</span>.<span class="cm-variable">get</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">selector</span>.<span class="cm-variable">wakeup</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">default</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">IOException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">rebuildSelector0</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleLoopException</span>(<span class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">continue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cancelledKeys</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">needsToSelectAgain</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">ioRatio</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">ioRatio</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">ioRatio</span> <span class="cm-operator">==</span> <span class="cm-number">100</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理 I/O 事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">processSelectedKeys</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理所有任务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">runAllTasks</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">long</span> <span class="cm-variable">ioStartTime</span> <span class="cm-operator">=</span> <span class="cm-variable">System</span>.<span class="cm-variable">nanoTime</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理 I/O 事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">processSelectedKeys</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">long</span> <span class="cm-variable">ioTime</span> <span class="cm-operator">=</span> <span class="cm-variable">System</span>.<span class="cm-variable">nanoTime</span>() <span class="cm-operator">-</span> <span class="cm-variable">ioStartTime</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理完 I/O 事件，再处理异步任务队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">runAllTasks</span>(<span class="cm-variable">ioTime</span> <span class="cm-operator">*</span> (<span class="cm-number">100</span> <span class="cm-operator">-</span> <span class="cm-variable">ioRatio</span>) <span class="cm-operator">/</span> <span class="cm-variable">ioRatio</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Throwable</span> <span class="cm-variable">t</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleLoopException</span>(<span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">isShuttingDown</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">closeAll</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">confirmShutdown</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Throwable</span> <span class="cm-variable">t</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleLoopException</span>(<span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1317px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1317px;"></div></div></div></pre><p><span>上述源码的结构比较清晰，NioEventLoop 每次循环的处理流程都包含事件轮询 select、事件处理 processSelectedKeys、任务处理 runAllTasks 几个步骤，是典型的 Reactor 线程模型的运行机制。而且 Netty 提供了一个参数 ioRatio，可以调整 I/O 事件处理和任务处理的时间比例。下面我们将着重从</span><strong><span>事件处理</span></strong><span>和</span><strong><span>任务处理</span></strong><span>两个核心部分出发，详细介绍 Netty EventLoop 的实现原理。</span></p><p>&nbsp;</p><h4 id='事件处理机制'><span>事件处理机制</span></h4><p><img src="images/Middleware/事件处理机制.png" referrerpolicy="no-referrer" alt="事件处理机制"></p><p><span>结合Netty的整体架构，看上述EventLoop的事件流转图，以便更好地理解 Netty EventLoop 的设计原理。NioEventLoop 的事件处理机制采用的是</span><strong><span>无锁串行化的设计思路</span></strong><span>：</span></p><ul><li><p><strong><span>BossEventLoopGroup</span></strong><span> 和 </span><strong><span>WorkerEventLoopGroup</span></strong><span> 包含一个或者多个 NioEventLoop</span></p><p><span>BossEventLoopGroup 负责监听客户端的 Accept 事件，当事件触发时，将事件注册至 WorkerEventLoopGroup 中的一个 NioEventLoop 上。每新建一个 Channel， 只选择一个 NioEventLoop 与其绑定。所以说 Channel 生命周期的所有事件处理都是</span><strong><span>线程独立</span></strong><span>的，不同的 NioEventLoop 线程之间不会发生任何交集。</span></p></li><li><p><span>NioEventLoop 完成数据读取后，会调用绑定的 ChannelPipeline 进行事件传播</span></p><p><span>ChannelPipeline 也是</span><strong><span>线程安全</span></strong><span>的，数据会被传递到 ChannelPipeline 的第一个 ChannelHandler 中。数据处理完成后，将加工完成的数据再传递给下一个 ChannelHandler，整个过程是</span><strong><span>串行化</span></strong><span>执行，不会发生线程上下文切换的问题。</span></p></li></ul><p>&nbsp;</p><p><span>NioEventLoop 无锁串行化的设计不仅使系统吞吐量达到最大化，而且降低了用户开发业务逻辑的难度，不需要花太多精力关心线程安全问题。虽然单线程执行避免了线程切换，但是它的缺陷就是不能执行时间过长的 I/O 操作，一旦某个 I/O 事件发生阻塞，那么后续的所有 I/O 事件都无法执行，甚至造成事件积压。在使用 Netty 进行程序开发时，我们一定要对 ChannelHandler 的实现逻辑有充分的风险意识。</span></p><p><span>NioEventLoop 线程的可靠性至关重要，一旦 NioEventLoop 发生阻塞或者陷入空轮询，就会导致整个系统不可用。在 JDK 中， Epoll 的实现是存在漏洞的，即使 Selector 轮询的事件列表为空，NIO 线程一样可以被唤醒，导致 CPU 100% 占用。这就是臭名昭著的 JDK epoll 空轮询的 Bug。Netty 作为一个高性能、高可靠的网络框架，需要保证 I/O 线程的安全性。那么它是如何解决 JDK epoll 空轮询的 Bug 呢？实际上 Netty 并没有从根源上解决该问题，而是巧妙地规避了这个问题。</span></p><p>&nbsp;</p><p><span>抛开其它细枝末节，直接定位到事件轮询select()方法中的最后一部分代码，一起看下Netty是如何解决epoll空轮询的Bug：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">long</span> <span class="cm-variable">time</span> <span class="cm-operator">=</span> <span class="cm-variable">System</span>.<span class="cm-variable">nanoTime</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-variable">time</span> <span class="cm-operator">-</span> <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">MILLISECONDS</span>.<span class="cm-variable">toNanos</span>(<span class="cm-variable">timeoutMillis</span>) <span class="cm-operator">&gt;=</span> <span class="cm-variable">currentTimeNanos</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">selectCnt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">selectCnt</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">SELECTOR_AUTO_REBUILD_THRESHOLD</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">selector</span> <span class="cm-operator">=</span> <span class="cm-variable">selectRebuildSelector</span>(<span class="cm-variable">selectCnt</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">selectCnt</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p><span>Netty提供了一种检测机制判断线程是否可能陷入空轮询，具体的实现方式如下：</span></p><ul><li><span>每次执行 select 操作之前记录当前时间 currentTimeNanos</span></li><li><strong><span>time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos</span></strong><span>，如果事件轮询的持续时间大于等于 timeoutMillis，那么说明是正常的，否则表明阻塞时间并未达到预期，可能触发了空轮询的 Bug</span></li><li><span>Netty 引入了计数变量 selectCnt。在正常情况下，selectCnt 会重置，否则会对 selectCnt 自增计数。当 selectCnt 达到 SELECTOR_AUTO_REBUILD_THRESHOLD（默认512） 阈值时，会触发重建 Selector 对象</span></li></ul><p><span>Netty 采用这种方法巧妙地规避了 JDK Bug。异常的 Selector 中所有的 SelectionKey 会重新注册到新建的 Selector 上，重建完成之后异常的 Selector 就可以废弃了。</span></p><p>&nbsp;</p><h4 id='任务处理机制'><span>任务处理机制</span></h4><p><span>NioEventLoop 不仅负责处理 I/O 事件，还要兼顾执行任务队列中的任务。任务队列遵循 FIFO 规则，可以保证任务执行的公平性。NioEventLoop 处理的任务类型基本可以分为三类：</span></p><ul><li><strong><span>普通任务</span></strong><span>：通过 NioEventLoop 的 execute() 方法向任务队列 taskQueue 中添加任务。例如 Netty 在写数据时会封装 WriteAndFlushTask 提交给 taskQueue。taskQueue 的实现类是多生产者单消费者队列 MpscChunkedArrayQueue，在多线程并发添加任务时，可以保证线程安全</span></li><li><strong><span>定时任务</span></strong><span>：通过调用 NioEventLoop 的 schedule() 方法向定时任务队列 scheduledTaskQueue 添加一个定时任务，用于周期性执行该任务。例如，心跳消息发送等。定时任务队列 scheduledTaskQueue 采用优先队列 PriorityQueue 实现</span></li><li><strong><span>尾部队列</span></strong><span>：tailTasks 相比于普通任务队列优先级较低，在每次执行完 taskQueue 中任务后会去获取尾部队列中任务执行。尾部任务并不常用，主要用于做一些收尾工作，例如统计事件循环的执行时间、监控信息上报等</span></li></ul><p><span>下面结合任务处理 runAllTasks 的源码结构，分析下 NioEventLoop 处理任务的逻辑，源码实现如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">runAllTasks</span>(<span class="cm-variable-3">long</span> <span class="cm-variable">timeoutNanos</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 1. 合并定时任务到普通任务队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">fetchFromScheduledTaskQueue</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 2. 从普通任务队列中取出任务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Runnable</span> <span class="cm-variable">task</span> <span class="cm-operator">=</span> <span class="cm-variable">pollTask</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">task</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">afterRunningAllTasks</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">false</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 3. 计算任务处理的超时时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">long</span> <span class="cm-variable">deadline</span> <span class="cm-operator">=</span> <span class="cm-variable">ScheduledFutureTask</span>.<span class="cm-variable">nanoTime</span>() <span class="cm-operator">+</span> <span class="cm-variable">timeoutNanos</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">long</span> <span class="cm-variable">runTasks</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">long</span> <span class="cm-variable">lastExecutionTime</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (;;) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 4. 安全执行任务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">safeExecute</span>(<span class="cm-variable">task</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">runTasks</span> <span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 5. 每执行 64 个任务检查一下是否超时</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> ((<span class="cm-variable">runTasks</span> <span class="cm-operator">&amp;</span> <span class="cm-number">0x3F</span>) <span class="cm-operator">==</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lastExecutionTime</span> <span class="cm-operator">=</span> <span class="cm-variable">ScheduledFutureTask</span>.<span class="cm-variable">nanoTime</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">lastExecutionTime</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">deadline</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">task</span> <span class="cm-operator">=</span> <span class="cm-variable">pollTask</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">task</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lastExecutionTime</span> <span class="cm-operator">=</span> <span class="cm-variable">ScheduledFutureTask</span>.<span class="cm-variable">nanoTime</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">break</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 6. 收尾工作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">afterRunningAllTasks</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">lastExecutionTime</span> <span class="cm-operator">=</span> <span class="cm-variable">lastExecutionTime</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 777px;"></div><div class="CodeMirror-gutters" style="display: none; height: 777px;"></div></div></div></pre><p><span>在代码中以注释的方式标注了具体的实现步骤，可以分为 6 个步骤：</span></p><ul><li><strong><span>fetchFromScheduledTaskQueue函数</span></strong><span>：将定时任务从 scheduledTaskQueue 中取出，聚合放入普通任务队列 taskQueue 中，只有定时任务的截止时间小于当前时间才可以被合并</span></li><li><strong><span>从普通任务队列taskQueue中取出任务</span></strong></li><li><strong><span>计算任务执行的最大超时时间</span></strong></li><li><strong><span>safeExecute函数</span></strong><span>：安全执行任务，实际直接调用的 Runnable 的 run() 方法</span></li><li><strong><span>每执行 64 个任务进行超时时间的检查</span></strong><span>：如果执行时间大于最大超时时间，则立即停止执行任务，避免影响下一轮的 I/O 事件的处理</span></li><li><strong><span>最后获取尾部队列中的任务执行</span></strong></li></ul><p>&nbsp;</p><h4 id='eventloop最佳实践'><span>EventLoop最佳实践</span></h4><p><span>在日常开发中用好 EventLoop 至关重要，这里结合实际工作中的经验给出一些 EventLoop 的最佳实践方案：</span></p><ul><li><span>网络连接建立过程中三次握手、安全认证的过程会消耗不少时间。这里建议采用 Boss 和 Worker 两个 EventLoopGroup，有助于分担 Reactor 线程的压力</span></li><li><span>由于 Reactor 线程模式适合处理耗时短的任务场景，对于耗时较长的 ChannelHandler 可以考虑维护一个业务线程池，将编解码后的数据封装成 Task 进行异步处理，避免 ChannelHandler 阻塞而造成 EventLoop 不可用</span></li><li><span>如果业务逻辑执行时间较短，建议直接在 ChannelHandler 中执行。例如编解码操作，这样可以避免过度设计而造成架构的复杂性</span></li><li><span>不宜设计过多的 ChannelHandler。对于系统性能和可维护性都会存在问题，在设计业务架构的时候，需要明确业务分层和 Netty 分层之间的界限。不要一味地将业务逻辑都添加到 ChannelHandler 中</span></li></ul><p>&nbsp;</p><h3 id='channelpipeline'><span>ChannelPipeline</span></h3><p><span>Pipeline 的字面意思是管道、流水线。它在 Netty 中起到的作用，和一个工厂的流水线类似。原始的网络字节流经过 Pipeline，被一步步加工包装，最后得到加工后的成品。是Netty的核心处理链，用以实现网络事件的动态编排和有序传播。</span></p><h4 id='channelpipeline内部结构'><span>ChannelPipeline内部结构</span></h4><p><span>ChannelPipeline 可以看作是 ChannelHandler 的容器载体，它是由一组 ChannelHandler 实例组成的，内部通过双向链表将不同的 ChannelHandler 链接在一起，如下图所示。当有 I/O 读写事件触发时，ChannelPipeline 会依次调用 ChannelHandler 列表对 Channel 的数据进行拦截和处理。</span></p><p><img src="images/Middleware/ChannelPipeline内部结构.png" referrerpolicy="no-referrer" alt="ChannelPipeline内部结构"></p><p><span>根据网络数据的流向，ChannelPipeline 分为入站 ChannelInboundHandler 和出站 ChannelOutboundHandler 两种处理器。在客户端与服务端通信的过程中，数据从客户端发向服务端的过程叫出站，反之称为入站。</span></p><p><img src="images/Middleware/ChannelPipeline入站和出站.png" referrerpolicy="no-referrer" alt="ChannelPipeline入站和出站"></p><p>&nbsp;</p><h4 id='channelhandler接口设计'><span>ChannelHandler接口设计</span></h4><p><span>整个ChannelHandler是围绕I/O事件的生命周期所设计的，如建立连接、读数据、写数据、连接销毁等。ChannelHandler 有两个重要的</span><strong><span>子接口</span></strong><span>：</span><strong><span>ChannelInboundHandler</span></strong><span>和</span><strong><span>ChannelOutboundHandler</span></strong><span>，分别拦截</span><strong><span>入站和出站的各种 I/O 事件</span></strong><span>。</span></p><p><strong><span>① ChannelInboundHandler的事件回调方法与触发时机</span></strong></p><figure><table><thead><tr><th><span>事件回调方法</span></th><th><span>触发时机</span></th></tr></thead><tbody><tr><td><span>channelRegistered</span></td><td><span>Channel 被注册到 EventLoop</span></td></tr><tr><td><span>channelUnregistered</span></td><td><span>Channel 从 EventLoop 中取消注册</span></td></tr><tr><td><span>channelActive</span></td><td><span>Channel 处于就绪状态，可以被读写</span></td></tr><tr><td><span>channelInactive</span></td><td><span>Channel 处于非就绪状态Channel 可以从远端读取到数据</span></td></tr><tr><td><span>channelRead</span></td><td><span>Channel 可以从远端读取到数据</span></td></tr><tr><td><span>channelReadComplete</span></td><td><span>Channel 读取数据完成</span></td></tr><tr><td><span>userEventTriggered</span></td><td><span>用户事件触发时</span></td></tr><tr><td><span>channelWritabilityChanged</span></td><td><span>Channel 的写状态发生变化</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>② ChannelOutboundHandler的事件回调方法与触发时机</span></strong></p><p><span>ChannelOutboundHandler 的事件回调方法非常清晰，直接通过 ChannelOutboundHandler 的接口列表可以看到每种操作所对应的回调方法，如下图所示。这里每个回调方法都是在相应操作执行之前触发，在此就不多做赘述了。此外 ChannelOutboundHandler 中绝大部分接口都包含ChannelPromise 参数，以便于在操作完成时能够及时获得通知。</span></p><p><img src="images/Middleware/ChannelOutboundHandler.png" referrerpolicy="no-referrer" alt="ChannelOutboundHandler"></p><p>&nbsp;</p><h4 id='channelpipeline事件传播机制'><span>ChannelPipeline事件传播机制</span></h4><p><span>上述ChannelPipeline可分为入站 ChannelInboundHandler 和出站 ChannelOutboundHandler 两种处理器，与此对应传输的事件类型可以分为</span><strong><span>Inbound 事件</span></strong><span>和</span><strong><span>Outbound 事件</span></strong><span>。</span></p><ul><li><strong><span>Inbound事件</span></strong><span>：传播方向为Head-&gt;Tail，即按照添加的顺序进行正向传播（A→B→C）</span></li><li><strong><span>Outbound事件</span></strong><span>：传播方向为Tail-&gt;Head，即按照添加的顺序进行反向传播（C→B→A）</span></li></ul><p><span>代码示例体验 ChannelPipeline 的事件传播机制：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">serverBootstrap</span>.<span class="cm-variable">childHandler</span>(<span class="cm-keyword">new</span> <span class="cm-variable">ChannelInitializer</span><span class="cm-operator">&lt;</span><span class="cm-variable">SocketChannel</span><span class="cm-operator">&gt;</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">initChannel</span>(<span class="cm-variable">SocketChannel</span> <span class="cm-variable">ch</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleInBoundHandler</span>(<span class="cm-string">"SampleInBoundHandlerA"</span>, <span class="cm-atom">false</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleInBoundHandler</span>(<span class="cm-string">"SampleInBoundHandlerB"</span>, <span class="cm-atom">false</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleInBoundHandler</span>(<span class="cm-string">"SampleInBoundHandlerC"</span>, <span class="cm-atom">true</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleOutBoundHandler</span>(<span class="cm-string">"SampleOutBoundHandlerA"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleOutBoundHandler</span>(<span class="cm-string">"SampleOutBoundHandlerB"</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">SampleOutBoundHandler</span>(<span class="cm-string">"SampleOutBoundHandlerC"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p><span>执行结果：</span></p><p><img src="images/Middleware/SampleOutBoundHandler执行结果.png" referrerpolicy="no-referrer" alt="SampleOutBoundHandler执行结果"></p><p>&nbsp;</p><h4 id='channelpipeline异常传播机制'><span>ChannelPipeline异常传播机制</span></h4><p><span>ChannelPipeline 事件传播的实现采用了经典的责任链模式，调用链路环环相扣。那么如果有一个节点处理逻辑异常会出现什么现象呢？ctx.fireExceptionCaugh 会将异常按顺序从 Head 节点传播到 Tail 节点。如果用户没有对异常进行拦截处理，最后将由 Tail 节点统一处理。</span></p><p><img src="images/Middleware/Netty异常处理的最佳实践.png" referrerpolicy="no-referrer" alt="Netty异常处理的最佳实践"></p><p><span>建议用户自定义的异常处理器代码示例如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ExceptionHandler</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ChannelDuplexHandler</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">exceptionCaught</span>(<span class="cm-variable">ChannelHandlerContext</span> <span class="cm-variable">ctx</span>, <span class="cm-variable">Throwable</span> <span class="cm-variable">cause</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">cause</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">RuntimeException</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"Handle Business Exception Success."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p><span>加入统一的异常处理器后，可以看到异常已经被优雅地拦截并处理掉了。这也是 Netty 推荐的最佳异常处理实践。</span></p><p><img src="images/Middleware/Netty统一异常处理验证.png" referrerpolicy="no-referrer" alt="Netty统一异常处理验证"></p><p>&nbsp;</p><h3 id='定时器timertask'><span>定时器TimerTask</span></h3><p>&nbsp;</p><h3 id='时间轮hashedwheeltimer'><span>时间轮HashedWheelTimer</span></h3><p><span>时间轮其实就是一种环形的数据结构，可以想象成时钟，分成很多格子，一个格子代表一段时间。并用一个链表保存在该格子上的计划任务，同时一个指针随着时间一格一格转动，并执行相应格子中的所有到期任务。任务通过时间取模决定放入那个格子。</span></p><p><img src="images/Middleware/HashedWheelTimer.png" referrerpolicy="no-referrer" alt="HashedWheelTimer"></p><p><span>在网络通信中管理上万的连接，每个连接都有超时任务，如果为每个任务启动一个Timer超时器，那么会占用大量资源。为了解决这个问题，可用Netty工具类HashedWheelTimer。</span></p><p><span>Netty 的时间轮 </span><code>HashedWheelTimer</code><span> 给出了一个</span><strong><span>粗略的定时器实现</span></strong><span>，之所以称之为粗略的实现是</span><strong><span>因为该时间轮并没有严格的准时执行定时任务</span></strong><span>，而是在每隔一个时间间隔之后的时间节点执行，并执行当前时间节点之前到期的定时任务。</span></p><p><span>当然具体的定时任务的时间执行精度可以通过调节 HashedWheelTimer 构造方法的时间间隔的大小来进行调节，在大多数网络应用的情况下，由于 IO 延迟的存在，并</span><strong><span>不会严格要求具体的时间执行精度</span></strong><span>，所以默认的 100ms 时间间隔可以满足大多数的情况，不需要再花精力去调节该时间精度。</span></p><p>&nbsp;</p><p><strong><span>HashedWheelTimer的特点</span></strong></p><ul><li><span>从源码分析可以看出，其实 HashedWheelTimer 的时间精度并不高，误差能够在 100ms 左右，同时如果任务队列中的等待任务数量过多，可能会产生更大的误差</span></li><li><span>但是 HashedWheelTimer 能够处理非常大量的定时任务，且每次定位到要处理任务的候选集合链表只需要 O(1) 的时间，而 Timer 等则需要调整堆，是 O(logN) 的时间复杂度</span></li><li><span>HashedWheelTimer 本质上是</span><code>模拟了时间的轮盘</code><span>，将大量的任务拆分成了一个个的小任务列表，能够有效</span><code>节省 CPU 和线程资源</code></li></ul><p>&nbsp;</p><p><strong><span>源码解读</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">HashedWheelTimer</span>(<span class="cm-variable">ThreadFactory</span> <span class="cm-variable">threadFactory</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">tickDuration</span>, <span class="cm-variable">TimeUnit</span> <span class="cm-variable">unit</span>, </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">ticksPerWheel</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">leakDetection</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">maxPendingTimeouts</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ......</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><ul><li><code>threadFactory</code><span>：自定义线程工厂，用于创建线程对象</span></li><li><code>tickDuration</code><span>：间隔多久走到下一槽（相当于时钟走一格）</span></li><li><code>unit</code><span>：定义tickDuration的时间单位</span></li><li><code>ticksPerWheel</code><span>：一圈有多个槽</span></li><li><code>leakDetection</code><span>：是否开启内存泄漏检测</span></li><li><code>maxPendingTimeouts</code><span>：最多待执行的任务个数。0或负数表示无限制</span></li></ul><p>&nbsp;</p><p><strong><span>优缺点</span></strong></p><ul><li><p><strong><span>优点</span></strong></p><ul><li><span>可以添加、删除、取消定时任务</span></li><li><span>能高效的处理大批定时任务</span></li></ul></li><li><p><strong><span>缺点</span></strong></p><ul><li><span>对内存要求较高，占用较高的内存</span></li><li><span>时间精度要求不高</span></li></ul></li></ul><p>&nbsp;</p><p><strong><span>定时任务方案</span></strong></p><p><span>目前主流的一些定时任务方案：</span></p><ul><li><span>Timer</span></li><li><span>ScheduledExecutorService</span></li><li><span>ThreadPoolTaskScheduler（基于ScheduledExecutorService）</span></li><li><span>Netty的schedule（用到了PriorityQueue）</span></li><li><span>Netty的HashedWheelTimer（时间轮）</span></li><li><span>Kafka的TimingWheel（层级时间轮）</span></li></ul><p><span>使用案例：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 构造一个 Timer 实例</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Timer</span> <span class="cm-variable">timer</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashedWheelTimer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 提交一个任务，让它在 5s 后执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Timeout</span> <span class="cm-variable">timeout1</span> <span class="cm-operator">=</span> <span class="cm-variable">timer</span>.<span class="cm-variable">newTimeout</span>(<span class="cm-keyword">new</span> <span class="cm-variable">TimerTask</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>(<span class="cm-variable">Timeout</span> <span class="cm-variable">timeout</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"5s 后执行该任务"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}, <span class="cm-number">5</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 再提交一个任务，让它在 10s 后执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Timeout</span> <span class="cm-variable">timeout2</span> <span class="cm-operator">=</span> <span class="cm-variable">timer</span>.<span class="cm-variable">newTimeout</span>(<span class="cm-keyword">new</span> <span class="cm-variable">TimerTask</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>(<span class="cm-variable">Timeout</span> <span class="cm-variable">timeout</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"10s 后执行该任务"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}, <span class="cm-number">10</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 取消掉那个 5s 后执行的任务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">timeout1</span>.<span class="cm-variable">isExpired</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">timeout1</span>.<span class="cm-variable">cancel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 原来那个 5s 后执行的任务，已经取消了。这里我们反悔了，我们要让这个任务在 3s 后执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 我们说过 timeout 持有上、下层的实例，所以下面的 timer 也可以写成 timeout1.timer()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">timer</span>.<span class="cm-variable">newTimeout</span>(<span class="cm-variable">timeout1</span>.<span class="cm-variable">task</span>(), <span class="cm-number">3</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 626px;"></div><div class="CodeMirror-gutters" style="display: none; height: 626px;"></div></div></div></pre><p>&nbsp;</p><h3 id='无锁队列mpsc-queue'><span>无锁队列mpsc queue</span></h3><p>&nbsp;</p><h3 id='fastthreadlocal'><span>FastThreadLocal</span></h3><p>&nbsp;</p><h3 id='bytebuf-1'><span>ByteBuf</span></h3><p>&nbsp;</p><h3 id='编解码协议'><span>编解码协议</span></h3><p><span>netty-codec模块主要负责编解码工作，通过编解码实现原始字节数据与业务实体对象之间的相互转化。Netty支持大多数业界主流协议的编解码器，如</span><strong><span>HTTP、HTTP2、Redis、XML</span></strong><span>等，为开发者节省了大量的精力。此外该模块提供了抽象的编解码类</span><strong><span>ByteToMessageDecoder</span></strong><span>和</span><strong><span>MessageToByteEncoder</span></strong><span>，通过继承这两个类可以轻松实现自定义的编解码逻辑。</span></p><p><img src="images/Middleware/Netty协议.png" referrerpolicy="no-referrer" alt="Netty协议"></p><p>&nbsp;</p><h3 id='拆包粘包'><span>拆包粘包</span></h3><ul><li><p><span>拆包/粘包的解决方案</span></p><ul><li><p><strong><span>消息长度固定</span></strong><span>：每个数据报文都需要一个固定的长度。当接收方累计读取到固定长度的报文后，就认为已经获得一个完整的消息。当发送方的数据小于固定长度时，则需要空位补齐。消息定长法使用非常简单，但是缺点也非常明显，无法很好设定固定长度的值，如果长度太大会造成字节浪费，长度太小又会影响消息传输，所以在一般情况下消息定长法不会被采用。</span></p></li><li><p><strong><span>特定分隔符</span></strong></p><p><span>既然接收方无法区分消息的边界，那么我们可以在每次发送报文的尾部加上特定分隔符，接收方就可以根据特殊分隔符进行消息拆分。</span></p></li><li><p><strong><span>消息长度 + 消息内容</span></strong></p><p><span>消息长度 + 消息内容是项目开发中最常用的一种协议，如上展示了该协议的基本格式。消息头中存放消息的总长度，例如使用 4 字节的 int 值记录消息的长度，消息体实际的二进制的字节数据。接收方在解析数据时，首先读取消息头的长度字段 Len，然后紧接着读取长度为 Len 的字节数据，该数据即判定为一个完整的数据报文。</span></p></li></ul></li></ul><p>&nbsp;</p><h2 id='核心流程-2'><span>核心流程</span></h2><h3 id='服务端启动流程'><span>服务端启动流程</span></h3><p><span>Netty 服务端的启动过程大致分为三个步骤：</span></p><ul><li><span>配置线程池</span></li><li><span>Channel 初始化</span></li><li><span>端口绑定</span></li></ul><p>&nbsp;</p><h4 id='配置线程池'><span>配置线程池</span></h4><p><strong><span>单线程模式</span></strong>
<span>Reactor 单线程模型所有 I/O 操作都由一个线程完成，所以只需要启动一个 EventLoopGroup 即可。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">EventLoopGroup</span> <span class="cm-variable">group</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NioEventLoopGroup</span>(<span class="cm-number">1</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ServerBootstrap</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ServerBootstrap</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">group</span>(<span class="cm-variable">group</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>多线程模式</span></strong>
<span>Reactor 单线程模型有非常严重的性能瓶颈，因此 Reactor 多线程模型出现了。在 Netty 中使用 Reactor 多线程模型与单线程模型非常相似，区别是 NioEventLoopGroup 可以不需要任何参数，它默认会启动 2 倍 CPU 核数的线程。当然，你也可以自己手动设置固定的线程数。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">EventLoopGroup</span> <span class="cm-variable">group</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NioEventLoopGroup</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ServerBootstrap</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ServerBootstrap</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">group</span>(<span class="cm-variable">group</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>主从多线程模式</span></strong>
<span>在大多数场景下，我们采用的都是主从多线程 Reactor 模型。Boss 是主 Reactor，Worker 是从 Reactor。它们分别使用不同的 NioEventLoopGroup，主 Reactor 负责处理 Accept，然后把 Channel 注册到从 Reactor 上，从 Reactor 主要负责 Channel 生命周期内的所有 I/O 事件。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">EventLoopGroup</span> <span class="cm-variable">bossGroup</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NioEventLoopGroup</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">EventLoopGroup</span> <span class="cm-variable">workerGroup</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">NioEventLoopGroup</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ServerBootstrap</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ServerBootstrap</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">group</span>(<span class="cm-variable">bossGroup</span>, <span class="cm-variable">workerGroup</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><p>&nbsp;</p><h4 id='channel-初始化'><span>Channel 初始化</span></h4><p><strong><span>设置Channel类型</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 客户端Channel</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">NioSocketChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">OioSocketChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 服务端Channel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">NioServerSocketChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">OioServerSocketChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">EpollServerSocketChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// UDP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">NioDatagramChannel</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">b</span>.<span class="cm-variable">channel</span>(<span class="cm-variable">OioDatagramChannel</span>.<span class="cm-keyword">class</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p><strong><span>注册ChannelHandler</span></strong></p><p><span>ServerBootstrap 的 childHandler() 方法需要注册一个 ChannelHandler。ChannelInitializer是实现了 ChannelHandler接口的匿名类，通过实例化 ChannelInitializer 作为 ServerBootstrap 的参数。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">childHandler</span>(<span class="cm-keyword">new</span> <span class="cm-variable">ChannelInitializer</span><span class="cm-operator">&lt;</span><span class="cm-variable">SocketChannel</span><span class="cm-operator">&gt;</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; <span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; <span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">initChannel</span>(<span class="cm-variable">SocketChannel</span> <span class="cm-variable">ch</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// HTTP 编解码处理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="cm-variable">addLast</span>(<span class="cm-string">"codec"</span>, <span class="cm-keyword">new</span> <span class="cm-variable">HttpServerCodec</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// HTTPContent 压缩处理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="cm-variable">addLast</span>(<span class="cm-string">"compressor"</span>, <span class="cm-keyword">new</span> <span class="cm-variable">HttpContentCompressor</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// HTTP 消息聚合处理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="cm-variable">addLast</span>(<span class="cm-string">"aggregator"</span>, <span class="cm-keyword">new</span> <span class="cm-variable">HttpObjectAggregator</span>(<span class="cm-number">65536</span>))&nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 自定义业务逻辑处理器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="cm-variable">addLast</span>(<span class="cm-string">"handler"</span>, <span class="cm-keyword">new</span> <span class="cm-variable">HttpServerHandler</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p><strong><span>设置Channel参数</span></strong></p><p><span>ServerBootstrap 设置 Channel 属性有option和childOption两个方法，option 主要负责设置 Boss 线程组，而 childOption 对应的是 Worker 线程组。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">b</span>.<span class="cm-variable">option</span>(<span class="cm-variable">ChannelOption</span>.<span class="cm-variable">SO_KEEPALIVE</span>, <span class="cm-atom">true</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>常用参数如下：</span></p><figure><table><thead><tr><th><span>参数名</span></th><th><span>描述信息</span></th></tr></thead><tbody><tr><td><span>SO_KEEPALIVE</span></td><td><span>设置为 true 代表启用了 TCP SO_KEEPALIVE 属性，TCP 会主动探测连接状态，即连接保活</span></td></tr><tr><td><span>SO_BACKLOG</span></td><td><span>已完成三次握手的请求队列最大长度，同一时刻服务端可能会处理多个连接，在高并发海量连接的场景下，该参数应适当调大</span></td></tr><tr><td><span>TCP_NODELAY</span></td><td><span>Netty 默认是 true，表示立即发送数据。如果设置为 false 表示启用 Nagle 算法，该算法会将 TCP 网络数据包累积到一定量才会发送，虽然可以减少报文发送的数量，但是会造成一定的数据延迟。Netty 为了最小化数据传输的延迟，默认禁用了 Nagle 算法</span></td></tr><tr><td><span>SO_SNDBUF</span></td><td><span>TCP 数据发送缓冲区大小</span></td></tr><tr><td><span>SO_RCVBUF</span></td><td><span>TCP数据接收缓冲区大小，TCP数据接收缓冲区大小</span></td></tr><tr><td><span>SO_LINGER</span></td><td><span>设置延迟关闭的时间，等待缓冲区中的数据发送完成</span></td></tr><tr><td><span>CONNECT_TIMEOUT_MILLIS</span></td><td><span>建立连接的超时时间</span></td></tr></tbody></table></figure><p>&nbsp;</p><h4 id='端口绑定'><span>端口绑定</span></h4><p><span>bind() 方法会真正触发启动，sync() 方法则会阻塞，直至整个启动过程完成，具体使用方式如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ChannelFuture</span> <span class="cm-variable">f</span> <span class="cm-operator">=</span> <span class="cm-variable">b</span>.<span class="cm-variable">bind</span>(<span class="cm-number">8080</span>).<span class="cm-variable">sync</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><h2 id='netty流程'><span>Netty流程</span></h2><p><span>从功能上，流程可以分为服务启动、建立连接、读取数据、业务处理、发送数据、关闭连接以及关闭服务。整体流程如下所示(图中没有包含关闭的部分)：</span></p><p><img src="images/Middleware/Netty整体流程.png" referrerpolicy="no-referrer" alt="Netty整体流程"></p><p><img src="images/Middleware/Netty线程模型.png" referrerpolicy="no-referrer" alt="Netty线程模型"></p><p>&nbsp;</p><h2 id='线程模型-2'><span>线程模型</span></h2><p><span>Netty通过Reactor模型基于多路复用器接收并处理用户请求，内部实现了两个线程池，boss线程池和work线程池，其中boss线程池的线程负责处理请求的accept事件，当接收到accept事件的请求时，把对应的socket封装到一个NioSocketChannel中，并交给work线程池，其中work线程池负责请求的read和write事件，由对应的Handler处理。</span></p><h3 id='单线程reactor线程模型'><span>单线程Reactor线程模型</span></h3><p><span>下图演示了单线程reactor线程模型，之所以称之为单线程，还是因为只有一个accpet Thread接受任务，之后转发到reactor线程中进行处理。两个黄色框表示的是Reactor Thread Group，里面有多个Reactor Thread。一个Reactor Thread Group中的Reactor Thread功能都是相同的，例如第一个黄色框中的Reactor Thread都是处理拆分后的任务的第一阶段，第二个黄色框中的Reactor Thread都是处理拆分后的任务的第二步骤。任务具体要怎么拆分，要结合具体场景，下图只是演示作用。</span><strong><span>一般来说，都是以比较耗时的操作(例如IO)为切分点</span></strong><span>。</span></p><p><img src="images/Middleware/单线程reactor线程模型.png" referrerpolicy="no-referrer" alt="单线程reactor线程模型"></p><p><span>特别的，如果我们在任务处理的过程中，不划分为多个阶段进行处理的话，那么单线程reactor线程模型就退化成了并行工作和模型。</span><strong><span>事实上，可以认为并行工作者模型，就是单线程reactor线程模型的最简化版本。</span></strong></p><p>&nbsp;</p><h3 id='多线程reactor线程模型'><span>多线程Reactor线程模型</span></h3><p><span>所谓多线程reactor线程模型，无非就是有多个accpet线程，如下图中的虚线框中的部分。</span></p><p><img src="images/Middleware/多线程reactor线程模型.png" referrerpolicy="no-referrer" alt="多线程reactor线程模型"></p><p>&nbsp;</p><h3 id='混合型reactor线程模型'><span>混合型Reactor线程模型</span></h3><p><span>混合型reactor线程模型，实际上最能体现reactor线程模型的本质：</span></p><ul><li><span>将任务处理切分成多个阶段进行，每个阶段处理完自己的部分之后，转发到下一个阶段进行处理。不同的阶段之间的执行是异步的，可以认为每个阶段都有一个独立的线程池。</span></li><li><span>不同的类型的任务，有着不同的处理流程，划分时需要划分成不同的阶段。如下图蓝色是一种任务、绿色是另一种任务，两种任务有着不同的执行流程</span></li></ul><p><img src="images/Middleware/混合型reactor线程模型.png" referrerpolicy="no-referrer" alt="混合型reactor线程模型"></p><p>&nbsp;</p><h3 id='netty-reactor线程模型'><span>Netty-Reactor线程模型</span></h3><p><img src="images/Middleware/Netty-Reactor.png" referrerpolicy="no-referrer" alt="Netty-Reactor"></p><p><span>图中大致包含了5个步骤，而我们编写的服务端代码中可能并不能完全体现这样的步骤，因为Netty将其中一些步骤的细节隐藏了，笔者将会通过图形分析与源码分析相结合的方式帮助读者理解这五个步骤。这个五个步骤可以按照以下方式简要概括：</span></p><ul><li><span>设置服务端ServerBootStrap启动参数</span></li><li><span>通过ServerBootStrap的bind方法启动服务端，bind方法会在parentGroup中注册NioServerScoketChannel，监听客户端的连接请求</span></li><li><span>Client发起连接CONNECT请求，parentGroup中的NioEventLoop不断轮循是否有新的客户端请求，如果有，ACCEPT事件触发</span></li><li><span>ACCEPT事件触发后，parentGroup中NioEventLoop会通过NioServerSocketChannel获取到对应的代表客户端的NioSocketChannel，并将其注册到childGroup中</span></li><li><span>childGroup中的NioEventLoop不断检测自己管理的NioSocketChannel是否有读写事件准备好，如果有的话，调用对应的ChannelHandler进行处理</span></li></ul><p>&nbsp;</p><h2 id='bytebuf-2'><span>ByteBuf</span></h2><h3 id='工作流程-2'><span>工作流程</span></h3><p><span>ByteBuf维护两个不同的索引：</span><code>读索引(readerIndex)</code><span> 和 </span><code>写索引(writerIndex)</code><span> 。如下图所示: </span></p><p><img src="images/Middleware/ByteBuf工作流程.png" referrerpolicy="no-referrer" alt="ByteBuf工作流程"></p><ul><li><code>ByteBuf</code><span> 维护了 </span><code>readerIndex</code><span> 和 </span><code>writerIndex</code><span> 索引</span></li><li><span>当 </span><code>readerIndex &gt; writerIndex</code><span> 时，则抛出 </span><code>IndexOutOfBoundsException</code></li><li><code>ByteBuf</code><span>容量 = </span><code>writerIndex</code></li><li><code>ByteBuf</code><span> 可读容量 = </span><code>writerIndex</code><span> - </span><code>readerIndex</code></li><li><code>readXXX()</code><span> 和 </span><code>writeXXX()</code><span> 方法将会推进其对应的索引。自动推进</span></li><li><code>getXXX()</code><span> 和 </span><code>setXXX()</code><span> 方法将对 </span><code>writerIndex</code><span> 和 </span><code>readerIndex</code><span> 无影响</span></li></ul><p>&nbsp;</p><h3 id='使用模式'><span>使用模式</span></h3><p><span>ByteBuf本质是一个由不同的索引分别控制读访问和写访问的字节数组。ByteBuf共有三种模式：</span><code>堆缓冲区模式(Heap Buffer)</code><span>、</span><code>直接缓冲区模式(Direct Buffer)</code><span> 和 </span><code>复合缓冲区模式(Composite Buffer)</code><span>。</span></p><h4 id='堆缓冲区模式heap-buffer'><span>堆缓冲区模式(Heap Buffer)</span></h4><p><span>堆缓冲区模式又称为</span><code>支撑数组(backing array)</code><span>。将数据存放在JVM的堆空间，通过将数据存储在数组中实现。</span></p><ul><li><strong><span>优点</span></strong><span>：由于数据存储在Jvm堆中可以快速创建和快速释放，并且提供了数组直接快速访问的方法</span></li><li><strong><span>缺点</span></strong><span>：每次数据与I/O进行传输时，都需要将数据拷贝到直接缓冲区</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">heapBuffer</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 创建Java堆缓冲区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">heapBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>(); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">heapBuf</span>.<span class="cm-variable">hasArray</span>()) { <span class="cm-comment">// 是数组支撑</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">array</span> <span class="cm-operator">=</span> <span class="cm-variable">heapBuf</span>.<span class="cm-variable">array</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">offset</span> <span class="cm-operator">=</span> <span class="cm-variable">heapBuf</span>.<span class="cm-variable">arrayOffset</span>() <span class="cm-operator">+</span> <span class="cm-variable">heapBuf</span>.<span class="cm-variable">readerIndex</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">length</span> <span class="cm-operator">=</span> <span class="cm-variable">heapBuf</span>.<span class="cm-variable">readableBytes</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleArray</span>(<span class="cm-variable">array</span>, <span class="cm-variable">offset</span>, <span class="cm-variable">length</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p>&nbsp;</p><h4 id='直接缓冲区模式direct-buffer'><span>直接缓冲区模式(Direct Buffer)</span></h4><p><span>Direct Buffer属于堆外分配的直接内存，不会占用堆的容量。适用于套接字传输过程，避免了数据从内部缓冲区拷贝到直接缓冲区的过程，性能较好。对于涉及大量I/O的数据读写，建议使用Direct Buffer。而对于用于后端的业务消息编解码模块建议使用Heap Buffer。</span></p><ul><li><strong><span>优点</span></strong><span>: 使用Socket传递数据时性能很好，避免了数据从Jvm堆内存拷贝到直接缓冲区的过程。提高了性能</span></li><li><strong><span>缺点</span></strong><span>: 相对于堆缓冲区而言，Direct Buffer分配内存空间和释放更为昂贵</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">directBuffer</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">directBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">directBuffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">directBuf</span>.<span class="cm-variable">hasArray</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">length</span> <span class="cm-operator">=</span> <span class="cm-variable">directBuf</span>.<span class="cm-variable">readableBytes</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">array</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">byte</span>[<span class="cm-variable">length</span>];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">directBuf</span>.<span class="cm-variable">getBytes</span>(<span class="cm-variable">directBuf</span>.<span class="cm-variable">readerIndex</span>(), <span class="cm-variable">array</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">handleArray</span>(<span class="cm-variable">array</span>, <span class="cm-number">0</span>, <span class="cm-variable">length</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p>&nbsp;</p><h4 id='复合缓冲区模式composite-buffer'><span>复合缓冲区模式(Composite Buffer)</span></h4><p><span>Composite Buffer是Netty特有的缓冲区。本质上类似于提供一个或多个ByteBuf的组合视图，可以根据需要添加和删除不同类型的ByteBuf。</span></p><ul><li><span>Composite Buffer是一个组合视图。它提供一种访问方式让使用者自由组合多个ByteBuf，避免了拷贝和分配新的缓冲区</span></li><li><span>Composite Buffer不支持访问其支撑数组。因此如果要访问，需要先将内容拷贝到堆内存中，再进行访问</span></li></ul><p><span>下图是将两个ByteBuf：头部 + Body 组合在一起，没有进行任何复制过程。仅仅创建了一个视图：</span></p><p><img src="images/Middleware/CompositeBuffer.png" referrerpolicy="no-referrer" alt="CompositeBuffer"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">byteBufComposite</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 复合缓冲区，只是提供一个视图</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">CompositeByteBuf</span> <span class="cm-variable">messageBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">compositeBuffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">headerBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>(); <span class="cm-comment">// can be backing or direct</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">bodyBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">directBuffer</span>(); &nbsp; <span class="cm-comment">// can be backing or direct</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">messageBuf</span>.<span class="cm-variable">addComponents</span>(<span class="cm-variable">headerBuf</span>, <span class="cm-variable">bodyBuf</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">messageBuf</span>.<span class="cm-variable">removeComponent</span>(<span class="cm-number">0</span>); <span class="cm-comment">// remove the header</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf</span> : <span class="cm-variable">messageBuf</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">buf</span>.<span class="cm-variable">toString</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h3 id='字节级操作'><span>字节级操作</span></h3><h4 id='随机访问索引'><span>随机访问索引</span></h4><p><span>ByteBuf的索引与普通的Java字节数组一样。第一个字节的索引是0，最后一个字节索引总是capacity()-1。访问方式如下：</span></p><ul><li><span>readXXX()和writeXXX()方法将会推进其对应的索引readerIndex和writerIndex。自动推进</span></li><li><span>getXXX()和setXXX()方法用于访问数据，对writerIndex和readerIndex无影响</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">byteBufRelativeAccess</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buffer</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>(); <span class="cm-comment">// get reference form somewhere</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">buffer</span>.<span class="cm-variable">capacity</span>(); <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-variable">buffer</span>.<span class="cm-variable">getByte</span>(<span class="cm-variable">i</span>); <span class="cm-comment">// 不改变readerIndex值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>((<span class="cm-variable-3">char</span>) <span class="cm-variable">b</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p>&nbsp;</p><h4 id='顺序访问索引'><span>顺序访问索引</span></h4><p><span>Netty的ByteBuf同时具有读索引和写索引，但JDK的ByteBuffer只有一个索引，所以JDK需要调用flip()方法在读模式和写模式之间切换。ByteBuf被读索引和写索引划分成3个区域：</span><strong><span>可丢弃字节区域</span></strong><span>、</span><strong><span>可读字节区域</span></strong><span> 和 </span><strong><span>可写字节区域</span></strong><span> 。</span></p><p><img src="images/Middleware/ByteBuf顺序访问索引.png" referrerpolicy="no-referrer" alt="ByteBuf顺序访问索引"></p><p>&nbsp;</p><h4 id='可丢弃字节区域'><span>可丢弃字节区域</span></h4><p><span>可丢弃字节区域是指：[0，readerIndex)之间的区域。可调用discardReadBytes()方法丢弃已经读过的字节。</span></p><ul><li><span>discardReadBytes()效果 ----- 将可读字节区域(CONTENT)[readerIndex, writerIndex)往前移动readerIndex位，同时修改读索引和写索引</span></li><li><span>discardReadBytes()方法会移动可读字节区域内容(CONTENT)。如果频繁调用，会有多次数据复制开销，对性能有一定的影响</span></li></ul><p>&nbsp;</p><h4 id='可读字节区域'><span>可读字节区域</span></h4><p><span>可读字节区域是指:[readerIndex, writerIndex)之间的区域。任何名称以read和skip开头的操作方法，都会改变readerIndex索引。</span></p><p>&nbsp;</p><h4 id='可写字节区域'><span>可写字节区域</span></h4><p><span>可写字节区域是指:[writerIndex, capacity)之间的区域。任何名称以write开头的操作方法都将改变writerIndex的值。</span></p><p>&nbsp;</p><h4 id='索引管理'><span>索引管理</span></h4><ul><li><span>markReaderIndex()+resetReaderIndex() ----- markReaderIndex()是先备份当前的readerIndex，resetReaderIndex()则是将刚刚备份的readerIndex恢复回来。常用于dump ByteBuf的内容，又不想影响原来ByteBuf的readerIndex的值</span></li><li><span>readerIndex(int) ----- 设置readerIndex为固定的值</span></li><li><span>writerIndex(int) ----- 设置writerIndex为固定的值</span></li><li><span>clear() ----- 效果是: readerIndex=0, writerIndex(0)。不会清除内存</span></li><li><span>调用clear()比调用discardReadBytes()轻量的多。仅仅重置readerIndex和writerIndex的值，不会拷贝任何内存，开销较小</span></li></ul><p>&nbsp;</p><h4 id='查找操作indexof'><span>查找操作(indexOf)</span></h4><p><span>查找ByteBuf指定的值。类似于，String.indexOf(&quot;str&quot;)操作</span></p><ul><li><span>最简单的方法 —— indexOf()</span></li><li><span>利用ByteProcessor作为参数来查找某个指定的值</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">byteProcessor</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buffer</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>(); <span class="cm-comment">//get reference form somewhere</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 使用indexOf()方法来查找</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buffer</span>.<span class="cm-variable">indexOf</span>(<span class="cm-variable">buffer</span>.<span class="cm-variable">readerIndex</span>(), <span class="cm-variable">buffer</span>.<span class="cm-variable">writerIndex</span>(), (<span class="cm-variable-3">byte</span>)<span class="cm-number">8</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 使用ByteProcessor查找给定的值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">index</span> <span class="cm-operator">=</span> <span class="cm-variable">buffer</span>.<span class="cm-variable">forEachByte</span>(<span class="cm-variable">ByteProcessor</span>.<span class="cm-variable">FIND_CR</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p>&nbsp;</p><h4 id='派生缓冲------视图'><span>派生缓冲——视图</span></h4><p><span>派生缓冲区为ByteBuf提供了一个访问的视图。视图仅仅提供一种访问操作，不做任何拷贝操作。下列方法，都会呈现给使用者一个视图，以供访问:</span></p><ul><li><span>duplicate()</span></li><li><span>slice()</span></li><li><span>slice(int, int)</span></li><li><span>Unpooled.unmodifiableBuffer(...)</span></li><li><span>Unpooled.wrappedBuffer(...)</span></li><li><span>order(ByteOrder)</span></li><li><span>readSlice(int)</span></li></ul><p><strong><span>理解</span></strong></p><ul><li><span>上面的6中方法，都会返回一个新的ByteBuf实例，具有自己的读索引和写索引。但是，其内部存储是与原对象是共享的。这就是视图的概念</span></li><li><span>请注意：如果你修改了这个新的ByteBuf实例的具体内容，那么对应的源实例也会被修改，因为其内部存储是共享的</span></li><li><span>如果需要拷贝现有缓冲区的真实副本，请使用copy()或copy(int, int)方法</span></li><li><span>使用派生缓冲区，避免了复制内存的开销，有效提高程序的性能</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">byteBufSlice</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Charset</span> <span class="cm-variable">utf8</span> <span class="cm-operator">=</span> <span class="cm-variable">Charset</span>.<span class="cm-variable">forName</span>(<span class="cm-string">"UTF-8"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">copiedBuffer</span>(<span class="cm-string">"Netty in Action rocks!"</span>, <span class="cm-variable">utf8</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">sliced</span> <span class="cm-operator">=</span> <span class="cm-variable">buf</span>.<span class="cm-variable">slice</span>(<span class="cm-number">0</span>, <span class="cm-number">15</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">sliced</span>.<span class="cm-variable">toString</span>(<span class="cm-variable">utf8</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buf</span>.<span class="cm-variable">setByte</span>(<span class="cm-number">0</span>, (<span class="cm-variable-3">byte</span>)<span class="cm-string">'J'</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">assert</span> <span class="cm-variable">buf</span>.<span class="cm-variable">getByte</span>(<span class="cm-number">0</span>) <span class="cm-operator">==</span> <span class="cm-variable">sliced</span>.<span class="cm-variable">getByte</span>(<span class="cm-number">0</span>); <span class="cm-comment">// return true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">byteBufCopy</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Charset</span> <span class="cm-variable">utf8</span> <span class="cm-operator">=</span> <span class="cm-variable">Charset</span>.<span class="cm-variable">forName</span>(<span class="cm-string">"UTF-8"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">copiedBuffer</span>(<span class="cm-string">"Netty in Action rocks!"</span>, <span class="cm-variable">utf8</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">copy</span> <span class="cm-operator">=</span> <span class="cm-variable">buf</span>.<span class="cm-variable">copy</span>(<span class="cm-number">0</span>, <span class="cm-number">15</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">copy</span>.<span class="cm-variable">toString</span>(<span class="cm-variable">utf8</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buf</span>.<span class="cm-variable">setByte</span>(<span class="cm-number">0</span>, (<span class="cm-variable-3">byte</span>)<span class="cm-string">'J'</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">assert</span> <span class="cm-variable">buf</span>.<span class="cm-variable">getByte</span>(<span class="cm-number">0</span>) <span class="cm-operator">!=</span> <span class="cm-variable">copy</span>.<span class="cm-variable">getByte</span>(<span class="cm-number">0</span>); <span class="cm-comment">// return true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 410px;"></div><div class="CodeMirror-gutters" style="display: none; height: 410px;"></div></div></div></pre><p>&nbsp;</p><h4 id='读写操作'><span>读/写操作</span></h4><p><span>如上文所提到的，有两种类别的读/写操作:</span></p><ul><li><span>get()和set()操作 ----- 从给定的索引开始，并且保持索引不变</span></li><li><span>read()和write()操作 ----- 从给定的索引开始，并且根据已经访问过的字节数对索引进行访问</span></li><li><span>下图给出get()操作API，对于set()操作、read()操作和write操作可参考书籍或API</span></li></ul><p><img src="images/Middleware/ByteBuf-get.png" referrerpolicy="no-referrer" alt="ByteBuf-get"></p><p>&nbsp;</p><h4 id='更多操作'><span>更多操作</span></h4><p><img src="images/Middleware/ByteBuf-更多操作.png" referrerpolicy="no-referrer" alt="ByteBuf-更多操作"></p><p><span>下面的两个方法操作字面意思较难理解，给出解释:</span></p><ul><li><strong><span>hasArray()</span></strong><span>：如果ByteBuf由一个字节数组支撑，则返回true。通俗的讲：ByteBuf是堆缓冲区模式，则代表其内部存储是由字节数组支撑的</span></li><li><strong><span>array()</span></strong><span>：如果ByteBuf是由一个字节数组支撑泽返回数组，否则抛出UnsupportedOperationException异常。也就是，ByteBuf是堆缓冲区模式</span></li></ul><p>&nbsp;</p><h3 id='bytebuf分配'><span>ByteBuf分配</span></h3><p><span>创建和管理ByteBuf实例的多种方式：</span><strong><span>按序分配(ByteBufAllocator)</span></strong><span>、</span><strong><span>Unpooled缓冲区</span></strong><span> 和 </span><strong><span>ByteBufUtil类</span></strong><span>。</span></p><h4 id='按序分配bytebufallocator接口'><span>按序分配：ByteBufAllocator接口</span></h4><p><span>Netty通过接口ByteBufAllocator实现了(ByteBuf的)池化。Netty提供池化和非池化的ButeBufAllocator: </span></p><ul><li><code>ctx.channel().alloc().buffer()</code><span>：本质就是ByteBufAllocator.DEFAULT</span></li><li><code>ByteBufAllocator.DEFAULT.buffer()</code><span>：返回一个基于堆或者直接内存存储的Bytebuf。默认是堆内存</span></li><li><code>ByteBufAllocator.DEFAULT</code><span>：有两种类型: UnpooledByteBufAllocator.DEFAULT(非池化)和PooledByteBufAllocator.DEFAULT(池化)。对于Java程序，默认使用PooledByteBufAllocator(池化)。对于安卓，默认使用UnpooledByteBufAllocator(非池化)</span></li><li><span>可以通过BootStrap中的Config为每个Channel提供独立的ByteBufAllocator实例</span></li></ul><p><img src="images/Middleware/ByteBufAllocator.png" referrerpolicy="no-referrer" alt="img"></p><p><span>解释:</span></p><ul><li><span>上图中的buffer()方法，返回一个基于堆或者直接内存存储的Bytebuf ----- 缺省是堆内存。源码: AbstractByteBufAllocator() { this(false); }</span></li><li><span>ByteBufAllocator.DEFAULT ----- 可能是池化，也可能是非池化。默认是池化(PooledByteBufAllocator.DEFAULT)</span></li></ul><p>&nbsp;</p><h4 id='unpooled缓冲区------非池化'><span>Unpooled缓冲区——非池化</span></h4><p><span>Unpooled提供静态的辅助方法来创建未池化的ByteBuf。</span></p><p><img src="images/Middleware/Unpooled缓冲区.png" referrerpolicy="no-referrer" alt="Unpooled缓冲区"></p><p><span>注意:</span></p><ul><li><span>上图的buffer()方法，返回一个未池化的基于堆内存存储的ByteBuf</span></li><li><span>wrappedBuffer() ----- 创建一个视图，返回一个包装了给定数据的ByteBuf。非常实用</span></li></ul><p><span>创建ByteBuf代码:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">createByteBuf</span>(<span class="cm-variable">ChannelHandlerContext</span> <span class="cm-variable">ctx</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 1. 通过Channel创建ByteBuf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf1</span> <span class="cm-operator">=</span> <span class="cm-variable">ctx</span>.<span class="cm-variable">channel</span>().<span class="cm-variable">alloc</span>().<span class="cm-variable">buffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 2. 通过ByteBufAllocator.DEFAULT创建</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf2</span> <span class="cm-operator">=</span> &nbsp;<span class="cm-variable">ByteBufAllocator</span>.<span class="cm-variable">DEFAULT</span>.<span class="cm-variable">buffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 3. 通过Unpooled创建</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buf3</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p>&nbsp;</p><h4 id='bytebufutil类'><span>ByteBufUtil类</span></h4><p><span>ByteBufUtil类提供了用于操作ByteBuf的静态的辅助方法: hexdump()和equals</span></p><ul><li><span>hexdump()：以十六进制的表示形式打印ByteBuf的内容。非常有价值</span></li><li><span>equals()：判断两个ByteBuf实例的相等性</span></li></ul><p>&nbsp;</p><h3 id='引用计数'><span>引用计数</span></h3><p><span>Netty4.0版本中为ButeBuf和ButeBufHolder引入了引用计数技术。请区别引用计数和可达性分析算法(jvm垃圾回收)</span></p><ul><li><span>谁负责释放：一般来说，是由最后访问(引用计数)对象的那一方来负责将它释放</span></li><li><span>buffer.release()：引用计数减1</span></li><li><span>buffer.retain()：引用计数加1</span></li><li><span>buffer.refCnt()：返回当前对象引用计数值</span></li><li><span>buffer.touch()：记录当前对象的访问位置，主要用于调试</span></li><li><span>引用计数并非仅对于直接缓冲区(direct Buffer)。ByteBuf的三种模式: 堆缓冲区(heap Buffer)、直接缓冲区(dirrect Buffer)和复合缓冲区(Composite Buffer)都使用了引用计数，某些时候需要程序员手动维护引用数值</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">releaseReferenceCountedObject</span>(){</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ByteBuf</span> <span class="cm-variable">buffer</span> <span class="cm-operator">=</span> <span class="cm-variable">ByteBufAllocator</span>.<span class="cm-variable">DEFAULT</span>.<span class="cm-variable">buffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 引用计数加1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buffer</span>.<span class="cm-variable">retain</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 输出引用计数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buffer</span>.<span class="cm-variable">refCnt</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 引用计数减1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">buffer</span>.<span class="cm-variable">release</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p>&nbsp;</p><h2 id='zero-copy'><span>Zero-Copy</span></h2><p><strong><span>Netty</span></strong><span> 的</span><code>Zero-copy</code><span> 体现在如下几个个方面:</span></p><ul><li><strong><span>通过CompositeByteBuf实现零拷贝</span></strong><span>：Netty提供了</span><code>CompositeByteBuf</code><span> 类，可以将多个ByteBuf合并为一个逻辑上的ByteBuf，避免了各个ByteBuf之间的拷贝</span></li><li><strong><span>通过wrap操作实现零拷贝</span></strong><span>：通过</span><code>wrap</code><span>操作，可以将byte[]、ByteBuf、ByteBuffer等包装成一个Netty ByteBuf对象，进而避免了拷贝操作</span></li><li><span>通过slice操作实现零拷贝：ByteBuf支持</span><code>slice</code><span>操作，可以将ByteBuf分解为多个共享同一个存储区域的ByteBuf，避免了内存的拷贝</span></li><li><strong><span>通过FileRegion实现零拷贝</span></strong><span>：通过 </span><code>FileRegion</code><span> 包装的</span><code>FileChannel.tranferTo</code><span> 实现文件传输，可以直接将文件缓冲区的数据发送到目标 Channel，避免了传统通过循环write方式导致的内存拷贝问题</span></li></ul><h3 id='零拷贝操作'><span>零拷贝操作</span></h3><h4 id='通过compositebytebuf实现零拷贝'><span>通过CompositeByteBuf实现零拷贝</span></h4><p><img src="images/Middleware/CompositeByteBuf实现零拷贝.png" referrerpolicy="no-referrer" alt="CompositeByteBuf实现零拷贝"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">body</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 传统合并header和body：两次额外的数据拷贝</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">allBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>(<span class="cm-variable">header</span>.<span class="cm-variable">readableBytes</span>() <span class="cm-operator">+</span> <span class="cm-variable">body</span>.<span class="cm-variable">readableBytes</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">allBuf</span>.<span class="cm-variable">writeBytes</span>(<span class="cm-variable">header</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">allBuf</span>.<span class="cm-variable">writeBytes</span>(<span class="cm-variable">body</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 合并header和body：内部这两个 ByteBuf 都是单独存在的, CompositeByteBuf 只是逻辑上是一个整体</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">CompositeByteBuf</span> <span class="cm-variable">compositeByteBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">compositeBuffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">compositeByteBuf</span>.<span class="cm-variable">addComponents</span>(<span class="cm-atom">true</span>, <span class="cm-variable">header</span>, <span class="cm-variable">body</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 底层封装了 CompositeByteBuf 操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">allByteBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">wrappedBuffer</span>(<span class="cm-variable">header</span>, <span class="cm-variable">body</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p>&nbsp;</p><h4 id='通过wrap操作实现零拷贝'><span>通过wrap操作实现零拷贝</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">byte</span>[] <span class="cm-variable">bytes</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 传统方式：直接将byte[]数组拷贝到ByteBuf中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">byteBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">buffer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">byteBuf</span>.<span class="cm-variable">writeBytes</span>(<span class="cm-variable">bytes</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// wrap方式：将bytes包装成为一个UnpooledHeapByteBuf对象, 包装过程中, 是不会有拷贝操作的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 即最后我们生成的生成的ByteBuf对象是和bytes数组共用了同一个存储空间, 对bytes的修改也会反映到ByteBuf对象中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">ByteBuf</span> <span class="cm-variable">byteBuf</span> <span class="cm-operator">=</span> <span class="cm-variable">Unpooled</span>.<span class="cm-variable">wrappedBuffer</span>(<span class="cm-variable">bytes</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h4 id='通过slice操作实现零拷贝'><span>通过slice操作实现零拷贝</span></h4><p><span>slice 操作和 wrap 操作刚好相反,</span><code>Unpooled.wrappedBuffer</code><span> 可以将多个 ByteBuf 合并为一个, 而 slice 操作可以将一个 </span><strong><span>ByteBuf </span></strong><code>切片</code><span> 为多个共享一个存储区域的 ByteBuf 对象. ByteBuf 提供了两个 slice 操作方法:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">ByteBuf</span> <span class="cm-def">slice</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">ByteBuf</span> <span class="cm-def">slice</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">index</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">length</span>);</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>不带参数的</span><code>slice</code><span>方法等同于</span><code>buf.slice(buf.readerIndex(), buf.readableBytes())</code><span> 调用, 即返回 buf 中可读部分的切片. 而 </span><code>slice(int index, int length)</code><span>方法相对就比较灵活了, 我们可以设置不同的参数来获取到 buf 的不同区域的切片。</span></p><p><span>用 </span><code>slice</code><span> 方法产生 header 和 body 的过程是没有拷贝操作的, header 和 body 对象在内部其实是共享了 byteBuf 存储空间的不同部分而已，即：</span></p><p><img src="images/Middleware/slice操作实现零拷贝.png" referrerpolicy="no-referrer" alt="slice操作实现零拷贝"></p><p>&nbsp;</p><h4 id='通过fileregion实现零拷贝'><span>通过FileRegion实现零拷贝</span></h4><p><span>Netty 中使用 FileRegion 实现文件传输的零拷贝, 不过在底层 FileRegion 是依赖于 </span><strong><span>Java NIO</span></strong><span> </span><code>FileChannel.transfer</code><span> 的零拷贝功能。当有了 FileRegion 后, 我们就可以直接通过它将文件的内容直接写入 </span><strong><span>Channel</span></strong><span> 中, 而不需要像传统的做法: 拷贝文件内容到临时 </span><strong><span>buffer</span></strong><span>, 然后再将 </span><strong><span>buffer</span></strong><span> 写入 </span><strong><span>Channel.</span></strong><span> 通过这样的零拷贝操作, 无疑对传输大文件很有帮助。</span></p><p>&nbsp;</p><h3 id='传统io的流程'><span>传统IO的流程</span></h3><p><img src="images/Middleware/传统IO的流程Copy.png" referrerpolicy="no-referrer" alt="传统IO的流程Copy"></p><p><img src="images/Middleware/传统IO的流程.png" referrerpolicy="no-referrer" alt="传统IO的流程"></p><ul><li><strong><span>「第一步」</span></strong><span>：将文件通过 </span><strong><span>「DMA」</span></strong><span> 技术从磁盘中拷贝到内核缓冲区</span></li><li><strong><span>「第二步」</span></strong><span>：将文件从内核缓冲区拷贝到用户进程缓冲区域中</span></li><li><strong><span>「第三步」</span></strong><span>：将文件从用户进程缓冲区中拷贝到 socket 缓冲区中</span></li><li><strong><span>「第四步」</span></strong><span>：将socket缓冲区中的文件通过 </span><strong><span>「DMA」</span></strong><span> 技术拷贝到网卡</span></li></ul><p>&nbsp;</p><h3 id='零拷贝整体流程图'><span>零拷贝整体流程图</span></h3><p><img src="images/Middleware/零拷贝CPU.png" referrerpolicy="no-referrer" alt="零拷贝CPU"></p><p><img src="images/Middleware/零拷贝整体流程图.png" referrerpolicy="no-referrer" alt="零拷贝整体流程图"></p><p>&nbsp;</p><h2 id='tcp粘包拆包'><span>TCP粘包拆包</span></h2><h3 id='粘包拆包图解'><span>粘包拆包图解</span></h3><p><img src="images/Middleware/CP粘包拆包图解.png" referrerpolicy="no-referrer" alt="CP粘包拆包图解"></p><p><span>假设客户端分别发送了两个数据包D1和D2给服务端，由于服务端一次读取到字节数是不确定的，故可能存在以下几种情况：</span></p><ul><li><span>服务端分两次读取到两个独立的数据包，分别是D1和D2，没有粘包和拆包</span></li><li><span>服务端一次接收到了两个数据包，D1和D2粘在一起，发生粘包</span></li><li><span>服务端分两次读取到数据包，第一次读取到了完整D1包和D2包的部分内容，第二次读取到了D2包的剩余内容，发生拆包</span></li><li><span>服务端分两次读取到数据包，第一次读取到部分D1包，第二次读取到剩余的D1包和全部的D2包</span></li><li><span>当TCP缓存再小一点的话，会把D1和D2分别拆成多个包发送</span></li></ul><p>&nbsp;</p><h3 id='产生原因-1'><span>产生原因</span></h3><p><span>产生粘包和拆包问题的主要原因是，操作系统在发送TCP数据的时候，底层会有一个缓冲区，例如1024个字节大小：</span></p><ul><li><span>如果一次请求发送的数据量比较小，没达到缓冲区大小，TCP则会将多个请求合并为同一个请求进行发送，这就形成了粘包问题</span></li><li><span>如果一次请求发送的数据量比较大，超过了缓冲区大小，TCP就会将其拆分为多次发送，这就是拆包，也就是将一个大的包拆分为多个小包进行发送</span></li></ul><p>&nbsp;</p><h3 id='解决方案-1'><span>解决方案</span></h3><h4 id='固定长度'><span>固定长度</span></h4><p><span>对于使用固定长度的粘包和拆包场景，可以使用：</span></p><ul><li><code>FixedLengthFrameDecoder</code><span>：每次读取固定长度的消息，如果当前读取到的消息不足指定长度，那么就会等待下一个消息到达后进行补足。其使用也比较简单，只需要在构造函数中指定每个消息的长度即可。</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-def">initChannel</span>(<span class="cm-variable">SocketChannel</span> <span class="cm-variable">ch</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里将FixedLengthFrameDecoder添加到pipeline中，指定长度为20</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FixedLengthFrameDecoder</span>(<span class="cm-number">20</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 将前一步解码得到的数据转码为字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">StringDecoder</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里FixedLengthFrameEncoder是我们自定义的，用于将长度不足20的消息进行补全空格</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FixedLengthFrameEncoder</span>(<span class="cm-number">20</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 最终的数据处理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">EchoServerHandler</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h4 id='指定分隔符'><span>指定分隔符</span></h4><p><span>对于通过分隔符进行粘包和拆包问题的处理，Netty提供了两个编解码的类：</span></p><ul><li><code>LineBasedFrameDecoder</code><span>：通过换行符，即</span><code>\n</code><span>或者</span><code>\r\n</code><span>对数据进行处理</span></li><li><code>DelimiterBasedFrameDecoder</code><span>：通过用户指定的分隔符对数据进行粘包和拆包处理</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-def">initChannel</span>(<span class="cm-variable">SocketChannel</span> <span class="cm-variable">ch</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">delimiter</span> <span class="cm-operator">=</span> <span class="cm-string">"_$"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 将delimiter设置到DelimiterBasedFrameDecoder中，经过该解码一器进行处理之后，源数据将会</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 被按照_$进行分隔，这里1024指的是分隔的最大长度，即当读取到1024个字节的数据之后，若还是未</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 读取到分隔符，则舍弃当前数据段，因为其很有可能是由于码流紊乱造成的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">DelimiterBasedFrameDecoder</span>(<span class="cm-number">1024</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Unpooled</span>.<span class="cm-variable">wrappedBuffer</span>(<span class="cm-variable">delimiter</span>.<span class="cm-variable">getBytes</span>())));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 将分隔之后的字节数据转换为字符串数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">StringDecoder</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这是我们自定义的一个编码器，主要作用是在返回的响应数据最后添加分隔符</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">DelimiterBasedFrameEncoder</span>(<span class="cm-variable">delimiter</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 最终处理数据并且返回响应的handler</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">EchoServerHandler</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 432px;"></div><div class="CodeMirror-gutters" style="display: none; height: 432px;"></div></div></div></pre><p>&nbsp;</p><h4 id='数据包长度字段'><span>数据包长度字段</span></h4><p><span>处理粘拆包的主要思想是在生成的数据包中添加一个长度字段，用于记录当前数据包的长度。</span></p><ul><li><p><code>LengthFieldBasedFrameDecoder</code><span>：按照参数指定的包长度偏移量数据对接收到的数据进行解码，从而得到目标消息体数据。解码过程如下图所示：</span></p><p><img src="images/Middleware/LengthFieldBasedFrameDecoder.png" referrerpolicy="no-referrer" alt="LengthFieldBasedFrameDecoder"></p></li><li><p><code>LengthFieldPrepender</code><span>：在响应的数据前面添加指定的字节数据，这个字节数据中保存了当前消息体的整体字节数据长度。编码过程如下图所示：</span></p><p><img src="images/Middleware/LengthFieldPrepender.png" referrerpolicy="no-referrer" alt="LengthFieldPrepender"></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Override</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable-3">void</span> <span class="cm-def">initChannel</span>(<span class="cm-variable">SocketChannel</span> <span class="cm-variable">ch</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里将LengthFieldBasedFrameDecoder添加到pipeline的首位，因为其需要对接收到的数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 进行长度字段解码，这里也会对数据进行粘包和拆包处理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">LengthFieldBasedFrameDecoder</span>(<span class="cm-number">1024</span>, <span class="cm-number">0</span>, <span class="cm-number">2</span>, <span class="cm-number">0</span>, <span class="cm-number">2</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// LengthFieldPrepender是一个编码器，主要是在响应字节数据前面添加字节长度字段</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">LengthFieldPrepender</span>(<span class="cm-number">2</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 对经过粘包和拆包处理之后的数据进行json反序列化，从而得到User对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">JsonDecoder</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 对响应数据进行编码，主要是将User对象序列化为json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">JsonEncoder</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 处理客户端的请求的数据，并且进行响应</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ch</span>.<span class="cm-variable">pipeline</span>().<span class="cm-variable">addLast</span>(<span class="cm-keyword">new</span> <span class="cm-variable">EchoServerHandler</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 389px;"></div><div class="CodeMirror-gutters" style="display: none; height: 389px;"></div></div></div></pre><p>&nbsp;</p><h4 id='自定义粘包拆包器'><span>自定义粘包拆包器</span></h4><p><span>可以通过实现</span><code>MessageToByteEncoder</code><span>和</span><code>ByteToMessageDecoder</code><span>来实现自定义粘包和拆包处理的目的。</span></p><ul><li><code>MessageToByteEncoder</code><span>：作用是将响应数据编码为一个ByteBuf对象</span></li><li><code>ByteToMessageDecoder</code><span>：将接收到的ByteBuf数据转换为某个对象数据</span></li></ul><p>&nbsp;</p><h2 id='高性能'><span>高性能</span></h2><ul><li><strong><span>IO线程模型</span></strong><span>：同步非阻塞，用最少的资源做更多的事</span></li><li><strong><span>内存零拷贝</span></strong><span>：尽量减少不必要的内存拷贝，实现了更高效率的传输</span></li><li><strong><span>内存池设计</span></strong><span>：申请的内存可以重用，主要指直接内存。内部实现是用一颗二叉查找树管理内存分配情况</span></li><li><strong><span>串形化处理读写</span></strong><span>：避免使用锁带来的性能开销</span></li><li><strong><span>高性能序列化协议</span></strong><span>：支持 protobuf 等高性能序列化协议</span></li></ul><p>&nbsp;</p><h2 id='操作系统调优'><span>操作系统调优</span></h2><h3 id='文件描述符'><span>文件描述符</span></h3><ul><li><span>设置系统最大文件句柄数</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> /proc/sys/fs/file-max</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修改</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">在/etc/sysctl.conf插入fs<span class="cm-def">.file-max</span><span class="cm-operator">=</span><span class="cm-number">1000000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 配置生效</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sysctl <span class="cm-attribute">-p</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><ul><li><span>设置单进程打开的最大句柄数</span></li></ul><p><span>默认单进程打开的最大句柄数是 </span><code>1024</code><span>，通过 </span><code>ulimit -a</code><span> 可以查看相关参数，示例如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-punctuation">[</span><span class="cm-identifier">root</span><span class="cm-variable-2">@test</span> <span class="cm-error">~</span><span class="cm-punctuation">]</span><span class="cm-comment"># ulimit -a</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">core</span> <span class="cm-identifier">file</span> <span class="cm-identifier">size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">(</span><span class="cm-identifier">blocks</span><span class="cm-punctuation">,</span> <span class="cm-operator">-</span><span class="cm-identifier">c</span><span class="cm-punctuation">)</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">data</span> <span class="cm-identifier">seg</span> <span class="cm-identifier">size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-identifier">kbytes</span><span class="cm-punctuation">,</span> <span class="cm-operator">-</span><span class="cm-identifier">d</span><span class="cm-punctuation">)</span> <span class="cm-identifier">unlimited</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">scheduling</span> <span class="cm-identifier">priority</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-operator">-</span><span class="cm-identifier">e</span><span class="cm-punctuation">)</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">file</span> <span class="cm-identifier">size</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-identifier">blocks</span><span class="cm-punctuation">,</span> <span class="cm-operator">-f</span><span class="cm-punctuation">)</span> <span class="cm-identifier">unlimited</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">pending</span> <span class="cm-identifier">signals</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-operator">-</span><span class="cm-identifier">i</span><span class="cm-punctuation">)</span> <span class="cm-number">256324</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">max</span> <span class="cm-identifier">locked</span> <span class="cm-identifier">memory</span> &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-identifier">kbytes</span><span class="cm-punctuation">,</span> <span class="cm-operator">-</span><span class="cm-identifier">l</span><span class="cm-punctuation">)</span> <span class="cm-number">64</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">max</span> <span class="cm-identifier">memory</span> <span class="cm-identifier">size</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-punctuation">(</span><span class="cm-identifier">kbytes</span><span class="cm-punctuation">,</span> <span class="cm-operator">-</span><span class="cm-identifier">m</span><span class="cm-punctuation">)</span> <span class="cm-identifier">unlimited</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-identifier">open</span> <span class="cm-identifier">files</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">(</span><span class="cm-operator">-</span><span class="cm-identifier">n</span><span class="cm-punctuation">)</span> <span class="cm-number">1024</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">......</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p><span>当并发接入的TCP连接数超过上限时，就会报“too many open files”，所有新的客户端接入将失败。通过 </span><code>vi /etc/security/limits.conf</code><span> 命令添加如下配置参数：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">*</span> &nbsp;<span class="cm-identifier">soft</span> &nbsp;<span class="cm-identifier">nofile</span> &nbsp;<span class="cm-number">1000000</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">*</span> &nbsp;<span class="cm-identifier">hard</span> &nbsp;<span class="cm-identifier">nofile</span> &nbsp;<span class="cm-number">1000000</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>修改之后保存，注销当前用户，重新登录，通过 </span><code>ulimit -a</code><span> 查看修改的状态是否生效。</span></p><p><strong><span>注意</span></strong><span>：尽管我们可以将单个进程打开的最大句柄数修改的非常大，但是当句柄数达到一定数量级之后，处理效率将出现明显下降，因此，需要根据服务器的硬件配置和处理能力进行合理设置。</span></p><p>&nbsp;</p><h3 id='tcpip相关参数'><span>TCP/IP相关参数</span></h3><p><span>需要重点调优的TCP IP参数如下：</span></p><ul><li><span>net.ipv4.tcp_rmem：为每个TCP连接分配的读缓冲区内存大小。第一个值时socket接收缓冲区分配的最小字节数。</span></li></ul><p>&nbsp;</p><h3 id='多网卡队列和软中断'><span>多网卡队列和软中断</span></h3><ul><li><p><strong><span>TCP缓冲区</span></strong></p><p><span>根据推送消息的大小，合理设置以下两个参数，对于海量长连接，通常 32K 是个不错的选择：</span></p><ul><li><strong><span>SO_SNDBUF</span></strong><span>：发送缓冲区大小</span></li><li><strong><span>SO_RCVBUF</span></strong><span>：接收缓冲区大小</span></li></ul></li><li><p><strong><span>软中断</span></strong></p><p><span>使用命令 </span><code>cat /proc/interrupts</code><span> 查看网卡硬件中断的运行情况，如果全部被集中在CPU0上处理，则无法并行执行多个软中断。Linux kernel内核≥2.6.35的版本，可以开启RPS，网络通信能力提升20%以上，RPS原理是：根据数据包的源地址、目的地址和源端口等，计算出一个Hash值，然后根据Hash值来选择软中断运行的CPU，即实现每个链接和CPU绑定，通过Hash值来均衡软中断运行在多个CPU上。</span></p></li></ul><p>&nbsp;</p><h2 id='netty性能调优'><span>Netty性能调优</span></h2><h3 id='设置合理的线程数'><span>设置合理的线程数</span></h3><p><strong><span>boss线程池优化</span></strong></p><p><span>对于Netty服务端，通常只需要启动一个监听端口用于端侧设备接入，但是如果集群实例较少，甚至是单机部署，那么在短时间内大量设备接入时，需要对服务端的监听方式和线程模型做优化，即服务端监听多个端口，利用主从Reactor线程模型。由于同时监听了多个端口，每个ServerSocketChannel都对应一个独立的Acceptor线程，这样就能并行处理，加速端侧设备的接人速度，减少端侧设备的连接超时失败率，提高单节点服务端的处理性能。</span></p><p>&nbsp;</p><p><strong><span>work线程池优化(I/O工作线程池)</span></strong></p><p><span>对于I/O工作线程池的优化，可以先采用系统默认值（cpu内核数*2）进行性能测试，在性能测试过程中采集I/O线程的CPU占用大小，看是否存在瓶颈，具体策略如下：</span></p><ul><li><span>通过执行 </span><code>ps -ef|grep java</code><span> 找到服务端进程pid</span></li><li><span>执行</span><code>top -Hp pid</code><span>查询该进程下所有线程的运行情况，通过“shift+p”对CPU占用大小做排序，获取线程的pid及对应的CPU占用大小</span></li><li><span>使用</span><code>printf&#39;%x\n&#39; pid</code><span>将pid转换成16进制格式</span></li><li><span>通过</span><code>jstack -f pid</code><span>命令获取线程堆栈，或者通过jvisualvm工具打印线程堆栈，找到I/O work工作线程，查看他们的CPU占用大小及线程堆栈，关键词：</span><code>SelectorImpl.lockAndDoSelect</code></li></ul><p><strong><span>分析</span></strong></p><ul><li><p><span>如果连续采集几次进行对比，发现线程堆栈都停留在SelectorImpl.lockAndDoSelect处，则说明I/O线程比较空闲，无需对工作线程数做调整</span></p></li><li><p><span>如果发现I/O线程的热点停留在读或写操作，或停留在ChannelHandler的执行处，则可以通过适当调大NioEventLoop线程的个数来提升网络的读写性能。调整方式有两种：</span></p><ul><li><span>接口API指定：在创建NioEventLoopGroup实例时指定线程数</span></li><li><span>系统参数指定：通过-Dio.netty.eventLoopThreads来指定NioEventLoopGroup线程池（不建议）</span></li></ul></li></ul><p>&nbsp;</p><h3 id='心跳检测优化'><span>心跳检测优化</span></h3><p><span>心跳检测的目的就是确认当前链路是否可用，对方是否活着并且能够正常接收和发送消息。从技术层面看，要解决链路的可靠性问题，必须周期性地对链路进行有效性检测。目前最流行和通用的做法就是心跳检测。</span></p><p><strong><span>海量设备接入的服务端心跳优化策略</span></strong></p><ul><li><strong><span>要能够及时检测失效的连接，并将其剔除</span></strong><span>。防止无效的连接句柄积压，导致OOM等问题</span></li><li><strong><span>设置合理的心跳周期</span></strong><span>。防止心跳定时任务积压，造成频繁的老年代GC（新生代和老年代都有导致STW的GC，不过耗时差异较大），导致应用暂停</span></li><li><strong><span>使用Nety提供的链路空闲检测机制</span></strong><span>。不要自己创建定时任务线程池，加重系统的负担，以及增加潜在的并发安全问题</span></li></ul><p><strong><span>心跳检测机制分为三个层面</span></strong></p><ul><li><strong><span>TCP层的心跳检测</span></strong><span>：即TCP的 Keep-Alive机制，它的作用域是整个TCP协议栈</span></li><li><strong><span>协议层的心跳检测</span></strong><span>：主要存在于长连接协议中，例如MQTT</span></li><li><strong><span>应用层的心跳检测</span></strong><span>：它主要由各业务产品通过约定方式定时给对方发送心跳消息实现</span></li></ul><p><strong><span>心跳检测机制分类</span></strong></p><ul><li><strong><span>Ping-Pong型心跳</span></strong><span>：由通信一方定时发送Ping消息，对方接收到Ping消息后立即返回Pong答应消息给对方，属于“请求-响应型”心跳</span></li><li><strong><span>Ping-Ping型心跳</span></strong><span>：不区分心跳请求和答应，由通信双发按照约定时间向对方发送心跳Ping消息，属于”双向心跳“</span></li></ul><p><strong><span>心跳检测机制策略</span></strong></p><ul><li><strong><span>心跳超时</span></strong><span>：连续N次检测都没有收到对方的Pong应答消息或Ping请求消息，则认为链路已经发生逻辑失效</span></li><li><strong><span>心跳失败</span></strong><span>：在读取和发送心跳消息的时候，如果直接发生了IO异常，说明链路已经失效</span></li></ul><p><strong><span>链路空闲检测机制</span></strong></p><ul><li><strong><span>读空闲</span></strong><span>：链路持续时间T没有读取到任何消息</span></li><li><strong><span>写空闲</span></strong><span>：链路持续时间T没有发送任何消息</span></li><li><strong><span>读写空闲</span></strong><span>：链路持续时间T没有接收或者发送任何消息</span></li></ul><p>&nbsp;</p><p><strong><span>案例分析</span></strong></p><p><span>由于移动无线网络的特点，推送服务的心跳周期并不能设置的太长，否则长连接会被释放，造成频繁的客户端重连，但是也不能设置太短，否则在当前缺乏统一心跳框架的机制下很容易导致信令风暴（例如微信心跳信令风暴问题）。具体的心跳周期并没有统一的标准，180S 也许是个不错的选择，微信为 300S。</span></p><p><span>在 Netty 中，可以通过在 ChannelPipeline 中增加 IdleStateHandler 的方式实现心跳检测，在构造函数中指定链路空闲时间，然后实现空闲回调接口，实现心跳的发送和检测。拦截链路空闲事件并处理心跳：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyHandler</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ChannelHandlerAdapter</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">userEventTriggered</span>(<span class="cm-variable">ChannelHandlerContext</span> <span class="cm-variable">ctx</span>, <span class="cm-variable-3">Object</span> <span class="cm-variable">evt</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">evt</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">IdleStateEvent</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 心跳处理</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p><strong><span>心跳优化结论</span></strong></p><ul><li><span>对于百万级的服务器，一般不建议很长的心跳周期和超时时长</span></li><li><span>心跳检测周期通常不要超过60s，心跳检测超时通常为心跳检测周期的2倍</span></li><li><span>建议通过IdleStateHandler实现心跳，不要自己创建定时任务线程池，加重系统负担和增加潜在并发安全问题</span></li><li><span>发生心跳超时或心跳失败时，都需要关闭链路，由客户端发起重连操作，保证链路能够恢复正常</span></li><li><span>链路空闲事件被触发后并没有关闭链路，而是触发IdleStateEvent事件，用户订阅IdleStateEvent事件，用于自定义逻辑处理。如关闭链路、客户端发起重新连接、告警和日志打印等</span></li><li><span>链路空闲检测类库主要包括：IdleStateHandler、ReadTimeoutHandler、WriteTimeoutHandler</span></li></ul><p>&nbsp;</p><h3 id='接收和发送缓冲区调优'><span>接收和发送缓冲区调优</span></h3><p><span>对于长链接，每个链路都需要维护自己的消息接收和发送缓冲区，JDK 原生的 NIO 类库使用的是java.nio.ByteBuffer, 它实际是一个长度固定的byte[]，无法动态扩容。</span></p><p><strong><span>场景</span></strong><span>：假设单条消息最大上限为10K，平均大小为5K，为满足10K消息处理，ByteBuffer的容量被设置为10K，这样每条链路实际上多消耗了5K内存，如果长链接链路数为100万，每个链路都独立持有ByteBuffer接收缓冲区，则额外损耗的总内存Total(M) =1000000×5K=4882M</span></p><p>&nbsp;</p><p><span>Netty提供的ByteBuf支持容量动态调整，同时提供了两种接收缓冲区的内存分配器：</span></p><ul><li><strong><span>FixedRecvByteBufAllocator</span></strong><span>：固定长度的接收缓冲区分配器，它分配的ByteBuf长度是固定大小的，并不会根据实际数据报大小动态收缩。但如果容量不足，支持动态扩展</span></li><li><strong><span>AdaptiveRecvByteBufAllocator</span></strong><span>：容量动态调整的接收缓冲区分配器，会根据之前Channel接收到的数据报大小进行计算，如果连续填充满接收缓冲区的可写空间，则动态扩展容量。如果连续2次接收到的数据报都小于指定值，则收缩当前的容量，以节约内存</span></li></ul><p><span>相对于FixedRecvByteBufAllocator，使用AdaptiveRecvByteBufAllocator更为合理，可在创建客户端或者服务端的时候指定RecvByteBufAllocator。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Bootstrap</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Bootstrap</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">b</span>.<span class="cm-variable">group</span>(<span class="cm-variable">group</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">channel</span>(<span class="cm-variable">NioSocketChannel</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">option</span>(<span class="cm-variable">ChannelOption</span>.<span class="cm-variable">TCP_NODELAY</span>, <span class="cm-atom">true</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">option</span>(<span class="cm-variable">ChannelOption</span>.<span class="cm-variable">RCVBUF_ALLOCATOR</span>, <span class="cm-variable">AdaptiveRecvByteBufAllocator</span>.<span class="cm-variable">DEFAULT</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>：无论是接收缓冲区还是发送缓冲区，缓冲区的大小建议设置为消息的平均大小，不要设置成最大消息的上限，这会导致额外的内存浪费。</span></p><p>&nbsp;</p><h3 id='合理使用内存池'><span>合理使用内存池</span></h3><p><span>每个NioEventLoop线程处理N个链路。</span><strong><span>链路处理流程</span></strong><span>：开始处理A链路→</span><strong><span>创建接收缓冲区(创建ByteBuf)</span></strong><span>→消息解码→封装成POJO对象→提交至后台线程成Task→</span><strong><span>释放接收缓冲区</span></strong><span>→开始处理B链路。</span></p><p><span>如果使用内存池，则当A链路接收到新数据报后，从NioEventLoop的内存池中申请空闲的ByteBuf，解码完成后，调用release将ByteBuf释放到内存池中，供后续B链路继续使用。使用内存池优化后，单个NioEventLoop的ByteBuf申请和GC次数从原来的N=1000000/64= 15625次减少为最少0次（假设每次申请都有可用的内存）。</span></p><p><span>Netty默认不使用内存池，需要在创建客户端或者服务端的时候进行指定：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Bootstrap</span> <span class="cm-variable">b</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Bootstrap</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">b</span>.<span class="cm-variable">group</span>(<span class="cm-variable">group</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">channel</span>(<span class="cm-variable">NioSocketChannel</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">option</span>(<span class="cm-variable">ChannelOption</span>.<span class="cm-variable">TCP_NODELAY</span>, <span class="cm-atom">true</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">option</span>(<span class="cm-variable">ChannelOption</span>.<span class="cm-variable">ALLOCATOR</span>, <span class="cm-variable">PooledByteBufAllocator</span>.<span class="cm-variable">DEFAULT</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><span>使用内存池之后，内存的申请和释放必须成对出现，即 retain() 和 release() 要成对出现，否则会导致内存泄露。值得注意的是，如果使用内存池，完成 ByteBuf 的解码工作之后必须显式的调用 ReferenceCountUtil.release(msg) 对接收缓冲区 ByteBuf 进行内存释放，否则它会被认为仍然在使用中，这样会导致内存泄露。</span></p><p>&nbsp;</p><h3 id='防止io线程被意外阻塞'><span>防止I/O线程被意外阻塞</span></h3><p><span>通常情况不能在Netty的I/O线程上做执行时间不可控的操作，如访问数据库、调用第三方服务等，但有一些隐形的阻塞操作却容易被忽略，如打印日志。</span></p><p><span>生产环境中，一般需要实时打印接口日志，其它日志处于ERROR级别，当服务发生I/O异常后，会记录异常日志。如果磁盘的WIO比较高，可能会发生写日志文件操作被同步阻塞，阻塞时间无法预测，就会导致Netty的NioEventLoop线程被阻塞，Socket链路无法被及时管理，其它链路也无法进行读写操作等。</span></p><p><span>常用的log4j虽然支持异步写日志(AsyncAppender)，但当日志队列满之后，它会同步阻塞业务线程，直到日志队列有空闲位置可用。</span></p><p><span>类似问题具有极强的隐蔽性，往往WIO高的时间持续非常短，或是偶现的，在测试环境中很难模拟此类故障，问题定位难度大。</span></p><p>&nbsp;</p><h3 id='io线程与业务线程分离'><span>I/O线程与业务线程分离</span></h3><ul><li><p><span>如果服务端不做复杂业务逻辑操作，仅是简单内存操作和消息转发，则可通过调大NioEventLoop工作线程池的方式，直接在I/O线程中执行业务ChannelHandler，这样便减少了一次线上上下文切换，性能反而更高</span></p></li><li><p><span>如果有复杂的业务逻辑操作，则建议I/O线程和业务线程分离。</span></p><ul><li><span>对于I/O线程，由于互相之间不存在锁竞争，可以创建一个大的NioEventLoopGroup线程组，所有Channel都共享一个线程池</span></li><li><span>对于后端的业务线程池，则建议创建多个小的业务线程池，线程池可以与I/O线程绑定，这样既减少了锁竞争，又提升了后端的处理性能</span></li></ul></li></ul><p>&nbsp;</p><h3 id='服务端并发连接数流控'><span>服务端并发连接数流控</span></h3><p><span>无论服务端的性能优化到多少，都需要考虑流控功能。当资源成为瓶颈，或遇到端侧设备的大量接入，需要通过流控对系统做保护。一般Netty主要考虑并发连接数的控制。</span></p><p>&nbsp;</p><h2 id='案例分析'><span>案例分析</span></h2><h3 id='疑似内存泄漏'><span>疑似内存泄漏</span></h3><p><strong><span>环境</span></strong><span>：8C16G的Linux</span></p><p><strong><span>描述</span></strong><span>：boss为1，worker为6，其余分配给业务使用，保持10W用户长链接，2W用户并发做消息请求</span></p><p><strong><span>分析</span></strong><span>：dump内存堆栈发现Netty的ScheduledFutureTask增加了9076%，达到110W个实例。通过业务代码分析发现用户使用了IdleStateHandler用于在链路空闲时进行业务逻辑处理，但空闲时间比较大，为15分钟。Netty 的 IdleStateHandler 会根据用户的使用场景，启动三类定时任务，分别是：ReaderIdleTimeoutTask、WriterIdleTimeoutTask 和 AllIdleTimeoutTask，它们都会被加入到 NioEventLoop 的 Task 队列中被调度和执行。由于超时时间过长，10W 个长链接链路会创建 10W 个 ScheduledFutureTask 对象，每个对象还保存有业务的成员变量，非常消耗内存。用户的持久代设置的比较大，一些定时任务被老化到持久代中，没有被 JVM 垃圾回收掉，内存一直在增长，用户误认为存在内存泄露，即小问题被放大而引出的问题。</span></p><p><strong><span>解决</span></strong><span>：重新设计和反复压测之后将超时时间设置为45秒，内存可以实现正常回收。</span></p><p>&nbsp;</p><h3 id='当心closewait'><span>当心CLOSE_WAIT</span></h3><p><span>由于网络不稳定经常会导致客户端断连，如果服务端没有能够及时关闭 socket，就会导致处于 close_wait 状态的链路过多。close_wait 状态的链路并不释放句柄和内存等资源，如果积压过多可能会导致系统句柄耗尽，发生“Too many open files”异常，新的客户端无法接入，涉及创建或者打开句柄的操作都将失败。</span></p><p><span>close_wait 是被动关闭连接是形成的，根据 TCP 状态机，服务器端收到客户端发送的 FIN，TCP 协议栈会自动发送 ACK，链接进入 close_wait 状态。但如果服务器端不执行 socket 的 close() 操作，状态就不能由 close_wait 迁移到 last_ack，则系统中会存在很多 close_wait 状态的连接。通常来说，一个 close_wait 会维持至少 2 个小时的时间（系统默认超时时间的是 7200 秒，也就是 2 小时）。如果服务端程序因某个原因导致系统造成一堆 close_wait 消耗资源，那么通常是等不到释放那一刻，系统就已崩溃。</span></p><p><span>导致 close_wait 过多的可能原因如下：</span></p><ul><li><strong><span>程序处理Bug</span></strong><span>：导致接收到对方的 fin 之后没有及时关闭 socket，这可能是 Netty 的 Bug，也可能是业务层 Bug，需要具体问题具体分析</span></li><li><strong><span>关闭socket不及时</span></strong><span>：例如 I/O 线程被意外阻塞，或者 I/O 线程执行的用户自定义 Task 比例过高，导致 I/O 操作处理不及时，链路不能被及时释放</span></li></ul><p><strong><span>解决方案</span></strong></p><ul><li><strong><span>不要在 Netty 的 I/O 线程（worker线程）上处理业务（心跳发送和检测除外）</span></strong></li><li><strong><span>在I/O线程上执行自定义Task要当心</span></strong></li><li><strong><span>IdleStateHandler、ReadTimeoutHandler和WriteTimeoutHandler使用要当</span></strong></li></ul><p>&nbsp;</p><h1 id='rabbitmq'><span>RabbitMQ</span></h1><h2 id='模式介绍'><span>模式介绍</span></h2><p><span>在 RabbitMQ 官网上提供了 6 中工作模式：简单模式、工作队列模式、发布/订阅模式、路由模式、主题模式 和 RPC 模式。本篇只对前 5 种工作方式进行介绍。</span></p><p>&nbsp;</p><h3 id='简单模式与工作队列模式'><span>简单模式与工作队列模式</span></h3><p><span>之所以将这两种模式合并在一起介绍，是因为它们工作原理非常简单，由 3 个对象组成：生产者、队列、消费者。</span></p><p><a href='http://images.extlight.com/rabbitmq-work-01.png'><img src="images/Middleware/rabbitmq-work-01.png" referrerpolicy="no-referrer" alt="img"></a></p><p><span>生产者负责生产消息，将消息发送到队列中，消费者监听队列，队列有消息就进行消费。</span></p><p><a href='http://images.extlight.com/rabbitmq-work-02.png'><img src="images/Middleware/rabbitmq-work-02.png" referrerpolicy="no-referrer" alt="img"></a></p><p><span>当有多个消费者时，消费者平均消费队列中的消息。代码演示：</span></p><p><span>生产者：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//1.获取连接</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">ConnectionUtil</span>.<span class="cm-variable">getConnection</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//2.创建通道</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Channel</span> <span class="cm-variable">channel</span> <span class="cm-operator">=</span> <span class="cm-variable">connection</span>.<span class="cm-variable">createChannel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//3.申明队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">queueDeclare</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">null</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//4.发送消息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">basicPublish</span>(<span class="cm-string">""</span>, <span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">null</span>, <span class="cm-string">"hello simple"</span>.<span class="cm-variable">getBytes</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"发送成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//5.释放连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">connection</span>.<span class="cm-variable">close</span>();</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p><span>消费者：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 1.获取连接</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">ConnectionUtil</span>.<span class="cm-variable">getConnection</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 2.创建通道</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Channel</span> <span class="cm-variable">channel</span> <span class="cm-operator">=</span> <span class="cm-variable">connection</span>.<span class="cm-variable">createChannel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 3.申明队列</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">queueDeclare</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">null</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 4.监听消息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">basicConsume</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">true</span>, <span class="cm-keyword">new</span> <span class="cm-variable">DefaultConsumer</span>(<span class="cm-variable">channel</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">handleDelivery</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">consumerTag</span>, <span class="cm-variable">Envelope</span> <span class="cm-variable">envelope</span>, <span class="cm-variable">BasicProperties</span> <span class="cm-variable">properties</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">body</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">message</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">body</span>, <span class="cm-string">"UTF-8"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"接收:"</span> <span class="cm-operator">+</span> <span class="cm-variable">message</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p>&nbsp;</p><h3 id='发布订阅路由与主题模式'><span>发布/订阅、路由与主题模式</span></h3><p><span>这 3 种模式都使用到交换机。生产者不直接与队列交互，而是将消息发送到交换机中，再由交换机将消息放入到已绑定该交换机的队列中给消费者消费。常用的交换机类型有 3 种：fanout、direct、topic。工作原理图如下：</span></p><p><a href='http://images.extlight.com/rabbitmq-work-03-1.png'><img src="images/Middleware/rabbitmq-work-03-1.png" referrerpolicy="no-referrer" alt="img"></a></p><p><strong><span>fanout</span></strong><span>：不处理路由键。只需要简单的将队列绑定到交换机上。一个发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。很像子网广播，每台子网内的主机都获得了一份复制的消息。fanout 类型交换机转发消息是最快的。</span></p><p><strong><span>其中，发布/订阅模式使用的是 fanout 类型的交换机。</span></strong></p><p><a href='http://images.extlight.com/rabbitmq-work-04-1.png'><img src="images/Middleware/rabbitmq-work-04-1.png" referrerpolicy="no-referrer" alt="img"></a></p><p><strong><span>direct</span></strong><span>：处理路由键。需要将一个队列绑定到交换机上，要求该消息与一个特定的路由键完全匹配。如果一个队列绑定到该交换机上要求路由键 “dog”，则只有被标记为 “dog” 的消息才被转发，不会转发 dog.puppy，也不会转发 dog.guard，只会转发dog。</span></p><p><strong><span>其中，路由模式使用的是 direct 类型的交换机。</span></strong></p><p><a href='http://images.extlight.com/rabbitmq-work-05-1.png'><img src="images/Middleware/rabbitmq-work-05-1.png" referrerpolicy="no-referrer" alt="img"></a></p><p><strong><span>topic</span></strong><span>：将路由键和某模式进行匹配。此时队列需要绑定要一个模式上。符号 “#” 匹配一个或多个词，符号“</span><span>*</span><span>”匹配不多不少一个词。因此“audit.#” 能够匹配到“audit.irs.corporate”，但是“audit.*” 只会匹配到 “audit.irs”。</span></p><p><strong><span>其中，主题模式使用的是 topic 类型的交换机。</span></strong><span>代码演示：</span></p><p><span>生产者：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 1.获取连接</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">ConnectionUtil</span>.<span class="cm-variable">getConnection</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 2.创建通道</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Channel</span> <span class="cm-variable">channel</span> <span class="cm-operator">=</span> <span class="cm-variable">connection</span>.<span class="cm-variable">createChannel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 3.申明交换机</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">exchangeDeclare</span>(<span class="cm-variable">EXCHANGE_NAME</span>, <span class="cm-string">"fanout"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 4.发送消息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">100</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-variable">channel</span>.<span class="cm-variable">basicPublish</span>(<span class="cm-variable">EXCHANGE_NAME</span>, <span class="cm-string">""</span>, <span class="cm-atom">null</span>, (<span class="cm-string">"hello ps"</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-string">""</span>).<span class="cm-variable">getBytes</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"发送成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 5.释放连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">connection</span>.<span class="cm-variable">close</span>();</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><span>多个消费者：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 1.获取连接</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">ConnectionUtil</span>.<span class="cm-variable">getConnection</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 2.创建通道</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Channel</span> <span class="cm-variable">channel</span> <span class="cm-operator">=</span> <span class="cm-variable">connection</span>.<span class="cm-variable">createChannel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 3.申明交换机</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">exchangeDeclare</span>(<span class="cm-variable">EXCHANGE_NAME</span>, <span class="cm-string">"fanout"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 4.队列绑定交换机</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">queueDeclare</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">false</span>, <span class="cm-atom">null</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">queueBind</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-variable">EXCHANGE_NAME</span>, <span class="cm-string">""</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 5.消费消息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">basicQos</span>(<span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">channel</span>.<span class="cm-variable">basicConsume</span>(<span class="cm-variable">QUEUE_NAME</span>, <span class="cm-atom">false</span>, <span class="cm-keyword">new</span> <span class="cm-variable">DefaultConsumer</span>(<span class="cm-variable">channel</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">handleDelivery</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">consumerTag</span>, <span class="cm-variable">Envelope</span> <span class="cm-variable">envelope</span>, <span class="cm-variable">AMQP</span>.<span class="cm-variable">BasicProperties</span> <span class="cm-variable">properties</span>, <span class="cm-variable-3">byte</span>[] <span class="cm-variable">body</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">message</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">body</span>, <span class="cm-string">"UTF-8"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"recv1:"</span> <span class="cm-operator">+</span> <span class="cm-variable">message</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">500</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">channel</span>.<span class="cm-variable">basicAck</span>(<span class="cm-variable">envelope</span>.<span class="cm-variable">getDeliveryTag</span>(), <span class="cm-atom">false</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">});</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 605px;"></div><div class="CodeMirror-gutters" style="display: none; height: 605px;"></div></div></div></pre><p>&nbsp;</p><h1 id='dubbo'><span>Dubbo</span></h1><p><span>Apache Dubbo 是一款高性能、轻量级的开源 Java 服务框架。Apache Dubbo 提供了六大核心能力：</span><strong><span>面向接口代理的高性能RPC调用，智能容错和负载均衡，服务自动注册和发现，高度可扩展能力，运行期流量调度，可视化的服务治理与运维</span></strong><span>。</span></p><ul><li><p><strong><span>面向接口代理的高性能RPC调用</span></strong></p><p><span>提供高性能的基于代理的远程调用能力，服务以接口为粒度，为开发者屏蔽远程调用底层细节。</span></p></li><li><p><strong><span>智能负载均衡</span></strong></p><p><span>内置多种负载均衡策略，智能感知下游节点健康状况，显著减少调用延迟，提高系统吞吐量。</span></p></li><li><p><strong><span>服务自动注册与发现</span></strong></p><p><span>支持多种注册中心服务，服务实例上下线实时感知。</span></p></li><li><p><strong><span>高度可扩展能力</span></strong></p><p><span>遵循微内核+插件的设计原则，所有核心能力如Protocol、Transport、Serialization被设计为扩展点，平等对待内置实现和第三方实现。</span></p></li><li><p><strong><span>运行期流量调度</span></strong></p><p><span>内置条件、脚本等路由策略，通过配置不同的路由规则，轻松实现灰度发布，同机房优先等功能。</span></p></li><li><p><strong><span>可视化的服务治理与运维</span></strong></p><p><span>提供丰富服务治理、运维工具：随时查询服务元数据、服务健康状态及调用统计，实时下发路由策略、调整配置参数。</span></p></li></ul><p><img src="images/Middleware/DubboArchitecture.png" referrerpolicy="no-referrer" alt="DubboArchitecture"></p><p><img src="images/Middleware/ApacheDubbo.jpg" referrerpolicy="no-referrer" alt="ApacheDubbo"></p><h2 id='rpc'><span>RPC</span></h2><p><span>Remote Procedure Call Protocol 既 </span><strong><span>远程过程调用</span></strong><span>，一种能让我们</span><strong><span>像调用本地服务一样调用远程服务</span></strong><span>，可以让调用者对网络通信这些细节</span><strong><span>无感知</span></strong><span>，比如服务消费方在执行 helloWorldService.sayHello(&quot;sowhat&quot;) 时，实质上调用的是远端的服务。这种方式其实就是</span><strong><span>RPC</span></strong><span>，</span><strong><span>RPC</span></strong><span>思想在各大互联网公司中被广泛使用，如阿里巴巴的</span><strong><span>dubbo</span></strong><span>、当当的</span><strong><span>Dubbox</span></strong><span> 、Facebook 的 </span><strong><span>thrift</span></strong><span>、Google 的</span><strong><span>grpc</span></strong><span>、Twitter的</span><strong><span>finagle</span></strong><span>等。</span></p><p>&nbsp;</p><h2 id='框架设计'><span>框架设计</span></h2><h3 id='dubbo-简介'><span>Dubbo 简介</span></h3><p><span>Dubbo 是阿里巴巴研发开源工具，主要分为2.6.x 跟 2.7.x 版本。是一款分布式、高性能、透明化的 RPC 服务框架，提供服务自动注册、自动发现等高效服务治理方案，可以和Spring 框架无缝集成，它提供了6大核心能力：</span></p><ul><li><span>面向接口代理的高性能RPC调用</span></li><li><span>智能容错和负载均衡</span></li><li><span>服务自动注册和发现</span></li><li><span>高度可扩展能力</span></li><li><span>运行期流量调度</span></li><li><span>可视化的服务治理与运维</span></li></ul><p>&nbsp;</p><p><strong><span>调用过程</span></strong><span>：</span></p><ul><li><span>服务提供者 </span><strong><span>Provider</span></strong><span> 启动然后向 </span><strong><span>Registry</span></strong><span> 注册自己所能提供的服务。</span></li><li><span>服务消费者 Consumer 向</span><strong><span>Registry</span></strong><span>订阅所需服务，</span><strong><span>Consumer</span></strong><span> 解析</span><strong><span>Registry</span></strong><span>提供的元信息，从服务中通过负载均衡选择 </span><strong><span>Provider</span></strong><span>调用。</span></li><li><span>服务提供方 </span><strong><span>Provider</span></strong><span> 元数据变更的话</span><strong><span>Registry</span></strong><span>会把变更推送给</span><strong><span>Consumer</span></strong><span>，以此保证</span><strong><span>Consumer</span></strong><span>获得最新可用信息。</span></li></ul><p>&nbsp;</p><p><strong><span>注意点</span></strong><span>：</span></p><ul><li><strong><span>Provider</span></strong><span> 跟 </span><strong><span>Consumer</span></strong><span> 在内存中记录调用次数跟时间，定时发送统计数据到</span><strong><span>Monitor</span></strong><span>，发送的时候是</span><strong><span>短</span></strong><span>连接。</span></li><li><strong><span>Monitor</span></strong><span> 跟 </span><strong><span>Registry</span></strong><span> 是可选的，可直接在配置文件中写好，</span><strong><span>Provider</span></strong><span> 跟 </span><strong><span>Consumer</span></strong><span>进行直连。</span></li><li><strong><span>Monitor</span></strong><span> 跟 </span><strong><span>Registry</span></strong><span> 挂了也没事， </span><strong><span>Consumer</span></strong><span> 本地缓存了 </span><strong><span>Provider</span></strong><span> 信息。</span></li><li><strong><span>Consumer</span></strong><span> 直接调用 </span><strong><span>Provider</span></strong><span> 不会经过 </span><strong><span>Registry</span></strong><span>。</span><strong><span>Provider</span></strong><span>、</span><strong><span>Consumer</span></strong><span>这俩到 </span><strong><span>Registry</span></strong><span>之间是长连接。</span></li></ul><p>&nbsp;</p><h3 id='dubbo框架分层'><span>Dubbo框架分层</span></h3><p><img src="images/Middleware/Dubbo框架分层.jpg" referrerpolicy="no-referrer" alt="Dubbo框架分层"></p><p><span>如上图，总的而言 Dubbo 分为三层。</span></p><ul><li><strong><span>Busines</span></strong><span>层：由用户自己来提供接口和实现还有一些配置信息。</span></li><li><strong><span>RPC</span></strong><span>层：真正的RPC调用的核心层，封装整个RPC的调用过程、负载均衡、集群容错、代理。</span></li><li><strong><span>Remoting</span></strong><span>层：对网络传输协议和数据转换的封装。</span></li></ul><p>&nbsp;</p><p><span>如果每一层再细分下去，一共有十层：</span></p><ol start='' ><li><span>接口服务层（Service）：该层与业务逻辑相关，根据 provider 和 consumer 的业务设计对应的接口和实现。</span></li><li><span>配置层（Config）：对外配置接口，以 ServiceConfig 和 ReferenceConfig 为中心初始化配置。</span></li><li><span>服务代理层（Proxy）：服务接口透明代理，Provider跟Consumer都生成代理类，使得服务接口透明，代理层实现服务调用跟结果返回。</span></li><li><span>服务注册层（Registry）：封装服务地址的注册和发现，以服务 URL 为中心。</span></li><li><span>路由层（Cluster）：封装多个提供者的路由和负载均衡，并桥接注册中心，以Invoker 为中心，扩展接口为 Cluster、Directory、Router 和 LoadBlancce。</span></li><li><span>监控层（Monitor）：RPC 调用次数和调用时间监控，以 Statistics 为中心，扩展接口为 MonitorFactory、Monitor 和 MonitorService。</span></li><li><span>远程调用层（Protocal）：封装 RPC 调用，以 Invocation 和 Result 为中心，扩展接口为 Protocal、Invoker 和 Exporter。</span></li><li><span>信息交换层（Exchange）：封装请求响应模式，同步转异步。以 Request 和Response 为中心，扩展接口为 Exchanger、ExchangeChannel、ExchangeClient 和 ExchangeServer。</span></li><li><span>网络传输层（Transport）：抽象 mina 和 netty 为统一接口，以 Message 为中心，扩展接口为 Channel、Transporter、Client、Server 和 Codec。</span></li><li><span>数据序列化层（Serialize）：可复用的一些工具，扩展接口为 Serialization、ObjectInput、ObjectOutput 和 ThreadPool。</span></li></ol><p>&nbsp;</p><p><span>他们之间的调用关系直接看下面官网图即可：</span></p><p><img src="images/Middleware/Dubbo调用关系.jpg" referrerpolicy="no-referrer" alt="Dubbo调用关系"></p><p>&nbsp;</p><h2 id='spi机制'><span>SPI机制</span></h2><p><strong><span>Dubbo</span></strong><span> 采用 </span><strong><span>微内核设计</span></strong><span> + </span><strong><span>SPI</span></strong><span> 扩展技术来搭好核心框架，同时满足用户定制化需求。这里重点说下</span><strong><span>SPI</span></strong><span>。</span></p><h3 id='spi-含义'><span>SPI 含义</span></h3><p><strong><span>SPI</span></strong><span> 全称为 </span><strong><span>Service Provider Interface</span></strong><span>，是一种</span><strong><span>服务发现机制</span></strong><span>。它约定在</span><strong><span>ClassPath</span></strong><span>路径下的</span><strong><span>META-INF/services</span></strong><span>文件夹查找文件，自动加载文件里所定义的类。</span></p><p>&nbsp;</p><h3 id='java-spi缺点'><span>Java SPI缺点</span></h3><ul><li><span>不能按需加载，Java SPI在加载扩展点的时候，会一次性加载所有可用的扩展点，很多是不需要的，会浪费系统资源。</span></li><li><span>获取某个实现类的方式不够灵活，只能通过 Iterator 形式获取，不能根据某个参数来获取对应的实现类。</span></li><li><span>不支持AOP与依赖注入，JAVA SPI可能会丢失加载扩展点异常信息，导致追踪问题很困难。</span></li></ul><p>&nbsp;</p><h3 id='dubbo-spi-2'><span>Dubbo SPI</span></h3><p><span>JDK自带的不好用Dubbo 就自己实现了一个 SPI，该SPI </span><strong><span>可以通过名字实例化指定的实现类，并且实现了 IOC 、AOP 与 自适应扩展 SPI</span></strong><span> 。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">key </span>=<span class="cm-quote"> com.sowhat.value</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>Dubbo 对配置文件目录的约定，不同于 Java SPI ，Dubbo 分为了三类目录。</span></p><ul><li><span>META-INF/services/ ：该目录下 SPI 配置文件是为了用来兼容 Java SPI </span></li><li><span>META-INF/dubbo/ ：该目录存放用户自定义的 SPI 配置文件</span></li><li><span>META-INF/dubbo/internal/ ：该目录存 Dubbo 内部使用的 SPI 配置文件</span></li></ul><p>&nbsp;</p><h3 id='dubbo-spi源码追踪'><span>Dubbo SPI源码追踪</span></h3><p><strong><span>ExtensionLoader.getExtension</span></strong><span> 方法的整个思路是 查找缓存是否存在，不存在则读取SPI文件，通过反射创建类，然后设置依赖注入这些东西，有包装类就包装下，执行流程如下图所示：</span></p><p><img src="images/Middleware/DubboSPI源码追踪.png" referrerpolicy="no-referrer" alt="DubboSPI源码追踪"></p><h3 id='injectextension--ioc'><span>injectExtension  IOC</span></h3><p><span>查找 set 方法，根据参数找到依赖对象则注入。</span></p><p>&nbsp;</p><h3 id='wrapperclass-aop'><span>WrapperClass AOP</span></h3><p><span>包装类，Dubbo帮你自动包装，只需某个扩展类的构造函数只有一个参数，并且是扩展接口类型，就会被判定为包装类。</span></p><p>&nbsp;</p><h3 id='activate'><span>Activate</span></h3><p><span>Active 有三个属性，group 表示修饰在哪个端，是 provider 还是 consumer，value 表示在 URL参数中出现才会被激活，order 表示实现类的顺序。</span></p><p>&nbsp;</p><h3 id='adaptive自适应扩展'><span>Adaptive自适应扩展</span></h3><p><strong><span>需求</span></strong><span>：根据配置来进行 SPI 扩展的加载后不想在启动的时候让扩展被加载，想根据请求时候的参数来动态选择对应的扩展。</span><strong><span>实现</span></strong><span>：Dubbo用代理机制实现了自适应扩展，为用户想扩展的接口 通过JDK 或者 Javassist 编译生成一个代理类，然后通过反射创建实例。实例会根据本来方法的请求参数得知需要的扩展类，然后通过 ExtensionLoader.getExtensionLoader(type.class).getExtension(name)来获取真正的实例来调用，看个官网样例。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">WheelMaker</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Wheel</span> <span class="cm-variable">makeWheel</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// WheelMaker 接口的自适应实现类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">AdaptiveWheelMaker</span> <span class="cm-keyword">implements</span> <span class="cm-variable">WheelMaker</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Wheel</span> <span class="cm-variable">makeWheel</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">url</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IllegalArgumentException</span>(<span class="cm-string">"url == null"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">// 1. 调用 url 的 getXXX 方法获取参数值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">wheelMakerName</span> <span class="cm-operator">=</span> <span class="cm-variable">url</span>.<span class="cm-variable">getParameter</span>(<span class="cm-string">"Wheel.maker"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">wheelMakerName</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IllegalArgumentException</span>(<span class="cm-string">"wheelMakerName == null"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 2. 调用 ExtensionLoader 的 getExtensionLoader 获取加载器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 3. 调用 ExtensionLoader 的 getExtension 根据从url获取的参数作为类名称加载实现类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">WheelMaker</span> <span class="cm-variable">wheelMaker</span> <span class="cm-operator">=</span> <span class="cm-variable">ExtensionLoader</span>.<span class="cm-variable">getExtensionLoader</span>(<span class="cm-variable">WheelMaker</span>.<span class="cm-keyword">class</span>).<span class="cm-variable">getExtension</span>(<span class="cm-variable">wheelMakerName</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 4. 调用实现类的具体方法实现调用。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">wheelMaker</span>.<span class="cm-variable">makeWheel</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 540px;"></div><div class="CodeMirror-gutters" style="display: none; height: 540px;"></div></div></div></pre><p><span>查看Adaptive注解源码可知该注解可用在</span><strong><span>类</span></strong><span>或</span><strong><span>方法</span></strong><span>上，Adaptive 注解在类上或者方法上有不同的实现逻辑。</span></p><p>&nbsp;</p><h4 id='adaptive注解在类上'><span>Adaptive注解在类上</span></h4><p><span>Adaptive 注解在类上时，Dubbo 不会为该类生成代理类，Adaptive 注解在类上的情况很少，在 Dubbo 中，仅有两个类被 Adaptive 注解了，分别是 AdaptiveCompiler 和 AdaptiveExtensionFactory，表示拓展的加载逻辑由人工编码完成，这不是我们关注的重点。</span></p><p>&nbsp;</p><h4 id='adaptive注解在方法上'><span>Adaptive注解在方法上</span></h4><p><span>Adaptive注解在方法上时，Dubbo则会为该方法生成代理逻辑，表示拓展的加载逻辑需由框架自动生成，实现机制如下：</span></p><ul><li><span>加载标注有 @Adaptive 注解的接口，如果不存在，则不支持 Adaptive 机制</span></li><li><span>为目标接口按照一定的模板生成子类代码，并且编译生成的代码，然后通过反射生成该类的对象</span></li><li><span>结合生成的对象实例，通过传入的URL对象，获取指定key的配置，然后加载该key对应的类对象，最终将调用委托给该类对象进行</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SPI</span>(<span class="cm-string">"apple"</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">FruitGranter</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">Fruit</span> <span class="cm-variable">grant</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Adaptive</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">watering</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 苹果种植者</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">AppleGranter</span> <span class="cm-keyword">implements</span> <span class="cm-variable">FruitGranter</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Fruit</span> <span class="cm-variable">grant</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Apple</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">watering</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"watering apple"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"watering finished"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 香蕉种植者</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">BananaGranter</span> <span class="cm-keyword">implements</span> <span class="cm-variable">FruitGranter</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Fruit</span> <span class="cm-variable">grant</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Banana</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">watering</span>(<span class="cm-variable">URL</span> <span class="cm-variable">url</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"watering banana"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-string">"watering success"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 691px;"></div><div class="CodeMirror-gutters" style="display: none; height: 691px;"></div></div></div></pre><p><span>调用方法实现：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ExtensionLoaderTest</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Test</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">testGetExtensionLoader</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 首先创建一个模拟用的URL对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">URL</span> <span class="cm-variable">url</span> <span class="cm-operator">=</span> <span class="cm-variable">URL</span>.<span class="cm-variable">valueOf</span>(<span class="cm-string">"dubbo://192.168.0.1:1412?fruit.granter=apple"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 通过ExtensionLoader获取一个FruitGranter对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">FruitGranter</span> <span class="cm-variable">granter</span> <span class="cm-operator">=</span> <span class="cm-variable">ExtensionLoader</span>.<span class="cm-variable">getExtensionLoader</span>(<span class="cm-variable">FruitGranter</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  .<span class="cm-variable">getAdaptiveExtension</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 使用该FruitGranter调用其"自适应标注的"方法，获取调用结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">result</span> <span class="cm-operator">=</span> <span class="cm-variable">granter</span>.<span class="cm-variable">watering</span>(<span class="cm-variable">url</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">result</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p><span>通过如上方式生成一个内部类。</span></p><p>&nbsp;</p><h2 id='服务暴露流程'><span>服务暴露流程</span></h2><h3 id='服务暴露总览'><span>服务暴露总览</span></h3><p><strong><span>Dubbo</span></strong><span>框架是以</span><strong><span>URL</span></strong><span>为总线的模式，运行过程中所有的状态数据信息都可以通过</span><strong><span>URL</span></strong><span>来获取，比如当前系统采用什么序列化，采用什么通信，采用什么负载均衡等信息，都是通过</span><strong><span>URL</span></strong><span>的参数来呈现的，所以在框架运行过程中，运行到某个阶段需要相应的数据，都可以通过对应的</span><strong><span>Key</span></strong><span>从</span><strong><span>URL</span></strong><span>的参数列表中获取。</span><strong><span>URL</span></strong><span> 具体的参数如下：</span></p><ul><li><span>protocol：指的是 dubbo 中的各种协议，如：dubbo thrift http</span></li><li><span>username/password：用户名/密码</span></li><li><span>host/port：主机/端口</span></li><li><span>path：接口的名称</span></li><li><span>parameters：参数键值对</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">protocol</span>:<span class="cm-quote">//username</span>:<span class="cm-quote">password@host</span>:<span class="cm-quote">port/path?k</span>=<span class="cm-quote">v</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>服务暴露从代码流程看分为三部分：</span></p><ul><li><span>检查配置，最终组装成 </span><strong><span>URL</span></strong><span>。</span></li><li><span>暴露服务到到本地服务跟远程服务。</span></li><li><span>服务注册至注册中心。</span></li></ul><p>&nbsp;</p><p><span>服务暴露从对象构建转换看分为两步：</span></p><ul><li><span>将服务封装成</span><strong><span>Invoker</span></strong><span>。</span></li><li><span>将</span><strong><span>Invoker</span></strong><span>通过协议转换为</span><strong><span>Exporter</span></strong><span>。</span></li></ul><p>&nbsp;</p><h3 id='服务暴露源码追踪'><span>服务暴露源码追踪</span></h3><ul><li><span>容器启动，Spring IOC刷新完毕后调用 onApplicationEvent 开启服务暴露，ServiceBean </span></li><li><span>export 跟 doExport 来进行拼接构建URL，为屏蔽调用的细节，统一暴露出一个可执行体，通过ProxyFactory 获取到 invoker</span></li><li><span>调用具体 Protocol 将把包装后的 invoker 转换成 exporter，此处用到了SPI</span></li><li><span>然后启动服务器server，监听端口，使用NettyServer创建监听服务器</span></li><li><span>通过 RegistryProtocol 将URL注册到注册中心，使得consumer可获得provider信息</span></li></ul><p>&nbsp;</p><h2 id='服务引用流程'><span>服务引用流程</span></h2><p><span>Dubbo中一个可执行体就是一个invoker，所以 provider 跟 consumer 都要向 invoker 靠拢。通过上面demo可知为了无感调用远程接口，底层需要有个代理类包装 invoker。</span></p><p>&nbsp;</p><p><strong><span>服务的引入时机有两种</span></strong></p><ul><li><p><span>饿汉式</span></p><p><span>通过实现 Spring 的 InitializingBean 接口中的 afterPropertiesSet 方法，容器通过调用 </span><strong><span>ReferenceBean</span></strong><span>的 afterPropertiesSet 方法时引入服务。</span></p></li><li><p><span>懒汉式(默认)</span></p><p><span>懒汉式是只有当服务被注入到其他类中时启动引入流程。</span></p></li></ul><p>&nbsp;</p><p><strong><span>服务引用的三种方式</span></strong></p><ul><li><strong><span>本地引入</span></strong><span>：服务暴露时本地暴露，避免网络调用开销</span></li><li><strong><span>直接连接引入远程服务</span></strong><span>：不启动注册中心，直接写死远程</span><strong><span>Provider</span></strong><span>地址 进行直连</span></li><li><strong><span>通过注册中心引入远程服务</span></strong><span>：通过注册中心抉择如何进行负载均衡调用远程服务</span></li></ul><p>&nbsp;</p><p><strong><span>服务引用流程</span></strong></p><ul><li><span>检查配置构建map ，map 构建 URL ，通过URL上的协议利用自适应扩展机制调用对应的 protocol.refer 得到相应的 invoker ，此处</span></li><li><span>想注册中心注册自己，然后订阅注册中心相关信息，得到provider的 ip 等信息，再通过共享的netty客户端进行连接。</span></li><li><span>当有多个 URL 时，先遍历构建出 invoker 然后再由 </span><strong><span>StaticDirectory</span></strong><span> 封装一下，然后通过 cluster 进行合并，只暴露出一个 invoker 。</span></li><li><span>然后再构建代理，封装 invoker 返回服务引用，之后 Comsumer 调用的就是这个代理类。</span></li></ul><p>&nbsp;</p><p><strong><span>调用方式</span></strong></p><ul><li><span>oneway：不关心请求是否发送成功。</span></li><li><span>Async异步调用：Dubbo天然异步，客户端调用请求后将返回的 ResponseFuture 存到上下文中，用户可随时调用 future.get 获取结果。异步调用通过唯一</span><strong><span>ID</span></strong><span> 标识此次请求。</span></li><li><span>Sync同步调用：在 Dubbo 源码中就调用了 future.get，用户感觉方法被阻塞了，必须等结果后才返回。</span></li></ul><p>&nbsp;</p><h2 id='调用整体流程'><span>调用整体流程</span></h2><p><strong><span>调用之前你可能需要考虑这些事</span></strong></p><ul><li><span>consumer 跟 provider 约定好通讯协议，dubbo支持多种协议，比如dubbo、rmi、hessian、http、webservice等。默认走dubbo协议，连接属于</span><strong><span>单一长连接</span></strong><span>，</span><strong><span>NIO异步通信</span></strong><span>。适用传输数据量很小(单次请求在100kb以内)，但是并发量很高。</span></li><li><span>约定序列化模式，大致分为两大类，一种是字符型(XML或json 人可看懂 但传输效率低)，一种是二进制流(数据紧凑，机器友好)。默认使用 hessian2作为序列化协议。</span></li><li><span>consumer 调用 provider 时提供对应接口、方法名、参数类型、参数值、版本号。</span></li><li><span>provider列表对外提供服务涉及到负载均衡选择一个provider提供服务。</span></li><li><span>consumer 跟 provider 定时向monitor 发送信息。</span></li></ul><p>&nbsp;</p><p><strong><span>调用大致流程</span></strong></p><ul><li><span>客户端发起请求来调用接口，接口调用生成的代理类。代理类生成RpcInvocation 然后调用invoke方法。</span></li><li><span>ClusterInvoker获得注册中心中服务列表，通过负载均衡给出一个可用的invoker。</span></li><li><span>序列化跟反序列化网络传输数据。通过NettyServer调用网络服务。</span></li><li><span>服务端业务线程池接受解析数据，从exportMap找到invoker进行invoke。</span></li><li><span>调用真正的Impl得到结果然后返回。</span></li></ul><p>&nbsp;</p><p><strong><span>调用方式</span></strong></p><ul><li><span>oneway：不关心请求是否发送成功，消耗最小。</span></li><li><span>sync同步调用：在 Dubbo 源码中就调用了 future.get，用户感觉方法被阻塞了，必须等结果后才返回。</span></li><li><span>Async 异步调用：Dubbo天然异步，客户端调用请求后将返回的 ResponseFuture 存到上下文中，用户可以随时调用future.get获取结果。异步调用通过</span><strong><span>唯一ID</span></strong><span>标识此次请求。</span></li></ul><p>&nbsp;</p><h2 id='集群容错负载均衡'><span>集群容错负载均衡</span></h2><p><span>Dubbo 引入了</span><strong><span>Cluster</span></strong><span>、</span><strong><span>Directory</span></strong><span>、</span><strong><span>Router</span></strong><span>、</span><strong><span>LoadBalance</span></strong><span>、</span><strong><span>Invoker</span></strong><span>模块来保证Dubbo系统的稳健性，关系如下图：</span></p><p><img src="images/Middleware/Dubbo集群容错负载均衡.jpg" referrerpolicy="no-referrer" alt="Dubbo集群容错负载均衡"></p><ul><li><span>服务发现时会将多个多个远程调用放入</span><strong><span>Directory</span></strong><span>，然后通过</span><strong><span>Cluster</span></strong><span>封装成一个</span><strong><span>Invoker</span></strong><span>，该</span><strong><span>invoker</span></strong><span>提供容错功能</span></li><li><span>消费者代用的时候从</span><strong><span>Directory</span></strong><span>中通过负载均衡获得一个可用</span><strong><span>invoker</span></strong><span>，最后发起调用</span></li><li><span>你可以认为</span><strong><span>Dubbo</span></strong><span>中的</span><strong><span>Cluster</span></strong><span>对上面进行了大的封装，自带各种鲁棒性功能</span></li></ul><p>&nbsp;</p><h3 id='集群容错'><span>集群容错</span></h3><p><span>集群容错是在消费者端通过</span><strong><span>Cluster</span></strong><span>子类实现的，Cluster接口有10个实现类，每个</span><strong><span>Cluster</span></strong><span>实现类都会创建一个对应的</span><strong><span>ClusterInvoker</span></strong><span>对象。核心思想是</span><strong><span>让用户选择性调用这个Cluster中间层，屏蔽后面具体实现细节</span></strong><span>。</span></p><figure><table><thead><tr><th style='text-align:left;' ><span>Cluster</span></th><th style='text-align:left;' ><span>Cluster Invoker</span></th><th style='text-align:left;' ><span>作用</span></th></tr></thead><tbody><tr><td style='text-align:left;' ><span>FailoverCluster</span></td><td style='text-align:left;' ><span>FailoverClusterInvoker</span></td><td style='text-align:left;' ><span>失败自动切换功能，</span><strong><span>默认</span></strong></td></tr><tr><td style='text-align:left;' ><span>FailfastCluster</span></td><td style='text-align:left;' ><span>FailfastClusterInvoker</span></td><td style='text-align:left;' ><span>一次调用，失败异常</span></td></tr><tr><td style='text-align:left;' ><span>FailsafeCluster</span></td><td style='text-align:left;' ><span>FailsafeClusterInvoker</span></td><td style='text-align:left;' ><span>调用出错则日志记录</span></td></tr><tr><td style='text-align:left;' ><span>FailbackCluster</span></td><td style='text-align:left;' ><span>FailbackClusterInvoker</span></td><td style='text-align:left;' ><span>失败返空，定时重试2次</span></td></tr><tr><td style='text-align:left;' ><span>ForkingCluster</span></td><td style='text-align:left;' ><span>ForkingClusterInvoker</span></td><td style='text-align:left;' ><span>一个任务并发调用，一个OK则OK</span></td></tr><tr><td style='text-align:left;' ><span>BroadcastCluster</span></td><td style='text-align:left;' ><span>BroadcastClusterInvoker</span></td><td style='text-align:left;' ><span>逐个调用invoker，全可用才可用</span></td></tr><tr><td style='text-align:left;' ><span>AvailableCluster</span></td><td style='text-align:left;' ><span>AvailableClusterInvoker</span></td><td style='text-align:left;' ><span>哪个能用就用那个</span></td></tr><tr><td style='text-align:left;' ><span>MergeableCluster</span></td><td style='text-align:left;' ><span>MergeableClusterInvoker</span></td><td style='text-align:left;' ><span>按组合并返回结果</span></td></tr></tbody></table></figure><p>&nbsp;</p><h3 id='智能容错之负载均衡'><span>智能容错之负载均衡</span></h3><p><span>Dubbo中一般有4种负载均衡策略。</span></p><ul><li><strong><span>RandomLoadBalance</span></strong><span>：加权随机，它的算法思想简单。假设有一组服务器 servers = [A, B, C]，对应权重为 weights = [5, 3, 2]，权重总和为10。现把这些权重值平铺在一维坐标值上，[0, 5) 区间属于服务器 A，[5, 8) 区间属于服务器 B，[8, 10) 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 [0, 10) 之间的随机数，然后计算这个随机数会落到哪个区间上。</span><strong><span>默认实现</span></strong><span>。</span></li><li><strong><span>LeastActiveLoadBalance</span></strong><span>：最少活跃数负载均衡，选择现在活跃调用数最少的提供者进行调用，活跃的调用数少说明它现在很轻松，而且活跃数都是从 0 加起来的，来一个请求活跃数+1，一个请求处理完成活跃数-1，所以活跃数少也能变相的体现处理的快。</span></li><li><strong><span>RoundRobinLoadBalance</span></strong><span>：加权轮询负载均衡，比如现在有两台服务器 A、B，轮询的调用顺序就是 A、B、A、B，如果加了权重，A 比B 的权重是2:1，那现在的调用顺序就是 A、A、B、A、A、B。</span></li><li><strong><span>ConsistentHashLoadBalance</span></strong><span>：一致性 Hash 负载均衡，将服务器的 IP 等信息生成一个 hash 值，将hash 值投射到圆环上作为一个节点，然后当 key 来查找的时候顺时针查找第一个大于等于这个 key 的 hash 值的节点。一般而言还会引入虚拟节点，使得数据更加的分散，避免数据倾斜压垮某个节点。如下图 Dubbo 默认搞了 160 个虚拟节点。</span></li></ul><p><img src="images/Middleware/ConsistentHashLoadBalance.png" referrerpolicy="no-referrer" alt="ConsistentHashLoadBalance"></p><p>&nbsp;</p><h3 id='智能容错之服务目录'><span>智能容错之服务目录</span></h3><p><span>关于 服务目录Directory 你可以理解为是相同服务Invoker的集合，核心是RegistryDirectory类。具有三个功能。</span></p><ul><li><span>从注册中心获得invoker列表</span></li><li><span>监控着注册中心invoker的变化，invoker的上下线</span></li><li><span>刷新invokers列表到服务目录</span></li></ul><p>&nbsp;</p><h3 id='智能容错之服务路由'><span>智能容错之服务路由</span></h3><p><span>服务路由其实就是路由规则，它规定了服务消费者可以调用哪些服务提供者。条件路由规则由两个条件组成，分别用于对服务消费者和提供者进行匹配。比如有这样一条规则：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">host </span>=<span class="cm-quote"> 10.20.153.14 </span>=<span class="cm-quote">&gt; host </span>=<span class="cm-quote"> 10.20.153.12</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>该条规则表示 IP 为 10.20.153.14 的服务消费者只可调用 IP 为 10.20.153.12 机器上的服务，不可调用其他机器上的服务。条件路由规则的格式如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-header">[服务消费者匹配条件]</span> =<span class="cm-quote">&gt; [服务提供者匹配条件]</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>如果服务消费者匹配条件为空，表示不对服务消费者进行限制。如果服务提供者匹配条件为空，表示对某些服务消费者禁用服务。</span></p><p>&nbsp;</p><h2 id='设计rpc'><span>设计RPC</span></h2><p><span>一个RPC框架大致需要以下功能：</span></p><ol start='' ><li><span>服务的注册与发现</span></li><li><span>用动态代理</span></li><li><span>负载均衡（LoadBalance）</span></li><li><span>通信协议</span></li><li><span>序列化与反序列化</span></li><li><span>网络通信(Netty)</span></li><li><span>Monitor</span></li></ol><p>&nbsp;</p><h1 id='nacos'><span>Nacos</span></h1><h2 id='基本架构'><span>基本架构</span></h2><p><img src="images/Middleware/Nacos架构图.jpeg" referrerpolicy="no-referrer" alt="Nacos架构图"></p><h3 id='服务-service'><span>服务 (Service)</span></h3><p><span>服务是指一个或一组软件功能（例如特定信息的检索或一组操作的执行），其目的是不同的客户端可以为不同的目的重用（例如通过跨进程的网络调用）。Nacos 支持主流的服务生态，如 Kubernetes Service、gRPC|Dubbo RPC Service 或者 Spring Cloud RESTful Service。</span></p><p>&nbsp;</p><h3 id='服务注册中心-service-registry'><span>服务注册中心 (Service Registry)</span></h3><p><span>服务注册中心，它是服务，其实例及元数据的数据库。服务实例在启动时注册到服务注册表，并在关闭时注销。服务和路由器的客户端查询服务注册表以查找服务的可用实例。服务注册中心可能会调用服务实例的健康检查 API 来验证它是否能够处理请求。</span></p><p>&nbsp;</p><h3 id='服务元数据-service-metadata'><span>服务元数据 (Service Metadata)</span></h3><p><span>服务元数据是指包括服务端点(endpoints)、服务标签、服务版本号、服务实例权重、路由规则、安全策略等描述服务的数据。</span></p><p>&nbsp;</p><h3 id='服务提供方-service-provider'><span>服务提供方 (Service Provider)</span></h3><p><span>是指提供可复用和可调用服务的应用方。</span></p><p>&nbsp;</p><h3 id='服务消费方-service-consumer'><span>服务消费方 (Service Consumer)</span></h3><p><span>是指会发起对某个服务调用的应用方。</span></p><p>&nbsp;</p><h3 id='配置-configuration'><span>配置 (Configuration)</span></h3><p><span>在系统开发过程中通常会将一些需要变更的参数、变量等从代码中分离出来独立管理，以独立的配置文件的形式存在。目的是让静态的系统工件或者交付物（如 WAR，JAR 包等）更好地和实际的物理运行环境进行适配。配置管理一般包含在系统部署的过程中，由系统管理员或者运维人员完成这个步骤。配置变更是调整系统运行时的行为的有效手段之一。</span></p><p>&nbsp;</p><h3 id='配置管理-configuration-management'><span>配置管理 (Configuration Management)</span></h3><p><span>在数据中心中，系统中所有配置的编辑、存储、分发、变更管理、历史版本管理、变更审计等所有与配置相关的活动统称为配置管理。</span></p><p>&nbsp;</p><h3 id='名字服务-naming-service'><span>名字服务 (Naming Service)</span></h3><p><span>提供分布式系统中所有对象(Object)、实体(Entity)的“名字”到关联的元数据之间的映射管理服务，例如 ServiceName -&gt; Endpoints Info, Distributed Lock Name -&gt; Lock Owner/Status Info, DNS Domain Name -&gt; IP List, 服务发现和 DNS 就是名字服务的2大场景。</span></p><p>&nbsp;</p><h3 id='配置服务-configuration-service'><span>配置服务 (Configuration Service)</span></h3><p><span>在服务或者应用运行过程中，提供动态配置或者元数据以及配置管理的服务提供者。</span></p><p>&nbsp;</p><h2 id='逻辑架构'><span>逻辑架构</span></h2><p><img src="images/Middleware/Nacos逻辑架构及其组件介绍.png" referrerpolicy="no-referrer" alt="Nacos逻辑架构及其组件介绍"></p><ul><li><span>服务管理：实现服务CRUD，域名CRUD，服务健康状态检查，服务权重管理等功能</span></li><li><span>配置管理：实现配置管CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能</span></li><li><span>元数据管理：提供元数据CURD 和打标能力</span></li><li><span>插件机制：实现三个模块可分可合能力，实现扩展点SPI机制</span></li><li><span>事件机制：实现异步化事件通知，sdk数据变化异步通知等逻辑</span></li><li><span>日志模块：管理日志分类，日志级别，日志可移植性（尤其避免冲突），日志格式，异常码+帮助文档</span></li><li><span>回调机制：sdk通知数据，通过统一的模式回调用户处理。接口和数据结构需要具备可扩展性</span></li><li><span>寻址模式：解决ip，域名，nameserver、广播等多种寻址模式，需要可扩展</span></li><li><span>推送通道：解决server与存储、server间、server与sdk间推送性能问题</span></li><li><span>容量管理：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性</span></li><li><span>流量管理：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制</span></li><li><span>缓存机制：容灾目录，本地缓存，server缓存机制。容灾目录使用需要工具</span></li><li><span>启动模式：按照单机模式，配置模式，服务模式，dns模式，或者all模式，启动不同的程序+UI</span></li><li><span>一致性协议：解决不同数据，不同一致性要求情况下，不同一致性机制</span></li><li><span>存储模块：解决数据持久化、非持久化存储，解决数据分片问题</span></li><li><span>Nameserver：解决namespace到clusterid的路由问题，解决用户环境与nacos物理环境映射问题</span></li><li><span>CMDB：解决元数据存储，与三方cmdb系统对接问题，解决应用，人，资源关系</span></li><li><span>Metrics：暴露标准metrics数据，方便与三方监控系统打通</span></li><li><span>Trace：暴露标准trace，方便与SLA系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通</span></li><li><span>接入管理：相当于阿里云开通服务，分配身份、容量、权限过程</span></li><li><span>用户管理：解决用户管理，登录，sso等问题</span></li><li><span>权限管理：解决身份识别，访问控制，角色管理等问题</span></li><li><span>审计系统：扩展接口方便与不同公司审计系统打通</span></li><li><span>通知系统：核心数据变更，或者操作，方便通过SMS系统打通，通知到对应人数据变更</span></li><li><span>OpenAPI：暴露标准Rest风格HTTP接口，简单易用，方便多语言集成</span></li><li><span>Console：易用控制台，做服务管理、配置管理等操作</span></li><li><span>SDK：多语言sdk</span></li><li><span>Agent：dns-f类似模式，或者与mesh等方案集成</span></li><li><span>CLI：命令行对产品进行轻量化管理，像git一样好用</span></li></ul><p>&nbsp;</p><h2 id='功能特性'><span>功能特性</span></h2><p><span>Nacos 的关键特性包括：</span></p><ul><li><strong><span>服务发现和服务健康监测</span></strong></li><li><strong><span>动态配置服务</span></strong></li><li><strong><span>动态 DNS 服务</span></strong></li><li><strong><span>服务及其元数据管理</span></strong></li></ul><p>&nbsp;</p><h3 id='数据模型-2'><span>数据模型</span></h3><p><span>Nacos 数据模型 Key 由三元组唯一确定, Namespace默认是空串，公共命名空间（public），分组默认是 DEFAULT_GROUP。</span></p><p><img src="images/Middleware/nacos_data_model.jpeg" referrerpolicy="no-referrer" alt="nacos_data_model"></p><p>&nbsp;</p><h3 id='nacos-sdk类视图'><span>Nacos-SDK类视图</span></h3><p><img src="images/Middleware/nacos_sdk_class_relation.jpeg" referrerpolicy="no-referrer" alt="nacos_sdk_class_relation"></p><p>&nbsp;</p><h3 id='配置领域模型'><span>配置领域模型</span></h3><p><span>围绕配置，主要有两个关联的实体，一个是配置变更历史，一个是服务标签（用于打标分类，方便索引），由 ID 关联。</span></p><p><img src="images/Middleware/nacos_config_er.jpeg" referrerpolicy="no-referrer" alt="nacos_config_er"></p><p>&nbsp;</p><h2 id='安装部署-1'><span>安装部署</span></h2><h3 id='下载源码或者安装包'><span>下载源码或者安装包</span></h3><p><strong><span>从 Github 上下载源码方式</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> clone https://github.com/alibaba/nacos.git</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> nacos/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mvn <span class="cm-attribute">-Prelease-nacos</span> <span class="cm-attribute">-Dmaven</span>.test<span class="cm-def">.skip</span><span class="cm-operator">=</span><span class="cm-atom">true</span> clean install <span class="cm-attribute">-U</span> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">ls</span> <span class="cm-attribute">-al</span> distribution/target/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">// change the <span class="cm-def">$version</span> to your actual path</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> distribution/target/nacos-server-<span class="cm-def">$version</span>/nacos/bin</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p><strong><span>下载编译后压缩包方式</span></strong></p><p><span>您可以从 </span><a href='https://github.com/alibaba/nacos/releases'><span>最新稳定版本</span></a><span> 下载 </span><code>nacos-server-$version.zip</code><span> 包。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  unzip nacos-server-<span class="cm-def">$version</span>.zip 或者 tar <span class="cm-attribute">-xvf</span> nacos-server-<span class="cm-def">$version</span>.tar.gz</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-builtin">cd</span> nacos/bin</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p>&nbsp;</p><h3 id='启动服务器'><span>启动服务器</span></h3><p><strong><span>Linux/Unix/Mac</span></strong></p><p><span>启动命令(standalone代表着单机模式运行，非集群模式):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sh</span> startup.sh <span class="cm-attribute">-m</span> standalone</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>如果您使用的是ubuntu系统，或者运行脚本报错提示符号找不到，可尝试如下运行：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">bash</span> startup.sh <span class="cm-attribute">-m</span> standalone</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><strong><span>Windows</span></strong></p><p><span>启动命令(standalone代表着单机模式运行，非集群模式):</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">startup.cmd <span class="cm-attribute">-m</span> standalone</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><h3 id='服务测试'><span>服务测试</span></h3><p><strong><span>服务注册</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>服务发现</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> GET <span class="cm-string">'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>发布配置</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=HelloWorld"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>获取配置</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> GET <span class="cm-string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p>&nbsp;</p><h3 id='关闭服务器'><span>关闭服务器</span></h3><p><strong><span>Linux/Unix/Mac</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sh</span> shutdown.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><strong><span>Windows</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">shutdown.cmd</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>或者双击 </span><code>shutdown.cmd</code><span>运行文件。</span></p><p>&nbsp;</p><h2 id='开源案例'><span>开源案例</span></h2><h3 id='spring-boot'><span>Spring Boot</span></h3><h4 id='启动配置管理-1'><span>启动配置管理</span></h4><p><span>启动了 Nacos server 后，您就可以参考以下示例代码，为您的 Spring Boot 应用启动 Nacos 配置管理服务了。</span></p><p><strong><span>第一步</span></strong><span>：添加依赖</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.boot<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>nacos-config-spring-boot-starter<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>${latest.version}<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>：版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.boot/nacos-config-spring-boot-starter'><span>0.2.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.x 版本，版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.boot/nacos-config-spring-boot-starter'><span>0.1.x.RELEASE</span></a><span> 对应的是 Spring Boot 1.x 版本。</span></p><p><strong><span>第二步</span></strong><span>：在 </span><code>application.properties</code><span> 中配置 Nacos server 的地址：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">nacos.config.server-addr</span>=<span class="cm-quote">127.0.0.1</span>:<span class="cm-quote">8848</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><strong><span>第三步</span></strong><span>：使用 </span><code>@NacosPropertySource</code><span> 加载 </span><code>dataId</code><span> 为 </span><code>example</code><span> 的配置源，并开启自动更新：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootApplication</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@NacosPropertySource</span>(<span class="cm-variable">dataId</span> <span class="cm-operator">=</span> <span class="cm-string">"example"</span>, <span class="cm-variable">autoRefreshed</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">NacosConfigApplication</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SpringApplication</span>.<span class="cm-variable">run</span>(<span class="cm-variable">NacosConfigApplication</span>.<span class="cm-keyword">class</span>, <span class="cm-variable">args</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p><strong><span>第四步</span></strong><span>：通过 Nacos 的 </span><code>@NacosValue</code><span> 注解设置属性值。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Controller</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@RequestMapping</span>(<span class="cm-string">"config"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ConfigController</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@NacosValue</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"${useLocalCache:false}"</span>, <span class="cm-variable">autoRefreshed</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">useLocalCache</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@RequestMapping</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"/get"</span>, <span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-variable">GET</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@ResponseBody</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">get</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">useLocalCache</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p><strong><span>第五步</span></strong><span>：启动 </span><code>NacosConfigApplication</code><span>，调用 </span><code>curl http://localhost:8080/config/get</code><span>，返回内容是 </span><code>false</code><span>。</span></p><p><strong><span>第六步</span></strong><span>：通过调用 </span><a href='https://nacos.io/zh-cn/docs/open-api.html'><span>Nacos Open API</span></a><span> 向 Nacos server 发布配置：dataId 为</span><code>example</code><span>，内容为</span><code>useLocalCache=true</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=example&amp;group=DEFAULT_GROUP&amp;content=useLocalCache=true"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>第七步</span></strong><span>：再次访问 </span><code>http://localhost:8080/config/get</code><span>，此时返回内容为</span><code>true</code><span>，说明程序中的</span><code>useLocalCache</code><span>值已经被动态更新了。</span></p><p>&nbsp;</p><h4 id='启动服务发现-1'><span>启动服务发现</span></h4><p><span>本节演示如何在您的 Spring Boot 项目中启动 Nacos 的服务发现功能。</span></p><p><strong><span>第一步</span></strong><span>：添加依赖</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.boot<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>nacos-discovery-spring-boot-starter<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>${latest.version}<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>：版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.boot/nacos-discovery-spring-boot-starter'><span>0.2.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.x 版本，版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.boot/nacos-discovery-spring-boot-starter'><span>0.1.x.RELEASE</span></a><span> 对应的是 Spring Boot 1.x 版本。</span></p><p><strong><span>第二步</span></strong><span>：在 </span><code>application.properties</code><span> 中配置 Nacos server 的地址：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">nacos.discovery.server-addr</span>=<span class="cm-quote">127.0.0.1</span>:<span class="cm-quote">8848</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><strong><span>第三步</span></strong><span>：使用 </span><code>@NacosInjected</code><span> 注入 Nacos 的 </span><code>NamingService</code><span> 实例：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Controller</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@RequestMapping</span>(<span class="cm-string">"discovery"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">DiscoveryController</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@NacosInjected</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">NamingService</span> <span class="cm-variable">namingService</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@RequestMapping</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"/get"</span>, <span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-variable">GET</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@ResponseBody</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">Instance</span><span class="cm-operator">&gt;</span> <span class="cm-variable">get</span>(<span class="cm-meta">@RequestParam</span> <span class="cm-variable-3">String</span> <span class="cm-variable">serviceName</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">NacosException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">namingService</span>.<span class="cm-variable">getAllInstances</span>(<span class="cm-variable">serviceName</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootApplication</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">NacosDiscoveryApplication</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SpringApplication</span>.<span class="cm-variable">run</span>(<span class="cm-variable">NacosDiscoveryApplication</span>.<span class="cm-keyword">class</span>, <span class="cm-variable">args</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 475px;"></div><div class="CodeMirror-gutters" style="display: none; height: 475px;"></div></div></div></pre><p><strong><span>第四步</span></strong><span>：启动 </span><code>NacosDiscoveryApplication</code><span>，调用 </span><code>curl http://localhost:8080/discovery/get?serviceName=example</code><span>，此时返回为空 JSON 数组</span><code>[]</code><span>。</span></p><p><strong><span>第五步</span></strong><span>：通过调用 </span><a href='https://nacos.io/zh-cn/docs/open-api.html'><span>Nacos Open API</span></a><span> 向 Nacos server 注册一个名称为 </span><code>example</code><span> 服务</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> PUT <span class="cm-string">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=example&amp;ip=127.0.0.1&amp;port=8080'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>第六步</span></strong><span>：再次访问 </span><code>curl http://localhost:8080/discovery/get?serviceName=example</code><span>，此时返回内容为：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="json" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"instanceId"</span>: <span class="cm-string">"127.0.0.1-8080-DEFAULT-example"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"ip"</span>: <span class="cm-string">"127.0.0.1"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"port"</span>: <span class="cm-number">8080</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"weight"</span>: <span class="cm-number">1.0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"healthy"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"cluster"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"serviceName"</span>: <span class="cm-atom">null</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"name"</span>: <span class="cm-string">""</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"healthChecker"</span>: {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"type"</span>: <span class="cm-string">"TCP"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"defaultPort"</span>: <span class="cm-number">80</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"defaultCheckPort"</span>: <span class="cm-number">80</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"useIPPort4Check"</span>: <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-string cm-property">"metadata"</span>: {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"service"</span>: <span class="cm-atom">null</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"metadata"</span>: {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 475px;"></div><div class="CodeMirror-gutters" style="display: none; height: 475px;"></div></div></div></pre><p>&nbsp;</p><h3 id='spring-cloud'><span>Spring Cloud</span></h3><h4 id='启动配置管理-2'><span>启动配置管理</span></h4><p><span>启动了 Nacos server 后，您就可以参考以下示例代码，为您的 Spring Cloud 应用启动 Nacos 配置管理服务了。</span></p><p><strong><span>第一步</span></strong><span>：添加依赖</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.cloud<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>${latest.version}<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>：版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-config'><span>2.1.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.1.x 版本。版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-config'><span>2.0.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.0.x 版本，版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-config'><span>1.5.x.RELEASE</span></a><span> 对应的是 Spring Boot 1.5.x 版本。</span></p><p><strong><span>第二步</span></strong><span>：在 </span><code>bootstrap.properties</code><span> 中配置 Nacos server 的地址和应用名</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.cloud.nacos.config.server-addr</span>=<span class="cm-quote">127.0.0.1</span>:<span class="cm-quote">8848</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.application.name</span>=<span class="cm-quote">example</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>说明：之所以需要配置 </span><code>spring.application.name</code><span> ，是因为它是构成 Nacos 配置管理 </span><code>dataId</code><span>字段的一部分。</span></p><p><strong><span>第三步</span></strong><span>：在 Nacos Spring Cloud 中，</span><code>dataId</code><span> 的完整格式如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">${prefix}-${spring.profiles.active}.${file-extension}</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ul><li><code>prefix</code><span> 默认为 </span><code>spring.application.name</code><span> 的值，也可以通过配置项 </span><code>spring.cloud.nacos.config.prefix</code><span>来配置。</span></li><li><code>spring.profiles.active</code><span> 即为当前环境对应的 profile，详情可以参考 </span><a href='https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles'><span>Spring Boot文档</span></a><span>。 </span><strong><span>注意：当 </span><code>spring.profiles.active</code><span> 为空时，对应的连接符 </span><code>-</code><span> 也将不存在，dataId 的拼接格式变成 </span><code>${prefix}.${file-extension}</code></strong></li><li><code>file-exetension</code><span> 为配置内容的数据格式，可以通过配置项 </span><code>spring.cloud.nacos.config.file-extension</code><span> 来配置。目前只支持 </span><code>properties</code><span> 和 </span><code>yaml</code><span> 类型。</span></li></ul><p><strong><span>第四步</span></strong><span>：通过 Spring Cloud 原生注解 </span><code>@RefreshScope</code><span> 实现配置自动更新：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@RestController</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@RequestMapping</span>(<span class="cm-string">"/config"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@RefreshScope</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ConfigController</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Value</span>(<span class="cm-string">"${useLocalCache:false}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">useLocalCache</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@RequestMapping</span>(<span class="cm-string">"/get"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">get</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">useLocalCache</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p><strong><span>第五步</span></strong><span>：首先通过调用 </span><a href='https://nacos.io/zh-cn/docs/open-api.html'><span>Nacos Open API</span></a><span> 向 Nacos Server 发布配置：dataId 为</span><code>example.properties</code><span>，内容为</span><code>useLocalCache=true</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=example.properties&amp;group=DEFAULT_GROUP&amp;content=useLocalCache=true"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>第六步</span></strong><span>：运行 </span><code>NacosConfigApplication</code><span>，调用 </span><code>curl http://localhost:8080/config/get</code><span>，返回内容是 </span><code>true</code><span>。</span></p><p><strong><span>第七步</span></strong><span>：再次调用 </span><a href='https://nacos.io/zh-cn/docs/open-api.html'><span>Nacos Open API</span></a><span> 向 Nacos server 发布配置：dataId 为</span><code>example.properties</code><span>，内容为</span><code>useLocalCache=false</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">curl</span> <span class="cm-attribute">-X</span> POST <span class="cm-string">"http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=example.properties&amp;group=DEFAULT_GROUP&amp;content=useLocalCache=false"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>第八步</span></strong><span>：再次访问 </span><code>http://localhost:8080/config/get</code><span>，此时返回内容为</span><code>false</code><span>，说明程序中的</span><code>useLocalCache</code><span>值已经被动态更新了。</span></p><p>&nbsp;</p><h4 id='启动服务发现-2'><span>启动服务发现</span></h4><p><span>本节通过实现一个简单的 </span><code>echo service</code><span> 演示如何在您的 Spring Cloud 项目中启用 Nacos 的服务发现功能，如下图示:</span></p><p><img src="images/Middleware/echo_service.png" referrerpolicy="no-referrer" alt="echo_service"></p><p><strong><span>第一步</span></strong><span>：添加依赖：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.cloud<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>${latest.version}<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><strong><span>注意</span></strong><span>：版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-discovery'><span>2.1.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.1.x 版本。版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-discovery'><span>2.0.x.RELEASE</span></a><span> 对应的是 Spring Boot 2.0.x 版本，版本 </span><a href='https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-starter-alibaba-nacos-discovery'><span>1.5.x.RELEASE</span></a><span> 对应的是 Spring Boot 1.5.x 版本。</span></p><p><strong><span>第二步</span></strong><span>：配置服务提供者，从而服务提供者可以通过 Nacos 的服务注册发现功能将其服务注册到 Nacos server 上。</span></p><p><span>i. 在 </span><code>application.properties</code><span> 中配置 Nacos server 的地址：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">server.port</span>=<span class="cm-quote">8070</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.application.name</span>=<span class="cm-quote">service-provider</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.cloud.nacos.discovery.server-addr</span>=<span class="cm-quote">127.0.0.1</span>:<span class="cm-quote">8848</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><span>ii. 通过 Spring Cloud 原生注解 </span><code>@EnableDiscoveryClient</code><span> 开启服务注册发现功能：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootApplication</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@EnableDiscoveryClient</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">NacosProviderApplication</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">SpringApplication</span>.<span class="cm-variable">run</span>(<span class="cm-variable">NacosProviderApplication</span>.<span class="cm-keyword">class</span>, <span class="cm-variable">args</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@RestController</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">class</span> <span class="cm-def">EchoController</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@RequestMapping</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"/echo/{string}"</span>, <span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-variable">RequestMethod</span>.<span class="cm-variable">GET</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">echo</span>(<span class="cm-meta">@PathVariable</span> <span class="cm-variable-3">String</span> <span class="cm-variable">string</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-string">"Hello Nacos Discovery "</span> <span class="cm-operator">+</span> <span class="cm-variable">string</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 367px;"></div><div class="CodeMirror-gutters" style="display: none; height: 367px;"></div></div></div></pre><p><strong><span>第三步</span></strong><span>：配置服务消费者，从而服务消费者可通过 Nacos 的服务注册发现功能从 Nacos server 上获取到它要调用的服务。</span></p><p><span>i. 在 </span><code>application.properties</code><span> 中配置 Nacos server 的地址：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">server.port</span>=<span class="cm-quote">8080</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.application.name</span>=<span class="cm-quote">service-consumer</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">spring.cloud.nacos.discovery.server-addr</span>=<span class="cm-quote">127.0.0.1</span>:<span class="cm-quote">8848</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><span>ii. 通过 Spring Cloud 原生注解 </span><code>@EnableDiscoveryClient</code><span> 开启服务注册发现功能。给 </span><a href='https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-resttemplate.html'><span>RestTemplate</span></a><span> 实例添加 </span><code>@LoadBalanced</code><span> 注解，开启 </span><code>@LoadBalanced</code><span> 与 </span><a href='https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-ribbon.html'><span>Ribbon</span></a><span> 的集成：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootApplication</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@EnableDiscoveryClient</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">NacosConsumerApplication</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@LoadBalanced</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">RestTemplate</span> <span class="cm-variable">restTemplate</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">RestTemplate</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SpringApplication</span>.<span class="cm-variable">run</span>(<span class="cm-variable">NacosConsumerApplication</span>.<span class="cm-keyword">class</span>, <span class="cm-variable">args</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@RestController</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">TestController</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">RestTemplate</span> <span class="cm-variable">restTemplate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Autowired</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">TestController</span>(<span class="cm-variable">RestTemplate</span> <span class="cm-variable">restTemplate</span>) {<span class="cm-keyword">this</span>.<span class="cm-variable">restTemplate</span> <span class="cm-operator">=</span> <span class="cm-variable">restTemplate</span>;}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@RequestMapping</span>(<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-string">"/echo/{str}"</span>, <span class="cm-variable">method</span> <span class="cm-operator">=</span> <span class="cm-variable">RequestMethod</span>.<span class="cm-variable">GET</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span> <span class="cm-variable">echo</span>(<span class="cm-meta">@PathVariable</span> <span class="cm-variable-3">String</span> <span class="cm-variable">str</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">restTemplate</span>.<span class="cm-variable">getForObject</span>(<span class="cm-string">"http://service-provider/echo/"</span> <span class="cm-operator">+</span> <span class="cm-variable">str</span>, <span class="cm-variable-3">String</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 669px;"></div><div class="CodeMirror-gutters" style="display: none; height: 669px;"></div></div></div></pre><p><strong><span>第四步</span></strong><span>：启动 </span><code>ProviderApplication</code><span> 和 </span><code>ConsumerApplication</code><span> ，调用 </span><code>http://localhost:8080/echo/2018</code><span>，返回内容为 </span><code>Hello Nacos Discovery 2018</code><span>。</span></p><p>&nbsp;</p><h1 id='sentinel'><span>Sentinel</span></h1><p><span>Sentinel（分布式系统的流量防卫兵）。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。Sentinel 具有以下特征：</span></p><ul><li><strong><span>丰富的应用场景</span></strong><span>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等</span></li><li><strong><span>完备的实时监控</span></strong><span>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况</span></li><li><strong><span>广泛的开源生态</span></strong><span>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel</span></li><li><strong><span>完善的 SPI 扩展点</span></strong><span>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等</span></li></ul><p>&nbsp;</p><h2 id='主要特性'><span>主要特性</span></h2><p><span>Sentinel 的主要特性：</span></p><p><img src="images/Middleware/Sentinel-features-overview.png" referrerpolicy="no-referrer" alt="Sentinel-features-overview"></p><p>&nbsp;</p><h2 id='开源生态'><span>开源生态</span></h2><p><span>Sentinel 的开源生态：</span></p><p><img src="images/Middleware/Sentinel-opensource-eco.png" referrerpolicy="no-referrer" alt="Sentinel-opensource-eco"></p><p><span>Sentinel 分为两个部分:</span></p><ul><li><span>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持</span></li><li><span>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器</span></li></ul><p>&nbsp;</p><h2 id='quick-start'><span>Quick Start</span></h2><h3 id='手动接入sentinel以及控制台'><span>手动接入Sentinel以及控制台</span></h3><p><span>下面例子将展示应用如何三步接入 Sentinel。同时，Sentinel 也提供所见即所得的控制台，可实时监控资源以及管理规则。</span></p><p><strong><span>STEP 1. 在应用中引入Sentinel Jar包</span></strong></p><p><span>如果应用使用 pom 工程，则在 </span><code>pom.xml</code><span> 文件中加入以下代码即可：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span>com.alibaba.csp<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">groupId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span>sentinel-core<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">artifactId</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span>1.8.1<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">version</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">dependency</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><span>注意: Sentinel仅支持JDK 1.8或者以上版本。如果未使用依赖管理工具，请到 </span><a href='https://mvnrepository.com/artifact/com.alibaba.csp/sentinel-core'><span>Maven Center Repository</span></a><span> 直接下载JAR 包。</span></p><p>&nbsp;</p><p><strong><span>STEP 2. 定义资源</span></strong></p><p><span>接下来，我们把需要控制流量的代码用 Sentinel API </span><code>SphU.entry(&quot;HelloWorld&quot;)</code><span> 和 </span><code>entry.exit()</code><span> 包围起来即可。在下面的例子中，我们将 </span><code>System.out.println(&quot;hello world&quot;);</code><span> 这端代码作为资源，用 API 包围起来（埋点）。参考代码如下:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">initFlowRules</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-atom">true</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Entry</span> <span class="cm-variable">entry</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">entry</span> <span class="cm-operator">=</span> <span class="cm-variable">SphU</span>.<span class="cm-variable">entry</span>(<span class="cm-string">"HelloWorld"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/*您的业务逻辑 - 开始*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"hello world"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/*您的业务逻辑 - 结束*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>} <span class="cm-keyword">catch</span> (<span class="cm-variable">BlockException</span> <span class="cm-variable">e1</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/*流控逻辑处理 - 开始*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"block!"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/*流控逻辑处理 - 结束*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>} <span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; <span class="cm-keyword">if</span> (<span class="cm-variable">entry</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp; &nbsp; <span class="cm-variable">entry</span>.<span class="cm-variable">exit</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 432px;"></div><div class="CodeMirror-gutters" style="display: none; height: 432px;"></div></div></div></pre><p><span>完成以上两步后，代码端的改造就完成了。当然，我们也提供了 </span><a href='https://github.com/alibaba/Sentinel/wiki/注解支持'><span>注解支持模块</span></a><span>，可以以低侵入性的方式定义资源。</span></p><p>&nbsp;</p><p><strong><span>STEP 3. 定义规则</span></strong></p><p><span>接下来，通过规则来指定允许该资源通过的请求次数，如下面的代码定义了资源 </span><code>HelloWorld</code><span> 每秒最多只能通过 20 个请求。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">initFlowRules</span>(){</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">FlowRule</span><span class="cm-operator">&gt;</span> <span class="cm-variable">rules</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ArrayList</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">FlowRule</span> <span class="cm-variable">rule</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">FlowRule</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rule</span>.<span class="cm-variable">setResource</span>(<span class="cm-string">"HelloWorld"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rule</span>.<span class="cm-variable">setGrade</span>(<span class="cm-variable">RuleConstant</span>.<span class="cm-variable">FLOW_GRADE_QPS</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// Set limit QPS to 20.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rule</span>.<span class="cm-variable">setCount</span>(<span class="cm-number">20</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">rules</span>.<span class="cm-variable">add</span>(<span class="cm-variable">rule</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">FlowRuleManager</span>.<span class="cm-variable">loadRules</span>(<span class="cm-variable">rules</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p><span>完成上面 3 步，Sentinel 就能够正常工作了。更多的信息可以参考 </span><a href='https://github.com/alibaba/Sentinel/wiki/如何使用'><span>使用文档</span></a><span>。</span></p><p>&nbsp;</p><p><strong><span>STEP 4. 检查效果</span></strong></p><p><span>Demo 运行之后，我们可以在日志 </span><code>~/logs/csp/${appName}-metrics.log.xxx</code><span> 里看到下面的输出:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">|--timestamp-|------date time----|-resource-|p |block|s |e|rt</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998904000</span>|2018-06-26 <span class="cm-number">15</span>:41:44|HelloWorld|20|0 &nbsp;  |20|0|0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998905000</span>|2018-06-26 <span class="cm-number">15</span>:41:45|HelloWorld|20|5579 |20|0|728</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998906000</span>|2018-06-26 <span class="cm-number">15</span>:41:46|HelloWorld|20|15698|20|0|0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998907000</span>|2018-06-26 <span class="cm-number">15</span>:41:47|HelloWorld|20|19262|20|0|0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998908000</span>|2018-06-26 <span class="cm-number">15</span>:41:48|HelloWorld|20|19502|20|0|0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1529998909000</span>|2018-06-26 <span class="cm-number">15</span>:41:49|HelloWorld|20|18386|20|0|0</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p><span>其中 </span><code>p</code><span> 代表通过的请求, </span><code>block</code><span> 代表被阻止的请求, </span><code>s</code><span> 代表成功执行完成的请求个数, </span><code>e</code><span> 代表用户自定义的异常, </span><code>rt</code><span> 代表平均响应时长。可以看到，这个程序每秒稳定输出 &quot;hello world&quot; 20 次，和规则中预先设定的阈值是一样的。</span></p><p>&nbsp;</p><p><strong><span>STEP 5. 启动 Sentinel 控制台</span></strong></p><p><span>您可以参考 </span><a href='https://github.com/alibaba/Sentinel/wiki/控制台'><span>Sentinel 控制台文档</span></a><span> 启动控制台，可以实时监控各个资源的运行情况，并且可以实时地修改限流规则。</span></p><p><img src="images/Middleware/dashboard-monitoring.png" referrerpolicy="no-referrer" alt="dashboard-monitoring"></p><p>&nbsp;</p><h1 id='influxdb'><span>Influxdb</span></h1><p><span>InfluxDB 是用Go语言编写的一个开源分布式时序、事件和指标数据库，无需外部依赖。InfluxDB在DB-Engines的时序数据库类别里排名第一。</span></p><h2 id='重要特性'><span>重要特性</span></h2><ul><li><strong><span>极简架构：</span></strong><span>单机版的InfluxDB只需要安装一个binary，即可运行使用，完全没有任何的外部依赖</span></li><li><strong><span>极强的写入能力：</span></strong><span> 底层采用自研的TSM存储引擎，TSM也是基于LSM的思想，提供极强的写能力以及高压缩率</span></li><li><strong><span>高效查询：</span></strong><span>对Tags会进行索引，提供高效的检索</span></li><li><strong><span>InfluxQL</span></strong><span>：提供QL-Like的查询语言，极大的方便了使用，数据库在易用性上演进的终极目标都是提供Query Language</span></li><li><strong><span>Continuous Queries</span></strong><span>: 通过CQ能够支持auto-rollup和pre-aggregation，对常见的查询操作可以通过CQ来预计算加速查询</span></li></ul><p>&nbsp;</p><h2 id='存储引擎'><span>存储引擎</span></h2><p><span>InfluxDB 采用自研的TSM (Time-Structured Merge Tree) 作为存储引擎， 其核心思想是通过牺牲掉一些功能来对性能达到极致优化，其官方文档上有项目存储引擎经历了从LevelDB到BlotDB，再到选择自研TSM的过程，整个选择转变的思考。</span></p><p><strong><span>时序数据库的需求：</span></strong></p><ul><li><span>数十亿个单独的数据点</span></li><li><span>高写入吞吐量</span></li><li><span>高读取吞吐量</span></li><li><span>大型删除（数据过期）</span></li><li><span>主要是插入/追加工作负载，很少更新</span></li></ul><p>&nbsp;</p><h3 id='lsm'><span>LSM</span></h3><p><strong><span>LSM 的局限性</span></strong></p><p><span>在官方文档上有写， 为了解决高写入吞吐量的问题， Influxdb 一开始选择了LevelDB 作为其存储引擎。 然而，随着更多地了解人们对时间序列数据的需求，influxdb遇到了一些无法克服的挑战。</span></p><p>&nbsp;</p><p><strong><span>LSM （日志结构合并树）为 LevelDB的引擎原理</span></strong></p><ul><li><span>levelDB 不支持热备份。 对数据库进行安全备份必须关闭后才能复制。LevelDB的RocksDB和HyperLevelDB变体可以解决此问题</span></li><li><span>时序数据库需要提供一种自动管理数据保存的方式。 即删除过期数据， 而在levelDB 中，删除的代价过高。（通过添加墓碑的方式， 段结构合并的时候才会真正物理性的删除）</span></li></ul><p>&nbsp;</p><h3 id='tsm'><span>TSM</span></h3><p><span>按不同的时间范围划分为不同的分区（Shard），因为时序数据写入都是按时间线性产生的，所以分区的产生也是按时间线性增长的，写入通常是在最新的分区，而不会散列到多个分区。分区的优点是数据回收的物理删除非常简单，直接把整个分区删除即可。</span></p><ul><li><span>在最开始的时候， influxdb 采用的方案每个shard都是一个独立的数据库实例，底层都是一套独立的LevelDB存储引擎。 这时带来的问题是，LevelDB底层采用level compaction策略，每个存储引擎都会打开比较多的文件，随着shard的增多，最终进程打开的文件句柄会很快触及到上限</span></li><li><span>由于遇到大量的客户反馈文件句柄过多的问题，InfluxDB在新版本的存储引擎选型中选择了BoltDB替换LevelDB。BoltDB底层数据结构是mmap B+树。 但由于B+ 树会产生大量的随机写。 所以写入性能较差</span></li><li><span>之后Influxdb 最终决定仿照LSM 的思想自研TSM ，主要改进点是基于时序数据库的特性作出一些优化，包含Cache、WAL以及Data File等各个组件，也会有flush、compaction等这类数据操作</span></li></ul><p>&nbsp;</p><h2 id='系统架构'><span>系统架构</span></h2><p><img src="images/Middleware/InfluxDB系统架构.jpg" referrerpolicy="no-referrer" alt="InfluxDB系统架构"></p><ul><li><strong><span>DataBase：</span></strong><span>用户可以通过 create database xxx 来创建一个database</span></li><li><strong><span>Retention Policy（RP）：</span></strong><span> 数据保留策略， 可用来规定数据的的过期时间</span></li><li><strong><span>Shard Group：</span></strong><span> 实现了数据分区，但是Shard Group只是一个逻辑概念，在它里面包含了大量Shard，Shard才是InfluxDB中真正存储数据以及提供读写服务的概念</span></li></ul><p>&nbsp;</p><h1 id='spring-1'><span>Spring</span></h1><p><span>Spring是一个轻量级的IoC和AOP容器框架。是为Java应用程序提供基础性服务的一套框架，目的是用于简化企业应用程序的开发，它使得开发者只需要关心业务需求。</span></p><p>&nbsp;</p><p><strong><span>Spring的优点？</span></strong></p><ul><li><span>spring属于低侵入式设计，代码的污染极低</span></li><li><span>spring的DI机制将对象之间的依赖关系交由框架处理，减低组件的耦合性</span></li><li><span>Spring提供了AOP技术，支持将一些通用任务，如安全、事务、日志、权限等进行集中式管理，从而提供更好的复用</span></li><li><span>spring对于主流的应用框架提供了集成支持</span></li></ul><p><span> </span><strong><span>使用Spring框架的好处是什么？</span></strong></p><ul><li><strong><span>轻量：</span></strong><span>Spring 是轻量的，基本的版本大约2MB</span></li><li><strong><span>控制反转：</span></strong><span>Spring通过控制反转实现了松散耦合，对象们给出它们的依赖，而不是创建或查找依赖的对象们。</span></li><li><strong><span>面向切面的编程(AOP)：</span></strong><span>Spring支持面向切面的编程，并且把应用业务逻辑和系统服务分开</span></li><li><strong><span>容器：</span></strong><span>Spring 包含并管理应用中对象的生命周期和配置</span></li><li><strong><span>MVC框架</span></strong><span>：Spring的WEB框架是个精心设计的框架，是Web框架的一个很好的替代品</span></li><li><strong><span>事务管理：</span></strong><span>Spring 提供一个持续的事务管理接口，可以扩展到上至本地事务下至全局事务（JTA）</span></li><li><strong><span>异常处理：</span></strong><span>Spring 提供方便的API把具体技术相关的异常（比如由JDBC，Hibernate or JDO抛出的）转化为一致的unchecked 异常</span></li></ul><p>&nbsp;</p><h2 id='相关概念'><span>相关概念</span></h2><p><img src="images/Middleware/Spring关系.jpg" referrerpolicy="no-referrer" alt="Spring关系"></p><h3 id='spring-2'><span>Spring</span></h3><p><span>Spring是一个开源容器框架，可以接管web层，业务层，dao层，持久层的组件，并且可以配置各种bean，和维护bean与bean之间的关系。其核心就是控制反转(IOC)，和面向切面(AOP)，简单的说就是一个分层的轻量级开源框架。</span></p><p>&nbsp;</p><h3 id='springmvc'><span>SpringMVC</span></h3><p><span>Spring MVC属于SpringFrameWork的后续产品，已经融合在Spring Web Flow里面。SpringMVC是一种web层mvc框架，用于替代servlet（处理|响应请求，获取表单参数，表单校验等。SpringMVC是一个MVC的开源框架，SpringMVC = struts2 + spring，springMVC就相当于是Struts2加上Spring的整合。</span></p><p><img src="images/Middleware/SpringMVC工作原理.png" referrerpolicy="no-referrer" alt="SpringMVC工作原理"></p><p><span>SpringMVC是属于SpringWeb里面的一个功能模块（SpringWebMVC）。专门用来开发SpringWeb项目的一种MVC模式的技术框架实现。</span></p><p>&nbsp;</p><h3 id='springboot-1'><span>SpringBoot</span></h3><p><span>Springboot是一个微服务框架，延续了spring框架的核心思想IOC和AOP，简化了应用的开发和部署。Spring Boot是为了简化Spring应用的创建、运行、调试、部署等而出现的，使用它可以做到专注于Spring应用的开发，而无需过多关注XML的配置。提供了一堆依赖打包，并已经按照使用习惯解决了依赖问题—&gt;习惯大于约定。</span></p><p><span>Spring Boot基本上是Spring框架的扩展，它消除了设置Spring应用程序所需的XML配置，为更快，更高效的开发生态系统铺平了道路。Spring Boot中的一些特点：</span></p><ul><li><span>创建独立的spring应用</span></li><li><span>嵌入Tomcat, JettyUndertow 而且不需要部署他们</span></li><li><span>提供的“starters” poms来简化Maven配置</span></li><li><span>尽可能自动配置spring应用</span></li><li><span>提供生产指标,健壮检查和外部化配置</span></li><li><span>绝对没有代码生成和XML配置要求</span></li></ul><p>&nbsp;</p><h2 id='spring原理'><span>Spring原理</span></h2><h3 id='核心组件'><span>核心组件</span></h3><p><img src="images/Middleware/Spring核心组件.png" referrerpolicy="no-referrer" alt="Spring核心组件"></p><p>&nbsp;</p><h3 id='spring常用模块'><span>Spring常用模块</span></h3><p><img src="images/Middleware/Spring常用模块.png" referrerpolicy="no-referrer" alt="Spring常用模块"></p><p><span>主要包括以下七个模块：</span></p><ul><li><strong><span>Spring Context</span></strong><span>：提供框架式的Bean访问方式，以及企业级功能（JNDI、定时任务等）</span></li><li><strong><span>Spring Core</span></strong><span>：核心类库，所有功能都依赖于该类库，提供IOC和DI服务</span></li><li><strong><span>Spring AOP</span></strong><span>：AOP服务</span></li><li><strong><span>Spring Web</span></strong><span>：提供了基本的面向Web的综合特性，提供对常见框架如Struts2的支持，Spring能够管理这些框架，将Spring的资源注入给框架，也能在这些框架的前后插入拦截器</span></li><li><strong><span>Spring MVC</span></strong><span>：提供面向Web应用的Model-View-Controller，即MVC实现</span></li><li><strong><span>Spring DAO</span></strong><span>：对JDBC的抽象封装，简化了数据访问异常的处理，并能统一管理JDBC事务</span></li><li><strong><span>Spring ORM</span></strong><span>：对现有的ORM框架的支持</span></li></ul><p>&nbsp;</p><h3 id='spring主要包'><span>Spring主要包</span></h3><p><img src="images/Middleware/Spring主要包.png" referrerpolicy="no-referrer" alt="Spring主要包"></p><p>&nbsp;</p><h3 id='spring常用注解'><span>Spring常用注解</span></h3><p><img src="images/Middleware/Spring常用注解.png" referrerpolicy="no-referrer" alt="Spring常用注解"></p><p>&nbsp;</p><h2 id='ioc-1'><span>IoC</span></h2><p><span>IOC就是控制反转，指创建对象的控制权转移给Spring框架进行管理，并由Spring根据配置文件去创建实例和管理各个实例之间的依赖关系，对象与对象之间松散耦合，也利于功能的复用。DI依赖注入，和控制反转是同一个概念的不同角度的描述，即 应用程序在运行时依赖IoC容器来动态注入对象需要的外部依赖。</span></p><p><span>最直观的表达就是，以前创建对象的主动权和时机都是由自己把控的，IOC让对象的创建不用去new了，可以由spring自动生产，使用java的反射机制，根据配置文件在运行时动态的去创建对象以及管理对象，并调用对象的方法的。</span></p><p><span>Spring的IOC有三种注入方式 ：</span><strong><span>构造器注入、setter方法注入、根据注解注入</span></strong><span>。</span></p><p>&nbsp;</p><h2 id='aop-1'><span>AOP</span></h2><p><span>AOP，一般称为面向切面，作为面向对象的一种补充，用于将那些与业务无关，但却对多个对象产生影响的公共行为和逻辑，抽取并封装为一个可重用的模块，这个模块被命名为“切面”（Aspect），减少系统中的重复代码，降低了模块间的耦合度，提高系统的可维护性。可用于权限认证、日志、事务处理。AOP实现的关键在于 代理模式，AOP代理主要分为静态代理和动态代理。静态代理的代表为AspectJ；动态代理则以Spring AOP为代表。</span></p><p>&nbsp;</p><h3 id='静态代理'><span>静态代理</span></h3><p><span>AspectJ是静态代理，也称为编译时增强，AOP框架会在编译阶段生成AOP代理类，并将AspectJ(切面)织入到Java字节码中，运行的时候就是增强之后的AOP对象。</span></p><h3 id='动态代理'><span>动态代理</span></h3><p><span>Spring AOP使用的动态代理，所谓的动态代理就是说AOP框架不会去修改字节码，而是每次运行时在内存中临时为方法生成一个AOP对象，这个AOP对象包含了目标对象的全部方法，并且在特定的切点做了增强处理，并回调原对象的方法。Spring AOP中的动态代理主要有两种方式，JDK动态代理和CGLIB动态代理：</span></p><ul><li><p><strong><span>JDK动态代理</span></strong><span>：只提供接口的代理，不支持类的代理，要求被代理类实现接口。JDK动态代理的核心是InvocationHandler接口和Proxy类，在获取代理对象时，使用Proxy类来动态创建目标类的代理类（即最终真正的代理类，这个类继承自Proxy并实现了我们定义的接口），当代理对象调用真实对象的方法时， InvocationHandler 通过invoke()方法反射来调用目标类中的代码，动态地将横切逻辑和业务编织在一起。</span></p><p><strong><span>InvocationHandler的invoke(Object  proxy,Method  method,Object[] args)</span></strong><span>：</span></p><ul><li><strong><span>proxy</span></strong><span>：是最终生成的代理对象</span></li><li><strong><span>method</span></strong><span>：是被代理目标实例的某个具体方法;</span></li><li><strong><span>args</span></strong><span>：是被代理目标实例某个方法的具体入参, 在方法反射调用时使用</span></li></ul></li><li><p><strong><span>CGLIB动态代理</span></strong><span>：如果被代理类没有实现接口，那么Spring AOP会选择使用CGLIB来动态代理目标类。CGLIB（Code Generation Library），是一个代码生成的类库，可以在运行时动态的生成指定类的一个子类对象，并覆盖其中特定方法并添加增强代码，从而实现AOP。CGLIB是通过继承的方式做的动态代理，因此如果某个类被标记为final，那么它是无法使用CGLIB做动态代理的。 </span></p></li></ul><p>&nbsp;</p><p><strong><span>静态代理与动态代理区别？</span></strong></p><p><span>生成AOP代理对象的时机不同，相对来说AspectJ的静态代理方式具有更好的性能，但是AspectJ需要特定的编译器进行处理，而Spring AOP则无需特定的编译器处理。</span></p><p><span>IoC让相互协作的组件保持松散的耦合，而AOP编程允许你把遍布于应用各层的功能分离出来形成可重用的功能组件。</span></p><p>&nbsp;</p><h3 id='应用场景-1'><span>应用场景</span></h3><p><span>AOP 主要应用场景有：</span></p><ul><li><span>Authentication 权限</span></li><li><span>Caching 缓存</span></li><li><span>Context passing 内容传递</span></li><li><span>Error handling 错误处理</span></li><li><span>Lazy loading 懒加载</span></li><li><span>Debugging 调试</span></li><li><span>logging, tracing, profiling and monitoring 记录跟踪 优化 校准</span></li><li><span>Performance optimization 性能优化</span></li><li><span>Persistence 持久化</span></li><li><span>Resource pooling 资源池</span></li><li><span>Synchronization 同步</span></li><li><span>Transactions 事务</span></li></ul><p>&nbsp;</p><h2 id='过滤器filter）'><span>过滤器（Filter）</span></h2><p><span>主要作用是过滤字符编码、做一些业务逻辑判断，主要用于对用户请求进行预处理，同时也可进行逻辑判断。Filter在请求进入servlet容器执行service()方法之前就会经过filter过滤，不像Intreceptor一样依赖于springmvc框架，只需要依赖于servlet。Filter启动是随WEB应用的启动而启动，只需要初始化一次，以后都可以进行拦截。Filter有如下几个种类：</span></p><ul><li><span>用户授权Filter：检查用户请求，根据请求过滤用户非法请求</span></li><li><span>日志Filter：记录某些特殊的用户请求</span></li><li><span>解码Filter：对非标准编码的请求解码</span></li></ul><p>&nbsp;</p><h2 id='拦截器interceptor）'><span>拦截器（Interceptor）</span></h2><p><span>主要作用是拦截用户请求，进行处理。比如判断用户登录情况、权限验证，只要针对Controller请求进行处理，是通过</span><strong><span>HandlerInterceptor</span></strong><span>。</span></p><p><span>Interceptor分两种情况，一种是对会话的拦截，实现spring的HandlerInterceptor接口并注册到mvc的拦截队列中，其中</span><strong><span>preHandle()</span></strong><span>方法在调用Handler之前进行拦截，</span><strong><span>postHandle()</span></strong><span>方法在视图渲染之前调用，</span><strong><span>afterCompletion()</span></strong><span>方法在返回相应之前执行；另一种是对方法的拦截，需要使用@Aspect注解，在每次调用指定方法的前、后进行拦截。</span></p><p>&nbsp;</p><p><strong><span>Filter和Interceptor的区别</span></strong></p><ul><li><span>Filter是基于函数回调（doFilter()方法）的，而Interceptor则是基于Java反射的（AOP思想）</span></li><li><span>Filter依赖于Servlet容器，而Interceptor不依赖于Servlet容器</span></li><li><span>Filter对几乎所有的请求起作用，而Interceptor只能对action请求起作用</span></li><li><span>Interceptor可以访问Action的上下文，值栈里的对象，而Filter不能</span></li><li><span>在action的生命周期里，Interceptor可以被多次调用，而Filter只能在容器初始化时调用一次</span></li><li><span>Filter在过滤是只能对request和response进行操作，而interceptor可以对request、response、handler、modelAndView、exception进行操作</span></li></ul><p>&nbsp;</p><h3 id='handlerinterceptor'><span>HandlerInterceptor</span></h3><p><span>HandlerInterceptor是springMVC项目中的拦截器，它拦截的目标是请求的地址，比MethodInterceptor先执行。</span></p><p><span>实现一个HandlerInterceptor拦截器可以直接实现HandlerInterceptor接口，也可以继承HandlerInterceptorAdapter类。</span></p><p><span>这两种方法殊途同归，其实HandlerInterceptorAdapter也就是声明了HandlerInterceptor接口中所有方法的默认实现，而我们在继承他之后只需要重写必要的方法。</span></p><p>&nbsp;</p><h3 id='methodinterceptor'><span>MethodInterceptor</span></h3><p><span>MethodInterceptor是AOP项目中的拦截器，它拦截的目标是方法，即使不是controller中的方法。实现MethodInterceptor 拦截器大致也分为两种，一种是实现MethodInterceptor接口，另一种利用AspectJ的注解或配置。</span></p><p>&nbsp;</p><h2 id='spring流程'><span>Spring流程</span></h2><h3 id='spring容器启动流程'><span>Spring容器启动流程</span></h3><ul><li><p><span>初始化Spring容器，注册内置的BeanPostProcessor的BeanDefinition到容器中</span></p><p><span>① 实例化BeanFactory【DefaultListableBeanFactory】工厂，用于生成Bean对象</span>
<span>② 实例化BeanDefinitionReader注解配置读取器，用于对特定注解（如@Service、@Repository）的类进行读取转化成  BeanDefinition 对象，（BeanDefinition 是 Spring 中极其重要的一个概念，它存储了 bean 对象的所有特征信息，如是否单例，是否懒加载，factoryBeanName 等）</span>
<span>③ 实例化ClassPathBeanDefinitionScanner路径扫描器，用于对指定的包目录进行扫描查找 bean 对象</span></p></li><li><p><span>将配置类的BeanDefinition注册到容器中</span></p></li><li><p><span>调用refresh()方法刷新容器</span></p><p><span>① prepareRefresh()刷新前的预处理</span>
<span>② obtainFreshBeanFactory()：获取在容器初始化时创建的BeanFactory</span>
<span>③ prepareBeanFactory(beanFactory)：BeanFactory的预处理工作，向容器中添加一些组件</span>
<span>④ postProcessBeanFactory(beanFactory)：子类重写该方法，可以实现在BeanFactory创建并预处理完成以后做进一步的设置</span>
<span>⑤ invokeBeanFactoryPostProcessors(beanFactory)：在BeanFactory标准初始化之后执行BeanFactoryPostProcessor的方法，即BeanFactory的后置处理器</span>
<span>⑥ registerBeanPostProcessors(beanFactory)：向容器中注册Bean的后置处理器BeanPostProcessor，它的主要作用是干预Spring初始化bean的流程，从而完成代理、自动注入、循环依赖等功能</span>
<span>⑦ initMessageSource()：初始化MessageSource组件，主要用于做国际化功能，消息绑定与消息解析</span>
<span>⑧ initApplicationEventMulticaster()：初始化事件派发器，在注册监听器时会用到</span>
<span>⑨ onRefresh()：留给子容器、子类重写这个方法，在容器刷新的时候可以自定义逻辑</span>
<span>⑩ registerListeners()：注册监听器。将容器中所有ApplicationListener注册到事件派发器中，并派发之前步骤产生的事件</span>
<span>⑪  finishBeanFactoryInitialization(beanFactory)：初始化所有剩下的单实例bean，核心方法是preInstantiateSingletons()，会调用getBean()方法创建对象</span>
<span>⑫ finishRefresh()：发布BeanFactory容器刷新完成事件</span></p></li></ul><p>&nbsp;</p><h3 id='springmvc流程'><span>SpringMVC流程</span></h3><ul><li><span>用户发送请求至前端控制器DispatcherServlet</span></li><li><span>DispatcherServlet收到请求后，调用HandlerMapping处理器映射器，请求获取Handler</span></li><li><span>处理器映射器根据请求url找到具体的处理器Handler，生成处理器对象及处理器拦截器(如果有则生成)，一并返回给DispatcherServlet</span></li><li><span>DispatcherServlet 调用 HandlerAdapter处理器适配器，请求执行Handler</span></li><li><span>HandlerAdapter 经过适配调用 具体处理器进行处理业务逻辑</span></li><li><span>Handler执行完成返回ModelAndView</span></li><li><span>HandlerAdapter将Handler执行结果ModelAndView返回给DispatcherServlet</span></li><li><span>DispatcherServlet将ModelAndView传给ViewResolver视图解析器进行解析</span></li><li><span>ViewResolver解析后返回具体View</span></li><li><span>DispatcherServlet对View进行渲染视图（即将模型数据填充至视图中）</span></li><li><span>DispatcherServlet响应用户</span></li></ul><p><img src="images/Middleware/SpringMVC流程.jpg" referrerpolicy="no-referrer" alt="SpringMVC流程"></p><ul><li><span>前端控制器 DispatcherServlet：接收请求、响应结果，相当于转发器，有了DispatcherServlet 就减少了其它组件之间的耦合度</span></li><li><span>处理器映射器 HandlerMapping：根据请求的URL来查找Handler</span></li><li><span>处理器适配器 HandlerAdapter：负责执行Handler</span></li><li><span>处理器 Handler：处理器，需要程序员开发</span></li><li><span>视图解析器 ViewResolver：进行视图的解析，根据视图逻辑名将ModelAndView解析成真正的视图（view）</span></li><li><span>视图View：View是一个接口， 它的实现类支持不同的视图类型，如jsp，freemarker，pdf等等</span></li></ul><p>&nbsp;</p><h3 id='非拦截器http请求流程'><span>非拦截器Http请求流程</span></h3><p><span>用户的普通Http请求执行顺序：</span></p><p><img src="images/Middleware/用户的普通Http请求执行顺序.jpg" referrerpolicy="no-referrer" alt="用户的普通Http请求执行顺序"></p><p>&nbsp;</p><h3 id='拦截器http请求流程'><span>拦截器Http请求流程</span></h3><p><span>过滤器、拦截器添加后的执行顺序：</span></p><p><img src="images/Middleware/过滤器、拦截器添加后的执行顺序.jpg" referrerpolicy="no-referrer" alt="过滤器、拦截器添加后的执行顺序"></p><p>&nbsp;</p><h1 id='springboot-2'><span>SpringBoot</span></h1><h2 id='mvc'><span>MVC</span></h2><h3 id='http请求处理流程'><span>HTTP请求处理流程</span></h3><h3 id='参数绑定'><span>参数绑定</span></h3><h3 id='过滤器拦截器aop执行顺序'><span>过滤器、拦截器、AOP执行顺序</span></h3><h2 id='ioc-2'><span>IOC</span></h2><h3 id='bean的加载过程'><span>Bean的加载过程</span></h3><h3 id='bean实例化的过程'><span>Bean实例化的过程</span></h3><h2 id='aop-2'><span>AOP</span></h2><p>&nbsp;</p><h2 id='others'><span>Others</span></h2><p>&nbsp;</p><h2 id='factorybean'><span>FactoryBean</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UserFactoryBean</span> <span class="cm-keyword">implements</span> <span class="cm-variable">FactoryBean</span><span class="cm-operator">&lt;</span><span class="cm-variable">User</span><span class="cm-operator">&gt;</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">User</span> <span class="cm-variable">getObject</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">User</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"调用 UserFactoryBean 的 getObject 方法生成 Bean:"</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">user</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">getObjectType</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这个 FactoryBean 返回的Bean的类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">User</span>.<span class="cm-keyword">class</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 367px;"></div><div class="CodeMirror-gutters" style="display: none; height: 367px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>FactoryBean在Mybatis中的实践</span></strong></p><p><span>Mybatis的Mapper接口的动态代理也是通过FactoryBean注入到Spring中的。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MapperFactoryBean</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-keyword">extends</span> <span class="cm-variable">SqlSessionDaoSupportimplements</span> <span class="cm-variable">FactoryBean</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment">// mapper的接口类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">mapperInterface</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">T</span> <span class="cm-variable">getObject</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 通过SqlSession获取接口的动态搭理对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">getSqlSession</span>().<span class="cm-variable">getMapper</span>(<span class="cm-keyword">this</span>.<span class="cm-variable">mapperInterface</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">getObjectType</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-variable">mapperInterface</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 389px;"></div><div class="CodeMirror-gutters" style="display: none; height: 389px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>FactoryBean在OpenFeign中的实践</span></strong></p><p><span>FeignClient接口的动态代理也是通过FactoryBean注入到Spring中的。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">FeignClientFactoryBean</span> <span class="cm-keyword">implements</span> </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">FactoryBean</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span>, <span class="cm-variable">InitializingBean</span>, <span class="cm-variable">ApplicationContextAware</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment">// FeignClient接口类型</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">private</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">type</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">public</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">getObject</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">getTarget</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">public</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">getObjectType</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">type</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 367px;"></div><div class="CodeMirror-gutters" style="display: none; height: 367px;"></div></div></div></pre><h2 id='import'><span>@Import</span></h2><p><span>@Import的核心作用就是导入配置类，并且还可以根据配合（比如@EnableXXX）使用的注解的属性来决定应该往Spring中注入什么样的Bean。</span></p><h3 id='实现importselector接口'><span>实现ImportSelector接口</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UserImportSelector</span> <span class="cm-keyword">implements</span> <span class="cm-variable">ImportSelector</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span>[] <span class="cm-variable">selectImports</span>(<span class="cm-variable">AnnotationMetadata</span> <span class="cm-variable">importingClassMetadata</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"调用 UserImportSelector 的 selectImports 方法获取一批类限定名"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>[]{<span class="cm-string">"com.sanyou.spring.extension.User"</span>};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Import</span>(<span class="cm-variable">UserImportSelector</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AnnotationConfigApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">AnnotationConfigApplicationContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将 Application 注册到容器中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">Application</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">refresh</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"获取到的Bean为"</span> <span class="cm-operator">+</span> <span class="cm-variable">applicationContext</span>.<span class="cm-variable">getBean</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 运行结果如下：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 调用 UserImportSelector 的 selectImports 方法获取一批类限定名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取到的Bean为com.sanyou.spring.extension.User@282003e1</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 648px;"></div><div class="CodeMirror-gutters" style="display: none; height: 648px;"></div></div></div></pre><p>&nbsp;</p><h3 id='实现importbeandefinitionregistrar接口'><span>实现ImportBeanDefinitionRegistrar接口</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UserImportBeanDefinitionRegistrar</span> <span class="cm-keyword">implements</span> <span class="cm-variable">ImportBeanDefinitionRegistrar</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">registerBeanDefinitions</span>(<span class="cm-variable">AnnotationMetadata</span> <span class="cm-variable">importingClassMetadata</span>, <span class="cm-variable">BeanDefinitionRegistry</span> <span class="cm-variable">registry</span>, <span class="cm-variable">BeanNameGenerator</span> <span class="cm-variable">importBeanNameGenerator</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//构建一个 BeanDefinition , Bean的类型为 User</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AbstractBeanDefinition</span> <span class="cm-variable">beanDefinition</span> <span class="cm-operator">=</span> <span class="cm-variable">BeanDefinitionBuilder</span>.<span class="cm-variable">rootBeanDefinition</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 设置 User 这个Bean的属性username的值为张小凡</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">addPropertyValue</span>(<span class="cm-string">"username"</span>, <span class="cm-string">"张小凡"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  .<span class="cm-variable">getBeanDefinition</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"往Spring容器中注入User"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//把 User 这个Bean的定义注册到容器中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">registry</span>.<span class="cm-variable">registerBeanDefinition</span>(<span class="cm-string">"user"</span>, <span class="cm-variable">beanDefinition</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 导入 UserImportBeanDefinitionRegistrar</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@Import</span>(<span class="cm-variable">UserImportBeanDefinitionRegistrar</span>.<span class="cm-keyword">class</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AnnotationConfigApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AnnotationConfigApplicationContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将 Application 注册到容器中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">Application</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">refresh</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-variable">applicationContext</span>.<span class="cm-variable">getBean</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"获取到的Bean为"</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span> <span class="cm-operator">+</span> <span class="cm-string">"，属性username值为："</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span>.<span class="cm-variable">getUsername</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 运行结果如下：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 往Spring容器中注入User</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取到的Bean为com.sanyou.spring.extension.User@6385cb26，属性username值为：张小凡</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 929px;"></div><div class="CodeMirror-gutters" style="display: none; height: 929px;"></div></div></div></pre><p>&nbsp;</p><h2 id='beanpostprocessor'><span>BeanPostProcessor</span></h2><p><span>Bean的后置处理器，在Bean创建的过程中起作用。BeanPostProcessor是Bean在创建过程中一个非常重要的扩展点，因为每个Bean在创建的各个阶段，都会回调BeanPostProcessor及其子接口的方法，传入正在创建的Bean对象，这样如果想对Bean创建过程中某个阶段进行自定义扩展，那么就可以自定义BeanPostProcessor来完成。常用的两个子接口：</span></p><ul><li><span>InstantiationAwareBeanPostProcessor</span></li><li><span>DestructionAwareBeanPostProcessor</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UserBeanPostProcessor</span> <span class="cm-keyword">implements</span> <span class="cm-variable">BeanPostProcessor</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">postProcessAfterInitialization</span>(<span class="cm-variable-3">Object</span> <span class="cm-variable">bean</span>, <span class="cm-variable-3">String</span> <span class="cm-variable">beanName</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">BeansException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">bean</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">User</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//如果当前的Bean的类型是 User ，就把这个对象 username 的属性赋值为 张小凡</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ((<span class="cm-variable">User</span>) <span class="cm-variable">bean</span>).<span class="cm-variable">setUsername</span>(<span class="cm-string">"张小凡"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">bean</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AnnotationConfigApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AnnotationConfigApplicationContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将 UserBeanPostProcessor 和  User 注册到容器中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">UserBeanPostProcessor</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">refresh</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-variable">applicationContext</span>.<span class="cm-variable">getBean</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"获取到的Bean为"</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span> <span class="cm-operator">+</span> <span class="cm-string">"，属性username值为："</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span>.<span class="cm-variable">getUsername</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 运行结果如下：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取到的Bean为com.sanyou.spring.extension.User@21a947fe，属性username值为：三友的java日记</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 777px;"></div><div class="CodeMirror-gutters" style="display: none; height: 777px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>Spring内置的BeanPostProcessor</span></strong></p><figure><table><thead><tr><th style='text-align:left;' ><span>BeanPostProcessor</span></th><th style='text-align:left;' ><span>作用</span></th></tr></thead><tbody><tr><td style='text-align:left;' ><span>AutowiredAnnotationBeanPostProcessor</span></td><td style='text-align:left;' ><span>处理@Autowired、@Value注解</span></td></tr><tr><td style='text-align:left;' ><span>CommonAnnotationBeanPostProcessor</span></td><td style='text-align:left;' ><span>处理@Resource、@PostConstruct、@PreDestroy注解</span></td></tr><tr><td style='text-align:left;' ><span>AnnotationAwareAspectJAutoProxyCreator</span></td><td style='text-align:left;' ><span>处理一些注解或者是AOP切面的动态代理</span></td></tr><tr><td style='text-align:left;' ><span>ApplicationContextAwareProcessor</span></td><td style='text-align:left;' ><span>处理Aware接口注入的</span></td></tr><tr><td style='text-align:left;' ><span>AsyncAnnotationBeanPostProcessor</span></td><td style='text-align:left;' ><span>处理@Async注解</span></td></tr><tr><td style='text-align:left;' ><span>ScheduledAnnotationBeanPostProcessor</span></td><td style='text-align:left;' ><span>处理@Scheduled注解</span></td></tr></tbody></table></figure><p>&nbsp;</p><p><strong><span>BeanPostProcessor在Dubbo中的应用</span></strong></p><p><span>在Dubbo中可以通过@DubboReference(@Reference)来引用生产者提供的接口，这个注解的处理也是依靠ReferenceAnnotationBeanPostProcessor，也就是 BeanPostProcessor 的扩展来实现的。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ReferenceAnnotationBeanPostProcessor</span> </span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">extends</span> <span class="cm-variable">AbstractAnnotationBeanPostProcessor</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword">implements</span> <span class="cm-variable">ApplicationContextAware</span>, <span class="cm-variable">BeanFactoryPostProcessor</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 忽略</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p>&nbsp;</p><h2 id='beanfactorypostprocessor'><span>BeanFactoryPostProcessor</span></h2><p><span>BeanFactoryPostProcessor是可以对Spring容器做处理的，方法入参就是Spring容器，通过这个接口，就对容器进行为所欲为的操作。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyBeanFactoryPostProcessor</span> <span class="cm-keyword">implements</span> <span class="cm-variable">BeanFactoryPostProcessor</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">postProcessBeanFactory</span>(<span class="cm-variable">ConfigurableListableBeanFactory</span> <span class="cm-variable">beanFactory</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">BeansException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 禁止循环依赖</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ((<span class="cm-variable">DefaultListableBeanFactory</span>) <span class="cm-variable">beanFactory</span>).<span class="cm-variable">setAllowCircularReferences</span>(<span class="cm-atom">false</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h2 id='spring-spi机制'><span>Spring SPI机制</span></h2><p><span>SPI全称为 (Service Provider Interface)，是一种动态替换发现的机制，一种解耦非常优秀的思想，SPI可以很灵活的让接口和实现分离， 让API提供者只提供接口，第三方来实现，然后可使用配置文件的方式来实现替换或者扩展，在框架中比较常见，提高框架的可扩展性。</span></p><ul><li><span>JDK：ServiceLoader</span></li><li><span>Dubbo：ExtensionLoader</span></li><li><span>Spring：SpringFactoriesLoader</span></li></ul><p><span>Spring的SPI机制规定，配置文件必须在classpath路径下的META-INF文件夹内，文件名必须为spring.factories，文件内容为键值对，一个键可以有多个值，只需要用逗号分割就行，同时键值都需要是类的全限定名。但是键和值可以没有任何关系，当然想有也可以有。</span></p><h3 id='自动装配'><span>自动装配</span></h3><h3 id='propertysourceloader'><span>PropertySourceLoader</span></h3><p><span>在SpringBoot环境下，外部化的配置文件支持properties和yaml两种格式。但现在不想使用properties和yaml格式的文件，想使用json格式的配置文件。则可通过PropertySourceLoader来实现。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">interface</span> <span class="cm-def">PropertySourceLoader</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment">// 可以支持哪种文件格式的解析</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-variable-3">String</span>[] <span class="cm-variable">getFileExtensions</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-comment">// 解析配置文件，读出内容，封装成一个PropertySource&lt;?&gt;结合返回回去</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">PropertySource</span><span class="cm-operator">&lt;?&gt;&gt;</span> <span class="cm-variable">load</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">Resource</span> <span class="cm-variable">resource</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 216px;"></div><div class="CodeMirror-gutters" style="display: none; height: 216px;"></div></div></div></pre><p><span>对于PropertySourceLoader的实现，SpringBoot两个实现：</span></p><ul><li><p><strong><span>PropertiesPropertySourceLoader</span></strong><span>：可以解析properties或者xml结尾的配置文件</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">PropertiesPropertySourceLoader</span> <span class="cm-keyword">implements</span> <span class="cm-variable">PropertySourceLoader</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">XML_FILE_EXTENSION</span> <span class="cm-operator">=</span> <span class="cm-string">".xml"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">PropertiesPropertySourceLoader</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span>[] <span class="cm-variable">getFileExtensions</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>[]{<span class="cm-string">"properties"</span>, <span class="cm-string">"xml"</span>};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">PropertySource</span><span class="cm-operator">&lt;?&gt;&gt;</span> <span class="cm-variable">load</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">Resource</span> <span class="cm-variable">resource</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-operator">?&gt;</span> <span class="cm-variable">properties</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">loadProperties</span>(<span class="cm-variable">resource</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">properties</span>.<span class="cm-variable">isEmpty</span>() <span class="cm-operator">?</span> <span class="cm-variable">Collections</span>.<span class="cm-variable">emptyList</span>() : <span class="cm-variable">Collections</span>.<span class="cm-variable">singletonList</span>(<span class="cm-keyword">new</span> <span class="cm-variable">OriginTrackedMapPropertySource</span>(<span class="cm-variable">name</span>, <span class="cm-variable">Collections</span>.<span class="cm-variable">unmodifiableMap</span>(<span class="cm-variable">properties</span>), <span class="cm-atom">true</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-operator">?&gt;</span> <span class="cm-variable">loadProperties</span>(<span class="cm-variable">Resource</span> <span class="cm-variable">resource</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">filename</span> <span class="cm-operator">=</span> <span class="cm-variable">resource</span>.<span class="cm-variable">getFilename</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> (<span class="cm-variable">Map</span>)(<span class="cm-variable">filename</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">filename</span>.<span class="cm-variable">endsWith</span>(<span class="cm-string">".xml"</span>) <span class="cm-operator">?</span> <span class="cm-variable">PropertiesLoaderUtils</span>.<span class="cm-variable">loadProperties</span>(<span class="cm-variable">resource</span>) : (<span class="cm-keyword">new</span> <span class="cm-variable">OriginTrackedPropertiesLoader</span>(<span class="cm-variable">resource</span>)).<span class="cm-variable">load</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 648px;"></div><div class="CodeMirror-gutters" style="display: none; height: 648px;"></div></div></div></pre></li><li><p><strong><span>YamlPropertySourceLoader</span></strong><span>：解析以yml或者yaml结尾的配置文件</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">YamlPropertySourceLoader</span> <span class="cm-keyword">implements</span> <span class="cm-variable">PropertySourceLoader</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">public</span> <span class="cm-variable-3">String</span>[] <span class="cm-variable">getFileExtensions</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>[] { <span class="cm-string">"yml"</span>, <span class="cm-string">"yaml"</span> };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">public</span> <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">PropertySource</span><span class="cm-operator">&lt;?&gt;&gt;</span> <span class="cm-variable">load</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">Resource</span> <span class="cm-variable">resource</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">ClassUtils</span>.<span class="cm-variable">isPresent</span>(<span class="cm-string">"org.yaml.snakeyaml.Yaml"</span>, <span class="cm-atom">null</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IllegalStateException</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string">"Attempted to load "</span> <span class="cm-operator">+</span> <span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">" but snakeyaml was not found on the classpath"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable-3">Object</span><span class="cm-operator">&gt;&gt;</span> <span class="cm-variable">loaded</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">OriginTrackedYamlLoader</span>(<span class="cm-variable">resource</span>).<span class="cm-variable">load</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">loaded</span>.<span class="cm-variable">isEmpty</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">Collections</span>.<span class="cm-variable">emptyList</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">PropertySource</span><span class="cm-operator">&lt;?&gt;&gt;</span> <span class="cm-variable">propertySources</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ArrayList</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">loaded</span>.<span class="cm-variable">size</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">loaded</span>.<span class="cm-variable">size</span>(); <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-3">String</span> <span class="cm-variable">documentNumber</span> <span class="cm-operator">=</span> (<span class="cm-variable">loaded</span>.<span class="cm-variable">size</span>() <span class="cm-operator">!=</span> <span class="cm-number">1</span>) <span class="cm-operator">?</span> <span class="cm-string">" (document #"</span> <span class="cm-operator">+</span> <span class="cm-variable">i</span> <span class="cm-operator">+</span> <span class="cm-string">")"</span> : <span class="cm-string">""</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">propertySources</span>.<span class="cm-variable">add</span>(<span class="cm-keyword">new</span> <span class="cm-variable">OriginTrackedMapPropertySource</span>(<span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-variable">documentNumber</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">Collections</span>.<span class="cm-variable">unmodifiableMap</span>(<span class="cm-variable">loaded</span>.<span class="cm-variable">get</span>(<span class="cm-variable">i</span>)), <span class="cm-atom">true</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">propertySources</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 777px;"></div><div class="CodeMirror-gutters" style="display: none; height: 777px;"></div></div></div></pre></li></ul><p><span>所以可以看出，要想实现json格式的支持，只需要自己实现可以用来解析json格式的配置文件的PropertySourceLoader就可以了。</span></p><p>&nbsp;</p><p><strong><span>实现可以读取json格式的配置文件</span></strong></p><p><strong><span>第一步：自定义一个JsonPropertySourceLoader，实现PropertySourceLoader接口</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">JsonPropertySourceLoader</span> <span class="cm-keyword">implements</span> <span class="cm-variable">PropertySourceLoader</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">String</span>[] <span class="cm-variable">getFileExtensions</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//这个方法表明这个类支持解析以json结尾的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>[]{<span class="cm-string">"json"</span>};</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">List</span><span class="cm-operator">&lt;</span><span class="cm-variable">PropertySource</span><span class="cm-operator">&lt;?&gt;&gt;</span> <span class="cm-variable">load</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable">Resource</span> <span class="cm-variable">resource</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ReadableByteChannel</span> <span class="cm-variable">readableByteChannel</span> <span class="cm-operator">=</span> <span class="cm-variable">resource</span>.<span class="cm-variable">readableChannel</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ByteBuffer</span> <span class="cm-variable">byteBuffer</span> <span class="cm-operator">=</span> <span class="cm-variable">ByteBuffer</span>.<span class="cm-variable">allocate</span>((<span class="cm-variable-3">int</span>) <span class="cm-variable">resource</span>.<span class="cm-variable">contentLength</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将文件内容读到 ByteBuffer 中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">readableByteChannel</span>.<span class="cm-variable">read</span>(<span class="cm-variable">byteBuffer</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将读出来的字节转换成字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">content</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">byteBuffer</span>.<span class="cm-variable">array</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 将字符串转换成 JSONObject</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">JSONObject</span> <span class="cm-variable">jsonObject</span> <span class="cm-operator">=</span> <span class="cm-variable">JSON</span>.<span class="cm-variable">parseObject</span>(<span class="cm-variable">content</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span> <span class="cm-variable">map</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashMap</span><span class="cm-operator">&lt;&gt;</span>(<span class="cm-variable">jsonObject</span>.<span class="cm-variable">size</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将 json 的键值对读出来，放入到 map 中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">String</span> <span class="cm-variable">key</span> : <span class="cm-variable">jsonObject</span>.<span class="cm-variable">keySet</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-variable">put</span>(<span class="cm-variable">key</span>, <span class="cm-variable">jsonObject</span>.<span class="cm-variable">getString</span>(<span class="cm-variable">key</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">Collections</span>.<span class="cm-variable">singletonList</span>(<span class="cm-keyword">new</span> <span class="cm-variable">MapPropertySource</span>(<span class="cm-string">"jsonPropertySource"</span>, <span class="cm-variable">map</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 799px;"></div><div class="CodeMirror-gutters" style="display: none; height: 799px;"></div></div></div></pre><p><strong><span>第二步：配置PropertySourceLoader</span></strong></p><p><span>基于SPI机制加载PropertySourceLoader实现。因此在spring.factories文件中配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.boot.env.PropertySourceLoader</span>=<span class="cm-quote">\</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">cn.test.JsonPropertySourceLoader</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><strong><span>第三步：测试验证</span></strong></p><p><span>在application.json中配置如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>"test.userName": "张小凡"</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><span>定义配置类：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">User</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 注入配置文件的属性</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Value</span>(<span class="cm-string">"${test.userName:}"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">String</span> <span class="cm-variable">userName</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><span>启动项目</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">@SpringBootApplication</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ConfigurableApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> <span class="cm-variable">SpringApplication</span>.<span class="cm-variable">run</span>(<span class="cm-variable">Application</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-variable">applicationContext</span>.<span class="cm-variable">getBean</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"获取到的Bean为"</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span> <span class="cm-operator">+</span> <span class="cm-string">"，属性userName值为："</span> <span class="cm-operator">+</span> <span class="cm-variable">user</span>.<span class="cm-variable">getUserName</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Bean</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">User</span> <span class="cm-variable">user</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">User</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 运行结果如下：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 获取到的Bean为com.sanyou.spring.extension.User@481ba2cf，属性username值为：张小凡</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>Nacos对于PropertySourceLoader的实现</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.boot.env.PropertySourceLoader</span>=<span class="cm-quote">\</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">com.alibaba.cloud.nacos.parser.NacosJsonPropertySourceLoader,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">com.alibaba.cloud.nacos.parser.NacosXmlPropertySourceLoader</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><span>Nacos作为配置中心，不仅支持properties和yaml格式的文件，还支持json格式的配置文件，那么客户端拿到这些配置就需要解析，SpringBoot已经支持了properties和yaml格式的文件的解析，那么Nacos只需要实现SpringBoot不支持的就可以了。</span></p><p>&nbsp;</p><h3 id='applicationcontextinitializer'><span>ApplicationContextInitializer</span></h3><p><span>ApplicationContextInitializer也是SpringBoot启动过程的一个扩展点。在SpringBoot启动过程，会回调这个类的实现initialize方法，传入ConfigurableApplicationContext。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.context.ApplicationContextInitializer</span>=<span class="cm-quote">\</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.context.ConfigurationWarningApplicationContextInitializer,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 238px;"></div><div class="CodeMirror-gutters" style="display: none; height: 238px;"></div></div></div></pre><p><span>注意：这里传入的ConfigurableApplicationContext并没有调用过refresh方法，也就是里面是没有Bean对象的，一般这个接口是用来配置ConfigurableApplicationContext，而不是用来获取Bean的。</span></p><p>&nbsp;</p><h3 id='environmentpostprocessor'><span>EnvironmentPostProcessor</span></h3><p><span>EnvironmentPostProcessor在SpringBoot启动过程中，也会调用，也是通过SPI机制来加载扩展的。EnvironmentPostProcessor是用来处理ConfigurableEnvironment的，也就是一些配置信息，SpringBoot所有的配置都是存在这个对象的。</span></p><p><span>这个类的作用就是用来处理外部化配置文件的，也就是这个类是用来处理配置文件的，通过前面提到的PropertySourceLoader解析配置文件，放到ConfigurableEnvironment里面。</span></p><p>&nbsp;</p><h3 id='applicationrunner和commandlinerunner'><span>ApplicationRunner和CommandLineRunner</span></h3><p><span>ApplicationRunner和CommandLineRunner都是在SpringBoot成功启动之后会调用，可以拿到启动时的参数。这两个其实不是通过SPI机制来扩展，而是直接从容器中获取的。因为调用ApplicationRunner和CommandLineRunner时，SpringBoot已经启动成功了，Spring容器都准备好了，需要什么Bean直接从容器中查找多方便。</span></p><p><span>所以要想扩展这个点，只需要实现接口，添加到Spring容器。</span></p><p>&nbsp;</p><h2 id='spring-event-事件'><span>Spring Event 事件</span></h2><p><span>什么是Spring Event 事件，就是Spring实现了这种事件模型，你只需要基于Spring提供的API进行扩展，就可以完成事件的发布订阅。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 火灾事件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">FireEvent</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ApplicationEvent</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">FireEvent</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">source</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">super</span>(<span class="cm-variable">source</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 打119的火灾事件的监听器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Call119FireEventListener</span> <span class="cm-keyword">implements</span> <span class="cm-variable">ApplicationListener</span><span class="cm-operator">&lt;</span><span class="cm-variable">FireEvent</span><span class="cm-operator">&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">onApplicationEvent</span>(<span class="cm-variable">FireEvent</span> <span class="cm-variable">event</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"打119"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 救人的火灾事件的监听器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SavePersonFireEventListener</span> <span class="cm-keyword">implements</span> <span class="cm-variable">ApplicationListener</span><span class="cm-operator">&lt;</span><span class="cm-variable">FireEvent</span><span class="cm-operator">&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">onApplicationEvent</span>(<span class="cm-variable">FireEvent</span> <span class="cm-variable">event</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"救人"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">AnnotationConfigApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AnnotationConfigApplicationContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//将 事件监听器 注册到容器中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">Call119FireEventListener</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">register</span>(<span class="cm-variable">SavePersonFireEventListener</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">refresh</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 发布着火的事件，触发监听</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">publishEvent</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FireEvent</span>(<span class="cm-string">"着火了"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 842px;"></div><div class="CodeMirror-gutters" style="display: none; height: 842px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>Spring内置的事件</span></strong></p><p><span>Spring内置的事件很多，这里我罗列几个</span></p><figure><table><thead><tr><th style='text-align:left;' ><span>事件类型</span></th><th style='text-align:left;' ><span>触发时机</span></th></tr></thead><tbody><tr><td style='text-align:left;' ><span>ContextRefreshedEvent</span></td><td style='text-align:left;' ><span>在调用ConfigurableApplicationContext 接口中的refresh()方法时触发</span></td></tr><tr><td style='text-align:left;' ><span>ContextStartedEvent</span></td><td style='text-align:left;' ><span>在调用ConfigurableApplicationContext的start()方法时触发</span></td></tr><tr><td style='text-align:left;' ><span>ContextStoppedEvent</span></td><td style='text-align:left;' ><span>在调用ConfigurableApplicationContext的stop()方法时触发</span></td></tr><tr><td style='text-align:left;' ><span>ContextClosedEvent</span></td><td style='text-align:left;' ><span>当ApplicationContext被关闭时触发该事件，也就是调用close()方法触发</span></td></tr></tbody></table></figure><p>&nbsp;</p><h3 id='applicationevent'><span>ApplicationEvent</span></h3><p><span>事件的父类，所有具体的事件都得继承这个类，构造方法的参数是这个事件携带的参数，监听器就可以通过这个参数来进行一些业务操作。</span></p><p><img src="images/Middleware/ApplicationEvent.png" referrerpolicy="no-referrer" alt="图片"></p><h3 id='applicationlistener'><span>ApplicationListener</span></h3><p><span>事件监听的接口，泛型是子类需要监听的事件类型，子类需要实现onApplicationEvent，参数就是事件类型，onApplicationEvent方法的实现就代表了对事件的处理，当事件发生时，Spring会回调onApplicationEvent方法的实现，传入发布的事件。</span></p><p><img src="images/Middleware/ApplicationListener.png" referrerpolicy="no-referrer" alt="图片"></p><h3 id='applicationeventpublisher'><span>ApplicationEventPublisher</span></h3><p><span>事件发布器，通过publishEvent方法就可以发布一个事件，然后就可以触发监听这个事件的监听器的回调。</span></p><p><span>ApplicationContext实现了ApplicationEventPublisher接口，所以通过ApplicationContext就可以发布事件。</span></p><p><img src="images/Middleware/ApplicationEventPublisher.png" referrerpolicy="no-referrer" alt="图片"></p><p>&nbsp;</p><h2 id='命名空间'><span>命名空间</span></h2><p><strong><span>第一步：定义一个xsd文件</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml</span> <span class="cm-meta">version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">&lt;!-- xmlns 和 targetNamespace 需要定义，结尾为sanyou，前面都一样的--&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">xsd:schema</span> <span class="cm-attribute">xmlns</span>=<span class="cm-string">"http://sanyou.com/schema/sanyou"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">xmlns:xsd</span>=<span class="cm-string">"http://www.w3.org/2001/XMLSchema"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">targetNamespace</span>=<span class="cm-string">"http://sanyou.com/schema/sanyou"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">xsd:import</span> <span class="cm-attribute">namespace</span>=<span class="cm-string">"http://www.w3.org/XML/1998/namespace"</span><span class="cm-tag cm-bracket">/&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">xsd:complexType</span> <span class="cm-attribute">name</span>=<span class="cm-string">"Bean"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">xsd:attribute</span> <span class="cm-attribute">name</span>=<span class="cm-string">"class"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"xsd:string"</span> <span class="cm-attribute">use</span>=<span class="cm-string">"required"</span><span class="cm-tag cm-bracket">/&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">xsd:complexType</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">&lt;!--  sanyou 便签的子标签，类型是Bean ，就会找到上面的complexType=Bean类型，然后处理属性  --&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">xsd:element</span> <span class="cm-attribute">name</span>=<span class="cm-string">"mybean"</span> <span class="cm-attribute">type</span>=<span class="cm-string">"Bean"</span><span class="cm-tag cm-bracket">/&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">xsd:schema</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 367px;"></div><div class="CodeMirror-gutters" style="display: none; height: 367px;"></div></div></div></pre><p><span>这个xsd文件来指明sanyou这个命名空间下有哪些标签和属性。这里我只指定了一个标签 mybean，mybean标签里面有个class的属性，然后这个标签的目的就是将class属性指定的Bean的类型，注入到Spring容器中，作用跟spring的标签的作用是一样的。xsd文件没有需要放的固定的位置，这里我放到 META-INF 目录下。</span></p><p><strong><span>第二步：解析这个命名空间</span></strong></p><p><span>解析命名空间很简单，Spring都有配套的东西--NamespaceHandler接口，只要实现这个接口就行了。但一般我们不直接实现 NamespaceHandler 接口，我们可以继承 NamespaceHandlerSupport 类，这个类实现了 NamespaceHandler 接口。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SanYouNameSpaceHandler</span> <span class="cm-keyword">extends</span> <span class="cm-variable">NamespaceHandlerSupport</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">init</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//注册解析 mybean 标签的解析器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">registerBeanDefinitionParser</span>(<span class="cm-string">"mybean"</span>, <span class="cm-keyword">new</span> <span class="cm-variable">SanYouBeanDefinitionParser</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">SanYouBeanDefinitionParser</span> <span class="cm-keyword">extends</span> <span class="cm-variable">AbstractSingleBeanDefinitionParser</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">shouldGenerateId</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-atom">true</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable-3">String</span> <span class="cm-variable">getBeanClassName</span>(<span class="cm-variable">Element</span> <span class="cm-variable">element</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">element</span>.<span class="cm-variable">getAttribute</span>(<span class="cm-string">"class"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 475px;"></div><div class="CodeMirror-gutters" style="display: none; height: 475px;"></div></div></div></pre><p><span>SanYouNameSpaceHandler的作用就是将sanyou命名空间中的mybean这个标签读出来，拿到class的属性，然后将这个class属性指定的class类型注入到Spring容器中，至于注册这个环节的代码，都交给了SanYouBeanDefinitionParser的父类来做了。</span></p><p><strong><span>第三步：创建并配置spring.handlers和spring.schemas文件</span></strong></p><p><span>先创建spring.handlers和spring.schemas文件。spring.handlers文件内容：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">http\</span>:<span class="cm-quote">//sanyou.com/schema/sanyou</span>=<span class="cm-quote">com.sanyou.spring.extension.namespace.SanYouNameSpaceHandler</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p><span>通过spring.handlers配置文件，就知道sanyou命名空间应该找SanYouNameSpaceHandler进行解析。spring.schemas文内容：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">http\</span>:<span class="cm-quote">//sanyou.com/schema/sanyou.xsd</span>=<span class="cm-quote">META-INF/sanyou.xsd</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><span>spring.schemas配置xsd文件的路径。文件都有了，只需要放到classpath下的META-INF文件夹就行了。</span></p><p><img src="images/Middleware/sanyou-xsd.png" referrerpolicy="no-referrer" alt="图片"></p><p><strong><span>第四步：测试</span></strong></p><p><span>先构建一个applicationContext.xml文件，放到resources目录下</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="xml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">&lt;?xml</span> <span class="cm-meta">version="1.0" encoding="UTF-8"?&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">beans</span> <span class="cm-attribute">xmlns:xsi</span>=<span class="cm-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-attribute">xmlns</span>=<span class="cm-string">"http://www.springframework.org/schema/beans"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-attribute">xmlns:sanyou</span>=<span class="cm-string">"http://sanyou.com/schema/sanyou"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-attribute">xsi:schemaLocation</span>=<span class="cm-string">"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string">http://www.springframework.org/schema/beans</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string">http://sanyou.com/schema/sanyou</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string">http://sanyou.com/schema/sanyou.xsd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string">"</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">&lt;!--使用 sanyou 标签，配置一个 User Bean--&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">sanyou:mybean</span> <span class="cm-attribute">class</span>=<span class="cm-string">"com.sanyou.spring.extension.User"</span><span class="cm-tag cm-bracket">/&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">beans</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p><span>再写个测试类：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Application</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ClassPathXmlApplicationContext</span> <span class="cm-variable">applicationContext</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ClassPathXmlApplicationContext</span>(<span class="cm-string">"applicationContext.xml"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">applicationContext</span>.<span class="cm-variable">refresh</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">User</span> <span class="cm-variable">user</span> <span class="cm-operator">=</span> <span class="cm-variable">applicationContext</span>.<span class="cm-variable">getBean</span>(<span class="cm-variable">User</span>.<span class="cm-keyword">class</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">user</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 运行结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// com.sanyou.spring.extension.User@27fe3806</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h1 id='springcloud'><span>SpringCloud</span></h1><p><img src="images/Middleware/SpringCloud.png" referrerpolicy="no-referrer" alt="SpringCloud"></p><h2 id='eurake'><span>Eurake</span></h2><p><span>Netflix Eureka 是由 Netflix 开源的一款基于 REST 的服务发现组件，包括 Eureka Server 及 Eureka Client。</span></p><p><img src="images/Middleware/Eurake介绍.png" referrerpolicy="no-referrer" alt="Eurake介绍"></p><p><img src="images/Middleware/Eurake.png" referrerpolicy="no-referrer" alt="Eurake"></p><ul><li><strong><span>Eurake客户端</span></strong><span>：负责将这个服务的信息注册到Eureka服务端中</span></li><li><strong><span>Eureka服务端</span></strong><span>：相当于一个注册中心，里面有注册表，注册表中保存了各个服务所在的机器和端口号，可以通过Eureka服务端找到各个服务</span></li></ul><p>&nbsp;</p><h3 id='eurka工作流程'><span>Eurka工作流程</span></h3><p><span>Eureka的工作流程如下：</span></p><ol start='' ><li><strong><span>Eureka Server 启动成功，等待服务端注册</span></strong><span>。在启动过程中如果配置了集群，集群之间定时通过 Replicate 同步注册表，每个 Eureka Server 都存在独立完整的服务注册表信息</span></li><li><span>Eureka Client 启动时根据配置的 Eureka Server 地址</span><strong><span>去注册中心注册服务</span></strong></li><li><span>Eureka Client 会</span><strong><span>每30s向 Eureka Server 发送一次心跳请求</span></strong><span>，证明客户端服务正常</span></li><li><span>当Eureka Server </span><strong><span>90s内没有收到Eureka Client的心跳，注册中心则认为该节点失效</span></strong><span>，会注销该实例</span></li><li><strong><span>单位时间内Eureka Server统计到有大量的Eureka Client没有上送心跳，则认为可能为网络异常</span></strong><span>，进入自我保护机制，不再剔除没有上送心跳的客户端</span></li><li><strong><span>当Eureka Client心跳请求恢复正常之后，Eureka Server自动退出自我保护模式</span></strong></li><li><strong><span>Eureka Client定时全量或者增量从注册中心获取服务注册表，并且将获取到的信息缓存到本地</span></strong></li><li><span>服务调用时，Eureka Client会先从本地缓存找调取的服务。若获取不到，先从注册中心刷新注册表，再同步到本地缓存</span></li><li><span>Eureka Client获取到目标服务器信息，发起服务调用</span></li><li><span>Eureka Client程序关闭时向Eureka Server发送取消请求，Eureka Server将实例从注册表中删除</span></li></ol><p>&nbsp;</p><h3 id='eureka-server'><span>Eureka Server</span></h3><p><span>Eureka Server注册中心服务端主要对外提供了三个功能：</span></p><ul><li><strong><span>服务注册</span></strong>
<span>服务提供者启动时，会通过 Eureka Client 向 Eureka Server 注册信息，Eureka Server 会存储该服务的信息，Eureka Server 内部有二层缓存机制来维护整个注册表。</span></li><li><strong><span>提供注册表</span></strong>
<span>服务消费者在调用服务时，如果 Eureka Client 没有缓存注册表的话，会从 Eureka Server 获取最新的注册表。</span></li><li><strong><span>同步状态</span></strong>
<span>Eureka Client 通过注册、心跳机制和 Eureka Server 同步当前客户端的状态。</span></li></ul><p>&nbsp;</p><p><strong><span>自我保护机制</span></strong>
<span>默认情况下，如果 Eureka Server 在一定的 90s 内没有接收到某个微服务实例的心跳，会注销该实例。但是在微服务架构下服务之间通常都是跨进程调用，网络通信往往会面临着各种问题，比如微服务状态正常，网络分区故障，导致此实例被注销。固定时间内大量实例被注销，可能会严重威胁整个微服务架构的可用性。为了解决这个问题，Eureka 开发了自我保护机制，那么什么是自我保护机制呢？Eureka Server 在运行期间会去统计心跳失败比例在 15 分钟之内是否低于 85%，如果低于 85%，Eureka Server 即会进入自我保护机制。Eureka Server 触发自我保护机制后，页面会出现提示：</span>
<img src="images/Middleware/EurekaServer触发自我保护机制.png" referrerpolicy="no-referrer" alt="EurekaServer触发自我保护机制"></p><p><span>Eureka Server进入自我保护机制，会出现以下几种情况：</span></p><ul><li><strong><span>Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务</span></strong></li><li><strong><span>Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用)</span></strong></li><li><strong><span>当网络稳定时，当前实例新的注册信息会被同步到其它节点中</span></strong></li></ul><p><span>Eureka自我保护机制是为了防止误杀服务而提供的一个机制：</span></p><ul><li><strong><span>当个别客户端出现心跳失联时，则认为是客户端的问题，剔除掉客户端</span></strong></li><li><strong><span>当Eureka捕获到大量的心跳失败时，则认为可能是网络问题，进入自我保护机制</span></strong></li><li><strong><span>当客户端心跳恢复时，Eureka会自动退出自我保护机制</span></strong></li></ul><p><span>如果在保护期内刚好这个服务提供者非正常下线了，此时服务消费者就会拿到一个无效的服务实例，即会调用失败。对于这个问题需要服务消费者端要有一些容错机制，如重试，断路器等。通过在 Eureka Server 配置如下参数，开启或者关闭保护机制，生产环境建议打开：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.enable-self-preservation</span>=<span class="cm-quote">true</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p>&nbsp;</p><h3 id='eureka-client'><span>Eureka Client</span></h3><p><span>Eureka Client注册中心客户端是一个 Java 客户端，用于简化与 Eureka Server 的交互。Eureka Client 会拉取、更新和缓存 Eureka Server 中的信息。因此当所有的 Eureka Server 节点都宕掉，服务消费者依然可以使用缓存中的信息找到服务提供者，但是当服务有更改的时候会出现信息不一致。</span></p><ul><li><p><strong><span>Register —— 服务注册</span></strong>
<span>服务的提供者，将自身注册到注册中心，服务提供者也是一个 Eureka Client。当 Eureka Client 向 Eureka Server 注册时，它提供自身的元数据，比如 IP 地址、端口，运行状况指示符 URL，主页等。</span></p></li><li><p><strong><span>Renew —— 服务续约</span></strong>
<span>Eureka Client 会每隔 30 秒发送一次心跳来续约。 通过续约来告知 Eureka Server 该 Eureka Client 运行正常，没有出现问题。 默认情况下，如果 Eureka Server 在 90 秒内没有收到 Eureka Client 的续约，Server 端会将实例从其注册表中删除，此时间可配置，一般情况不建议更改。服务续约的两个重要属性：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 服务续约任务的调用间隔时间，默认为30秒</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.lease-renewal-interval-in-seconds</span>=<span class="cm-quote">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 服务失效的时间，默认为90秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.lease-expiration-duration-in-seconds</span>=<span class="cm-quote">90</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre></li><li><p><strong><span>Eviction —— 服务剔除</span></strong>
<span>当Eureka Client和Eureka Server不再有心跳时，Eureka Server会将该服务实例从服务注册列表中删除，即服务剔除。</span></p></li><li><p><strong><span>Cancel —— 服务下线</span></strong>
<span>Eureka Client 在程序关闭时向 Eureka Server 发送取消请求。 发送请求后，该客户端实例信息将从 Eureka Server 的实例注册表中删除。该下线请求不会自动完成，它需要调用以下内容：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">DiscoveryManager</span>.<span class="cm-variable">getInstance</span>().<span class="cm-variable">shutdownComponent</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre></li><li><p><strong><span>GetRegisty —— 获取注册列表信息</span></strong>
<span>Eureka Client 从服务器获取注册表信息，并将其缓存在本地。客户端会使用该信息查找其他服务，从而进行远程调用。该注册列表信息定期（每30秒钟）更新一次。每次返回注册列表信息可能与 Eureka Client 的缓存信息不同，Eureka Client 自动处理。</span></p><p><span>如果由于某种原因导致注册列表信息不能及时匹配，Eureka Client 则会重新获取整个注册表信息。 Eureka Server 缓存注册列表信息，整个注册表以及每个应用程序的信息进行了压缩，压缩内容和没有压缩的内容完全相同。Eureka Client 和 Eureka Server 可以使用 JSON/XML 格式进行通讯。在默认情况下 Eureka Client 使用压缩 JSON 格式来获取注册列表的信息。获取服务是服务消费者的基础，所以必有两个重要参数需要注意：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用服务消费者从注册中心拉取服务列表的功能</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.fetch-registry</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置服务消费者从注册中心拉取服务列表的间隔</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.registry-fetch-interval-seconds</span>=<span class="cm-quote">30</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre></li><li><p><strong><span>Remote Call —— 远程调用</span></strong>
<span>当Eureka Client从注册中心获取到服务提供者信息后，就可以通过Http请求调用对应的服务；服务提供者有多个时，Eureka Client客户端会通过Ribbon自动进行负载均衡。</span></p></li></ul><p>&nbsp;</p><h3 id='eureka缓存机制'><span>Eureka缓存机制</span></h3><p><strong><span>Eureka Server数据存储</span></strong></p><p><span>Eureka Server的数据存储层是双层的 ConcurrentHashMap：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">ConcurrentHashMap</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable">Lease</span><span class="cm-operator">&lt;</span><span class="cm-variable">InstanceInfo</span><span class="cm-operator">&gt;&gt;&gt;</span> <span class="cm-variable">registry</span><span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ConcurrentHashMap</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable">Map</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">String</span>, <span class="cm-variable">Lease</span><span class="cm-operator">&lt;</span><span class="cm-variable">InstanceInfo</span><span class="cm-operator">&gt;&gt;&gt;</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><ul><li><strong><span>key</span></strong><span>：为服务名，即 </span><code>spring.application.name</code><span>，也就是客户端实例注册的应用名</span></li><li><strong><span>subKey</span></strong><span>：为 </span><code>instanceId</code><span>，也就是服务的唯一实例ID</span></li><li><strong><span>Lease&lt; InstanceInfo &gt;</span></strong><span>：Lease对象存储着这个实例的所有注册信息，包括 ip 、端口、属性等</span></li></ul><p>&nbsp;</p><p><strong><span>Eureka Server缓存机制</span></strong></p><p><span>Eureka Server为了提供响应效率，提供了两层的缓存结构，将Eureka Client所需要的注册信息，直接存储在缓存结构中。</span></p><ul><li><p><strong><span>第一层缓存：readOnlyCacheMap，本质上是 ConcurrentHashMap</span></strong></p><p><span>依赖定时从 readWriteCacheMap 同步数据，默认时间为 30 秒。</span></p><p><span>readOnlyCacheMap： 是一个 CurrentHashMap 只读缓存，这个主要是为了供客户端获取注册信息时使用，其缓存更新，依赖于定时器的更新，通过和 readWriteCacheMap 的值做对比，如果数据不一致，则以 readWriteCacheMap 的数据为准。</span></p></li><li><p><strong><span>第二层缓存：readWriteCacheMap，本质上是 Guava 缓存</span></strong></p><p><span>readWriteCacheMap：readWriteCacheMap 的数据主要同步于存储层。当获取缓存时判断缓存中是否没有数据，如果不存在此数据，则通过 CacheLoader 的 load 方法去加载，加载成功之后将数据放入缓存，同时返回数据。readWriteCacheMap缓存过期时间，默认为180秒，当服务下线、过期、注册、状态变更，都会来清除此缓存中的数据。</span></p></li></ul><p><span>Eureka Client 获取全量或者增量的数据时，会先从一级缓存中获取；如果一级缓存中不存在，再从二级缓存中获取；如果二级缓存也不存在，这时候先将存储层的数据同步到缓存中，再从缓存中获取。通过 Eureka Server 的二层缓存机制，可以非常有效地提升 Eureka Server 的响应时间，通过数据存储层和缓存层的数据切割，根据使用场景来提供不同的数据支持。</span></p><p>&nbsp;</p><p><strong><span>其它缓存设计</span></strong></p><p><span>除过 Eureka Server 端存在缓存外，Eureka Client 也同样存在着缓存机制，Eureka Client 启动时会全量拉取服务列表，启动后每隔 30 秒从 Eureka Server 量获取服务列表信息，并保持在本地缓存中。Eureka Client 增量拉取失败，或者增量拉取之后对比 hashcode 发现不一致，就会执行全量拉取，这样避免了网络某时段分片带来的问题，同样会更新到本地缓存。同时对于服务调用，如果涉及到 ribbon 负载均衡，那么 ribbon 对于这个实例列表也有自己的缓存，这个缓存定时(默认30秒)从 Eureka Client 的缓存更新。这么多的缓存机制可能就会造成一些问题，一个服务启动后可能最长需要 90s 才能被其它服务感知到：</span></p><ol start='' ><li><span>首先，Eureka Server 维护每 30s 更新的响应缓存</span></li><li><span>Eureka Client 对已经获取到的注册信息也做了 30s 缓存</span></li><li><span>负载均衡组件 Ribbon 也有 30s 缓存</span></li></ol><p><span>这三个缓存加起来，就有可能导致服务注册最长延迟 90s ，这个需要我们在特殊业务场景中注意其产生的影响。</span></p><p>&nbsp;</p><h3 id='常用配置-1'><span>常用配置</span></h3><p><span>Eureka Server常用配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#服务端开启自我保护模式，前面章节有介绍</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.enable-self-preservation</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#扫描失效服务的间隔时间（单位毫秒，默认是60*1000）即60秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.eviction-interval-timer-in-ms</span>=<span class="cm-quote"> 60000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#间隔多长时间，清除过期的 delta 数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.delta-retention-timer-interval-in-ms</span>=<span class="cm-quote">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#请求频率限制器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-burst-size</span>=<span class="cm-quote">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否开启请求频率限制器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-enabled</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#请求频率的平均值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-full-fetch-average-rate</span>=<span class="cm-quote">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否对标准的client进行频率请求限制。如果是false，则只对非标准client进行限制</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-throttle-standard-clients</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#注册服务、拉去服务列表数据的请求频率的平均值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-registry-fetch-average-rate</span>=<span class="cm-quote">500</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#设置信任的client list</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.rate-limiter-privileged-clients</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#在设置的时间范围类，期望与client续约的百分比。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.renewal-percent-threshold</span>=<span class="cm-quote">0.85</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#多长时间更新续约的阈值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.renewal-threshold-update-interval-ms</span>=<span class="cm-quote">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#对于缓存的注册数据，多长时间过期</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.response-cache-auto-expiration-in-seconds</span>=<span class="cm-quote">180</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#多长时间更新一次缓存中的服务注册数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.response-cache-update-interval-ms</span>=<span class="cm-quote">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#缓存增量数据的时间，以便在检索的时候不丢失信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.retention-time-in-m-s-in-delta-queue</span>=<span class="cm-quote">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#当时间戳不一致的时候，是否进行同步</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.sync-when-timestamp-differs</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否采用只读缓存策略，只读策略对于缓存的数据不会过期。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.use-read-only-response-cache</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">################server node 与 node 之间关联的配置#####################33</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#发送复制数据是否在request中，总是压缩</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.enable-replicated-request-compression</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#指示群集节点之间的复制是否应批处理以提高网络效率。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.batch-replication</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#允许备份到备份池的最大复制事件数量。而这个备份池负责除状态更新的其他事件。可以根据内存大小，超时和复制流量，来设置此值得大小</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-elements-in-peer-replication-pool</span>=<span class="cm-quote">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#允许备份到状态备份池的最大复制事件数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-elements-in-status-replication-pool</span>=<span class="cm-quote">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#多个服务中心相互同步信息线程的最大空闲时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-idle-thread-age-in-minutes-for-peer-replication</span>=<span class="cm-quote">15</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#状态同步线程的最大空闲时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-idle-thread-in-minutes-age-for-status-replication</span>=<span class="cm-quote">15</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#服务注册中心各个instance相互复制数据的最大线程数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-threads-for-peer-replication</span>=<span class="cm-quote">20</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#服务注册中心各个instance相互复制状态数据的最大线程数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-threads-for-status-replication</span>=<span class="cm-quote">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#instance之间复制数据的通信时长</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.max-time-for-replication</span>=<span class="cm-quote">30000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#正常的对等服务instance最小数量。-1表示服务中心为单节点。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.min-available-instances-for-peer-replication</span>=<span class="cm-quote">-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#instance之间相互复制开启的最小线程数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.min-threads-for-peer-replication</span>=<span class="cm-quote">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#instance之间用于状态复制，开启的最小线程数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.min-threads-for-status-replication</span>=<span class="cm-quote">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#instance之间复制数据时可以重试的次数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.number-of-replication-retries</span>=<span class="cm-quote">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka节点间间隔多长时间更新一次数据。默认10分钟。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-eureka-nodes-update-interval-ms</span>=<span class="cm-quote">600000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka服务状态的相互更新的时间间隔。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-eureka-status-refresh-time-interval-ms</span>=<span class="cm-quote">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka对等节点间连接超时时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-node-connect-timeout-ms</span>=<span class="cm-quote">200</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka对等节点连接后的空闲时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-node-connection-idle-timeout-seconds</span>=<span class="cm-quote">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#节点间的读数据连接超时时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-node-read-timeout-ms</span>=<span class="cm-quote">200</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka server 节点间连接的总共最大数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-node-total-connections</span>=<span class="cm-quote">1000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka server 节点间连接的单机最大数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.peer-node-total-connections-per-host</span>=<span class="cm-quote">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#在服务节点启动时，eureka尝试获取注册信息的次数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.registry-sync-retries</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#在服务节点启动时，eureka多次尝试获取注册信息的间隔时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.registry-sync-retry-wait-ms</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#当eureka server启动的时候，不能从对等节点获取instance注册信息的情况，应等待多长时间。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.server.wait-time-in-ms-when-sync-empty</span>=<span class="cm-quote">0</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1857px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1857px;"></div></div></div></pre><p><span>Eureka Client 常用配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#该客户端是否可用</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.enabled</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#实例是否在eureka服务器上注册自己的信息以供其他服务发现，默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.register-with-eureka</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#此客户端是否获取eureka服务器注册表上的注册信息，默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.fetch-registry</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否过滤掉，非UP的实例。默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.filter-only-up-instances</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#与Eureka注册服务中心的通信zone和url地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.serviceUrl.defaultZone</span>=<span class="cm-quote">http</span>:<span class="cm-quote">//${eureka.instance.hostname}</span>:<span class="cm-quote">${server.port}/eureka/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client连接Eureka服务端后的空闲等待时间，默认为30 秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-connection-idle-timeout-seconds</span>=<span class="cm-quote">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client连接eureka服务端的连接超时时间，默认为5秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-server-connect-timeout-seconds</span>=<span class="cm-quote">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client对服务端的读超时时长</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-server-read-timeout-seconds</span>=<span class="cm-quote">8</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client连接all eureka服务端的总连接数，默认200</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-server-total-connections</span>=<span class="cm-quote">200</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client连接eureka服务端的单机连接数量，默认50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-server-total-connections-per-host</span>=<span class="cm-quote">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#执行程序指数回退刷新的相关属性，是重试延迟的最大倍数值，默认为10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.cache-refresh-executor-exponential-back-off-bound</span>=<span class="cm-quote">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#执行程序缓存刷新线程池的大小，默认为5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.cache-refresh-executor-thread-pool-size</span>=<span class="cm-quote">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#心跳执行程序回退相关的属性，是重试延迟的最大倍数值，默认为10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.heartbeat-executor-exponential-back-off-bound</span>=<span class="cm-quote">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#心跳执行程序线程池的大小,默认为5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.heartbeat-executor-thread-pool-size</span>=<span class="cm-quote">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 询问Eureka服务url信息变化的频率（s），默认为300秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.eureka-service-url-poll-interval-seconds</span>=<span class="cm-quote">300</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#最初复制实例信息到eureka服务器所需的时间（s），默认为40秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.initial-instance-info-replication-interval-seconds</span>=<span class="cm-quote">40</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#间隔多长时间再次复制实例信息到eureka服务器，默认为30秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.instance-info-replication-interval-seconds</span>=<span class="cm-quote">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#从eureka服务器注册表中获取注册信息的时间间隔（s），默认为30秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.registry-fetch-interval-seconds</span>=<span class="cm-quote">30</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 获取实例所在的地区。默认为us-east-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.region</span>=<span class="cm-quote">us-east-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#实例是否使用同一zone里的eureka服务器，默认为true，理想状态下，eureka客户端与服务端是在同一zone下</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.prefer-same-zone-eureka</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 获取实例所在的地区下可用性的区域列表，用逗号隔开。（AWS）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.availability-zones.china</span>=<span class="cm-quote">defaultZone,defaultZone1,defaultZone2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka服务注册表信息里的以逗号隔开的地区名单，如果不这样返回这些地区名单，则客户端启动将会出错。默认为null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.fetch-remote-regions-registry</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#服务器是否能够重定向客户端请求到备份服务器。 如果设置为false，服务器将直接处理请求，如果设置为true，它可能发送HTTP重定向到客户端。默认为false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.allow-redirects</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#客户端数据接收</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.client-data-accept</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#增量信息是否可以提供给客户端看，默认为false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.disable-delta</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka服务器序列化/反序列化的信息中获取“_”符号的的替换字符串。默认为“__“</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.escape-char-replacement</span>=<span class="cm-quote">__</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#eureka服务器序列化/反序列化的信息中获取“$”符号的替换字符串。默认为“_-”</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.dollar-replacement</span>=<span class="cm-quote">"_-"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#当服务端支持压缩的情况下，是否支持从服务端获取的信息进行压缩。默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.g-zip-content</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#是否记录eureka服务器和客户端之间在注册表的信息方面的差异，默认为false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.log-delta-diff</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如果设置为true,客户端的状态更新将会点播更新到远程服务器上，默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.on-demand-update-status-change</span>=<span class="cm-quote">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#此客户端只对一个单一的VIP注册表的信息感兴趣。默认为null</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.registry-refresh-single-vip-address</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client是否在初始化阶段强行注册到服务中心，默认为false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.should-enforce-registration-at-init</span>=<span class="cm-quote">false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#client在shutdown的时候是否显示的注销服务从服务中心，默认为true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.client.should-unregister-on-shutdown</span>=<span class="cm-quote">true</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1576px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1576px;"></div></div></div></pre><p><span>Eureka Instance 常用配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#服务注册中心实例的主机名</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.hostname</span>=<span class="cm-quote">localhost</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#注册在Eureka服务中的应用组名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.app-group-name</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#注册在的Eureka服务中的应用名称</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.appname</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#该实例注册到服务中心的唯一ID</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.instance-id</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#该实例的IP地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.ip-address</span>=</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#该实例，相较于hostname是否优先使用IP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">eureka.instance.prefer-ip-address</span>=<span class="cm-quote">false</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h3 id='eureka集群原理'><span>Eureka集群原理</span></h3><p><img src="images/Middleware/Eureka集群原理.png" referrerpolicy="no-referrer" alt="Eureka集群原理"></p><ul><li><p><strong><span>Eureka Server集群相互之间通过 Replicate(复制) 来同步数据</span></strong></p><p><span>相互之间不区分主节点和从节点，所有的节点都是平等的。在这种架构中，节点通过彼此互相注册来提高可用性，每个节点需要添加一个或多个有效的 serviceUrl 指向其它节点。</span></p></li><li><p><strong><span>如果某台Eureka Server宕机，Eureka Client的请求会自动切换到新的Eureka Server节点</span></strong></p><p><span>当宕机的服务器重新恢复后，Eureka 会再次将其纳入到服务器集群管理之中。当节点开始接受客户端请求时，所有的操作都会进行节点间复制，将请求复制到其它 Eureka Server 所知的所有节点中。</span></p></li><li><p><strong><span>Eureka Server的同步遵循一个原则：只要有一条边将节点连接，就可以进行信息传播与同步</span></strong></p><p><span>如果存在多个节点，只需要将节点之间两两连接起来形成通路，那么其它注册中心都可以共享信息。每个 Eureka Server 同时也是 Eureka Client，多个 Eureka Server 之间通过 P2P 的方式完成服务注册表的同步。</span></p></li><li><p><strong><span>Eureka Server集群之间的状态是采用异步方式同步的</span></strong></p><p><span>所以不保证节点间的状态一定是一致的，不过基本能保证最终状态是一致的。</span></p></li></ul><p>&nbsp;</p><p><strong><span>Eureka 分区</span></strong>
<span>Eureka 提供了 Region 和 Zone 两个概念来进行分区，这两个概念均来自于亚马逊的 AWS:</span></p><ul><li><strong><span>region</span></strong><span>：可以理解为地理上的不同区域，比如亚洲地区，中国区或者深圳等等。没有具体大小的限制。根据项目具体的情况，可以自行合理划分 region</span></li><li><strong><span>zone</span></strong><span>：可以简单理解为 region 内的具体机房，比如说 region 划分为深圳，然后深圳有两个机房，就可以在此 region 之下划分出 zone1、zone2 两个 zone</span></li></ul><p><span>上图中的 us-east-1c、us-east-1d、us-east-1e 就代表了不同的 Zone。Zone 内的 Eureka Client 优先和 Zone 内的 Eureka Server 进行心跳同步，同样调用端优先在 Zone 内的 Eureka Server 获取服务列表，当 Zone 内的 Eureka Server 挂掉之后，才会从别的 Zone 中获取信息。</span></p><p>&nbsp;</p><p><strong><span>Eurka 保证 AP</span></strong></p><p><span>Eureka Server 各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而 Eureka Client 在向某个 Eureka 注册时，如果发现连接失败，则会自动切换至其它节点。只要有一台 Eureka Server 还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的(不保证强一致性)。</span></p><p>&nbsp;</p><h3 id='eureka一致性协议'><span>Eureka一致性协议</span></h3><p><span>Eureka 和 Zookeeper 的最大区别： Eureka 是 AP 模型，Zookeeper 是 CP 模型。在出现脑裂等场景时，Eureka 可用性是每一位，也就是说出现脑裂时，每个分区仍可以独立提供服务，是去中心化的。那Eureka是如何实现最终一致性的呢？</span></p><p>&nbsp;</p><h4 id='消息广播'><span>消息广播</span></h4><ol start='' ><li><p><span>Eureka Server 管理了全部的服务器列表（PeerEurekaNodes）</span></p></li><li><p><span>当 Eureka Server 收到客户端的注册、下线、心跳请求时，通过 PeerEurekaNode 向其余的服务器进行消息广播，如果广播失败则重试，直到任务过期后取消任务，此时这两台服务器之间数据会出现短暂的不一致。</span></p><p><strong><span>注意：</span></strong><span> 虽然消息广播失败，但只要收到客户端的心跳，仍会向所有的服务器（包括失联的服务器）广播心跳任务。</span></p></li><li><p><span>如果网络恢复正常，收到了其它服务器广播的心跳任务，此时可能有三种情况：</span></p><ol start='' ><li><span>一是脑裂很快恢复，一切正常；</span></li><li><span>二是该实例已经自动过期，则重新进行注册；</span></li><li><span>三是数据冲突，出现不一致的情况，则需要发起同步请求，其实也就是重新注册一次，同时踢除老的实例。</span></li></ol><p><span>总之，通过集群之间的消息广播可以实现数据的最终一致性。</span></p></li></ol><p>&nbsp;</p><p><strong><span>服务注册</span></strong></p><ol start='' ><li><span>Spring Cloud Eureka 在应用启动时，会在 EurekaAutoServiceRegistration 这个类初始化的时候，主动去 Eureka Server 端注册。</span></li><li><span>Eureka 在启动完成之后会启动一个 40 秒执行一次的定时任务，该任务会去监测自身的 IP 信息以及自身的配置信息是否发生改变，如果发生改变，则会重新发起注册。</span></li><li><span>续约返回 404 状态码时，会去重新注册</span></li></ol><p>&nbsp;</p><p><strong><span>主动下线</span></strong></p><p><span>Eureka 会在 spring 容器销毁的时候执行 shutDown 方法 ，该方法首先会将自身的状态改为 DOWN，接着发送cancle 命令至 Eureka Server 请求下掉自己的服务。</span></p><p>&nbsp;</p><p><strong><span>心跳续约与自动下线</span></strong></p><p><span>健康检测，一般都是 TTL(Time To Live) 机制。eg: 客户端每 5s 发送心跳，服务端 15s 没收到心跳包，更新实例状态为不健康， 30s 未收到心跳包，从服务列表中删除。</span><strong><span>Eureka Server 默认每 30s 发送心跳包，90s 未收心跳则删除。这个清理过期实例的线程，每 60s 执行一次。</span></strong></p><p>&nbsp;</p><h4 id='崩溃恢复'><span>崩溃恢复</span></h4><p><strong><span>重启</span></strong></p><p><span>Spring Cloud Eureka 启动时，在初始化 EurekaServerBootstrap#initEurekaServerContext 时会调用 PeerAwareInstanceRegistryImpl#syncUp 从其它 Eureka 中同步数据。</span></p><p>&nbsp;</p><p><strong><span>脑裂</span></strong></p><ul><li><span>发生脑裂后：和 Eureka Server 同区的服务可以正常访问，而不同区的服务则自动过期。</span></li><li><span>脑裂恢复后：接收其它 Eureka Sever 发送过来的心跳请求，此时有三种情况：一是脑裂很快恢复，一切正常；二是该实例已经自动过期，则重新进行注册；三是数据冲突，出现不一致的情况，则需要发起同步请求。</span></li></ul><p>&nbsp;</p><h2 id='zuul'><span>Zuul</span></h2><p><span>Zuul 是由 Netflix 孵化的一个致力于“网关 “解决方案的开源组件。</span></p><p><img src="images/Middleware/Zuul介绍.png" referrerpolicy="no-referrer" alt="Zuul介绍"></p><p><strong><span>网关的作用</span></strong></p><ul><li><span>统一入口：未全部为服务提供一个唯一的入口，网关起到外部和内部隔离的作用，保障了后台服务的安全性</span></li><li><span>鉴权校验：识别每个请求的权限，拒绝不符合要求的请求</span></li><li><span>动态路由：动态的将请求路由到不同的后端集群中</span></li><li><span>减少客户端与服务端的耦合：服务可以独立发展，通过网关层来做映射</span></li></ul><p><img src="images/Middleware/zuul过滤器的生命周期.png" referrerpolicy="no-referrer" alt="zuul过滤器的生命周期"></p><p><img src="images/Middleware/zuul限流参数.png" referrerpolicy="no-referrer" alt="zuul限流参数"></p><p><img src="images/Middleware/Zuul.png" referrerpolicy="no-referrer" alt="Zuul"></p><p>&nbsp;</p><h2 id='feign'><span>Feign</span></h2><p><code>Feign</code><span> 使用时分成两步：一是生成 Feign 的动态代理；二是 Feign 执行。</span></p><p><img src="images/Middleware/Feign整体设计.png" referrerpolicy="no-referrer" alt="Feign整体设计"></p><p><strong><span>总结：</span></strong></p><ul><li><span>前两步是生成动态对象：将 Method 方法的注解解析成 MethodMetadata，并最终生成 Feign 动态代理对象</span></li><li><span>后几步是调用过程：根据解析的MethodMetadata对象，将Method方法的参数转换成Request，最后调用Client发送请求</span></li></ul><p>&nbsp;</p><h3 id='feign动态代理'><span>Feign动态代理</span></h3><p><img src="images/Middleware/Feign动态代理.png" referrerpolicy="no-referrer" alt="Feign动态代理"></p><p><code>Feign</code><span> 的默认实现是 ReflectiveFeign，通过 Feign.Builder 构建。</span><strong><span>总结</span></strong><span> </span></p><ol start='' ><li><span>Contract 统一将方法解析 MethodMetadata(*)，这样就可以通过实现不同的 Contract 适配各种 REST 声明式规范。</span></li><li><span>buildTemplate 实际上将 Method 方法的参数转换成 Request。</span></li><li><span>将 metadata 和 buildTemplate 封装成 MethodHandler。</span></li></ol><p>&nbsp;</p><h3 id='基于feign实现负载均衡'><span>基于Feign实现负载均衡</span></h3><p><span>基于 Feign 的负载均衡（整合 Ribbon）。想要进行负载均衡，那就要对 Client 进行包装，实现负载均衡。 相关代码见</span><code>RibbonClient</code><span>和</span><code>LBClient</code><span>。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// RibbonClient 主要逻辑</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Client</span> <span class="cm-variable">delegate</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">LBClientFactory</span> <span class="cm-variable">lbClientFactory</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable">Response</span> <span class="cm-def">execute</span>(<span class="cm-variable">Request</span> <span class="cm-variable">request</span>, <span class="cm-variable">Request</span>.<span class="cm-variable">Options</span> <span class="cm-variable">options</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">URI</span> <span class="cm-variable">asUri</span> <span class="cm-operator">=</span> <span class="cm-variable">URI</span>.<span class="cm-variable">create</span>(<span class="cm-variable">request</span>.<span class="cm-variable">url</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">clientName</span> <span class="cm-operator">=</span> <span class="cm-variable">asUri</span>.<span class="cm-variable">getHost</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">URI</span> <span class="cm-variable">uriWithoutHost</span> <span class="cm-operator">=</span> <span class="cm-variable">cleanUrl</span>(<span class="cm-variable">request</span>.<span class="cm-variable">url</span>(), <span class="cm-variable">clientName</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 封装 RibbonRequest，包含 Client、Request、uri</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">LBClient</span>.<span class="cm-variable">RibbonRequest</span> <span class="cm-variable">ribbonRequest</span> <span class="cm-operator">=</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">LBClient</span>.<span class="cm-variable">RibbonRequest</span>(<span class="cm-variable">delegate</span>, <span class="cm-variable">request</span>, <span class="cm-variable">uriWithoutHost</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// executeWithLoadBalancer 实现负载均衡</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">lbClient</span>(<span class="cm-variable">clientName</span>).<span class="cm-variable">executeWithLoadBalancer</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ribbonRequest</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">FeignOptionsClientConfig</span>(<span class="cm-variable">options</span>)).<span class="cm-variable">toResponse</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">ClientException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">propagateFirstIOException</span>(<span class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">RuntimeException</span>(<span class="cm-variable">e</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 475px;"></div><div class="CodeMirror-gutters" style="display: none; height: 475px;"></div></div></div></pre><p><strong><span>总结：</span></strong><span> 实际上是把 Client 对象包装了一下，通过 executeWithLoadBalancer 进行负载均衡，这是 Ribbon 提供了 API。更多关于 Ribbon 的负载均衡就不在这进一步说明了。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-keyword">class</span> <span class="cm-def">LBClient</span> <span class="cm-keyword">extends</span> <span class="cm-variable">AbstractLoadBalancerAwareClient</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">&lt;</span><span class="cm-variable">LBClient</span>.<span class="cm-variable">RibbonRequest</span>, <span class="cm-variable">LBClient</span>.<span class="cm-variable">RibbonResponse</span><span class="cm-operator">&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// executeWithLoadBalancer 方法通过负载均衡算法后，最终调用 execute</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">RibbonResponse</span> <span class="cm-variable">execute</span>(<span class="cm-variable">RibbonRequest</span> <span class="cm-variable">request</span>, <span class="cm-variable">IClientConfig</span> <span class="cm-variable">configOverride</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>, <span class="cm-variable">ClientException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Request</span>.<span class="cm-variable">Options</span> <span class="cm-variable">options</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">configOverride</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">options</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Request</span>.<span class="cm-variable">Options</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">configOverride</span>.<span class="cm-variable">get</span>(<span class="cm-variable">CommonClientConfigKey</span>.<span class="cm-variable">ConnectTimeout</span>, <span class="cm-variable">connectTimeout</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">configOverride</span>.<span class="cm-variable">get</span>(<span class="cm-variable">CommonClientConfigKey</span>.<span class="cm-variable">ReadTimeout</span>, <span class="cm-variable">readTimeout</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">configOverride</span>.<span class="cm-variable">get</span>(<span class="cm-variable">CommonClientConfigKey</span>.<span class="cm-variable">FollowRedirects</span>, <span class="cm-variable">followRedirects</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">options</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Request</span>.<span class="cm-variable">Options</span>(<span class="cm-variable">connectTimeout</span>, <span class="cm-variable">readTimeout</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// http 请求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Response</span> <span class="cm-variable">response</span> <span class="cm-operator">=</span> <span class="cm-variable">request</span>.<span class="cm-variable">client</span>().<span class="cm-variable">execute</span>(<span class="cm-variable">request</span>.<span class="cm-variable">toRequest</span>(), <span class="cm-variable">options</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">retryableStatusCodes</span>.<span class="cm-variable">contains</span>(<span class="cm-variable">response</span>.<span class="cm-variable">status</span>())) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">response</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">ClientException</span>(<span class="cm-variable">ClientException</span>.<span class="cm-variable">ErrorType</span>.<span class="cm-variable">SERVER_THROTTLED</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">RibbonResponse</span>(<span class="cm-variable">request</span>.<span class="cm-variable">getUri</span>(), <span class="cm-variable">response</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 734px;"></div><div class="CodeMirror-gutters" style="display: none; height: 734px;"></div></div></div></pre><p>&nbsp;</p><h3 id='基于feign实现熔断'><span>基于Feign实现熔断</span></h3><p><span>基于 Feign 的熔断与限流（整合 Hystrix）。想要进行限流，那就要在方法执行前进行拦截，也就是重写InvocationHandlerFactory，在方法执行前进行熔断与限流。相关代码见 </span><code>HystrixFeign</code><span>，其实也就是实现了 HystrixInvocationHandler。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// HystrixInvocationHandler 主要逻辑</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">Object</span> <span class="cm-def">invoke</span>(<span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">proxy</span>, <span class="cm-keyword">final</span> <span class="cm-variable">Method</span> <span class="cm-variable">method</span>, <span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span>[] <span class="cm-variable">args</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">Throwable</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">HystrixCommand</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span> <span class="cm-variable">hystrixCommand</span> <span class="cm-operator">=</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">HystrixCommand</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Object</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">setterMethodMap</span>.<span class="cm-variable">get</span>(<span class="cm-variable">method</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">run</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">HystrixInvocationHandler</span>.<span class="cm-keyword">this</span>.<span class="cm-variable">dispatch</span>.<span class="cm-variable">get</span>(<span class="cm-variable">method</span>).<span class="cm-variable">invoke</span>(<span class="cm-variable">args</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">getFallback</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">return</span> <span class="cm-variable">hystrixCommand</span>.<span class="cm-variable">execute</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 389px;"></div><div class="CodeMirror-gutters" style="display: none; height: 389px;"></div></div></div></pre><p>&nbsp;</p><h3 id='feign参数编码整体流程'><span>Feign参数编码整体流程</span></h3><p><img src="images/Middleware/Feign参数编码整体流程.png" referrerpolicy="no-referrer" alt="Feign参数编码整体流程"><strong><span>总结：</span></strong><span> </span></p><ul><li><span>前两步是</span><code>Feign</code><span>代理生成阶段，解析方法参数及注解元信息。后三步是调用阶段，将方法参数编码成Http请求的数据格式</span></li><li><span>Contract 接口将 UserService 中每个接口中的方法及其注解解析为 MethodMetadata，然后使用 RequestTemplate# request 编码为一个 Request</span></li><li><span>RequestTemplate#request 编码为一个 Request 后就可以调用 Client#execute 发送 Http 请求</span></li><li><span>Client 的具体实现有 HttpURLConnection、Apache HttpComponnets、OkHttp3 、Netty 等。本文关注前三步：即 Feign 方法元信息解析及参数编码过程。</span></li></ul><p>&nbsp;</p><h3 id='feign整体装配流程'><span>Feign整体装配流程</span></h3><p><img src="images/Middleware/Feign整体装配流程.png" referrerpolicy="no-referrer" alt="Feign整体装配流程"></p><p><strong><span>总结：</span></strong><span> OpenFeign 装配有两个入口：</span></p><ol start='' ><li><p><span>@EnableAutoConfiguration 自动装配（spring.factories）</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="properties"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="properties"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="cm-quote">\</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.cloud.openfeign.ribbon.FeignRibbonClientAutoConfiguration,\</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-quote">org.springframework.cloud.openfeign.FeignAutoConfiguration</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><ul><li><p><span>FeignAutoConfiguration自动装配 FeignContext 和 Targeter，以及 Client 配置。</span></p><ul><li><code>FeignContext</code><span> 是每个 FeignClient 的装配上下文，默认的配置是 FeignClientsConfiguration</span></li><li><code>Targeter</code><span> 有两种实现：一是 DefaultTargeter，直接调用 Feign.Builder； </span><strong><span>二是 HystrixTargeter，调用 HystrixFeign.Builder，开启熔断。</span></strong></li><li><code>Client</code><span> ：自动装配 ApacheHttpClient，OkHttpClient，装配条件不满足，默认是 Client.Default。但这些 Client 都没有实现负载均衡。</span></li></ul></li><li><p><span>FeignRibbonClientAutoConfiguration实现负载均衡，负载均衡是在 Client 这一层实现的。</span></p><ul><li><code>HttpClientFeignLoadBalancedConfiguration</code><span> ApacheHttpClient 实现负载均衡</span></li><li><code>OkHttpFeignLoadBalancedConfiguration</code><span> OkHttpClient实现负载均衡</span></li><li><code>DefaultFeignLoadBalancedConfiguration</code><span> Client.Default实现负载均衡</span></li></ul></li></ul></li><li><p><span>@EnableFeignClients 自动扫描</span></p><p><span>@EnableFeignClients 注入 FeignClientsRegistrar，FeignClientsRegistrar 开启自动扫描，将包下 @FeignClient 标注的接口包装成 FeignClientFactoryBean 对象，最终通过 Feign.Builder 生成该接口的代理对象。而 Feign.Builder 的默认配置是 FeignClientsConfiguration，是在 FeignAutoConfiguration 自动注入的。</span></p></li></ol><p><strong><span>注意：</span></strong><span> 熔断与限流是 FeignAutoConfiguration 通过注入 HystrixTargeter 完成的，而负载均衡是FeignRibbonClientAutoConfiguration 注入的。</span></p><p>&nbsp;</p><h3 id='其它'><span>其它</span></h3><p><span>Feign是是一个声明式的Web Service客户端。</span></p><p><img src="images/Middleware/Feign介绍.png" referrerpolicy="no-referrer" alt="Feign介绍"></p><p><span>Feign就是使用了动态代理：</span></p><ul><li><span>首先，如果你对某个接口定义了@FeignClient注解，Feign就会针对这个接口创建一个动态代理</span></li><li><span>接着你要是调用那个接口，本质就是会调用 Feign创建的动态代理，这是核心中的核心</span></li><li><span>Feign的动态代理会根据你在接口上的@RequestMapping等注解，来动态构造出你要请求的服务的地址</span></li><li><span>最后针对这个地址，发起请求、解析响应</span></li></ul><p><img src="images/Middleware/Feign.png" referrerpolicy="no-referrer" alt="Feign"></p><p><img src="images/Middleware/Feign远程调用流程.png" referrerpolicy="no-referrer" alt="Feign远程调用流程"></p><p>&nbsp;</p><h2 id='ribbon'><span>Ribbon</span></h2><p><span>Ribbon Netflix 公司开源的一个负载均衡的组件。</span></p><p><img src="images/Middleware/Ribbon介绍.png" referrerpolicy="no-referrer" alt="Ribbon介绍"></p><p><span>Ribbon在服务消费者端配置和使用，它的作用就是负载均衡，然后默认使用的负载均衡算法是轮询算法，Ribbon会从Eureka服务端中获取到对应的服务注册表，然后就知道相应服务的位置，然后Ribbon根据设计的负载均衡算法去选择一台机器，Feigin就会针对这些机器构造并发送请求，如下图所示：</span></p><p><img src="images/Middleware/Ribbon.png" referrerpolicy="no-referrer" alt="Ribbon"></p><p><img src="images/Middleware/Ribbon规则.png" referrerpolicy="no-referrer" alt="Ribbon规则"></p><p>&nbsp;</p><h2 id='hystrix'><span>Hystrix</span></h2><p><span>Hystrix是Netstflix 公司开源的一个项目，它提供了熔断器功能，能够阻止分布式系统中出现联动故障。</span></p><p><img src="images/Middleware/Hystrix介绍.png" referrerpolicy="no-referrer" alt="Hystrix介绍"></p><p><span>Hystrix是隔离、熔断以及降级的一个框架，说白了就是Hystrix会搞很多小线程池然后让这些小线程池去请求服务，返回结果，Hystrix相当于是个中间过滤区，如果我们的积分服务挂了，那我们请求积分服务直接就返回了，不需要等待超时时间结束抛出异常，这就是所谓的熔断，但是也不能啥都不干就返回啊，不然我们之后手动加积分咋整啊，那我们每次调用积分服务就在数据库里记录一条消息，这就是所谓的降级，Hystrix隔离、熔断和降级的全流程如下：</span></p><p><img src="images/Middleware/Hystrix.png" referrerpolicy="no-referrer" alt="Hystrix"></p><p><img src="images/Middleware/Hystrix熔断.png" referrerpolicy="no-referrer" alt="Hystrix熔断"></p><p>&nbsp;</p><h2 id='gateway'><span>Gateway</span></h2><p><span>Spring Cloud Gateway 是 Spring 官方基于 Spring 5.0、 Spring Boot 2.0 和 Project Reactor 等技术开发的网关， Spring Cloud Gateway 旨在为微服务架构提供简单、 有效且统一的 API 路由管理方式。</span></p><p><img src="images/Middleware/Gateway介绍.png" referrerpolicy="no-referrer" alt="Gateway介绍"></p><p>&nbsp;</p><h2 id='config'><span>Config</span></h2><p><span>Spring Cloud 中提供了分布式配置中 Spring Cloud Config ，为外部配置提供了客户端和服务器端的支持。</span></p><p><img src="images/Middleware/Config介绍.png" referrerpolicy="no-referrer" alt="Config介绍"></p><p>&nbsp;</p><h2 id='bus'><span>Bus</span></h2><p><span>使用 Spring Cloud Bus, 可以非常容易地搭建起消息总线。</span></p><p><img src="images/Middleware/Bus介绍.png" referrerpolicy="no-referrer" alt="Bus介绍"></p><p>&nbsp;</p><h2 id='oauth2'><span>OAuth2</span></h2><p><span>Sprin Cloud 构建的微服务系统中可以使用 Spring Cloud OAuth2 来保护微服务系统。</span></p><p><img src="images/Middleware/OAuth2介绍.png" referrerpolicy="no-referrer" alt="OAuth2介绍"></p><p>&nbsp;</p><h2 id='sleuth'><span>Sleuth</span></h2><p><span>Spring Cloud Sleuth是Spring Cloud 个组件，它的主要功能是在分布式系统中提供服务链路追踪的解决方案。</span></p><p><img src="images/Middleware/Sleuth介绍.png" referrerpolicy="no-referrer" alt="Sleuth介绍"></p><p>&nbsp;</p><h1 id='mybatis'><span>MyBatis</span></h1><p><span>Mybatis是一个半ORM（对象关系映射）框架，它内部封装了JDBC，加载驱动、创建连接、创建statement等繁杂的过程，开发者开发时只需要关注如何编写SQL语句，可以严格控制sql执行性能，灵活度高。</span></p><p><span>作为一个半ORM框架，MyBatis 可以使用 XML 或注解来配置和映射原生信息，将 POJO映射成数据库中的记录，避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。</span></p><p><span>通过xml 文件或注解的方式将要执行的各种 statement 配置起来，并通过java对象和 statement中sql的动态参数进行映射生成最终执行的sql语句，最后由mybatis框架执行sql并将结果映射为java对象并返回。（从执行sql到返回result的过程）。</span></p><p><span>由于MyBatis专注于SQL本身，灵活度高，所以比较适合对性能的要求很高，或者需求变化较多的项目，如互联网项目。</span></p><p>&nbsp;</p><p><strong><span>Mybaits优缺点</span></strong></p><ul><li><p><span>优点</span></p><ul><li><span>基于SQL语句编程，相当灵活，不会对应用程序或者数据库的现有设计造成任何影响，SQL写在XML里，解除sql与程序代码的耦合，便于统一管理；提供XML标签，支持编写动态SQL语句，并可重用</span></li><li><span>与JDBC相比，减少了50%以上的代码量，消除了JDBC大量冗余的代码，不需要手动开关连接</span></li><li><span>很好的与各种数据库兼容（因为MyBatis使用JDBC来连接数据库，所以只要JDBC支持的数据库MyBatis都支持）</span></li><li><span>能够与Spring很好的集成</span></li><li><span>提供映射标签，支持对象与数据库的ORM字段关系映射；提供对象关系映射标签，支持对象关系组件维护</span></li></ul></li><li><p><span>缺点</span></p></li><li><p><span>SQL语句的编写工作量较大，尤其当字段多、关联表多时，对开发人员编写SQL语句的功底有一定要求</span></p></li><li><p><span>SQL语句依赖于数据库，导致数据库移植性差，不能随意更换数据库</span></p></li></ul><p>&nbsp;</p><p><strong><span>#{}和${}的区别是什么？</span></strong></p><ul><li><code>${}</code><span> 是字符串替换</span></li><li><code>#{}</code><span> 是预处理</span></li></ul><p><span>使用#{}可以有效的防止SQL注入，提高系统安全性。</span></p><h2 id='mybatis架构'><span>MyBatis架构</span></h2><p><img src="images/Middleware/Mybatis核心成员数据流.png" referrerpolicy="no-referrer" alt="Mybatis核心成员数据流"></p><p><span>核心成员说明</span></p><figure><table><thead><tr><th><span>核心成员</span></th><th><span>功能说明</span></th></tr></thead><tbody><tr><td><span>Configuration</span></td><td><span>保存MyBatis大部分配置信息</span></td></tr><tr><td><span>SqlSession</span></td><td><span>MyBatis主要的顶层API，与数据库交互，实现数据库增删改查功能</span></td></tr><tr><td><span>Executor</span></td><td><span>MyBatis 调度器，负责SQL语句的生成和查询缓存的维护</span></td></tr><tr><td><span>StatementHandler</span></td><td><span>封装JDBC，负责对JDBC statement 的操作，如设置参数等</span></td></tr><tr><td><span>ParameterHandler</span></td><td><span>用户传递的参数转换成JDBC Statement 所对应的数据类型</span></td></tr><tr><td><span>ResultSetHandler</span></td><td><span>负责将JDBC返回的ResultSet结果集对象转换成List类型的集合</span></td></tr><tr><td><span>TypeHandler</span></td><td><span>负责java数据类型和jdbc数据类型(也可以说是数据表列类型)之间的映射和转换</span></td></tr><tr><td><span>MappedStatement</span></td><td><span>MappedStatement维护一条&lt;select</span><span>|</span><span>update</span><span>|</span><span>delete</span><span>|</span><span>insert&gt;节点的封装</span></td></tr><tr><td><span>SqlSource</span></td><td><span>负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回</span></td></tr><tr><td><span>BoundSql</span></td><td><span>表示动态生成的SQL语句以及相应的参数信息</span></td></tr></tbody></table></figure><p>&nbsp;</p><h2 id='mybatis流程'><span>MyBatis流程</span></h2><p><img src="images/Middleware/Mybatis流程.png" referrerpolicy="no-referrer" alt="Mybatis流程"></p><p>&nbsp;</p><h2 id='dao接口工作原理'><span>Dao接口工作原理</span></h2><p><span>Mapper 接口的工作原理是JDK动态代理，Mybatis运行时会使用JDK动态代理为Mapper接口生成代理对象proxy，代理对象会拦截接口方法，根据类的全限定名+方法名，唯一定位到一个MapperStatement并调用执行器执行所代表的sql，然后将sql执行结果返回。</span></p><p><span>Mapper接口里的方法，是不能重载的，因为是使用 全限名+方法名 的保存和寻找策略。</span></p><p>&nbsp;</p><h2 id='mybatis缓存'><span>MyBatis缓存</span></h2><p><span>MyBatis 中有一级缓存和二级缓存，默认情况下一级缓存是开启的，而且是不能关闭的。一级缓存是指 SqlSession 级别的缓存，当在同一个 SqlSession 中进行相同的 SQL 语句查询时，第二次以后的查询不会从数据库查询，而是直接从缓存中获取，一级缓存最多缓存 1024 条 SQL。二级缓存是指可以跨 SqlSession 的缓存。是 mapper 级别的缓存，对于mapper级别的缓存不同的sqlsession 是可以共享的。一级缓存核心类是PerpetualCache，本质是一个hashMap。二级缓存默认不开启。</span></p><p><img src="images/Middleware/MyBatis缓存机制.png" referrerpolicy="no-referrer" alt="MyBatis缓存机制"></p><h3 id='一级缓存'><span>一级缓存</span></h3><p><span>Mybatis的一级缓存原理(sqlsession级别)。第一次发出一个查询 sql，sql 查询结果写入 sqlsession 的一级缓存中，缓存使用的数据结构是一个 map。</span></p><ul><li><span>key：MapperID+offset+limit+Sql+所有的入参</span></li><li><span>value：用户信息</span></li></ul><p><span>同一个 sqlsession 再次发出相同的 sql，就从缓存中取出数据。如果两次中间出现 commit 操作（修改、添加、删除），本 sqlsession 中的一级缓存区域全部清空，下次再去缓存中查询不到所以要从数据库查询，从数据库查询到再写入缓存。</span></p><p>&nbsp;</p><h3 id='二级缓存'><span>二级缓存</span></h3><p><span>二级缓存的范围是 mapper 级别（mapper 同一个命名空间），mapper 以命名空间为单位创建缓存数据结构，结构是 map。mybatis 的二级缓存是通过 CacheExecutor 实现的。CacheExecutor其实是 Executor 的代理对象。所有的查询操作，在 CacheExecutor 中都会先匹配缓存中是否存在，不存在则查询数据库。</span></p><ul><li><span>key：MapperID+offset+limit+Sql+所有的入参</span></li></ul><p><strong><span>具体使用需要配置：</span></strong></p><ul><li><span>Mybatis 全局配置中启用二级缓存配置</span></li><li><span>在对应的 Mapper.xml 中配置 cache 节点</span></li><li><span>在对应的 select 查询节点中添加 useCache=true</span></li></ul><p>&nbsp;</p><h2 id='mybatis主要组件'><span>MyBatis主要组件</span></h2><p><img src="images/Middleware/MyBatis执行sql流程.png" referrerpolicy="no-referrer" alt="MyBatis执行sql流程"></p><h3 id='sqlsessionfactorybuilder'><span>SqlSessionFactoryBuilder</span></h3><p><span>从名称长可以看出来使用的建造者设计模式（Builder），用于构建SqlSessionFactory对象：</span></p><ul><li><span>解析mybatis的xml配置文件，然后创建Configuration对象（对应</span><configuration><span>标签）</span></li><li><span>根据创建的Configuration对象，创建SqlSessionFactory（默认使用DefaultSqlSessionFactory）</span></li></ul><p>&nbsp;</p><h3 id='sqlsessionfactory'><span>SqlSessionFactory</span></h3><p><span>从名称上可以看出使用的工厂模式（Factory），用于创建并初始化SqlSession对象（数据库会话）</span></p><ul><li><span>调用openSession方法，创建SqlSession对象，可以将SqlSession理解为数据库连接（会话）</span></li><li><span>openSession方法有多个重载，可以创建SqlSession关闭自动提交、指定ExecutorType、指定数据库事务隔离级别</span></li></ul><p>&nbsp;</p><h3 id='sqlsession'><span>SqlSession</span></h3><p><span>如果了解web开发，就应该知道cookie和session吧，SqlSession的session和web开发中的session概念类似。session，译为“会话、会议”，数据的有效时间范围是在会话期间（会议期间），会话（会议）结束后，数据就清除了。也可以将SqlSession理解为一个数据库连接（但也不完全正确，因为创建SqlSession之后，如果不执行sql，那么这个连接是无意义的，所以数据库连接在执行sql的时候才建立的）。</span></p><p><span>SqlSession只是定义了执行sql的一些方法，而具体的实现由子类来完成，比如SqlSession有一个接口实现类DefaultSqlSession。MyBatis中通过Executor来执行sql的，在创建SqlSession的时候（openSession），同时会创建一个Executor对象。</span></p><p>&nbsp;</p><h3 id='executor'><span>Executor</span></h3><p><span>Executor（人称“执行器”）是一个接口，定义了对JDBC的封装。MyBatis中提供了多种执行器，如下：</span></p><p><img src="images/Middleware/MyBatis-Executor.png" referrerpolicy="no-referrer" alt="MyBatis-Executor"><span>CacheExecutor其实是一个Executor代理类，包含一个delegate，需要创建时手动传入（要入simple、reuse、batch三者之一)。ClosedExecutor，所有接口都会抛出异常，表示一个已经关闭的Executor。创建SqlSession时，默认使用的是SimpleExecutor。</span></p><p><span>Executor是对JDBC的封装。当我们使用JDBC来执行sql时，一般会先预处理sql，也就是conn.prepareStatement(sql)，获取返回的PreparedStatement对象（实现了Statement接口），再调用statement的executeXxx()来执行sql。也就是说，Executor在执行sql的时候也是需要创建Statement对象的。</span></p><p>&nbsp;</p><h3 id='statementhandler'><span>StatementHandler</span></h3><p><span>在JDBC中，是调用Statement.executeXxx()来执行sql。在MyBatis，也是调用Statement.executeXxx()来执行sql，此时就不得不提StatementHandler，可以将其理解为一个工人，他的工作包括</span></p><ul><li><span>对sql进行预处理</span></li><li><span>调用statement.executeXxx()执行sql</span></li><li><span>将数据库返回的结果集进行对象转换（ORM）</span></li></ul><p>&nbsp;</p><h3 id='parameterhandler'><span>ParameterHandler</span></h3><p><span>　ParameterHandler的功能就是sql预处理后，进行设置参数。ParamterHandler有一个DefaultParameterHandler。</span></p><p>&nbsp;</p><h3 id='resultsethandler'><span>ResultSetHandler</span></h3><p><span>当执行statement.execute()后，就可以通过statement.getResultSet()来获取结果集，获取到结果集之后，MyBatis会使用ResultSetHandler来将结果集的数据转换为Java对象（ORM映射）。ResultSetHandler有一个实现类，DefaultResultHandler，其重写handlerResultSets方法。</span></p><p>&nbsp;</p><h3 id='typehandler'><span>TypeHandler</span></h3><p><span>TypeHandler主要用在两个地方：</span></p><ul><li><p><span>参数绑定，发生在ParameterHandler.setParamenters()中</span></p><p><span>MyBatis中，可以使用</span><resultMap><span>来定义结果的映射关系，包括每一个字段的类型。TypeHandler可以对某个字段按照xml中配置的类型进行设置值，比如设置sql的uid参数时，类型为INTEGER（jdbcType）</span></p></li><li><p><span>获取结果集中的字段值，发生在ResultSetHandler处理结果集的过程中</span></p></li></ul><p>&nbsp;</p><h1 id='nginx'><span>Nginx</span></h1><h2 id='nginx安装'><span>Nginx安装</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># CentOS</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">yum install nginx;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Ubuntu</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sudo</span> apt-get install nginx;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Mac</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">brew install nginx;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p><span>安装完成后，通过 </span><code>rpm \-ql nginx</code><span> 命令查看 </span><code>Nginx</code><span> 的安装信息：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Nginx配置文件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/nginx/nginx.conf <span class="cm-comment"># nginx 主配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/nginx/nginx.conf.default</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可执行程序文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/bin/nginx-upgrade</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/sbin/nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># nginx库文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/lib/systemd/system/nginx.service <span class="cm-comment"># 用于配置系统守护进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/lib64/nginx/modules <span class="cm-comment"># Nginx模块目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 帮助文档</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/doc/nginx-1.16.1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/doc/nginx-1.16.1/CHANGES</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/doc/nginx-1.16.1/README</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/doc/nginx-1.16.1/README.dynamic</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/doc/nginx-1.16.1/UPGRADE-NOTES-1.6-to-1.10</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 静态资源目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/nginx/html/404.html</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/nginx/html/50x.html</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/share/nginx/html/index.html</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 存放Nginx日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/var/log/nginx</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 561px;"></div><div class="CodeMirror-gutters" style="display: none; height: 561px;"></div></div></div></pre><p><span>主要关注的文件夹有两个：</span></p><ul><li><code>/etc/nginx/conf.d/</code><span> 是子配置项存放处， </span><code>/etc/nginx/nginx.conf</code><span> 主配置文件会默认把该文件夹中所有子配置项都引入</span></li><li><code>/usr/share/nginx/html/</code><span> 静态文件都放在这个文件夹，也可以根据你自己的习惯放在其他地方</span></li></ul><p>&nbsp;</p><h2 id='运维命令-2'><span>运维命令</span></h2><p><span>一般可以在 </span><code>/etc/nginx/nginx.conf</code><span> 中配置。</span></p><h3 id='systemctl命令'><span>systemctl命令</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开机配置</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开机自动启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl enable nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭开机自动启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl disable nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动Nginx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl <span class="cm-builtin">start</span> nginx <span class="cm-comment"># 启动Nginx成功后，可以直接访问主机IP，此时会展示Nginx默认页面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 停止Nginx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl <span class="cm-builtin">stop</span> nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重启Nginx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl <span class="cm-builtin">restart</span> nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重新加载Nginx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl reload nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看 Nginx 运行状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">systemctl status nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看Nginx进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">ps</span> <span class="cm-attribute">-ef</span> | <span class="cm-builtin">grep</span> nginx</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 杀死Nginx进程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">kill</span> <span class="cm-attribute">-9</span> pid <span class="cm-comment"># 根据上面查看到的Nginx进程号，杀死Nginx进程，-9 表示强制结束进程</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 497px;"></div><div class="CodeMirror-gutters" style="display: none; height: 497px;"></div></div></div></pre><p>&nbsp;</p><h3 id='nginx应用命令'><span>Nginx应用命令</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-s</span> <span class="cm-builtin">start</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 向主进程发送信号，重新加载配置文件，热重启</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-s</span> reload</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重启 Nginx</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-s</span> reopen</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 快速关闭</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-s</span> <span class="cm-builtin">stop</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 等待工作进程处理完成后关闭</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-s</span> quit</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前 Nginx 最终的配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-T</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 检查配置是否有问题</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">nginx <span class="cm-attribute">-t</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p>&nbsp;</p><h2 id='配置规则'><span>配置规则</span></h2><p><span>Nginx层级结构如下：</span></p><p><img src="images/Middleware/Nginx层级结构.png" referrerpolicy="no-referrer" alt="Nginx层级结构"></p><h3 id='uri匹配'><span>URI匹配</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">location <span class="cm-operator">=</span> / {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 完全匹配  =</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 大小写敏感 ~</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 忽略大小写 ~*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">location ^~ /images/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 前半部分匹配 ^~</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 可以使用正则，如：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># location ~* \.(gif|jpg|png)$ { }</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">location / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 如果以上都未匹配，会进入这里</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><h3 id='upstream'><span>upstream</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：upstream</span> <span class="cm-tag">name </span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">示例：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> back_end_server{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-2">server</span> 192.168.100.33:<span class="cm-number">8081</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 173px;"></div><div class="CodeMirror-gutters" style="display: none; height: 173px;"></div></div></div></pre><p><code>upstream</code><span> 用于定义上游服务器（指的就是后台提供的应用服务器）的相关信息。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> test_server{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># weight=3 权重值，默认为1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># max_conns=1000 上游服务器的最大并发连接数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># fail_timeout=10s 服务器不可用的判定时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># max_fails=2 服务器不可用的检查次数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># backup 备份服务器，仅当其他服务器都不可用时才会启用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># down 标记服务器长期不可用，离线维护；</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">server</span> 127.0.0.1:<span class="cm-number">8081 weight</span>=<span class="cm-number">3 max_conns</span>=<span class="cm-number">1000 fail_timeout</span>=<span class="cm-number">10s max_fails</span>=2;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 限制每个worker子进程与上游服务器空闲长连接的最大数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">keepalive 16</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 单个长连接可以处理的最多 HTTP 请求个数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">keepalive_requests</span> 100;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 空闲长连接的最长保持时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">keepalive_timeout</span> 60s;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p>&nbsp;</p><h3 id='proxypass'><span>proxy_pass</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_pass</span> URL;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：location、if、limit_except</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">示例：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://127.0.0.1:<span class="cm-tag">8081</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://127.0.0.1:8081/<span class="cm-keyword">proxy</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 108px;"></div><div class="CodeMirror-gutters" style="display: none; height: 108px;"></div></div></div></pre><p><code>URL</code><span> 参数原则：</span></p><ul><li><code>URL</code><span> 必须以 </span><code>http</code><span> 或 </span><code>https</code><span> 开头</span></li><li><code>URL</code><span> 中可以携带变量</span></li><li><code>URL</code><span> 中是否带 </span><code>URI</code><span> ，会直接影响发往上游请求的 </span><code>URL</code><span> </span></li></ul><p><code>URL</code><span> 后缀带 </span><code>/</code><span> 和不带 </span><code>/</code><span> 的区别：</span></p><ul><li><span>不带 </span><code>/</code><span> 意味着 </span><code>Nginx</code><span> 不会修改用户 </span><code>URL</code><span> ，而是直接透传给上游的应用服务器</span></li><li><span>带 </span><code>/</code><span> 意味着 </span><code>Nginx</code><span> 会修改用户 </span><code>URL</code><span> ，修改方法是将 </span><code>location</code><span> 后的 </span><code>URL</code><span> 从用户 </span><code>URL</code><span> 中删除</span></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 用户请求 URL ：/bbs/abc/test.html</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">location</span> /bbs/{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># 请求到达上游应用服务器的 URL ：/bbs/abc/test.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://127.0.0.1:8080;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment"># 请求到达上游应用服务器的 URL ：/abc/test.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://127.0.0.1:8080/;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p><h2 id='应用场景-2'><span>应用场景</span></h2><h3 id='反向代理-1'><span>反向代理</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1 /etc/nginx/conf.d/proxy.conf</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.1 模拟被代理服务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">listen</span> 8080;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">server_name</span> localhost;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">location</span> /<span class="cm-keyword">proxy</span>/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">root</span> /usr/share/nginx/html/<span class="cm-keyword">proxy</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">index</span> <span class="cm-keyword">index</span>.html;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.2 /usr/share/nginx/html/proxy/index.html</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">&lt;h1</span>&gt; 121.42.11.<span class="cm-tag">34 proxy</span> <span class="cm-tag">html &lt;</span>/h1&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2 /etc/nginx/conf.d/proxy.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.1 back server</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">back_end </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-2">server</span> 121.42.11.34:<span class="cm-number">8080 weight</span>=<span class="cm-number">2 max_conns</span>=<span class="cm-number">1000 fail_timeout</span>=<span class="cm-number">10s max_fails</span>=3;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">keepalive 32</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">keepalive_requests</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">keepalive_timeout</span> 20s;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.2 代理配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># vim /etc/hosts进入配置文件,添加如下内容：121.5.180.193 proxy.lion.club</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> <span class="cm-keyword">proxy</span>.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /<span class="cm-keyword">proxy</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://back_end/<span class="cm-keyword">proxy</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 734px;"></div><div class="CodeMirror-gutters" style="display: none; height: 734px;"></div></div></div></pre><p>&nbsp;</p><h3 id='负载均衡-2'><span>负载均衡</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1 /etc/nginx/conf.d/balance.conf</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.1 模拟被代理服务1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">listen</span> 8020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">return</span> <span class="cm-number">200 </span><span class="cm-string">'return 8020 \n'</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.2 模拟被代理服务2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">listen</span> 8030;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">return</span> <span class="cm-number">200 </span><span class="cm-string">'return 8030 \n'</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1.3 模拟被代理服务3</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">listen</span> 8040;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">return</span> <span class="cm-number">200 </span><span class="cm-string">'return 8040 \n'</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2 /etc/nginx/conf.d/balance.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.1 demo server list</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">demo_server </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-2">server</span> 121.42.11.34:8020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable-2">server</span> 121.42.11.34:8030;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8040;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2.2 代理配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> balance.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /balance/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://demo_server;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 842px;"></div><div class="CodeMirror-gutters" style="display: none; height: 842px;"></div></div></div></pre><p>&nbsp;</p><h4 id='hash算法'><span>hash算法</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">demo_server </span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">hash </span>$request_uri;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8030;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8040;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> balance.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /balance/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://demo_server;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p><code>hash $request_uri</code><span> 表示使用 </span><code>request_uri</code><span> 变量作为 </span><code>hash</code><span> 的 </span><code>key</code><span> 值，只要访问的 </span><code>URI</code><span> 保持不变，就会一直分发给同一台服务器。</span></p><p>&nbsp;</p><h4 id='iphash'><span>ip_hash</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">demo_server </span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">ip_hash</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8030;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8040;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> balance.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /balance/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://demo_server;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 324px;"></div><div class="CodeMirror-gutters" style="display: none; height: 324px;"></div></div></div></pre><p><span>根据客户端的请求 </span><code>ip</code><span> 进行判断，只要 </span><code>ip</code><span> 地址不变就永远分配到同一台主机。它可以有效解决后台服务器 </span><code>session</code><span> 保持的问题。</span></p><p>&nbsp;</p><h4 id='最少连接数算法'><span>最少连接数算法</span></h4><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">demo_server </span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">zone test</span> 10M; <span class="cm-comment"># zone可以设置共享内存空间的名字和大小</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>least_conn;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8030;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:8040;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> balance.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /balance/ {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://demo_server;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p><span>各个 </span><code>worker</code><span> 子进程通过读取共享内存的数据，来获取后端服务器的信息。来挑选一台当前已建立连接数最少的服务器进行分配请求。</span></p><p>&nbsp;</p><h3 id='配置缓存'><span>配置缓存</span></h3><p><strong><span>① proxy_cache</span></strong></p><p><span>存储一些之前被访问过、而且可能将要被再次访问的资源，使用户可以直接从代理服务器获得，从而减少上游服务器的压力，加快整个访问速度。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_cache</span> <span class="cm-tag">zone |</span> <span class="cm-tag">off </span>; <span class="cm-comment"># zone 是共享内存的名称</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">默认值：proxy_cache</span> off;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http、server、location</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>② proxy_cache_path</span></strong></p><p><span>设置缓存文件的存放路径。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_cache_path</span> <span class="cm-tag">path </span>[level=levels] ...<span class="cm-tag">可选参数省略，下面会详细列举</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">默认值：proxy_cache_path</span> <span class="cm-tag">off</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><p><span>参数含义：</span></p><ul><li><code>path</code><span> 缓存文件的存放路径</span></li><li><code>level path</code><span> 的目录层级</span></li><li><code>keys_zone</code><span> 设置共享内存</span></li><li><code>inactive</code><span> 在指定时间内没有被访问，缓存会被清理，默认10分钟</span></li></ul><p><strong><span>③ proxy_cache_key</span></strong></p><p><span>设置缓存文件的 </span><code>key</code><span> 。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_cache_key</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">默认值：proxy_cache_key</span> $scheme$proxy_host$request_uri;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http、server、location</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>④ proxy_cache_valid</span></strong></p><p><span>配置什么状态码可以被缓存，以及缓存时长。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_cache_valid</span> [code...] time;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http、server、location</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">配置示例：proxy_cache_valid</span> <span class="cm-tag">200 304</span> 2m;; <span class="cm-comment"># 说明对于状态为200和304的缓存文件的缓存时间是2分钟</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 86px;"></div><div class="CodeMirror-gutters" style="display: none; height: 86px;"></div></div></div></pre><p><strong><span>⑤ proxy_no_cache</span></strong></p><p><span>定义相应保存到缓存的条件，如果字符串参数的至少一个值不为空且不等于“ 0”，则将不保存该响应到缓存。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_no_cache</span> string;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http、server、location</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">示例：proxy_no_cache</span> <span class="cm-tag">$http_pragma </span>&nbsp;  $http_authorization;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>⑥ proxy_cache_bypass</span></strong></p><p><span>定义条件，在该条件下将不会从缓存中获取响应。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">语法：proxy_cache_bypass</span> string;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">上下文：http、server、location</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">示例：proxy_cache_bypass</span> <span class="cm-tag">$http_pragma </span>&nbsp;  $http_authorization;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 65px;"></div><div class="CodeMirror-gutters" style="display: none; height: 65px;"></div></div></div></pre><p><strong><span>⑦ upstream_cache_status 变量</span></strong></p><p><span>它存储了缓存是否命中的信息，会设置在响应头信息中，在调试中非常有用。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">MISS: <span class="cm-tag">未命中缓存</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag">HIT：命中缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EXPIRED: <span class="cm-tag">缓存过期</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">STALE: <span class="cm-tag">命中了陈旧缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">REVALIDDATED: <span class="cm-tag">Nginx验证陈旧缓存依然有效</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">UPDATING: <span class="cm-tag">内容陈旧，但正在更新</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">BYPASS: <span class="cm-tag">X响应从原始服务器获取</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">proxy_cache_path</span> /etc/nginx/<span class="cm-tag">cache_temp levels</span>=2:<span class="cm-tag">2 keys_zone</span>=cache_zone:<span class="cm-tag">30m max_size</span>=<span class="cm-tag">2g inactive</span>=<span class="cm-tag">60m use_temp_path</span>=off;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> cache_server{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:1010;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">server</span> 121.42.11.34:1020;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-string-2">server_name</span> cache.lion.club;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 场景一：实时性要求不高，则配置缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">location</span> /<span class="cm-number">demo </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache</span> cache_zone; <span class="cm-comment"># 设置缓存内存，上面配置中已经定义好的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache_valid</span> <span class="cm-number">200 5m</span>; <span class="cm-comment"># 缓存状态为200的请求，缓存时长为5分钟</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache_key</span> $request_uri; <span class="cm-comment"># 缓存文件的key为请求的URI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">add_header</span> <span class="cm-number">Nginx-Cache-Status</span> <span class="cm-number">$upstream_cache_status </span><span class="cm-comment"># 把缓存状态设置为头部信息，响应给客户端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://cache_server; <span class="cm-comment"># 代理转发</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 场景二：实时性要求非常高，则配置不缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># URI 中后缀为 .txt 或 .text 的设置变量值为 "no cache"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">if</span> <span class="cm-number">($request_uri ~</span> <span class="cm-number">\</span>.<span class="cm-number">(txt|text)$)</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">set</span> <span class="cm-number">$cache_name </span><span class="cm-string">"no cache"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-2">location</span> /<span class="cm-number">test </span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">proxy_no_cache </span>$cache_name; <span class="cm-comment"># 判断该变量是否有值，如果有值则不进行缓存，如果没有值则进行缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache</span> cache_zone; <span class="cm-comment"># 设置缓存内存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache_valid</span> <span class="cm-number">200 5m</span>; <span class="cm-comment"># 缓存状态为200的请求，缓存时长为5分钟</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">proxy_cache_key</span> $request_uri; <span class="cm-comment"># 缓存文件的key为请求的URI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">add_header</span> <span class="cm-number">Nginx-Cache-Status</span> <span class="cm-number">$upstream_cache_status </span><span class="cm-comment"># 把缓存状态设置为头部信息，响应给客户端</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  <span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://cache_server; <span class="cm-comment"># 代理转发</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 864px;"></div><div class="CodeMirror-gutters" style="display: none; height: 864px;"></div></div></div></pre><p>&nbsp;</p><h3 id='https'><span>HTTPS</span></h3><p><span>下载证书的压缩文件，里面有个 </span><code>Nginx</code><span> 文件夹，把 </span><code>xxx.crt</code><span> 和 </span><code>xxx.key</code><span> 文件拷贝到服务器目录，再进行如下配置：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">listen</span> <span class="cm-number">443 ssl</span> <span class="cm-number">http2 default_server</span>; <span class="cm-comment"># SSL 访问端口号为 443</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string-2">server_name</span> lion.club; <span class="cm-comment"># 填写绑定证书的域名(我这里是随便写的)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">ssl_certificate</span> /etc/nginx/https/lion.club_bundle.crt; <span class="cm-comment"># 证书地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">ssl_certificate_key</span> /etc/nginx/https/lion.club.key; <span class="cm-comment"># 私钥地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">ssl_session_timeout</span> 10m;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">ssl_protocols</span> <span class="cm-number">TLSv1 TLSv1</span>.<span class="cm-number">1 TLSv1</span>.2; <span class="cm-comment"># 支持ssl协议版本，默认为后三个，主流版本是[TLSv1.2]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">root</span> &nbsp; &nbsp; &nbsp; &nbsp; /usr/share/nginx/html;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">index</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">index</span>.<span class="cm-number">html index</span>.htm;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 302px;"></div><div class="CodeMirror-gutters" style="display: none; height: 302px;"></div></div></div></pre><p>&nbsp;</p><h3 id='开启gzip压缩'><span>开启gzip压缩</span></h3><p><span>在 </span><code>/etc/nginx/conf.d/</code><span> 文件夹中新建配置文件 </span><code>gzip.conf</code><span> ：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认off，是否开启gzip</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip</span> on; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 要采用 gzip 压缩的 MIME 文件类型，其中 text/html 被系统强制启用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_types</span> text/<span class="cm-tag">plain text</span>/<span class="cm-tag">css application</span>/<span class="cm-tag">json application</span>/<span class="cm-tag">x-javascript</span> text/<span class="cm-tag">xml application</span>/<span class="cm-tag">xml application</span>/xml+<span class="cm-tag">rss text</span>/javascript;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># ---- 以上两个参数开启就可以支持Gzip压缩了 ----</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认 off，该模块启用后，Nginx 首先检查是否存在请求静态文件的 gz 结尾的文件，如果有则直接返回该 .gz 文件内容</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_static</span> on;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认 off，nginx做为反向代理时启用，用于设置启用或禁用从代理服务器上收到相应内容 gzip 压缩</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_proxied</span> any;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 用于在响应消息头中添加Vary：Accept-Encoding，使代理服务器根据请求头中的Accept-Encoding识别是否启用gzip压缩</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_vary</span> on;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># gzip 压缩比，压缩级别是 1-9，1 压缩级别最低，9 最高，级别越高压缩率越大，压缩时间越长，建议 4-6</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_comp_level</span> 6;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 获取多少内存用于缓存压缩结果，16 8k 表示以 8k*16 为单位获得</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_buffers</span> <span class="cm-tag">16 8k</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 允许压缩的页面最小字节数，页面字节数从header头中的 Content-Length 中进行获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_min_length</span> 1k;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认 1.1，启用 gzip 所需的 HTTP 最低版本</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">gzip_http_version</span> 1.1;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 626px;"></div><div class="CodeMirror-gutters" style="display: none; height: 626px;"></div></div></div></pre><p>&nbsp;</p><h2 id='常用配置-2'><span>常用配置</span></h2><h3 id='侦听端口'><span>侦听端口</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Standard HTTP Protocol</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Standard HTTPS Protocol</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> <span class="cm-number">443 ssl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># For http2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> <span class="cm-number">443 ssl</span> http2;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen on 80 using IPv6</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> [::]:80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen only on using IPv6</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> [::]:<span class="cm-number">80 ipv6only</span>=on;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h3 id='访问日志'><span>访问日志</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Relative or full path to log file</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">access_log</span> /path/to/file.log;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Turn 'on' or 'off'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">access_log</span> on;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 130px;"></div><div class="CodeMirror-gutters" style="display: none; height: 130px;"></div></div></div></pre><p>&nbsp;</p><h3 id='域名'><span>域名</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen to yourdomain.com</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen to multiple domains  server_name yourdomain.com www.yourdomain.com;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen to all domains</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> *.yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen to all top-level domains</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.*;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Listen to unspecified Hostnames (Listens to IP address itself)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> <span class="cm-string">""</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><h3 id='静态资源'><span>静态资源</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string-2">root</span> /path/to/website;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p><h3 id='重定向'><span>重定向</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> www.yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-number">301 http</span>://yourdomain.com$request_uri;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> www.yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">location</span> /<span class="cm-number">redirect-url</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-number">301 http</span>://otherdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h3 id='反向代理-2'><span>反向代理</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://0.0.0.0:3000;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># where 0.0.0.0:3000 is your application server (Ex: node.js) bound on 0.0.0.0 listening on port 3000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 194px;"></div><div class="CodeMirror-gutters" style="display: none; height: 194px;"></div></div></div></pre><p>&nbsp;</p><h3 id='负载均衡-3'><span>负载均衡</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">upstream</span> <span class="cm-tag">node_js </span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">server</span> 0.0.0.0:3000;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">server</span> 0.0.0.0:4000;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">server</span> 123.131.121.122;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-2">location</span> / {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string-2">proxy_pass</span> <span class="cm-variable-2">http</span>://node_js;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 281px;"></div><div class="CodeMirror-gutters" style="display: none; height: 281px;"></div></div></div></pre><p>&nbsp;</p><h3 id='ssl协议'><span>SSL协议</span></h3><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="nginx" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="nginx"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> <span class="cm-number">443 ssl</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl</span> on;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl_certificate</span> /path/to/cert.pem;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl_certificate_key</span> /path/to/privatekey.pem;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ssl_stapling on</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ssl_stapling_verify on</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ssl_trusted_certificate </span>/path/to/fullchain.pem;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl_protocols</span> <span class="cm-number">TLSv1 TLSv1</span>.<span class="cm-number">1 TLSv1</span>.2;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl_session_timeout</span> 1h;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">ssl_session_cache</span> shared:SSL:50m;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">add_header</span> <span class="cm-number">Strict-Transport-Security</span> <span class="cm-number">max-age</span>=15768000;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Permanent Redirect for HTTP to HTTPS</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-2">server</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">listen</span> 80;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string-2">server_name</span> yourdomain.com;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-number">301 https</span>://$host$request_uri;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p>&nbsp;</p><h2 id='日志分析'><span>日志分析</span></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计IP访问量</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> access.log | <span class="cm-builtin">sort</span> <span class="cm-attribute">-n</span> | uniq | <span class="cm-builtin">wc</span> <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看某一时间段的IP访问量(4-5点)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">grep</span> <span class="cm-string">"07/Apr/2017:0[4-5]"</span> access.log | <span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> | <span class="cm-builtin">sort</span> | uniq <span class="cm-attribute">-c</span>| <span class="cm-builtin">sort</span> <span class="cm-attribute">-nr</span> | <span class="cm-builtin">wc</span> <span class="cm-attribute">-l</span> &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看访问最频繁的前100个IP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> access.log | <span class="cm-builtin">sort</span> <span class="cm-attribute">-n</span> |uniq <span class="cm-attribute">-c</span> | <span class="cm-builtin">sort</span> <span class="cm-attribute">-rn</span> | head <span class="cm-attribute">-n</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看访问100次以上的IP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> access.log | <span class="cm-builtin">sort</span> <span class="cm-attribute">-n</span> |uniq <span class="cm-attribute">-c</span> |awk <span class="cm-string">'{if($1 &gt;100) print $0}'</span>|sort <span class="cm-attribute">-rn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查询某个IP的详细访问情况,按访问频率排序</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">grep</span> <span class="cm-string">'104.217.108.66'</span> access.log |awk <span class="cm-string">'{print $7}'</span>|sort |uniq <span class="cm-attribute">-c</span> |sort <span class="cm-attribute">-rn</span> |head <span class="cm-attribute">-n</span> <span class="cm-number">100</span> &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 页面访问统计</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看访问最频的页面(TOP100)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $7}'</span> access.log | <span class="cm-builtin">sort</span> |uniq <span class="cm-attribute">-c</span> | <span class="cm-builtin">sort</span> <span class="cm-attribute">-rn</span> | head <span class="cm-attribute">-n</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看访问最频的页面([排除php页面】(TOP100)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">grep</span> <span class="cm-attribute">-v</span> <span class="cm-string">".php"</span>  access.log | <span class="cm-builtin">awk</span> <span class="cm-string">'{print $7}'</span> | <span class="cm-builtin">sort</span> |uniq <span class="cm-attribute">-c</span> | <span class="cm-builtin">sort</span> <span class="cm-attribute">-rn</span> | head <span class="cm-attribute">-n</span> <span class="cm-number">100</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看页面访问次数超过100次的页面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> access.log | <span class="cm-builtin">cut</span> <span class="cm-attribute">-d</span> <span class="cm-string">' '</span> <span class="cm-attribute">-f</span> <span class="cm-number">7</span> | <span class="cm-builtin">sort</span> |uniq <span class="cm-attribute">-c</span> | <span class="cm-builtin">awk</span> <span class="cm-string">'{if ($1 &gt; 100) print $0}'</span> | less</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看最近1000条记录，访问量最高的页面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tail <span class="cm-attribute">-1000</span> access.log |awk <span class="cm-string">'{print $7}'</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|less</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 请求量统计</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每秒的请求数,top100的时间点(精确到秒)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> access.log |cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-21</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每分钟的请求数,top100的时间点(精确到分钟)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> access.log |cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-18</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每小时的请求数,top100的时间点(精确到小时)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> access.log |cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-15</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 性能分析</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 列出传输时间超过 3 秒的页面，显示前20条</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> access.log|awk <span class="cm-string">'($NF &gt; 3){print $7}'</span>|sort <span class="cm-attribute">-n</span>|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-20</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 列出php页面请求时间超过3秒的页面，并统计其出现的次数，显示前100条</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> access.log|awk <span class="cm-string">'($NF &gt; 1 &amp;&amp;  $7~/\.php/){print $7}'</span>|sort <span class="cm-attribute">-n</span>|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 蜘蛛抓取统计</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计蜘蛛抓取次数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">grep</span> <span class="cm-string">'Baiduspider'</span> access.log |wc <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计蜘蛛抓取404的次数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">grep</span> <span class="cm-string">'Baiduspider'</span> access.log |grep <span class="cm-string">'404'</span> | <span class="cm-builtin">wc</span> <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># TCP连接统计</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前TCP连接数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">netstat <span class="cm-attribute">-tan</span> | <span class="cm-builtin">grep</span> <span class="cm-string">"ESTABLISHED"</span> | <span class="cm-builtin">grep</span> <span class="cm-string">":80"</span> | <span class="cm-builtin">wc</span> <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 用tcpdump嗅探80端口的访问看看谁最高</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcpdump <span class="cm-attribute">-i</span> eth0 <span class="cm-attribute">-tnn</span> dst port <span class="cm-number">80</span> <span class="cm-attribute">-c</span> <span class="cm-number">1000</span> | <span class="cm-builtin">awk</span> <span class="cm-attribute">-F</span><span class="cm-string">"."</span> <span class="cm-string">'{print $1"."$2"."$3"."$4}'</span> | <span class="cm-builtin">sort</span> | uniq <span class="cm-attribute">-c</span> | <span class="cm-builtin">sort</span> <span class="cm-attribute">-nr</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> <span class="cm-def">$logpath</span> |sort <span class="cm-attribute">-n</span>|uniq|wc <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 系统正在统计某一个时间段IP访问量为</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sed</span> <span class="cm-attribute">-n</span> <span class="cm-string">'/22\/Jun\/2017:1[5]/,/22\/Jun\/2017:1[6]/p'</span> <span class="cm-def">$logpath</span>|awk <span class="cm-string">'{print $1}'</span>|sort <span class="cm-attribute">-n</span>|uniq|wc <span class="cm-attribute">-l</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 访问100次以上的IP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $1}'</span> <span class="cm-def">$logpath</span>|sort <span class="cm-attribute">-n</span>|uniq <span class="cm-attribute">-c</span>|awk <span class="cm-string">'{if($1&gt;100) print $0}'</span>|sort <span class="cm-attribute">-rn</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 访问最频繁的请求(TOP50)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $7}'</span> <span class="cm-def">$logpath</span> |sort |uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-rn</span> |head <span class="cm-attribute">-n</span> <span class="cm-number">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每秒的请求数(TOP50)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> <span class="cm-def">$logpath</span>|cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-21</span>|sort |uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每分钟的请求数(TOP50)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> <span class="cm-def">$logpath</span>|cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-18</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 统计每小时请求数(TOP50)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">awk</span> <span class="cm-string">'{print $4}'</span> <span class="cm-def">$logpath</span>|cut <span class="cm-attribute">-c</span> <span class="cm-number">14</span><span class="cm-attribute">-15</span>|sort|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-n</span> <span class="cm-number">50</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 传输时间超过1秒的请求(TOP20)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> <span class="cm-def">$logpath</span>|awk <span class="cm-string">'($NF &gt; 1){print $7}'</span>|sort <span class="cm-attribute">-n</span>|uniq <span class="cm-attribute">-c</span>|sort <span class="cm-attribute">-nr</span>|head <span class="cm-attribute">-20</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1728px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1728px;"></div></div></div></pre><p>&nbsp;</p><h1 id='lvs'><span>LVS</span></h1><p><span>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。</span></p><h2 id='工作模式'><span>工作模式</span></h2><p><span>LVS有三种常见的负载均衡的模式：</span><strong><span>NAT模式(网络地址转换模式)、IP TUN（隧道模式）、DR（知己路由模式）</span></strong><span>。阿里云还提供了两种模式：</span><strong><span>full NAT模式、ENAT模式</span></strong><span>。</span></p><p>&nbsp;</p><p><strong><span>术语</span></strong></p><ul><li><strong><span>DS</span></strong><span>：Director Server，指的是前端负载均衡器</span></li><li><strong><span>RS</span></strong><span>：Real Server，后端真实的工作服务器</span></li><li><strong><span>VIP</span></strong><span>：Virtual Ip Address，向外部直接面向用户请求，作为用户请求的目标的IP地址</span></li><li><strong><span>DIP</span></strong><span>：Director Server IP，主要用于和内部主机通讯的IP地址</span></li><li><strong><span>RIP</span></strong><span>：Real Server IP，后端服务器的IP地址</span></li><li><strong><span>CIP</span></strong><span>：Client IP，客户端主机IP地址</span></li></ul><p><span>(假设 cip 是200.200.200.2， vip是200.200.200.1）</span></p><p>&nbsp;</p><h3 id='nat模式网络地址转换'><span>NAT模式(网络地址转换)</span></h3><p><strong><span>NAT模式(NetWork Address Translation-网络地址转换)</span></strong><span>。客户发出请求，发送请求给链接调度器的VIP，调度器将请求报文中的目标Ip地址改为RIP。这样服务器RealServer将请求的内容发给调度器，调度器再将报文中的源IP地址改为VIP。</span></p><p><img src="images/Middleware/LVS-NAT.png" referrerpolicy="no-referrer" alt="LVS-NAT"></p><p><strong><span>原理</span></strong></p><ul><li><span>client发出请求（sip 200.200.200.2，dip 200.200.200.1）</span></li><li><span>请求包到达lvs，lvs修改请求包为（sip 200.200.200.2， dip rip）</span></li><li><span>请求包到达rs， rs回复（sip rip，dip 200.200.200.2）</span></li><li><span>这个回复包不能直接给client，因为rip不是VIP会被reset掉</span></li><li><span>但是因为lvs是网关，所以这个回复包先走到网关，网关有机会修改sip</span></li><li><span>网关修改sip为VIP，修改后的回复包（sip 200.200.200.1，dip 200.200.200.2）发给client</span></li></ul><p>&nbsp;</p><p><img src="images/Middleware/LVS-NAT-IP.png" referrerpolicy="no-referrer" alt="LVS-NAT-IP"></p><p><strong><span>优点</span></strong></p><ul><li><span>配置简单</span></li><li><span>支持端口映射（看名字就知道）</span></li><li><span>RIP一般是私有地址，主要用户LVS和RS之间通信</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>LVS和所有RS必须在同一个vlan</span></li><li><span>进出流量都要走LVS转发</span></li><li><span>LVS容易成为瓶颈</span></li><li><span>一般而言需要将VIP配置成RS的网关</span></li></ul><p>&nbsp;</p><p><strong><span>分析</span></strong></p><ul><li><p><strong><span>为什么NAT要求lvs和RS在同一个vlan？</span></strong></p><p><span>因为回复包必须经过lvs再次修改sip为vip，client才认，如果回复包的sip不是client包请求的dip（也就是vip），那么这个连接会被reset掉。如果LVS不是网关，因为回复包的dip是cip，那么可能从其它路由就走了，LVS没有机会修改回复包的sip</span></p></li></ul><p>&nbsp;</p><p><strong><span>NAT结构</span></strong></p><ul><li><span>LVS修改进出包的(sip, dip)的时只改了其中一个（所以才有接下来的full NAT）</span></li><li><span>NAT最大的缺点是要求LVS和RS必须在同一个vlan，这样限制了LVS集群和RS集群的部署灵活性</span></li></ul><p><img src="images/Middleware/LVS-NAT-STR.png" referrerpolicy="no-referrer" alt="LVS-NAT-STR"></p><p>&nbsp;</p><h3 id='ip-tun模型ip隧道'><span>IP TUN模型(IP隧道)</span></h3><p><strong><span>IP TUN模型(IP Tunneling-IP隧道)</span></strong><span>。和DR模式差不多，但是比DR多了一个隧道技术以支持realserver不在同一个物理环境中。就是realserver一个在北京，一个工作在上海。在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP</span></p><p><strong><span>原理</span></strong></p><ul><li><span>请求包到达LVS后，LVS将请求包封装成一个新的IP报文</span></li><li><span>新的IP包的目的IP是某一RS的IP，然后转发给RS</span></li><li><span>RS收到报文后IPIP内核模块解封装，取出用户的请求报文</span></li><li><span>发现目的IP是VIP，而自己的tunl0网卡上配置了这个IP，从而愉快地处理请求并将结果直接发送给客户</span></li></ul><p>&nbsp;</p><p><strong><span>优点</span></strong></p><ul><li><span>集群节点可以跨vlan</span></li><li><span>跟DR一样，响应报文直接发给client</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>RS上必须安装运行IPIP模块</span></li><li><span>多增加了一个IP头</span></li><li><span>LVS和RS上的tunl0虚拟网卡上配置同一个VIP（类似DR）</span></li></ul><p>&nbsp;</p><p><strong><span>分析</span></strong></p><ul><li><p><strong><span>为什么IP TUN不要求同一个vlan？</span></strong></p><p><span>因为IP TUN中不是修改MAC来路由，所以不要求同一个vlan，只要求lvs和rs之间ip能通就行。DR模式要求的是lvs和RS之间广播能通</span></p></li><li><p><strong><span>IP TUN性能</span></strong></p><p><span>回包不走LVS，但是多做了一次封包解包，不如DR好</span></p></li></ul><p>&nbsp;</p><p><strong><span>IP TUN结构</span></strong></p><ul><li><span>图中红线是再次封装过的包，ipip是操作系统的一个内核模块</span></li><li><span>DR可能在小公司用的比较多，IP TUN用的少一些</span></li></ul><p><img src="images/Middleware/LVS-TP-TUN-STR.png" referrerpolicy="no-referrer" alt="LVS-TP-TUN-STR"></p><p>&nbsp;</p><h3 id='dr模式直接路由'><span>DR模式(直接路由)</span></h3><p><strong><span>DR模式(Director Routing-直接路由)</span></strong><span>。整个DR模式都是停留在第二层的数据链路层。直接修改MAC。实现报文的转发。</span></p><p><img src="images/Middleware/LVS-DR.png" referrerpolicy="no-referrer" alt="LVS-DR"></p><p><strong><span>原理</span></strong></p><ul><li><span>请求流量(sip 200.200.200.2, dip 200.200.200.1) 先到达LVS</span></li><li><span>然后LVS，根据负载策略挑选众多 RS中的一个，然后将这个网络包的MAC地址修改成这个选中的RS的MAC</span></li><li><span>然后丢给交换机，交换机将这个包丢给选中的RS</span></li><li><span>选中的RS看到MAC地址是自己的、dip也是自己的，愉快地手下并处理、回复</span></li><li><span>回复包（sip 200.200.200.1， dip 200.200.200.2）</span></li><li><span>经过交换机直接回复给client了（不再走LVS）</span></li></ul><p>&nbsp;</p><p><img src="images/Middleware/LVS-DR-IP.png" referrerpolicy="no-referrer" alt="LVS-DR-IP"></p><p><strong><span>优点</span></strong></p><ul><li><span>DR模式是性能最好的一种模式，入站请求走LVS，回复报文绕过LVS直接发给Client</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>要求LVS和rs在同一个vlan</span></li><li><span>RS需要配置vip同时特殊处理arp</span></li><li><span>不支持端口映射</span></li></ul><p>&nbsp;</p><p><strong><span>分析</span></strong></p><ul><li><p><strong><span>为什么要求LVS和RS在同一个vlan（或说同一个二层网络里）？</span></strong></p><p><span>因为DR模式依赖多个RS和LVS共用同一个VIP，然后依据MAC地址来在LVS和多个RS之间路由，所以LVS和RS必须在一个vlan或者说同一个二层网络里</span></p></li><li><p><strong><span>DR 模式为什么性能最好？</span></strong></p><p><span>因为回复包不走LVS了，大部分情况下都是请求包小，回复包大，LVS很容易成为流量瓶颈，同时LVS只需要修改进来的包的MAC地址。</span></p></li><li><p><strong><span>DR 模式为什么回包不需要走LVS了？</span></strong></p><p><span>因为RS和LVS共享同一个vip，回复的时候RS能正确地填好sip为vip，不再需要LVS来多修改一次（后面讲的NAT、Full NAT都需要）。</span></p></li></ul><p>&nbsp;</p><p><strong><span>DR结构</span></strong></p><ul><li><span>绿色是请求包进来，红色是修改过MAC的请求包</span></li></ul><p><img src="images/Middleware/LVS-DR-STR.png" referrerpolicy="no-referrer" alt="LVS-DR-STR"></p><p>&nbsp;</p><h3 id='full-nat模式'><span>full NAT模式</span></h3><p><strong><span>full NAT模式(full NetWork Address Translation-全部网络地址转换)</span></strong><span>。</span></p><p><strong><span>原理（类似NAT）</span></strong></p><ul><li><span>client发出请求（sip 200.200.200.2 dip 200.200.200.1）</span></li><li><span>请求包到达lvs，lvs修改请求包为</span><strong><span>（sip 200.200.200.1， dip rip）</span></strong><span> 注意这里sip/dip都被修改了</span></li><li><span>请求包到达rs， rs回复（sip rip，dip 200.200.200.1）</span></li><li><span>这个回复包的目的IP是VIP(不像NAT中是 cip)，所以LVS和RS不在一个vlan通过IP路由也能到达lvs</span></li><li><span>lvs修改sip为vip， dip为cip，修改后的回复包（sip 200.200.200.1，dip 200.200.200.2）发给client</span></li></ul><p>&nbsp;</p><p><strong><span>优点</span></strong></p><ul><li><span>解决了NAT对LVS和RS要求在同一个vlan的问题，适用更复杂的部署形式</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>RS看不到cip（NAT模式下可以看到）</span></li><li><span>进出流量还是都走的lvs，容易成为瓶颈（跟NAT一样都有这个问题）</span></li></ul><p>&nbsp;</p><p><strong><span>分析</span></strong></p><ul><li><strong><span>为什么full NAT解决了NAT中要求的LVS和RS必须在同一个vlan的问题？</span></strong></li></ul><p><span>因为LVS修改进来的包的时候把(sip, dip)都修改了(这也是full的主要含义吧)，RS的回复包目的地址是vip（NAT中是cip），所以只要vip和rs之间三层可通就行，这样LVS和RS可以在不同的vlan了，也就是LVS不再要求是网关，从而LVS和RS可以在更复杂的网络环境下部署。</span></p><ul><li><strong><span>为什么full NAT后RS看不见cip了？</span></strong></li></ul><p><span>因为cip被修改掉了，RS只能看到LVS的vip，在阿里内部会将cip放入TCP包的Option中传递给RS，RS上一般部署自己写的toa模块来从Options中读取的cip，这样RS能看到cip了, 当然这不是一个开源的通用方案。</span></p><p>&nbsp;</p><p><strong><span>full NAT结构</span></strong></p><ul><li><span>full NAT解决了NAT的同vlan的要求，</span><strong><span>基本上可以用于公有云</span></strong></li><li><span>但还没解决进出流量都走LVS的问题（LVS要修改进出的包）</span></li></ul><p><img src="images/Middleware/LVS-full-NAT-STR.png" referrerpolicy="no-referrer" alt="LVS-full-NAT-STR"></p><p>&nbsp;</p><h3 id='enat模式'><span>ENAT模式</span></h3><p><strong><span>ENAT模式(enhence NAT)</span></strong><span>。ENAT模式在内部也会被称为 三角模式或者DNAT/SNAT模式。</span></p><p><strong><span>原理</span></strong></p><ul><li><span>client发出请求（cip，vip）</span></li><li><span>请求包到达lvs，lvs修改请求包为（vip，rip），并将cip放入TCP Option中</span></li><li><span>请求包根据ip路由到达rs， ctk模块读取TCP Option中的cip</span></li><li><span>回复包(RIP, vip)被ctk模块截获，并将回复包改写为（vip, cip)</span></li><li><span>因为回复包的目的地址是cip所以不需要经过lvs，可以直接发给client</span></li></ul><p>&nbsp;</p><p><strong><span>优点</span></strong></p><ul><li><span>不要求LVS和RS在同一个vlan</span></li><li><span>出去的流量不需要走LVS，性能好</span></li></ul><p><strong><span>缺点</span></strong></p><ul><li><span>集团实现的自定义方案，需要在所有RS上安装ctk组件（类似full NAT中的toa）</span></li></ul><p>&nbsp;</p><p><strong><span>分析</span></strong></p><ul><li><strong><span>为什么ENAT的回复包不需要走回LVS了？</span></strong></li></ul><p><span>因为full NAT模式下要走回去是需要LVS再次改写回复包的IP，而ENAT模式下，该事情在RS上被ctk模块提前做掉。</span></p><ul><li><strong><span>为什么ENAT的LVS和RS可以在不同的vlan？</span></strong></li></ul><p><span>跟full NAT一样。</span></p><p>&nbsp;</p><p><strong><span>ENAT结构</span></strong></p><p><img src="images/Middleware/LVS-ENAT-STR.png" referrerpolicy="no-referrer" alt="LVS-ENAT-STR"></p><h2 id='调度算法'><span>调度算法</span></h2><h3 id='静态调度算法'><span>静态调度算法</span></h3><p><span>只根据算法进行调度 而不考虑后端服务器的实际连接情况和负载情况。</span></p><ul><li><strong><span>RR：轮叫调度（Round Robin）</span></strong>
<span>调度器通过”轮叫”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载｡</span></li><li><strong><span>WRR：加权轮叫（Weight RR）</span></strong>
<span>调度器通过“加权轮叫”调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况,并动态地调整其权值。</span></li><li><strong><span>DH：目标地址散列调度（Destination Hash ）</span></strong>
<span>根据请求的目标IP地址，作为散列键(HashKey)从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</span></li><li><strong><span>SH：源地址 hash（Source Hash）</span></strong>
<span>源地址散列”调度算法根据请求的源IP地址，作为散列键(HashKey)从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空｡</span></li></ul><p>&nbsp;</p><h3 id='动态调度算法'><span>动态调度算法</span></h3><ul><li><strong><span>LC：最少链接（Least Connections）</span></strong>
<span>调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</span></li><li><strong><span>WLC：加权最少连接(默认)（Weighted Least Connections）</span></strong>
<span>在集群系统中的服务器性能差异较大的情况下，调度器采用“加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载｡调度器可以自动问询真实服务器的负载情况,并动态地调整其权值。</span></li><li><strong><span>SED：最短延迟调度（Shortest Expected Delay ）</span></strong>
<span>在WLC基础上改进，Overhead = （ACTIVE+1）*256/加权，不再考虑非活动状态，把当前处于活动状态的数目+1来实现，数目最小的，接受下次请求，+1的目的是为了考虑加权的时候，非活动连接过多缺陷：当权限过大的时候，会倒置空闲服务器一直处于无连接状态。</span></li><li><strong><span>NQ永不排队/最少队列调度（Never Queue Scheduling NQ）</span></strong>
<span>无需队列。如果有台 realserver的连接数＝0就直接分配过去，不需要再进行sed运算，保证不会有一个主机很空间。在SED基础上无论+几，第二次一定给下一个，保证不会有一个主机不会很空闲着，不考虑非活动连接，才用NQ，SED要考虑活动状态连接，对于DNS的UDP不需要考虑非活动连接，而httpd的处于保持状态的服务就需要考虑非活动连接给服务器的压力。</span></li><li><strong><span>LBLC：基于局部性的最少链接（locality-Based Least Connections）</span></strong>
<span>基于局部性的最少链接”调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统｡该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器;若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少链接”的原则选出一个可用的服务器，将请求发送到该服务器｡</span></li><li><strong><span>LBLCR：带复制的基于局部性最少连接（Locality-Based Least Connections with Replication）</span></strong>
<span>带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统｡它与LBLC算法的不同之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射｡该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按”最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器；若服务器超载，则按“最小连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器｡同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。</span></li></ul><p>&nbsp;</p><h2 id='常见问题分析'><span>常见问题分析</span></h2><h3 id='脑裂'><span>脑裂</span></h3><p><span>由于两台高可用服务器对之间，在指定时间内，无法相互检测到对方的心跳，而各自启动故障切换转移功能，取得资源服务及所有权，而此时的两台高可用服务器对都还或者，并且正在运行，这样就会导致同一个IP或服务在两段同时启动而发生冲突的严重问题，最严重的是两台主机占用同一个VIP，当用户写入数据的时候可能同时写在两台服务器上。</span>
<strong><span>1）产生裂脑原因</span></strong></p><ul><li><span>心跳链路故障，导致无法通信</span></li><li><span>开启防火墙阻挡心跳消息传输</span></li><li><span>心跳网卡地址配置等不正确</span></li><li><span>其他：心跳方式不同，心跳广播冲突，软件bug等1234</span></li></ul><p><span>备注：</span></p><ul><li><span>心跳线坏了（故障或老化）</span></li><li><span>网卡相关驱动坏了，IP配置即冲突问题（直连）</span></li><li><span>心跳线间连接的设备故障（网卡及交换机）</span></li><li><span>仲裁机器出问题</span></li></ul><p><strong><span>2）防止裂脑的方法</span></strong></p><ul><li><span>采用串行或以太网电缆连接，同时用两条心跳线路</span></li><li><span>做好裂脑的监控报警，在问题发生时人为第一时间介入仲裁</span></li><li><span>启用磁盘锁，即正在服务的一方只在发现心跳线全部断开时，才开启磁盘锁</span></li><li><span>fence设备（智能电源管理设备）</span></li><li><span>增加仲裁盘</span></li><li><span>加冗余线路</span></li></ul><p>&nbsp;</p><h3 id='负载不均'><span>负载不均</span></h3><p><strong><span>原因分析</span></strong></p><ul><li><span>lvs自身的会话保持参数设置。优化：使用cookie代替session</span></li><li><span>lvs调度算法设置，例如rr、wrr</span></li><li><span>后端RS节点的会话保持参数，例如apache的keepalive参数</span></li><li><span>访问量较少的情况下，不均衡的现象更加明显</span></li><li><span>用户发送的请求时间长短和请求资源多少以及大小</span></li></ul><p>&nbsp;</p><h3 id='排错'><span>排错</span></h3><p><span>先检查客户端到服务端——&gt;然后检查负载均衡到RS端——&gt;最后检查客户端到LVS端。</span></p><ul><li><span>调度器上lvs调度规则及IP正确性</span></li><li><span>RS节点上VIP和ARP抑制的检查</span></li></ul><p>&nbsp;</p><p><strong><span>生成思路</span></strong></p><ul><li><span>对绑定的VIP做实时监控，出问题报警或自动处理后报警</span></li><li><span>把绑定的VIP做成配置文件，例如: vim /etc/sysconfig/network-scripts/lo:0</span></li></ul><p>&nbsp;</p><p><strong><span>ARP抑制的配置思路</span></strong></p><ul><li><span>如果是单个VIP，那么可以用stop传参设置0</span></li><li><span>如果RS端有多个VIP绑定，此时，即使是停止VIP绑定也不一定不要置0.</span></li><li><span>RS节点上自身提供服务的检查</span></li><li><span>辅助排除工具有tcpdump、ping等</span></li><li><span>负载均衡和反向代理三角形排查理论</span></li></ul><p>&nbsp;</p><h1 id='keepalived'><span>Keepalived</span></h1><p><span>Keepalived是一个免费开源的，用C编写的类似于layer3, 4 &amp; 7交换机制软件，具备我们平时说的第3层、第4层和第7层交换机的功能。主要提供loadbalancing（负载均衡）和 high-availability（高可用）功能，负载均衡实现需要依赖Linux的虚拟服务内核模块（ipvs），而高可用是通过VRRP协议实现多台机器之间的故障转移服务。</span></p><p>&nbsp;</p><h2 id='功能体系'><span>功能体系</span></h2><p><img src="images/Middleware/Keepalived体系结构.jpg" referrerpolicy="no-referrer" alt="Keepalived体系结构"></p><p><span>Keepalived的所有功能是配置keepalived.conf文件来实现的。上图是Keepalived的功能体系结构，大致分两层：</span></p><ul><li><p><strong><span>内核空间（kernel space）</span></strong></p><p><span>主要包括IPVS（IP虚拟服务器，用于实现网络服务的负载均衡）和NETLINK（提供高级路由及其他相关的网络功能）两个部份。</span></p></li><li><p><strong><span>用户空间（user space）</span></strong></p><ul><li><span>WatchDog：负载监控checkers和VRRP进程的状况</span></li><li><span>VRRP Stack：负载负载均衡器之间的失败切换FailOver，如果只用一个负载均稀器，则VRRP不是必须的</span></li><li><span>Checkers：负责真实服务器的健康检查healthchecking，是keepalived最主要的功能。换言之，可以没有VRRP Stack，但健康检查healthchecking是一定要有的</span></li><li><span>IPVS wrapper：用户发送设定的规则到内核ipvs代码</span></li><li><span>Netlink Reflector：用来设定vrrp的vip地址等</span></li></ul></li></ul><p>&nbsp;</p><p><strong><span>重要功能</span></strong></p><ul><li><span>管理LVS负载均衡软件</span></li><li><span>实现LVS集群节点的健康检查中</span></li><li><span>作为系统网络服务的高可用性（failover）</span></li></ul><p>&nbsp;</p><p><strong><span>高可用故障切换转移原理</span></strong></p><p><span>Keepalived高可用服务对之间的故障切换转移，是通过 VRRP (Virtual Router Redundancy Protocol ,虚拟路由器冗余协议）来实现的。</span></p><p><span>在 Keepalived服务正常工作时，主 Master节点会不断地向备节点发送（多播的方式）心跳消息，用以告诉备Backup节点自己还活看，当主 Master节点发生故障时，就无法发送心跳消息，备节点也就因此无法继续检测到来自主 Master节点的心跳了，于是调用自身的接管程序，接管主Master节点的 IP资源及服务。而当主 Master节点恢复时，备Backup节点又会释放主节点故障时自身接管的IP资源及服务，恢复到原来的备用角色。</span></p><p><strong><span>VRRP</span></strong></p><p><span>全称Virtual Router Redundancy Protocol ,中文名为虚拟路由冗余协议 ，VRRP的出现就是为了解决静态踣甶的单点故障问题，VRRP是通过一种竞选机制来将路由的任务交给某台VRRP路由器的。</span></p><p>&nbsp;</p><h2 id='脑裂问题'><span>脑裂问题</span></h2><p><span>在高可用（HA）系统中，当联系2个节点的“心跳线”断开时，本来为一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去了联系，都以为是对方出了故障。两个节点上的HA软件像“裂脑人”一样，争抢“共享资源”、争起“应用服务”，就会发生严重后果——或者共享资源被瓜分、2边“服务”都起不来了；或者2边“服务”都起来了，但同时读写“共享存储”，导致数据损坏（常见如数据库轮询着的联机日志出错）。</span></p><p><span>对付HA系统“裂脑”的对策，目前达成共识的的大概有以下几条：</span></p><ul><li><span>添加冗余的心跳线，例如：双线条线（心跳线也HA），尽量减少“裂脑”发生几率</span></li><li><span>启用磁盘锁。正在服务一方锁住共享磁盘，“裂脑”发生时，让对方完全“抢不走”共享磁盘资源。但使用锁磁盘也会有一个不小的问题，如果占用共享盘的一方不主动“解锁”，另一方就永远得不到共享磁盘。现实中假如服务节点突然死机或崩溃，就不可能执行解锁命令。后备节点也就接管不了共享资源和应用服务。于是有人在HA中设计了“智能”锁。即：正在服务的一方只在发现心跳线全部断开（察觉不到对端）时才启用磁盘锁。平时就不上锁了</span></li><li><span>设置仲裁机制。例如设置参考IP（如网关IP），当心跳线完全断开时，2个节点都各自ping一下参考IP，不通则表明断点就出在本端。不仅“心跳”、还兼对外“服务”的本端网络链路断了，即使启动（或继续）应用服务也没有用了，那就主动放弃竞争，让能够ping通参考IP的一端去起服务。更保险一些，ping不通参考IP的一方干脆就自我重启，以彻底释放有可能还占用着的那些共享资源</span></li></ul><p>&nbsp;</p><h3 id='产生原因-2'><span>产生原因</span></h3><p><span>一般来说，裂脑的发生，有以下几种原因：</span></p><ul><li><p><span>高可用服务器对之间心跳线链路发生故障，导致无法正常通信</span></p><ul><li><span>因心跳线坏了（包括断了，老化）</span></li><li><span>因网卡及相关驱动坏了，ip配置及冲突问题（网卡直连）</span></li><li><span>因心跳线间连接的设备故障（网卡及交换机）</span></li><li><span>因仲裁的机器出问题（采用仲裁的方案）</span></li></ul></li><li><p><span>高可用服务器上开启了 iptables防火墙阻挡了心跳消息传输</span></p></li><li><p><span>高可用服务器上心跳网卡地址等信息配置不正确，导致发送心跳失败</span></p></li><li><p><span>其他服务配置不当等原因，如心跳方式不同，心跳广插冲突、软件Bug等</span></p></li></ul><p><strong><span>提示：</span></strong><span> Keepalived配置里同一 VRRP实例如果 virtual_router_id两端参数配置不一致也会导致裂脑问题发生。</span></p><p>&nbsp;</p><h3 id='解决方案-2'><span>解决方案</span></h3><p><span>在实际生产环境中，我们可以从以下几个方面来防止裂脑问题的发生：</span></p><ul><li><span>同时使用串行电缆和以太网电缆连接，同时用两条心跳线路，这样一条线路坏了，另一个还是好的，依然能传送心跳消息</span></li><li><span>当检测到裂脑时强行关闭一个心跳节点（这个功能需特殊设备支持，如Stonith、feyce）。相当于备节点接收不到心跳消患，通过单独的线路发送关机命令关闭主节点的电源</span></li><li><span>做好对裂脑的监控报警（如邮件及手机短信等或值班）.在问题发生时人为第一时间介入仲裁，降低损失。例如，百度的监控报警短倍就有上行和下行的区别。报警消息发送到管理员手机上，管理员可以通过手机回复对应数字或简单的字符串操作返回给服务器.让服务器根据指令自动处理相应故障，这样解决故障的时间更短.</span></li></ul><p>&nbsp;</p><p><span>在实施高可用方案时，要根据业务实际需求确定是否能容忍这样的损失。对于一般的网站常规业务，这个损失是可容忍的。</span></p><p>&nbsp;</p><h2 id='安装部署-2'><span>安装部署</span></h2><p><strong><span>第一步：keepalived软件安装</span></strong></p><p><span> </span><code>yum install keepalived -y</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/keepalived</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/keepalived/keepalived.conf &nbsp; &nbsp; #keepalived服务主配置文件</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/rc.d/init.d/keepalived &nbsp; &nbsp; &nbsp; &nbsp; #服务启动脚本</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/etc/sysconfig/keepalived</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/bin/genhash</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/libexec/keepalived</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">/usr/sbin/keepalived</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第二步：配置文件说明</span></strong></p><p><span>全局配置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> global_defs { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 全局配置</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  notification_email { &nbsp; <span class="cm-comment"># 定义报警邮件地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  acassen@firewall.loc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  failover@firewall.loc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;  sysadmin@firewall.loc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  notification_email_from Alexandre.Cassen@firewall.loc &nbsp; &nbsp;<span class="cm-comment"># 定义发送邮件的地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  smtp_server <span class="cm-number">192</span>.168.200.1 &nbsp; <span class="cm-comment"># 邮箱服务器 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  smtp_connect_timeout <span class="cm-number">30</span> &nbsp; &nbsp;<span class="cm-comment"># 定义超时时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  router_id LVS_DEVEL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 定义路由标识信息，相同局域网唯一</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> } &nbsp;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p><span>虚拟ip配置brrp</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">vrrp_instance VI_1 { &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 定义实例</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  state MASTER &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 状态参数 master/backup 只是说明</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  interface eth0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 虚IP地址放置的网卡位置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_router_id <span class="cm-number">51</span> &nbsp; &nbsp;<span class="cm-comment"># 同一家族要一直，同一个集群id一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  priority <span class="cm-number">100</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 优先级决定是主还是备 &nbsp;  越大越优先</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  advert_int <span class="cm-number">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 主备通讯时间间隔</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  authentication {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_type PASS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_pass <span class="cm-number">1111</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 认证</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_ipaddress {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">192</span>.168.200.16 &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 设备之间使用的虚拟ip地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">192</span>.168.200.17</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">192</span>.168.200.18</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 345px;"></div><div class="CodeMirror-gutters" style="display: none; height: 345px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第三步：最终配置文件</span></strong></p><p><span>主负载均衡服务器配置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># cat  /etc/keepalived/keepalived.conf </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">! Configuration File <span class="cm-keyword">for</span> keepalived</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">global_defs {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; router_id lb01</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">vrrp_instance VI_1 {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  state MASTER</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  interface eth0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_router_id <span class="cm-number">51</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  priority <span class="cm-number">150</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  advert_int <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  authentication {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_type PASS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_pass <span class="cm-number">1111</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_ipaddress {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">10</span>.0.0.3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p><span>备负载均衡服务器配置</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb02 ~]<span class="cm-comment"># cat /etc/keepalived/keepalived.conf </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">! Configuration File <span class="cm-keyword">for</span> keepalived</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">global_defs {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; router_id lb02</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">vrrp_instance VI_1 {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  state BACKUP</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  interface eth0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_router_id <span class="cm-number">51</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  priority <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  advert_int <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  authentication {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_type PASS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  auth_pass <span class="cm-number">1111</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  virtual_ipaddress {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-number">10</span>.0.0.3</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 453px;"></div><div class="CodeMirror-gutters" style="display: none; height: 453px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第四步：启动keepalived</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb02 ~]<span class="cm-comment"># /etc/init.d/keepalived start</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Starting keepalived: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [  OK  ]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 43px;"></div><div class="CodeMirror-gutters" style="display: none; height: 43px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第五步：在进行访问测试之前要保证后端的节点都能够单独的访问</span></strong></p><p><span>测试连通性.  后端节点</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:www.etiantian.org  10.0.0.8</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web01 www</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:www.etiantian.org  10.0.0.7</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web02 www</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:www.etiantian.org  10.0.0.9</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web03 www</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:bbs.etiantian.org  10.0.0.9</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web03 bbs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:bbs.etiantian.org  10.0.0.8</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web01 bbs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># curl -H host:bbs.etiantian.org  10.0.0.7</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">web02 bbs</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 259px;"></div><div class="CodeMirror-gutters" style="display: none; height: 259px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第六步：查看虚拟ip状态</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@lb01 conf]<span class="cm-comment"># ip a</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="cm-number">65536</span> qdisc noqueue state UNKNOWN </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  link/loopback <span class="cm-number">00</span>:00:00:00:00:00 brd <span class="cm-number">00</span>:00:00:00:00:00</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet <span class="cm-number">127</span>.0.0.1/8 scope host lo</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet6 ::1/128 scope host </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; valid_lft forever preferred_lft forever</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="cm-number">1500</span> qdisc pfifo_fast state UP qlen <span class="cm-number">1000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  link/ether <span class="cm-number">00</span>:0c:29:90:7f:0d brd ff:ff:ff:ff:ff:ff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet <span class="cm-number">10</span>.0.0.5/24 brd <span class="cm-number">10</span>.0.0.255 scope global eth0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet <span class="cm-number">10</span>.0.0.3/24 scope global secondary eth0:1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet6 fe80::20c:29ff:fe90:7f0d/64 scope link </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; valid_lft forever preferred_lft forever</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-number">3</span>: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="cm-number">1500</span> qdisc pfifo_fast state UP qlen <span class="cm-number">1000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  link/ether <span class="cm-number">00</span>:0c:29:90:7f:17 brd ff:ff:ff:ff:ff:ff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet <span class="cm-number">172</span>.16.1.5/24 brd <span class="cm-number">172</span>.16.1.255 scope global eth1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  inet6 fe80::20c:29ff:fe90:7f17/64 scope link </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; valid_lft forever preferred_lft forever</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 410px;"></div><div class="CodeMirror-gutters" style="display: none; height: 410px;"></div></div></div></pre><p>&nbsp;</p><p><strong><span>第七步：【总结】配置文件修改</span></strong></p><p><span>Keepalived主备配置文件区别：</span></p><ul><li><span>router_id 信息不一致</span></li><li><span>state 状态描述信息不一致</span></li><li><span>priority 主备竞选优先级数值不一致</span></li></ul><p>&nbsp;</p><h1 id='haproxy'><span>HAProxy</span></h1><p><span>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代 理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</span></p><p>&nbsp;</p><h2 id='四层负载均衡'><span>四层负载均衡</span></h2><p><span>所谓的四层就是ISO参考模型中的第四层。四层负载均衡也称为四层交换机，它主要是</span><strong><span>通过分析IP层及TCP/UDP层的流量实现的基于IP加端口的负载均衡</span></strong><span>。常见的基于四层的负载均衡器有</span><strong><span>LVS、F5</span></strong><span>等。</span></p><p><span> </span><img src="images/Middleware/四层负载均衡.png" referrerpolicy="no-referrer" alt="四层负载均衡"></p><p><span>以常见的TCP应用为例，负载均衡器在接收到第一个来自客户端的SYN请求时，会通过设定的负载均衡算法选择一个最佳的后端服务器，同时将报文中目标IP地址修改为后端服务器IP，然后直接转发给该后端服务器，这样一个负载均衡请求就完成了。从这个过程来看，一个TCP连接是客户端和服务器直接建立的，而负载均衡器只不过完成了一个类似路由器的转发动作。在某些负载均衡策略中，为保证后端服务器返回的报文可以正确传递给负载均衡器，在转发报文的同时可能还会对报文原来的源地址进行修改。</span></p><p>&nbsp;</p><h2 id='七层负载均衡'><span>七层负载均衡</span></h2><p><span>七层负载均衡器也称为七层交换机，位于OSI的最高层，即应用层，此时负载均衡器支持多种应用协议，常见的有</span><strong><span>HTTP、FTP、SMTP</span></strong><span>等。七层负载均衡器</span><strong><span>可以根据报文内容，再配合负载均衡算法来选择后端服务器</span></strong><span>，因此也称为“内容交换器”。比如，对于Web服务器的负载均衡，七层负载均衡器不但可以根据“IP+端口”的方式进行负载分流，还可以根据网站的URL、访问域名、浏览器类别、语言等决定负载均衡的策略。例如，有两台Web服务器分别对应中英文两个网站，两个域名分别是A、B，要实现访问A域名时进入中文网站，访问B域名时进入英文网站，这在四层负载均衡器中几乎是无法实现的，而七层负载均衡可以根据客户端访问域名的不同选择对应的网页进行负载均衡处理。常见的七层负载均衡器有HAproxy、Nginx等。</span></p><p><img src="images/Middleware/七层负载均衡.png" referrerpolicy="no-referrer" alt="七层负载均衡"></p><p><span>这里仍以常见的TCP应用为例，由于负载均衡器要获取到报文的内容，因此只能先代替后端服务器和客户端建立连接，接着，才能收到客户端发送过来的报文内容，然后再根据该报文中特定字段加上负载均衡器中设置的负载均衡算法来决定最终选择的内部服务器。纵观整个过程，七层负载均衡器在这种情况下类似于一个代理服务器。整个过程如下图所示。</span></p><p>&nbsp;</p><p><strong><span>四层和七层负载均衡</span></strong></p><p><span>对比四层负载均衡和七层负载均衡运行的整个过程，可以看出，在七层负载均衡模式下，负载均衡器与客户端及后端的服务器会分别建立一次TCP连接，而在四层负载均衡模式下，仅建立一次TCP连接。由此可知，七层负载均衡对负载均衡设备的要求更高，而七层负载均衡的处理能力也必然低于四层模式的负载均衡。</span></p><p>&nbsp;</p><h2 id='负载均衡策略'><span>负载均衡策略</span></h2><ul><li><span>roundrobin：表示简单的轮询</span></li><li><span>static-rr：表示根据权重</span></li><li><span>leastconn：表示最少连接者先处理</span></li><li><span>source：表示根据请求的源IP，类似Nginx的IP_hash机制</span></li><li><span>uri：表示根据请求的URI</span></li><li><span>url_param：表示根据HTTP请求头来锁定每一次HTTP请求</span></li><li><span>rdp-cookie(name)：表示根据据cookie(name)来锁定并哈希每一次TCP请求</span></li></ul><p>&nbsp;</p><p><strong><span>常用的负载均衡算法</span></strong></p><ul><li><span>轮询算法：roundrobin</span></li><li><span>根据请求源IP算法：source</span></li><li><span>最少连接者先处理算法：lestconn</span></li></ul><p>&nbsp;</p><h2 id='haproxy与lvs的区别'><span>HAProxy与LVS的区别</span></h2><p><span>HAProxy负载均衡与LVS负载均衡的区别：</span></p><ul><li><span>两者都是软件负载均衡产品，但是LVS是基于Linux操作系统实现的一种软负载均衡，而HAProxy是基于第三应用实现的软负载均衡</span></li><li><span>LVS是基于四层的IP负载均衡技术，而HAProxy是基于四层和七层技术、可提供TCP和HTTP应用的负载均衡综合解决方案</span></li><li><span>LVS工作在ISO模型的第四层，因此其状态监测功能单一，而HAProxy在状态监测方面功能强大，可支持端口、URL、脚本等多种状态检测方式</span></li><li><span>HAProxy虽然功能强大，但是整体处理性能低于四层模式的LVS负载均衡，而LVS拥有接近硬件设备的网络吞吐和连接负载能力</span></li></ul><p><span>综上所述，HAProxy和LVS各有优缺点，没有好坏之分，要选择哪个作为负载均衡器，要以实际的应用环境来决定。</span></p><p>&nbsp;</p><h2 id='安装配置'><span>安装配置</span></h2><p><strong><span>第一步：安装依赖</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.79688px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  yum -y install make gcc gcc-c++ openssl-devel</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><strong><span>第二步：安装haproxy</span></strong></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.39844px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style="text-rendering: auto;"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  wget http://haproxy.1wt.eu/download/1.3/src/haproxy-1.3.20.tar.gz</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  tar zcvf haproxy-1.3.20.tar.gz</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  cd haproxy-1.3.20</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  make TARGET=linux26 PREFIX=/usr/local/haproxy &nbsp;  # 将haproxy安装到/usr/local/haproxy</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@test ~] <span class="cm-comment">#  make install PREFIX=/usr/local/haproxy</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 151px;"></div><div class="CodeMirror-gutters" style="display: none; height: 151px;"></div></div></div></pre><p>&nbsp;</p></div></div>
</body>
</html>